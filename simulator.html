<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EPKTC39SQG"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-EPKTC39SQG');
    </script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è·äººã‚®ã‚¢ V22 (ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥UIãƒ»8è‰²ç‰ˆ)</title>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
    * { box-sizing: border-box; touch-action: manipulation; }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
        background-color: #2c3e50;
        color: #333;
        margin: 0; 
        height: 100dvh; 
        padding: 5px;
        padding-bottom: 80px; 
        display: flex; flex-direction: column;
        overflow: hidden;
    }

    /* UIå…±é€š */
    button {
        border: none; padding: 8px 10px; border-radius: 6px; cursor: pointer;
        font-size: 12px; font-weight: bold; color: white; display: flex; align-items: center; justify-content: center;
        transition: opacity 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    button:active { opacity: 0.7; transform: scale(0.96); }
    
    .btn-home { background: #555; }
    .btn-data { background: #8e44ad; }
    .btn-add  { background: #2ecc71; }
    .btn-reset{ background: #e74c3c; } 
    .btn-photo{ background: #e67e22; }
    .btn-save { background: #34495e; }
    .btn-sub  { background: #95a5a6; font-size: 11px; padding: 5px 10px; width:100%; margin-top:10px;}

    /* æ“ä½œãƒ‘ãƒãƒ« */
    .control-panel {
        background: rgba(255, 255, 255, 0.95);
        padding: 8px; border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        display: flex; gap: 5px; justify-content: space-between; align-items: center;
        margin-bottom: 5px; flex-shrink: 0; z-index: 100;
        overflow-x: auto; 
        white-space: nowrap;
    }
    .control-panel::-webkit-scrollbar { display: none; }

    /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
    .workspace { 
        display: flex; flex: 1; gap: 5px; overflow: hidden; position: relative;
        background-size: cover; background-position: center; background-repeat: no-repeat;
        background-color: #bdc3c7; 
        border-radius: 8px;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
    }
    
    .palette, .scale-area {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(4px);
    }

    /* å·¦ï¼šã‚«ã‚¿ãƒ­ã‚°ã‚¨ãƒªã‚¢ï¼ˆãƒãƒƒã‚¸ã‚’å»ƒæ­¢ã—ã¦ã‚¹ãƒƒã‚­ãƒªï¼ï¼‰ */
    .palette {
        width: 120px; border-radius: 8px;
        padding: 5px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px;
    }
    .palette-item-wrap { position: relative; width: 100%; display: flex; justify-content: center; }

    /* å³ï¼šç©ã¿ä¸Šã’ã‚¨ãƒªã‚¢ */
    .scale-area {
        flex: 1; border-bottom: 10px solid rgba(44, 62, 80, 0.8); border-radius: 8px 8px 0 0; position: relative;
        display: flex; justify-content: center; align-items: flex-end; overflow: hidden;
    }
    #stack-container {
        width: 100%; display: flex; flex-direction: column-reverse;
        align-items: center; transition: transform 0.1s; transform-origin: bottom center; padding-bottom: 2px;
    }

    /* åˆè¨ˆè¡¨ç¤º */
    .total-display {
        position: absolute; top: 10px; right: 10px;
        background: rgba(0, 0, 0, 0.8); color: #f1c40f; padding: 8px 14px;
        border-radius: 24px; font-size: 16px; font-weight: bold; z-index: 100; 
        backdrop-filter: blur(5px); border: 2px solid rgba(255,255,255,0.3);
        text-align: right; cursor: pointer; user-select: none; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        transition: transform 0.1s;
    }
    .total-display:active { transform: scale(0.95); background: rgba(0,0,0,1); }
    .tax-info { font-size: 10px; color: #ddd; font-weight: normal; display: block; margin-bottom: 2px;}
    .toggle-hint { font-size: 9px; color: #aaa; font-weight: normal; margin-left: 5px; }

    /* ç®±ã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆå…±é€šï¼‰ */
    .cost-box {
        width: 90%; max-width: 280px; border-radius: 4px;
        display: flex; justify-content: space-between; align-items: center; padding: 0 6px;
        color: white; font-weight: bold; cursor: grab; font-size: 10px;
        position: relative; line-height: 1.2; flex-shrink: 0; opacity: 0.9; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.4); text-shadow: 0 1px 2px rgba(0,0,0, 0.8); 
        -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;
    }
    /* ã‚«ã‚¿ãƒ­ã‚°å†…ã®ç®± */
    .palette .cost-box { 
        height: 38px !important; font-size: 10px; width: 100%; margin: 0;
        justify-content: center; /* ãƒãƒƒã‚¸ãŒç„¡ããªã£ãŸã®ã§æ–‡å­—ã‚’ä¸­å¤®ã¸ï¼ */
        padding: 0 5px; text-align: center; cursor: pointer;
    }
    
    .dragging-ghost { position: fixed; pointer-events: none; z-index: 9999; opacity: 0.8; transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«é¡ */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 999; backdrop-filter: blur(3px); }
    .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 350px; display: flex; flex-direction: column; gap: 10px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .form-group label { display: block; font-size: 11px; color: #555; margin-bottom: 3px; }
    .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    #site-data-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    
    /* 8è‰²ãƒ‘ãƒ¬ãƒƒãƒˆç”¨ã«2æ®µæŠ˜ã‚Šè¿”ã—è¨­å®š */
    .color-palette { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 8px; margin-top: 5px; }
    .color-swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .color-swatch.selected { border-color: #333; transform: scale(1.15); }

</style>
</head>
<body>

    <div class="control-panel">
        <div style="display:flex; gap:5px;">
            <button class="btn-home" onclick="location.href='index.html'">ğŸ  ãƒ›ãƒ¼ãƒ </button>
            <button class="btn-data" onclick="openDataModal()">âš™ï¸ è¨­å®š</button>
            <button class="btn-photo" onclick="document.getElementById('bg-upload').click()">ğŸ“· èƒŒæ™¯</button>
            <input type="file" id="bg-upload" accept="image/*" style="display:none" onchange="loadBackground(this)">
        </div>

        <div style="display:flex; gap:5px; align-items:center;">
            <input type="range" id="zoom" min="0.2" max="1.5" step="0.1" value="1.0" style="width:60px;">
            <button class="btn-add" onclick="openItemModal()">ï¼‹ éƒ¨æ</button>
            <button class="btn-reset" onclick="resetStack()">ğŸ—‘ï¸</button>
            <button class="btn-save" onclick="saveAsImage()">ğŸ’¾ ä¿å­˜</button>
        </div>
    </div>

    <div class="workspace" id="capture-area">
        <div class="palette" id="source-zone"></div>
        <div class="scale-area" id="drop-zone">
            <div class="total-display" onclick="toggleTax()">
                <span class="tax-info" id="tax-label">ç¨è¾¼åˆè¨ˆ</span>
                Â¥<span id="total-price">0</span>
                <span class="toggle-hint">â‡„</span>
            </div>
            <div id="stack-container"></div>
            <div style="position:absolute; bottom:5px; color:rgba(255,255,255,0.7); font-size:10px; text-shadow:0 1px 2px rgba(0,0,0,0.8);">ç®±ã‚¿ãƒƒãƒ—ã§è©³ç´°ãƒ»å‰Šé™¤</div>
        </div>
    </div>

    <div id="dataModal" class="modal">
        <div class="modal-content">
            <h3>å»ºç‰©ãƒ‡ãƒ¼ã‚¿ (è¨ˆç®—åŸºæº–)</h3>
            <div id="site-data-list"></div>
            <button class="btn-sub" onclick="addNewVariable()">ï¼‹ æ–°ã—ã„åŸºæº–ã‚’è¿½åŠ </button>
            <button onclick="saveDataModal()" style="background:#3498db; width:100%; margin-top:10px;">é–‰ã˜ã‚‹ & ä¿å­˜</button>
        </div>
    </div>

    <div id="itemModal" class="modal">
        <div class="modal-content">
            <h3 id="item-modal-title">éƒ¨æã‚«ã‚¿ãƒ­ã‚°è¿½åŠ </h3>
            <div class="form-group">
                <label>é …ç›®å</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="m-name" placeholder="åç§°ã‚’å…¥åŠ›" style="flex:1;">
                    <select id="m-name-preset" onchange="applyPresetName()" style="width:90px; font-size:11px;"><option value="">å€™è£œã‹ã‚‰</option></select>
                </div>
            </div>
            <div class="form-group"><label>è¨ˆç®—ã‚¿ã‚¤ãƒ—</label><select id="m-type"></select></div>
            <div class="form-group"><label>é‡‘é¡ / å˜ä¾¡</label><input type="number" id="m-price"></div>
            <div class="form-group"><label>è‰²ã‚’é¸æŠ</label><div class="color-palette" id="swatch-container"></div><input type="hidden" id="m-color-val" value="#95a5a6"></div>
            <div style="display:flex; gap:8px; margin-top:10px;">
                <button id="modal-delete-btn" onclick="deleteItemFromModal()" style="background:#e74c3c; width:45px; display:none;">ğŸ—‘ï¸</button>
                <button onclick="closeItemModal()" style="background:#ccc; flex:1; color:#333;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modal-submit-btn" onclick="saveItemFromModal()" style="background:#2ecc71; flex:1;">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <div id="stackDetailModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h3 id="detail-title" style="margin-top: 0; margin-bottom: 5px; color:#2c3e50;">é …ç›®å</h3>
            <div id="detail-formula" style="font-size: 14px; color: #666; margin-bottom: 10px; background:#f9f9f9; padding:10px; border-radius:6px; border:1px solid #eee;">
                è¨ˆç®—å¼
            </div>
            <div id="detail-price" style="font-size: 24px; font-weight: bold; color: #e74c3c; margin-bottom: 20px;">
                Â¥0
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="closeStackDetailModal()" style="background:#ccc; flex:1; color:#333;">é–‰ã˜ã‚‹</button>
                <button onclick="removeActiveStackBox()" style="background:#e74c3c; flex:1;">ğŸ—‘ï¸ ã“ã®ç®±ã‚’å´©ã™</button>
            </div>
        </div>
    </div>

<script>
    const PIXEL_PER_YEN = 0.0005; 
    const STORAGE_KEY_VARS = 'shokunin_vars_v9';
    const STORAGE_KEY_ITEMS = 'shokunin_items_v9';
    const TAX_RATE = 1.1; 

    let isTaxIncluded = true;
    let editingItemId = null; 
    let currentActiveStackBox = null; 

    // â˜…è±ªè¯8è‰²ãƒ‘ãƒ¬ãƒƒãƒˆã«å¤‰æ›´ï¼
    const PRESET_COLORS = [
        { val: '#95a5a6', name: 'ã‚°ãƒ¬ãƒ¼' }, { val: '#e74c3c', name: 'èµ¤' },
        { val: '#3498db', name: 'é’' },     { val: '#f1c40f', name: 'é»„' }, 
        { val: '#2ecc71', name: 'ç·‘' },     { val: '#e67e22', name: 'ã‚ªãƒ¬ãƒ³ã‚¸' },
        { val: '#9b59b6', name: 'ç´«' },     { val: '#34495e', name: 'æ¿ƒç´º' }
    ];

    let siteVariables = [], paletteItems = [];
    const sourceZone = document.getElementById('source-zone');
    const stackContainer = document.getElementById('stack-container');
    const dropZone = document.getElementById('drop-zone');
    const totalDisplay = document.getElementById('total-price');

    loadData(); renderPalette();

    document.getElementById('zoom').addEventListener('input', (e) => stackContainer.style.transform = `scale(${e.target.value})`);

    function toggleTax() {
        isTaxIncluded = !isTaxIncluded;
        recalcTotal();
        if(navigator.vibrate) navigator.vibrate(30);
    }

    function loadBackground(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById('capture-area').style.backgroundImage = `url(${e.target.result})`; };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveAsImage() {
        const element = document.getElementById('capture-area');
        html2canvas(element, { backgroundColor: null }).then(canvas => {
            const link = document.createElement('a'); link.download = 'mitsumori_sim.png'; link.href = canvas.toDataURL(); link.click();
        });
    }

    function initColorSwatches(targetColor = '#95a5a6') {
        const container = document.getElementById('swatch-container');
        const input = document.getElementById('m-color-val');
        container.innerHTML = ''; input.value = targetColor;

        PRESET_COLORS.forEach((color) => {
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch'; swatch.style.backgroundColor = color.val;
            swatch.onclick = () => {
                document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
                swatch.classList.add('selected'); input.value = color.val;
            };
            if (color.val === targetColor || color.val.toLowerCase() === targetColor.toLowerCase()) { swatch.classList.add('selected'); }
            container.appendChild(swatch);
        });
    }

    function loadData() {
        const savedVars = localStorage.getItem(STORAGE_KEY_VARS);
        siteVariables = savedVars ? JSON.parse(savedVars) : [{ id: 'wall', label: 'å¤–å£(ã¡)', val: 150 }, { id: 'roof', label: 'å±‹æ ¹(ã¡)', val: 80 }, { id: 'seal', label: 'ã‚·ãƒ¼ãƒ«(ï½)', val: 120 }];
        const savedItems = localStorage.getItem(STORAGE_KEY_ITEMS);
        paletteItems = savedItems ? JSON.parse(savedItems) : [
            { id: 1, label: "è¶³å ´ä»£", unitPrice: 150000, typeId: "fixed", color: "#95a5a6" },
            { id: 2, label: "å¤–å£ã‚·ãƒªã‚³ãƒ³", unitPrice: 2800, typeId: "wall", color: "#e74c3c" },
            { id: 3, label: "å±‹æ ¹ãƒ•ãƒƒç´ ", unitPrice: 4500, typeId: "roof", color: "#3498db" }
        ];
    }
    function saveData() { localStorage.setItem(STORAGE_KEY_VARS, JSON.stringify(siteVariables)); localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(paletteItems)); }

    function renderPalette() {
        sourceZone.innerHTML = '';
        paletteItems.forEach((item) => {
            const wrap = document.createElement('div'); wrap.className = 'palette-item-wrap';
            
            // ãƒãƒƒã‚¸ã¯ç”Ÿæˆã—ã¾ã›ã‚“ï¼
            const div = document.createElement('div'); div.className = 'cost-box'; 
            div.style.background = `linear-gradient(135deg, ${item.color}, ${darkenColor(item.color, 20)})`;
            div.innerHTML = `<span>${item.label}</span>`;
            
            // ã‚¿ãƒƒãƒ—ï¼†ãƒ‰ãƒ©ãƒƒã‚°ã®åˆ¶å¾¡
            setupTouchDrag(div, item);

            // PCç”¨ï¼šã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ã‚’é–‹ã
            div.addEventListener('click', () => openEditItemModal(item.id));
            div.draggable = true;
            div.addEventListener('dragstart', (e) => { e.dataTransfer.effectAllowed = 'copy'; e.dataTransfer.setData('application/json', JSON.stringify(item)); div.style.opacity = '0.5'; });
            div.addEventListener('dragend', () => div.style.opacity = '0.9');
            
            wrap.appendChild(div); sourceZone.appendChild(wrap);
        });
        
        // ãƒ‘ãƒ¬ãƒƒãƒˆã®ä¸‹ã«å°ã•ãªãƒ’ãƒ³ãƒˆã‚’æ·»ãˆã‚‹
        const hint = document.createElement('div');
        hint.style.cssText = "font-size:9px; color:#aaa; text-align:center; margin-top:10px;";
        hint.innerText = "ã‚¿ãƒƒãƒ—ã§ç·¨é›†ãƒ»å‰Šé™¤";
        sourceZone.appendChild(hint);
    }

    // â˜…ãƒ‰ãƒ©ãƒƒã‚°ã¨ã‚¿ãƒƒãƒ—ï¼ˆç·¨é›†ï¼‰ã‚’å®Œç’§ã«ä¸¡ç«‹ã•ã›ã‚‹å‡¦ç†
    function setupTouchDrag(el, itemData) {
        let ghost = null;
        let startX, startY;
        let isDragging = false;

        el.addEventListener('contextmenu', e => e.preventDefault());

        el.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            startX = touch.clientX; startY = touch.clientY;
            isDragging = false;
        }, {passive: false});

        el.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            
            // æŒ‡ãŒ5pxä»¥ä¸Šå‹•ã„ãŸã‚‰ã€Œãƒ‰ãƒ©ãƒƒã‚°ã€ã¨ã¿ãªã™
            if (!isDragging && (Math.abs(touch.clientX - startX) > 5 || Math.abs(touch.clientY - startY) > 5)) {
                isDragging = true;
                ghost = el.cloneNode(true);
                ghost.classList.add('dragging-ghost');
                ghost.style.width = el.offsetWidth + 'px'; ghost.style.height = el.offsetHeight + 'px';
                document.body.appendChild(ghost);
            }

            if (isDragging && ghost) {
                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
                ghost.style.left = (touch.clientX - el.offsetWidth/2) + 'px';
                ghost.style.top = (touch.clientY - el.offsetHeight/2) + 'px';
            }
        }, {passive: false});

        const cleanup = (e) => {
            if (isDragging && ghost) {
                if (e.type === 'touchend') {
                    e.preventDefault(); // ã‚¹ãƒãƒ›ã§ã®èª¤ã‚¯ãƒªãƒƒã‚¯ã‚’é˜²æ­¢
                    const touch = e.changedTouches[0];
                    const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (dropTarget && dropTarget.closest('#drop-zone')) { createStackBox(itemData); }
                }
                document.body.removeChild(ghost); 
                ghost = null;
            } else if (!isDragging && e.type === 'touchend') {
                // å‹•ã‹ã•ãšã«æŒ‡ã‚’é›¢ã—ãŸï¼ã€Œã‚¿ãƒƒãƒ—ã—ãŸã€ã®ã§ç·¨é›†ç”»é¢ã‚’é–‹ã
                openEditItemModal(itemData.id);
            }
            isDragging = false;
        };

        el.addEventListener('touchend', cleanup);
        el.addEventListener('touchcancel', cleanup); 
    }

    function createStackBox(data) {
        const div = document.createElement('div'); div.className = 'cost-box';
        div.style.background = `linear-gradient(135deg, ${data.color}, ${darkenColor(data.color, 20)})`;
        div.dataset.label = data.label; div.dataset.unitPrice = data.unitPrice; div.dataset.typeId = data.typeId; 
        
        div.addEventListener('click', () => { openStackDetailModal(div); });
        
        stackContainer.appendChild(div); recalcSingleBox(div); recalcTotal();
    }

    function recalcSingleBox(box) {
        const typeId = box.dataset.typeId; const unitPrice = parseFloat(box.dataset.unitPrice);
        let multiplier = 1; 
        if (typeId !== 'fixed') { const variable = siteVariables.find(v => v.id === typeId); multiplier = variable ? parseFloat(variable.val) : 0; }
        const currentPrice = unitPrice * multiplier;
        box.dataset.currentPrice = currentPrice;
        let height = currentPrice * PIXEL_PER_YEN; if (height < 24) height = 24; box.style.height = `${height}px`;
        box.innerHTML = `<span>${box.dataset.label}</span><span>Â¥${Math.round(currentPrice).toLocaleString()}</span>`;
    }

    function recalcTotal() {
        let total = 0; const boxes = stackContainer.querySelectorAll('.cost-box');
        boxes.forEach(box => { recalcSingleBox(box); total += parseFloat(box.dataset.currentPrice); });
        let displayTotal = isTaxIncluded ? Math.round(total * TAX_RATE) : total;
        document.getElementById('tax-label').innerText = isTaxIncluded ? "ç¨è¾¼åˆè¨ˆ" : "ç¨æŠœåˆè¨ˆ";
        document.getElementById('total-price').innerText = displayTotal.toLocaleString();
    }

    // --- ç©ã¿æœ¨ã®å†…è¨³ãƒ»å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ« ---
    function openStackDetailModal(box) {
        currentActiveStackBox = box;
        const label = box.dataset.label;
        const typeId = box.dataset.typeId;
        const unitPrice = parseFloat(box.dataset.unitPrice);
        const currentPrice = parseFloat(box.dataset.currentPrice);

        let formulaText = "å›ºå®šé‡‘é¡ï¼ˆä¸€å¼ï¼‰";
        if (typeId !== 'fixed') {
            const variable = siteVariables.find(v => v.id === typeId);
            if (variable) {
                const unitMatch = variable.label.match(/\((.*?)\)/);
                const unitStr = unitMatch ? unitMatch[1] : '';
                formulaText = `å˜ä¾¡ ${unitPrice.toLocaleString()}å†† Ã— ${variable.val} ${unitStr}`;
            }
        }

        document.getElementById('detail-title').innerText = label;
        document.getElementById('detail-formula').innerText = formulaText;
        document.getElementById('detail-price').innerText = `è¨ˆ: Â¥${Math.round(currentPrice).toLocaleString()}`;
        
        document.getElementById('stackDetailModal').style.display = 'flex';
    }

    function closeStackDetailModal() {
        document.getElementById('stackDetailModal').style.display = 'none';
        currentActiveStackBox = null;
    }

    function removeActiveStackBox() {
        if (currentActiveStackBox) {
            currentActiveStackBox.remove();
            recalcTotal();
            closeStackDetailModal();
        }
    }


    // --- âš™ï¸ è¨­å®šï¼ˆå»ºç‰©ãƒ‡ãƒ¼ã‚¿ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ« ---
    function openDataModal() {
        const list = document.getElementById('site-data-list'); list.innerHTML = '';
        siteVariables.forEach(v => {
            const div = document.createElement('div');
            const delBtn = `<button onclick="deleteVariable('${v.id}')" style="width:35px; flex-shrink:0; background:#fff5f5; color:#e74c3c; border:1px solid #e74c3c; font-size:16px; padding:0; box-shadow:none; border-radius:4px;" title="å‰Šé™¤">Ã—</button>`;
            div.className = 'form-group'; div.style.marginBottom = '0';
            div.innerHTML = `
                <label>${v.label}</label>
                <div style="display:flex; gap:5px;">
                    <input type="number" value="${v.val}" style="flex:1; min-width:0;" onchange="updateVariable('${v.id}', this.value)">
                    ${delBtn}
                </div>
            `;
            list.appendChild(div);
        });
        document.getElementById('dataModal').style.display = 'flex';
    }

    window.updateVariable = function(id, val) { const target = siteVariables.find(v => v.id === id); if (target) target.val = parseFloat(val); }
    window.addNewVariable = function() { const name = prompt("è¿½åŠ ã™ã‚‹é …ç›®åã‚’å…¥åŠ›\n(ä¾‹: ãƒ™ãƒ©ãƒ³ãƒ€, è¶³å ´ãªã©)"); if (!name) return; siteVariables.push({ id: 'custom_' + Date.now(), label: name, val: 0 }); openDataModal(); }
    window.deleteVariable = function(id) {
        if(confirm("ã“ã®åŸºæº–é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»æ—¢ã«ã“ã®é …ç›®ã‚’ä½¿ã£ã¦ã„ã‚‹éƒ¨æãŒã‚ã‚‹å ´åˆã€ãã®è¨ˆç®—ã¯ã€Œ0å††ã€ã«ãªã‚Šã¾ã™ã€‚")) {
            siteVariables = siteVariables.filter(v => v.id !== id); openDataModal();
        }
    }
    function saveDataModal() { document.getElementById('dataModal').style.display = 'none'; saveData(); recalcTotal(); }


    // --- ï¼‹ éƒ¨æè¿½åŠ ãƒ»ç·¨é›† ãƒ¢ãƒ¼ãƒ€ãƒ« ---
    function populateItemModalSelects() {
        const selectType = document.getElementById('m-type'); selectType.innerHTML = '<option value="fixed">å›ºå®šé‡‘é¡ (ä¸€å¼)</option>';
        const selectName = document.getElementById('m-name-preset'); selectName.innerHTML = '<option value="">å€™è£œã‹ã‚‰</option>';
        siteVariables.forEach(v => {
            const optType = document.createElement('option'); optType.value = v.id; optType.text = `Ã— ${v.label}`; selectType.appendChild(optType);
            const optName = document.createElement('option'); optName.value = v.label; optName.text = v.label; selectName.appendChild(optName);
        });
    }

    function openItemModal() {
        editingItemId = null;
        document.getElementById('item-modal-title').innerText = "éƒ¨æã‚«ã‚¿ãƒ­ã‚°è¿½åŠ ";
        document.getElementById('m-name').value = ''; document.getElementById('m-price').value = '';
        document.getElementById('modal-submit-btn').innerText = 'è¿½åŠ ';
        document.getElementById('modal-delete-btn').style.display = 'none'; // è¿½åŠ æ™‚ã¯ã‚´ãƒŸç®±ã‚’éš ã™
        
        populateItemModalSelects(); initColorSwatches('#95a5a6'); 
        document.getElementById('itemModal').style.display = 'flex';
    }

    window.openEditItemModal = function(id) {
        editingItemId = id;
        const item = paletteItems.find(i => i.id === id);
        if(!item) return;
        document.getElementById('item-modal-title').innerText = "éƒ¨æã®ç·¨é›†";
        document.getElementById('m-name').value = item.label; document.getElementById('m-price').value = item.unitPrice;
        populateItemModalSelects(); document.getElementById('m-type').value = item.typeId;
        initColorSwatches(item.color); 
        document.getElementById('modal-submit-btn').innerText = 'æ›´æ–°';
        document.getElementById('modal-delete-btn').style.display = 'block'; // ç·¨é›†æ™‚ã¯ã‚´ãƒŸç®±ã‚’è¡¨ç¤º
        
        document.getElementById('itemModal').style.display = 'flex';
    }

    window.applyPresetName = function() { const val = document.getElementById('m-name-preset').value; if (val) document.getElementById('m-name').value = val; }
    function closeItemModal() { document.getElementById('itemModal').style.display = 'none'; }
    
    // â˜…è¿½åŠ ï¼šéƒ¨æã®å‰Šé™¤å‡¦ç†
    window.deleteItemFromModal = function() {
        if(confirm("ã“ã®éƒ¨æã‚’ã‚«ã‚¿ãƒ­ã‚°ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã™ã§ã«ç©ã¿ä¸Šã’ãŸç®±ã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰")) {
            paletteItems = paletteItems.filter(i => i.id !== editingItemId);
            saveData(); renderPalette(); closeItemModal();
        }
    }

    window.saveItemFromModal = function() {
        const name = document.getElementById('m-name').value, type = document.getElementById('m-type').value, price = parseFloat(document.getElementById('m-price').value), color = document.getElementById('m-color-val').value;
        if (name && !isNaN(price)) {
            if (editingItemId) {
                const item = paletteItems.find(i => i.id === editingItemId);
                if (item) { item.label = name; item.typeId = type; item.unitPrice = price; item.color = color; }
            } else {
                paletteItems.push({ id: Date.now(), label: name, unitPrice: price, typeId: type, color: color });
            }
            saveData(); renderPalette(); closeItemModal();
        }
    }

    function resetStack() { if(confirm("ç©ã¿ä¸Šã’ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) { stackContainer.innerHTML = ''; recalcTotal(); } }
    function darkenColor(hex, percent) { let num = parseInt(hex.replace("#",""), 16), amt = Math.round(2.55 * percent), R = (num >> 16) - amt, B = (num >> 8 & 0x00FF) - amt, G = (num & 0x0000FF) - amt; return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (B<255?B<1?0:B:255)*0x100 + (G<255?G<1?0:G:255)).toString(16).slice(1); }
</script>
</body>
</html>
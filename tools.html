<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å ´ãƒ„ãƒ¼ãƒ« - è·äººã‚®ã‚¢</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192x192.png">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; padding-bottom: 80px; scroll-behavior: smooth; color: #333; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒŠãƒ“ */
        .site-header { background: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .site-title { margin: 0; font-size: 1.4rem; font-weight: bold; }
        .site-sub { font-size: 0.9rem; opacity: 0.8; margin-top: 5px; }
        .dashboard-nav { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; padding: 0 15px; position: sticky; top: 100px; z-index: 90; }
        .dash-btn { background: white; color: #555; border: 1px solid #ddd; padding: 10px 20px; border-radius: 30px; font-size: 0.9rem; font-weight: bold; text-decoration: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .dash-btn:active { transform: translateY(2px); box-shadow: none; }
        .dash-btn.rec { border-bottom: 4px solid #27ae60; color: #27ae60; }
        .dash-btn.sup { border-bottom: 4px solid #e67e22; color: #e67e22; }
        .dash-btn.man { border-bottom: 4px solid #2980b9; color: #2980b9; }
        
        /* ã‚³ãƒ³ãƒ†ãƒŠãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .container { max-width: 600px; margin: 0 auto; padding: 0 20px; }
        .section-header { font-size: 1.2rem; font-weight: bold; margin-top: 40px; margin-bottom: 15px; padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; scroll-margin-top: 140px; }
        .section-record { background-color: #e8f5e9; color: #2e7d32; border-left: 6px solid #2e7d32; }
        .section-support { background-color: #fff3e0; color: #e65100; border-left: 6px solid #e65100; }
        .section-manage { background-color: #e3f2fd; color: #1565c0; border-left: 6px solid #1565c0; }
        
        /* ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ */
        .tool-grid { display: grid; gap: 20px; padding-bottom: 20px; }
        .tool-btn { display: flex; align-items: center; justify-content: space-between; background: white; padding: 25px; border-radius: 16px; text-decoration: none; color: #333; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border: 2px solid transparent; transition: transform 0.1s; cursor: pointer; }
        .tool-grid.rec .tool-btn { border-color: #a5d6a7; }
        .tool-grid.sup .tool-btn { border-color: #ffcc80; }
        .tool-grid.man .tool-btn { border-color: #90caf9; }
        .tool-btn:active { transform: scale(0.98); background: #f9f9f9; }
        .btn-icon { font-size: 2.5rem; margin-right: 20px; width: 50px; text-align: center; }
        .btn-text h3 { margin: 0; font-size: 1.2rem; color: #333; }
        .btn-text p { margin: 5px 0 0; font-size: 0.85rem; color: #777; }

        /* æˆ»ã‚‹ãƒªãƒ³ã‚¯ */
        .back-link-area { margin-top:40px; display:flex; flex-direction:column; gap:10px; }
        .back-link { display: block; text-align: center; color: #888; text-decoration: none; padding: 15px; background: white; border-radius: 8px; border: 1px solid #eee; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; display: none; opacity: 0; transition: opacity 0.2s; }
        .overlay.show { display: block; opacity: 1; }
        .modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; padding: 24px; border-radius: 16px; z-index: 160; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; max-height: 90vh; overflow-y: auto; }
        .modal-box.show { display: block; }
        .btn-close { background-color: #95a5a6; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top:10px; }
        .save-btn { background-color: #2980b9; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; text-align: center; }
        
        /* ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #cameraModal { padding: 0; background: #000; color: white; overflow: hidden; height: 90vh; flex-direction: column; }
        #cameraModal.show { display: flex; }
        #cameraSetup { padding: 20px; background: #fff; color: #333; height: 100%; display: flex; flex-direction: column; overflow-y: auto; }
        .preview-canvas-wrapper { text-align: center; margin-bottom: 15px; background: #333; padding: 10px; border-radius: 8px; }
        #boardCanvas { max-width: 100%; height: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        #photoPreviewArea { display: none; position: relative; flex: 1; background: #000; overflow: hidden; justify-content: center; align-items: center; }
        #previewImage { max-width: 100%; max-height: 100%; object-fit: contain; }
        #overlayBoard { position: absolute; top: 20px; left: 20px; width: 200px; cursor: grab; z-index: 10; touch-action: none; } 
        .camera-controls-area { padding: 15px; background: #111; display: flex; justify-content: space-between; align-items: center; }
        .btn-cam-action { padding: 10px 20px; border-radius: 30px; font-weight: bold; cursor: pointer; border: none; }
        .btn-retake { background: #e74c3c; color: white; }
        .btn-save-photo { background: #00C853; color: white; font-size: 1.1rem; padding: 12px 30px; }
        .snap-controls { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 20; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 30px; }
        .snap-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5); width: 44px; height: 44px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .process-btns { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        /* å·¥ç¨‹ãƒœã‚¿ãƒ³ï¼šæ”¹è¡Œã‚’è¨±å¯ã—ã€æ–‡å­—ã‚µã‚¤ã‚ºã‚’å°‘ã—èª¿æ•´ */
        .proc-btn { 
            flex: 1; min-width: 70px; padding: 5px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å°‘ã—æ¸›ã‚‰ã™ */
            font-size: 0.9rem; line-height: 1.2; /* è¡Œé–“ã‚’è©°ã‚ã‚‹ */
            background: #f0f0f0; border: 1px solid #ccc; border-radius: 6px; 
            cursor: pointer; 
            white-space: normal; /* â˜…é‡è¦ï¼šã“ã“ã§æ”¹è¡Œã‚’è¨±å¯ */
            word-break: break-all; /* é•·ã„å˜èªã‚‚æŠ˜ã‚Šè¿”ã™ */
            color: #555; font-weight: bold; 
            position: relative; overflow: hidden; 
            display: flex; align-items: center; justify-content: center; text-align: center;
            height: 50px; /*é«˜ã•ã‚’æƒãˆã‚‹*/
        }
        .proc-btn.active { background: #2c3e50; color: white; border-color: #2c3e50; }
        
        .custom-btn-area { border-top: 1px dashed #ddd; padding-top: 15px; margin-top: 10px; }
        
        /* ä»»æ„ãƒœã‚¿ãƒ³ç”¨ã‚°ãƒªãƒƒãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .input-grid-cam { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 5px; }
        .cam-chip { 
            background: #f0f0f0; border: 1px solid #ccc; border-radius: 6px; 
            font-size: 0.8rem; height: 42px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; overflow: hidden; font-weight: bold; color: #555; 
            user-select: none; padding: 0 4px; text-align: center;
        }
        .cam-chip:active { transform: scale(0.96); }
        .cam-chip.active { background: #2c3e50; color: white; border-color: #2c3e50; } /* éƒ¨ä½ãƒ¢ãƒ¼ãƒ‰é¸æŠä¸­ */
        .cam-chip.mode-loc { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; } /* å ´æ‰€ãƒ¢ãƒ¼ãƒ‰ã®ãƒœã‚¿ãƒ³è‰² */
        .cam-chip.btn-switch { background: #34495e; color: white; border: none; font-size: 0.75rem; } /* åˆ‡æ›¿ãƒœã‚¿ãƒ³ */
        /* ã‚²ãƒ¼ã‚¸ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©ï¼ˆJSã§æ™‚é–“ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚CSSã‹ã‚‰ã¯transitionã‚’å‰Šé™¤ï¼‰ */
        .chip-bar { 
            position: absolute; bottom: 0; left: 0; 
            height: 4px; background: #f39c12; 
            width: 0%; 
            pointer-events: none; /* ã‚¿ãƒƒãƒ—ã®é‚ªé­”ã‚’ã—ãªã„ */
        }
        .pressing .chip-bar { width: 100%; transition: width 0.8s linear; }

        /* éšæ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆ3åˆ†å‰²ï¼‰ç”¨ */
        .cam-chip.split-btn {
            display: flex; padding: 0; overflow: hidden;
            background: #fff; border-color: #aaa;
        }
        .split-part {
            display: flex; align-items: center; justify-content: center;
            height: 100%; cursor: pointer; transition: 0.1s;
        }
        .split-minus, .split-plus {
            width: 25%; background: #eceff1; color: #555; font-weight: bold; font-size: 1.1rem;
        }
        .split-center {
            width: 50%; font-weight: bold; color: #2e7d32; border-left: 1px solid #ddd; border-right: 1px solid #ddd;
            font-size: 1rem;
        }
        .split-minus:active, .split-plus:active { background: #cfd8dc; }
        .split-center:active { background: #e8f5e9; }

        /* æ–¹ä½ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .slider-overlay {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 400px;
            background: rgba(44, 62, 80, 0.95);
            padding: 20px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 200; display: none; text-align: center;
            color: white; backdrop-filter: blur(5px);
        }
        .slider-overlay.show { display: block; animation: popUp 0.2s ease-out; }
        @keyframes popUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        
        .slider-label { font-size: 2.5rem; font-weight: bold; margin-bottom: 10px; color: #f39c12; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .slider-sub { font-size: 0.9rem; color: #bdc3c7; margin-bottom: 15px; }
        
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æœ¬ä½“ */
        input[type=range] {
            -webkit-appearance: none; 
            appearance: none; /* â˜…ã“ã‚Œã‚’è¿½åŠ ã™ã‚‹ã¨è­¦å‘ŠãŒæ¶ˆãˆã¾ã™ */
            width: 100%; height: 10px; border-radius: 5px; background: #555; outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 30px; height: 30px; border-radius: 50%; 
            background: #f39c12; cursor: pointer; border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* æ—¥å ±ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .rough-paper { background-color: #fff9c4; border: 2px dashed #dcdcdc; border-radius: 8px; padding: 15px; margin-top: 20px; position: relative; }
        .rough-textarea { width: 100%; height: 120px; background: transparent; border: none; outline: none; font-size: 1.1rem; line-height: 1.6; color: #444; font-family: "Yu Gothic", sans-serif; resize: none; }
        .mic-btn { background: #e74c3c; color: white; width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 1.5rem; position: absolute; bottom: 10px; right: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .mic-active { animation: pulse 1.5s infinite; background: #c0392b; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 100% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); } }
        
        /* å±¥æ­´ãƒªã‚¹ãƒˆ */
        .history-list { margin-top: 15px; max-height: 300px; overflow-y: auto; border-top: 1px solid #eee; padding-top: 10px; }
        .history-card { background: white; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .history-date { font-weight: bold; color: #2980b9; font-size: 0.85rem; }
        .history-content { font-size: 0.95rem; white-space: pre-wrap; color: #333; line-height: 1.5; margin-bottom: 10px; }
        .history-actions { display: flex; gap: 8px; }
        .btn-resend { flex: 1; background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; padding: 8px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-delete-hist { width: 60px; background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }

        /* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .edit-footer { display: flex; gap: 10px; margin-top: 20px; }
        .btn-del-single { width: 50px; background-color: #fff5f5; border: 1px solid #e74c3c; color: #e74c3c; border-radius: 8px; font-size: 1.2rem; cursor: pointer; }
        .cancel-btn { flex: 1; background-color: #e0e0e0; color: #333; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        label { margin-top: 15px; display: block; font-weight: bold; font-size: 0.95rem; color: #2c3e50; }
        input[type="text"], select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; background: #f9f9f9; }
        
        /* â˜…ä¿®æ­£ï¼šå…¥åŠ›æ¬„ã®å·¦å´ã«ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’é…ç½® */
    .input-wrapper { display: flex; align-items: center; margin-top: 5px; gap: 5px; }
    .btn-clear-left {
        width: 40px; height: 40px; border-radius: 6px; border: 1px solid #ccc;
        background: #ffebee; color: #c62828; font-weight: bold; font-size: 1.2rem;
        cursor: pointer; flex-shrink: 0;
    }
    .input-wrapper input { flex: 1; margin-top: 0; }

    /* â˜…è¿½åŠ ï¼šéšæ•°ãƒ»æ–¹ä½ã®é¸æŠçŠ¶æ…‹ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .cam-chip.target-floor.selected {
        background-color: #2196F3; color: white; border-color: #1976D2; /* é’ */
    }
    .cam-chip.target-dir.selected {
        background-color: #FFEB3B; color: #333; border-color: #FBC02D; /* é»„ */
    }
    /* æ“ä½œãƒœã‚¿ãƒ³ï¼ˆï¼‹ï¼ï¼‰ */
    .cam-chip.op-btn {
        background-color: #eceff1; color: #333; font-size: 1.4rem; font-weight: 900;
    }
    .cam-chip.op-btn:active { background-color: #cfd8dc; }
    /* ç‹¬ç«‹ã—ãŸæ“ä½œãƒœã‚¿ãƒ³ï¼ˆå¤§ããæŠ¼ã—ã‚„ã™ãï¼‰ */
    .cam-chip.control-btn {
        background: #eceff1; color: #333; font-size: 1.2rem;
    }
    .cam-chip.control-btn:active {
        background: #cfd8dc;
    }
    /* çœŸã‚“ä¸­ã®è¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆç›®ç«‹ãŸã›ã‚‹ï¼‰ */
    .cam-chip.display-btn {
        background: #fff; border: 2px solid #2e7d32; color: #2e7d32; font-size: 1.1rem;
    }
    </style>
</head>
<body>

<div class="site-header">
    <h2 class="site-title" id="displaySiteName">èª­ã¿è¾¼ã¿ä¸­...</h2>
    <div class="site-sub" id="displaySiteId">---</div>
</div>

<div class="dashboard-nav">
    <a href="#sec-record" class="dash-btn rec">ğŸ“ è¨˜éŒ²</a>
    <a href="#sec-support" class="dash-btn sup">ğŸ§° ã‚µãƒãƒ¼ãƒˆ</a>
    <a href="#sec-manage" class="dash-btn man">âš™ï¸ ç®¡ç†</a>
</div>

<div class="container">
    <div id="sec-record" class="section-header section-record">ğŸ“ è¨˜éŒ²ãƒ»å ±å‘Š</div>
    <div class="tool-grid rec">
        <div class="tool-btn" onclick="openCameraModal()">
            <div class="btn-icon">ğŸ“¸</div>
            <div class="btn-text"><h3>é›»å­é»’æ¿ã‚«ãƒ¡ãƒ©</h3><p>é«˜ç”»è³ªæ’®å½±ï¼†é»’æ¿åˆæˆ</p></div>
            <span style="font-size:1.5rem; color:#a5d6a7;">ï¼</span>
        </div>
        <div class="tool-btn" onclick="openModal('report')">
            <div class="btn-icon">ğŸ™ï¸</div>
            <div class="btn-text"><h3>ã—ã‚ƒã¹ã‚‹æ—¥å ±</h3><p>å£°ã§å…¥åŠ›ã€å±¥æ­´ã‹ã‚‰é€ä¿¡</p></div>
            <span style="font-size:1.5rem; color:#a5d6a7;">ï¼</span>
        </div>
    </div>

    <div id="sec-support" class="section-header section-support">ğŸ§° ç¾å ´ã‚µãƒãƒ¼ãƒˆ</div>
    <div class="tool-grid sup">
        <div class="tool-btn" onclick="searchSupply()">
            <div class="btn-icon">ğŸ›’</div>
            <div class="btn-text"><h3>è³‡æSOSãƒãƒƒãƒ—</h3><p>è¿‘ãã®ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼ã‚’æ¤œç´¢</p></div>
            <span style="font-size:1.5rem; color:#ffcc80;">ï¼</span>
        </div>
        <div class="tool-btn" onclick="handleCalendarAction()">
            <div class="btn-icon">ğŸ“…</div>
            <div class="btn-text"><h3>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²</h3><p>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ </p></div>
            <span style="font-size:1.5rem; color:#ffcc80;">â†—</span>
        </div>
    </div>

    <div id="sec-manage" class="section-header section-manage">âš™ï¸ æƒ…å ±ç®¡ç†</div>
    <div class="tool-grid man">
        <div class="tool-btn" onclick="openForm()">
            <div class="btn-icon">âœï¸</div>
            <div class="btn-text"><h3>æƒ…å ±ã®ç·¨é›†ãƒ»å‰Šé™¤</h3><p>ç¾å ´åã‚„ä½æ‰€ã®ä¿®æ­£</p></div>
            <span style="font-size:1.5rem; color:#90caf9;">ï¼</span>
        </div>
    </div>

    <div class="back-link-area">
        <a href="navi.html" class="back-link">â†©ï¸ ç¾å ´ä¸€è¦§ã«æˆ»ã‚‹</a>
        <div style="display:flex; gap:10px;">
            <a href="manager.html" class="back-link" style="flex:1; margin-top:0;">ğŸ“Š å·¥ç¨‹ç®¡ç†ã¸</a>
            <a href="index.html" class="back-link" style="flex:1; margin-top:0;">ğŸ” ã‚«ã‚¿ãƒ­ã‚°æ¤œç´¢ã¸</a>
        </div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="cameraModal" class="modal-box" style="width:100%; height:100%; max-width:none; border-radius:0; top:0; left:0; transform:none;">
    <div id="cameraSetup">
        <h3 style="text-align:center; margin-top:0;">é»’æ¿ã®æº–å‚™</h3>
        <div class="preview-canvas-wrapper"><canvas id="boardCanvas" width="400" height="300"></canvas></div>
        <label>ä¼šç¤¾å</label>
        <input type="text" id="companyName" placeholder="ä¼šç¤¾åã‚’å…¥åŠ›" oninput="drawBoard(); saveCameraSettings()">

        <label>å·¥ç¨‹ (å›ºå®š) <span style="font-size:0.8rem; font-weight:normal; color:#888;">(é•·æŠ¼ã—ã§ç·¨é›†)</span></label>
        <div class="process-btns"></div>
        
        <div class="custom-btn-area">
            <label style="margin-bottom:5px; display:block;">ä»»æ„ãƒœã‚¿ãƒ³ <span style="font-size:0.8rem; font-weight:normal; color:#888;">(é•·æŠ¼ã—ã§ç·¨é›†)</span></label>
            <div id="customBtnGroup" class="input-grid-cam"></div>
        </div>
        
        <label>æ–½å·¥ç®‡æ‰€</label>
        <div class="input-wrapper">
            <button class="btn-clear-left" onclick="clearLocation()">Ã—</button>
            <input type="text" id="photoDetail" placeholder="ä¾‹ï¼šåŒ—é¢ã€è»’å¤©ãªã©" oninput="drawBoard()">
        </div>
    </div>
    <div id="photoPreviewArea">
        <img id="previewImage" src="" alt="æ’®å½±å†™çœŸ">
        <img id="overlayBoard" src="" alt="é»’æ¿">
        <div class="snap-controls">
            <button class="snap-btn" onclick="snapBoard('tl')">â†–ï¸</button>
            <button class="snap-btn" onclick="snapBoard('tr')">â†—ï¸</button>
            <button class="snap-btn" onclick="snapBoard('bl')">â†™ï¸</button>
            <button class="snap-btn" onclick="snapBoard('br')">â†˜ï¸</button>
        </div>
        <div class="camera-controls-area" style="position:absolute; bottom:0; width:100%;">
            <button class="btn-cam-action btn-retake" onclick="retakePhoto()">ã‚„ã‚Šç›´ã™</button>
            <button class="btn-cam-action btn-save-photo" onclick="saveCompositePhoto()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>
        <div style="margin-top:auto; padding-top:20px; display:flex; gap:10px;">
            <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
            
            <input type="file" id="nativeCameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handlePhotoSelect(this)">
            
            <button class="save-btn" onclick="document.getElementById('nativeCameraInput').click()" style="background:#00C853; font-size:1.1rem;">ğŸ“¸ æ¨™æº–ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
        </div>
</div>

<div id="reportModal" class="modal-box" style="background:#fffcf0;">
    <h3>ğŸ™ï¸ ã‹ã‚“ãŸã‚“æ—¥å ±</h3>
    <div class="rough-paper">
        <textarea id="reportText" class="rough-textarea" placeholder="å†…å®¹ã‚’å…¥åŠ›..."></textarea>
        <button class="mic-btn" id="micBtn" onclick="toggleSpeech()">ğŸ¤</button>
    </div>
    
    <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
        <button class="save-btn" onclick="saveReportLocal()" style="background:#f39c12; font-size:1rem;">ğŸ’¾ ã¾ãšã¯å±¥æ­´ã«æ®‹ã™</button>
        <div style="display:flex; gap:5px;">
            <button class="save-btn" onclick="sendReportLine()" style="flex:1; background:#00C300; font-size:0.8rem;">LINE</button>
            <button class="save-btn" onclick="sendReportMail()" style="flex:1; background:#007bff; font-size:0.8rem;">ãƒ¡ãƒ¼ãƒ«</button>
        </div>
    </div>

    <div style="margin-top:15px;">
        <label style="margin:0; font-size:0.85rem; border-bottom:2px solid #ddd; padding-bottom:5px;">ğŸ“œ å±¥æ­´ (ã“ã®ç¾å ´ã®ã¿)</label>
        <div id="reportHistoryList" class="history-list"></div>
    </div>
    
    <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
</div>

<div id="calSelectModal" class="modal-box" style="text-align:center;">
    <h3>ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½</h3>
    <p style="font-size:0.9rem; color:#666;">æ“ä½œã‚’é¸ã‚“ã§ãã ã•ã„</p>
    <div style="display:flex; flex-direction:column; gap:15px; margin-top:20px;">
        <button class="save-btn" onclick="registerSharedCalendar()" style="background:#9b59b6;">ğŸ¢ å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²<br><span style="font-size:0.8rem; opacity:0.9;">(ã“ã®ç¾å ´ã®äºˆå®šã‚’å…±æœ‰)</span></button>
        <button class="save-btn" onclick="openPersonalCalendar()" style="background:#fff; color:#333; border:1px solid #ccc;">ğŸ‘¤ Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‹ã<br><span style="font-size:0.8rem; color:#666;">(å€‹äººã®äºˆå®šãƒ»æ­¯åŒ»è€…ãªã©)</span></button>
    </div>
    <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
</div>

<div id="inputForm" class="modal-box">
    <h3 style="margin-top:0; text-align:center;">æƒ…å ±ã®ç·¨é›†ãƒ»å‰Šé™¤</h3>
    <label>ç¾å ´å</label><input type="text" id="siteName">
    <label>ä½æ‰€</label><input type="text" id="address">
    <label>çŠ¶æ³</label>
    <select id="status">
        <option value="estimate">ğŸ“„ è¦‹ç©ä¸­</option>
        <option value="contract">ğŸ¤ å¥‘ç´„æ¸ˆã¿</option>
        <option value="billing">ğŸ’° è«‹æ±‚</option>
        <option value="complete">âœ… å®Œäº†</option>
        <option value="lost">âŒ å¤±æ³¨</option>
    </select>
    <div class="edit-footer">
        <button class="btn-del-single" onclick="deleteSite()">ğŸ—‘ï¸</button>
        <button class="cancel-btn" onclick="copySite()" style="background-color:#8e44ad; color:white;">ã‚³ãƒ”ãƒ¼ä½œæˆ</button>
        <button class="save-btn" onclick="saveEdit()">æ›´æ–°ã™ã‚‹</button>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const siteId = params.get('id');
    let currentSite = null;
    let sites = JSON.parse(localStorage.getItem('dx_sites')) || [];
    
    // --- å¤‰æ•°å®šç¾©ã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æœ€åˆã®æ–¹ï¼‰ ---
    
    // ç¾åœ¨é¸æŠä¸­ã®å·¥ç¨‹ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼‰
    let currentProcess = 'æ–½å·¥å‰';

    // â˜…è¿½åŠ ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å·¥ç¨‹ãƒªã‚¹ãƒˆ
    const DEFAULT_PROCESSES = ["æ–½å·¥å‰", "ä¸‹å¡—ã‚Š", "ä¸­å¡—ã‚Š", "ä¸Šå¡—ã‚Š", "å®Œäº†"];
    
    // å±¥æ­´èª­ã¿è¾¼ã¿
    let reportHistory;
    try { reportHistory = JSON.parse(localStorage.getItem('dx_reports')); } catch(e) { reportHistory = {}; }
    if (!reportHistory || Array.isArray(reportHistory) || typeof reportHistory !== 'object') { reportHistory = {}; }

    // ç¾å ´ç‰¹å®š
    if (siteId) {
        currentSite = sites.find(s => s.id === siteId);
        if (currentSite) {
            document.getElementById('displaySiteName').textContent = currentSite.name;
            document.getElementById('displaySiteId').textContent = `No. ${currentSite.id}`;
        } else { document.getElementById('displaySiteName').textContent = "ç¾å ´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; }
    } else {
        document.getElementById('displaySiteName').textContent = "ç¾å ´æœªé¸æŠ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼)";
    }

    window.onload = () => {
        // ä¼šç¤¾åã®èª­ã¿è¾¼ã¿
        const savedComp = localStorage.getItem('dx_company_name');
        document.getElementById('companyName').value = savedComp ? savedComp : "ãƒšã‚¤ãƒ³ãƒˆãƒã‚¦ã‚¹";

        // â˜…è¿½åŠ ï¼šå·¥ç¨‹ãƒœã‚¿ãƒ³ï¼ˆç·¨é›†å¯èƒ½ç‰ˆï¼‰ã‚’ç”Ÿæˆ
        renderProcessButtons(); 
        
        // ä»»æ„ãƒœã‚¿ãƒ³ï¼ˆéšæ•°ãƒ»æ–¹ä½ï¼‰ã‚’ç”Ÿæˆ
        renderCameraButtons(); 
        
        // é»’æ¿æç”»ã¨å±¥æ­´èª­ã¿è¾¼ã¿
        if(document.getElementById('boardCanvas')) drawBoard(); 
        if(siteId) renderReportHistory();
    };

    
    function saveCameraSettings() {
        const val = document.getElementById('companyName').value;
        localStorage.setItem('dx_company_name', val);
    }

    function openModal(type) { 
        document.getElementById('overlay').classList.add('show'); 
        if(type === 'camera') openCameraModal(); 
        if(type === 'report') { document.getElementById('reportModal').classList.add('show'); renderReportHistory(); } 
        if(type === 'calSelect') { document.getElementById('calSelectModal').classList.add('show'); }
    }
    function openCameraModal() { document.getElementById('overlay').classList.add('show'); document.getElementById('cameraModal').classList.add('show'); drawBoard(); }
    function openForm() { document.getElementById('overlay').classList.add('show'); document.getElementById('inputForm').classList.add('show'); document.getElementById('siteName').value = currentSite ? currentSite.name : ''; document.getElementById('address').value = currentSite ? currentSite.address : ''; document.getElementById('status').value = currentSite ? currentSite.status : 'estimate'; }
    function closeAllModals() { document.querySelectorAll('.modal-box').forEach(el => el.classList.remove('show')); document.getElementById('overlay').classList.remove('show'); stopSpeech(); if(document.getElementById('photoPreviewArea').style.display==='flex') retakePhoto(); }

    /* --- æ—¥å ±æ©Ÿèƒ½ --- */
    function saveReportLocal() { 
        const text = document.getElementById('reportText').value; 
        if(!text) { alert('æ—¥å ±ã®å†…å®¹ãŒç©ºã§ã™'); return; }
        const targetId = siteId || 'preview';
        if (!reportHistory[targetId]) { reportHistory[targetId] = []; } 
        const now = new Date();
        reportHistory[targetId].unshift({ 
            date: now.toLocaleString(), 
            timestamp: now.getTime(),   
            content: text,
            submitted: false            
        }); 
        localStorage.setItem('dx_reports', JSON.stringify(reportHistory)); 
        renderReportHistory(); 
        document.getElementById('reportText').value = ''; 
        alert('å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ'); 
    }
    
    function renderReportHistory() { 
        const listEl = document.getElementById('reportHistoryList'); 
        listEl.innerHTML = ''; 
        const targetId = siteId || 'preview';
        if (!reportHistory[targetId] || reportHistory[targetId].length === 0) { listEl.innerHTML = '<div style="color:#777; font-size:0.8rem; text-align:center; padding:10px;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; } 
        reportHistory[targetId].forEach((item, index) => { 
            let btnText = "ğŸ“¤ ã‚¯ãƒ©ã‚¦ãƒ‰ã¸æå‡º"; let btnStyle = "";
            if (item.submitted) { btnText = "âœ… æå‡ºæ¸ˆã¿"; btnStyle = "background: #27ae60 !important; color: white !important; border-color: #27ae60 !important; cursor: default;"; }
            const html = `<div class="history-card"><div class="history-header"><span class="history-date">ğŸ“… ${item.date}</span></div><div class="history-content">${item.content}</div><div class="history-actions"><button class="btn-resend" style="${btnStyle}" onclick="resendReport(${index})">${btnText}</button><button class="btn-delete-hist" onclick="deleteReport(${index})">å‰Šé™¤</button></div></div>`;
            listEl.insertAdjacentHTML('beforeend', html); 
        }); 
    }

    async function resendReport(index) {
        const targetId = siteId || 'preview';
        const item = reportHistory[targetId][index];
        if (!item) return;
        if (item.submitted) { if(!confirm("âœ… æ—¢ã«æå‡ºæ¸ˆã¿ã§ã™ã€‚\nãã‚Œã§ã‚‚å†é€ã—ã¾ã™ã‹ï¼Ÿ")) return; } else { if (!confirm(`ğŸ“… ${item.date} ã®æ—¥å ±ã¨ã—ã¦\nã‚¯ãƒ©ã‚¦ãƒ‰ã«æå‡ºã—ã¾ã™ã‹ï¼Ÿ`)) return; }
        const gasUrl = localStorage.getItem('dx_gas_url');
        if (!gasUrl) { alert("ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘\nãƒŠãƒ“ç”»é¢ã®è¨­å®šã‹ã‚‰ã€ŒGAS URLã€ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚"); return; }
        const reporterName = localStorage.getItem('dx_reporter_name') || "è·äºº";
        const btn = event.target; const originalText = btn.innerHTML; btn.innerHTML = "â³ é€ä¿¡ä¸­..."; btn.disabled = true;
        const sendData = { type: "report", id: currentSite ? currentSite.id : "", siteName: currentSite ? currentSite.name : "æœªå®š", address: currentSite ? currentSite.address : "", reporter: reporterName, content: item.content, timestamp: item.timestamp || new Date(item.date).getTime() };
        try {
            const response = await fetch(gasUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(sendData) });
            const resText = await response.text(); const resJson = JSON.parse(resText);
            if (resJson.result === "success") { alert("âœ… æå‡ºå®Œäº†ï¼"); reportHistory[targetId][index].submitted = true; localStorage.setItem('dx_reports', JSON.stringify(reportHistory)); renderReportHistory(); } else { throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼"); }
        } catch(e) { alert("é€ä¿¡å¤±æ•—: " + e); btn.innerHTML = originalText; btn.disabled = false; }
    }

    function deleteReport(index) {
        if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const targetId = siteId || 'preview';
        reportHistory[targetId].splice(index, 1);
        localStorage.setItem('dx_reports', JSON.stringify(reportHistory));
        renderReportHistory();
    }

    /* --- ãã®ä»–ãƒ„ãƒ¼ãƒ« --- */
    function handleCalendarAction() { const calId = localStorage.getItem('dx_calendar_id'); if (calId && calId.trim() !== "") openModal('calSelect'); else openPersonalCalendar(); }
    function openPersonalCalendar() { let stLabel = 'ç¾èª¿äºˆå®š'; if(currentSite && (currentSite.status === 'contract' || currentSite.status === 'active')) stLabel = 'æ–½å·¥ä¸­'; const text = encodeURIComponent(`ã€${stLabel}ã€‘${currentSite?currentSite.name:''}`); const location = encodeURIComponent(currentSite?currentSite.address:''); const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&location=${location}`; window.open(url, '_blank'); closeAllModals(); }
    function registerSharedCalendar() {
        if (!currentSite) return;
        const today = new Date().toISOString().split('T')[0];
        const targetDate = currentSite.start || today;
        const targetEndDate = currentSite.end || targetDate; 
        const dateMsg = currentSite.start ? `æœŸé–“: ${targetDate} ã€œ ${targetEndDate}` : `æ—¥ä»˜: ${targetDate} (æœ¬æ—¥)`;
        if(!confirm(`å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\n${dateMsg}\nç¾å ´: ${currentSite.name}`)) return;
        const calId = localStorage.getItem('dx_calendar_id');
        const gasUrl = localStorage.getItem('dx_gas_url');
        if(!gasUrl) { alert("GAS URLè¨­å®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒŠãƒ“ç”»é¢ã®è¨­å®šã‹ã‚‰å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
        if(!calId) { alert("å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å€‹äººã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"); return; }
        const data = { type: "calendar", calendarId: calId, id: currentSite.id, title: `ã€${getStatusLabel(currentSite.status)}ã€‘${currentSite.name}`, description: `ä½æ‰€: ${currentSite.address}\nçŠ¶æ³: ${getStatusLabel(currentSite.status)}\næ¡ˆä»¶No: ${currentSite.id}`, address: currentSite.address, status: currentSite.status, date: targetDate, start: targetDate, startDate: targetDate, end: targetEndDate, endDate: targetEndDate, startTime: targetDate, endTime: targetEndDate };
        fetch(gasUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(data) }).then(response => response.text()).then(text => { try { const res = JSON.parse(text); if(res.result === 'success') { alert("âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã—ã¾ã—ãŸï¼"); } else { alert("âš ï¸ ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + (res.error || "GASå´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")); } } catch(e) { console.error(text); alert("âš ï¸ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™ã€‚\nï¼ˆå·¥æœŸæœªå…¥åŠ›ãªã©ãŒåŸå› ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ä»Šæ—¥ã®æ—¥ä»˜ã§é€ä¿¡ã—ã¾ã—ãŸï¼‰"); } }).catch(err => { alert("é€šä¿¡å¤±æ•—: " + err); });
    }
    function getStatusLabel(st) { const map = { 'estimate':'è¦‹ç©', 'contract':'æ–½å·¥', 'billing':'è«‹æ±‚', 'complete':'å®Œäº†', 'lost':'å¤±æ³¨' }; return map[st] || 'äºˆå®š'; }

    /* ã‚«ãƒ¡ãƒ©ãƒ»é»’æ¿å‡¦ç† */
    const canvas = document.getElementById('boardCanvas'), ctx = canvas ? canvas.getContext('2d') : null;
    function setProcess(btn, text) { if (btn.classList.contains('active')) { btn.classList.remove('active'); currentProcess = ''; } else { document.querySelectorAll('.proc-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentProcess = text; } drawBoard(); }
    
    // â˜…ä¿®æ­£ç‰ˆï¼šé»’æ¿æç”»ï¼ˆãƒ¡ã‚¤ãƒªã‚ªå¯¾å¿œãƒ»é«˜ç”»è³ªãƒ•ã‚©ãƒ³ãƒˆæŒ‡å®šç‰ˆï¼‰
    function drawBoard() {
        if(!canvas) return;
        
        // ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        const siteName = currentSite ? currentSite.name : "ï¼ˆç¾å ´åæœªå®šï¼‰";
        const company = document.getElementById('companyName').value || "";
        const location = document.getElementById('photoDetail').value || "";
        const process = currentProcess || "ï¼ˆé¸æŠãªã—ï¼‰";
        const d = new Date();
        const dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;

        // â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šè¦‹ã‚„ã™ã„ãƒ•ã‚©ãƒ³ãƒˆã®å„ªå…ˆé †ä½ãƒªã‚¹ãƒˆ
        // 1. UDãƒ‡ã‚¸ã‚¿ãƒ«æ•™ç§‘æ›¸ä½“ï¼ˆWindows10ä»¥é™ã«ã‚ã‚‹ã€é»’æ¿ã«æœ€é©ã§è¦‹ã‚„ã™ã„ãƒ•ã‚©ãƒ³ãƒˆï¼‰
        // 2. ãƒ¡ã‚¤ãƒªã‚ª (Windowsã®å®šç•ª)
        // 3. ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ (iPhone/Macã®å®šç•ª)
        // 4. sans-serif (ãã®ä»–ã®æ¨™æº–)
        const fontFamily = '"Yu Gothic","Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif';

        // èƒŒæ™¯ã¨æ ç·š
        ctx.fillStyle = '#004d40'; ctx.fillRect(0, 0, canvas.width, canvas.height); 
        ctx.strokeStyle = 'white'; ctx.lineWidth = 5; ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
        
        // ä»•åˆ‡ã‚Šç·š
        ctx.lineWidth = 2; 
        ctx.beginPath(); 
        ctx.moveTo(10, 80); ctx.lineTo(390, 80); 
        ctx.moveTo(10, 150); ctx.lineTo(390, 150); 
        ctx.stroke();

        // å…±é€šè¨­å®š
        ctx.fillStyle = 'white'; 
        ctx.textAlign = 'left'; 
        ctx.textBaseline = 'middle'; 
        const maxWidth = 340; 

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼šè¡Œåˆ†å‰²è¨ˆç®— ---
        const getLines = (ctx, text, max) => {
            let words = text.split(''); 
            let lines = []; 
            let currentLine = words[0] || "";
            for (let i = 1; i < words.length; i++) {
                let char = words[i];
                if (ctx.measureText(currentLine + char).width < max) {
                    currentLine += char;
                } else {
                    lines.push(currentLine);
                    currentLine = char;
                }
            }
            lines.push(currentLine); 
            return lines;
        };

        // ==========================================
        // 1. å·¥äº‹å
        // ==========================================
        // â˜…ä¿®æ­£ï¼šãƒ•ã‚©ãƒ³ãƒˆæŒ‡å®šã« fontFamily å¤‰æ•°ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´
        ctx.font = `bold 20px ${fontFamily}`; ctx.fillText("å·¥äº‹å", 20, 23);
        
        let siteFontSize = 24;
        ctx.font = `bold ${siteFontSize}px ${fontFamily}`; // â˜…ä¿®æ­£
        let siteLines = getLines(ctx, siteName, maxWidth);

        if (siteLines.length > 1) {
            siteFontSize = 16; 
            ctx.font = `bold ${siteFontSize}px ${fontFamily}`; // â˜…ä¿®æ­£
            siteLines = getLines(ctx, siteName, maxWidth);
            if(siteLines.length > 2) { siteLines = siteLines.slice(0, 2); siteLines[1] = siteLines[1].substring(0, siteLines[1].length - 1) + "â€¦"; }
        }

        if (siteLines.length === 1) {
            ctx.fillText(siteLines[0], 20, 55);
        } else {
            ctx.fillText(siteLines[0], 20, 48);
            ctx.fillText(siteLines[1], 20, 68);
        }

        // ==========================================
        // 2. å·¥ç¨® / æ–½å·¥å†…å®¹
        // ==========================================
        ctx.font = `bold 20px ${fontFamily}`; ctx.fillText("å·¥ç¨® / æ–½å·¥å†…å®¹", 20, 95);

        let procFontSize = 26;
        ctx.font = `bold ${procFontSize}px ${fontFamily}`; // â˜…ä¿®æ­£
        let procLines = getLines(ctx, process, maxWidth);

        if (procLines.length > 1) {
            procFontSize = 18; 
            ctx.font = `bold ${procFontSize}px ${fontFamily}`; // â˜…ä¿®æ­£
            procLines = getLines(ctx, process, maxWidth);
            if(procLines.length > 2) { procLines = procLines.slice(0, 2); procLines[1] = procLines[1].substring(0, procLines[1].length - 1) + "â€¦"; }
        }

        if (procLines.length === 1) {
            ctx.fillText(procLines[0], 40, 125);
        } else {
            ctx.fillText(procLines[0], 40, 118);
            ctx.fillText(procLines[1], 40, 138);
        }

        // ==========================================
        // 3. æ–½å·¥ç®‡æ‰€
        // ==========================================
        ctx.font = `bold 20px ${fontFamily}`; ctx.fillText("æ–½å·¥ç®‡æ‰€", 20, 168);

        let locFontSize = 24;
        ctx.font = `bold ${locFontSize}px ${fontFamily}`; // â˜…ä¿®æ­£
        let locLines = getLines(ctx, location, maxWidth);

        if (locLines.length > 2) {
            locFontSize = 20; 
            ctx.font = `bold ${locFontSize}px ${fontFamily}`; // â˜…ä¿®æ­£
            locLines = getLines(ctx, location, maxWidth);
        }
        if (locLines.length > 3) {
            locFontSize = 17; 
            ctx.font = `bold ${locFontSize}px ${fontFamily}`; // â˜…ä¿®æ­£
            locLines = getLines(ctx, location, maxWidth);
            if(locLines.length > 3) { locLines = locLines.slice(0, 3); locLines[2] = locLines[2].substring(0, locLines[2].length - 1) + "â€¦"; }
        }

        const locX = 40;
        if (locLines.length === 1) {
            ctx.fillText(locLines[0], locX, 210);
        } else if (locLines.length === 2) {
            ctx.fillText(locLines[0], locX, 200);
            ctx.fillText(locLines[1], locX, 228);
        } else {
            ctx.fillText(locLines[0], locX, 195);
            ctx.fillText(locLines[1], locX, 215);
            ctx.fillText(locLines[2], locX, 235);
        }

        // ==========================================
        // 4. ãƒ•ãƒƒã‚¿ãƒ¼
        // ==========================================
        ctx.textAlign = 'right'; ctx.font = `bold 24px ${fontFamily}`; ctx.fillText(dateStr, 380, 270); 
        ctx.textAlign = 'left'; ctx.font = `16px ${fontFamily}`; ctx.fillStyle = '#ccc'; ctx.fillText(company, 20, 270);
    }
    let photoFile = null;

    // â˜…ä¿®æ­£ç‰ˆï¼šå†™çœŸé¸æŠæ™‚ã®å‡¦ç†ï¼ˆé»’æ¿ç”»åƒã®ç”Ÿæˆæ¼ã‚Œã‚’ä¿®æ­£ï¼‰
    function handlePhotoSelect(input) {
        if (input.files && input.files[0]) {
            photoFile = input.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                // 1. æ’®å½±ã—ãŸå†™çœŸã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã‚»ãƒƒãƒˆ
                const previewImg = document.getElementById('previewImage');
                previewImg.src = e.target.result;

                // 2. â˜…é‡è¦ï¼šç¾åœ¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆé»’æ¿ï¼‰ã‚’ç”»åƒãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã—ã¦ã‚»ãƒƒãƒˆ
                // ã“ã‚ŒãŒãªã„ã¨é»’æ¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“
                drawBoard(); // å¿µã®ãŸã‚æœ€æ–°ã®çŠ¶æ…‹ã‚’æç”»
                const boardImg = document.getElementById('overlayBoard');
                const canvas = document.getElementById('boardCanvas');
                boardImg.src = canvas.toDataURL('image/png');

                // 3. ç”»é¢åˆ‡ã‚Šæ›¿ãˆï¼ˆè¨­å®šç”»é¢ã‚’éš ã—ã¦ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã‚’å‡ºã™ï¼‰
                document.getElementById('cameraSetup').style.display = 'none';
                document.getElementById('photoPreviewArea').style.display = 'flex';

                // 4. é»’æ¿ã®åˆæœŸä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå·¦ä¸Šã«é…ç½®ï¼‰
                boardImg.style.top = '20px';
                boardImg.style.left = '20px';
                boardImg.style.bottom = '';
                boardImg.style.right = '';
                
                // 5. ã‚¹ãƒãƒ›ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ããªãã™ã‚‹ï¼ˆæ“ä½œã—ã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
                document.body.style.overflow = 'hidden';
            };

            reader.readAsDataURL(photoFile);
        }
        // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
        input.value = '';
    }function retakePhoto() { document.getElementById('photoPreviewArea').style.display = 'none'; document.getElementById('cameraSetup').style.display = 'flex'; photoFile = null; }
    function saveCompositePhoto() { if(!photoFile) return; const pImg = document.getElementById('previewImage'), bImg = document.getElementById('overlayBoard'), c = document.createElement('canvas'); c.width = pImg.naturalWidth; c.height = pImg.naturalHeight; const cx = c.getContext('2d'); cx.drawImage(pImg, 0, 0); const pRect = pImg.getBoundingClientRect(), bRect = bImg.getBoundingClientRect(), s = pImg.naturalWidth / pRect.width; cx.drawImage(bImg, (bRect.left - pRect.left) * s, (bRect.top - pRect.top) * s, bRect.width * s, bRect.height * s); const link = document.createElement('a'); link.href = c.toDataURL('image/jpeg', 0.9); link.download = `${currentSite?currentSite.name:'ç¾å ´'}_${currentProcess}_${Date.now()}.jpg`; document.body.appendChild(link); link.click(); document.body.removeChild(link); retakePhoto(); closeAllModals(); }
    // â˜…ä¿®æ­£ç‰ˆï¼šé»’æ¿ã®é…ç½®åˆ¶å¾¡ï¼ˆå†™çœŸã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦å¸ç€ï¼†ç«¯åˆ‡ã‚Œé˜²æ­¢ï¼‰
    
    // é…ç½®ã®ãƒãƒ¼ã‚¸ãƒ³ï¼ˆç«¯ã‹ã‚‰ä½•ãƒ”ã‚¯ã‚»ãƒ«å†…å´ã«ã™ã‚‹ã‹ï¼‰
    // 30pxã‚ã‚Œã°ç™½æ ãŒåˆ‡ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“
    const BOARD_MARGIN = 30; 

    function snapBoard(pos) {
        const board = document.getElementById('overlayBoard');
        const pImg = document.getElementById('previewImage');
        const container = document.getElementById('photoPreviewArea');
        
        // å†™çœŸãŒå®Ÿéš›ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹é ˜åŸŸã‚’å–å¾—
        const pRect = pImg.getBoundingClientRect();
        const cRect = container.getBoundingClientRect();

        // ã‚³ãƒ³ãƒ†ãƒŠ(ç”»é¢å…¨ä½“)ã«å¯¾ã™ã‚‹å†™çœŸã®ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—
        // ã“ã‚Œã§ã€Œé»’å¸¯ã€ã®éƒ¨åˆ†ã‚’é™¤å¤–ã—ã¦ã€å†™çœŸã®å››éš…ã‚’ç‰¹å®šã§ãã¾ã™
        const offsetTop = pRect.top - cRect.top;
        const offsetLeft = pRect.left - cRect.left;
        const pWidth = pRect.width;
        const pHeight = pRect.height;
        const bWidth = board.offsetWidth;
        const bHeight = board.offsetHeight;

        // ã„ã£ãŸã‚“ãƒªã‚»ãƒƒãƒˆ
        board.style.top = ''; board.style.bottom = ''; 
        board.style.left = ''; board.style.right = '';

        // å†™çœŸã®å››éš…ã‚’åŸºæº–ã«é…ç½®ï¼ˆãƒãƒ¼ã‚¸ãƒ³ä»˜ãï¼‰
        if (pos === 'tl') { // å·¦ä¸Š
            board.style.top = (offsetTop + BOARD_MARGIN) + 'px';
            board.style.left = (offsetLeft + BOARD_MARGIN) + 'px';
        } 
        else if (pos === 'tr') { // å³ä¸Š
            board.style.top = (offsetTop + BOARD_MARGIN) + 'px';
            board.style.left = (offsetLeft + pWidth - bWidth - BOARD_MARGIN) + 'px';
        } 
        else if (pos === 'bl') { // å·¦ä¸‹
            board.style.top = (offsetTop + pHeight - bHeight - BOARD_MARGIN) + 'px';
            board.style.left = (offsetLeft + BOARD_MARGIN) + 'px';
        } 
        else if (pos === 'br') { // å³ä¸‹
            board.style.top = (offsetTop + pHeight - bHeight - BOARD_MARGIN) + 'px';
            board.style.left = (offsetLeft + pWidth - bWidth - BOARD_MARGIN) + 'px';
        }
    }

    // â˜…ä¿®æ­£ç‰ˆï¼šé»’æ¿ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œï¼ˆ10pxå˜ä½ã®ã‚°ãƒªãƒƒãƒ‰ã‚¹ãƒŠãƒƒãƒ—ç§»å‹•ï¼‰

    const overlayBoard = document.getElementById('overlayBoard'); 
    let isDragging = false, dragStartX, dragStartY, initialLeft, initialTop;
    const SNAP_SIZE = 10; // â˜…ã“ã“ãŒã€Œã‚«ã‚¯ã¤ãã€ã®å¹…ï¼ˆ10pxï¼‰

    // --- 1. ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ ---
    const handleDragStart = (e) => {
        isDragging = true;
        const s = window.getComputedStyle(overlayBoard);
        initialLeft = parseInt(s.left) || 0;
        initialTop = parseInt(s.top) || 0;
        
        if(e.touches) {
            dragStartX = e.touches[0].clientX;
            dragStartY = e.touches[0].clientY;
        } else {
            dragStartX = e.clientX;
            dragStartY = e.clientY;
        }

        // åº§æ¨™æŒ‡å®šã‚’çµ±ä¸€
        overlayBoard.style.bottom = ''; 
        overlayBoard.style.right = ''; 
        overlayBoard.style.left = initialLeft + 'px'; 
        overlayBoard.style.top = initialTop + 'px';
        
        // ç§»å‹•ä¸­ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚‹ï¼ˆã‚­ãƒ“ã‚­ãƒ“å‹•ã‹ã™ãŸã‚ï¼‰
        overlayBoard.style.transition = 'none';
        
        if(e.cancelable && e.type === 'touchstart') e.preventDefault();
    };

    // --- 2. ãƒ‰ãƒ©ãƒƒã‚°ä¸­ï¼ˆã‚«ã‚¯ã‚«ã‚¯å‹•ã‹ã™å‡¦ç†ï¼‰ ---
    const handleDragMove = (e) => {
        if (!isDragging) return;
        
        let clientX, clientY;
        if(e.touches) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }

        // ç§»å‹•é‡ã‚’è¨ˆç®—
        const rawDx = clientX - dragStartX;
        const rawDy = clientY - dragStartY;

        // â˜…ã“ã“ãŒé­”æ³•ã®è¨ˆç®—å¼
        // ç§»å‹•é‡ã‚’ 10 ã§å‰²ã£ã¦å››æ¨äº”å…¥ã—ã€ã¾ãŸ 10 ã‚’æ›ã‘ã‚‹
        // ã“ã‚Œã§ã€Œ12pxå‹•ã„ãŸã€â†’ã€Œ10pxã€ã€ã€Œ18pxå‹•ã„ãŸã€â†’ã€Œ20pxã€ã«å¤‰æ›ã•ã‚Œã¾ã™
        const snappedDx = Math.round(rawDx / SNAP_SIZE) * SNAP_SIZE;
        const snappedDy = Math.round(rawDy / SNAP_SIZE) * SNAP_SIZE;

        overlayBoard.style.left = `${initialLeft + snappedDx}px`;
        overlayBoard.style.top = `${initialTop + snappedDy}px`;

        if(e.cancelable) e.preventDefault();
    };

    // --- 3. ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº† ---
    const handleDragEnd = () => {
        isDragging = false;
        // æ‰‹å‹•ã§å‹•ã‹ã—ãŸã‚ã¨ã¯ã€è‡ªå‹•å¸ç€ï¼ˆ9åˆ†å‰²ï¼‰ã¯ã‚ãˆã¦OFFã«ã—ã¾ã™
        // ï¼ˆå¾®èª¿æ•´ã—ãŸã„ã¨ã„ã†æ„æ€ã‚’å°Šé‡ã™ã‚‹ãŸã‚ï¼‰
    };

    // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼ˆã‚¹ãƒãƒ› & PCä¸¡å¯¾å¿œï¼‰
    overlayBoard.addEventListener('touchstart', handleDragStart, {passive: false});
    overlayBoard.addEventListener('touchmove', handleDragMove, {passive: false});
    overlayBoard.addEventListener('touchend', handleDragEnd);

    overlayBoard.addEventListener('mousedown', handleDragStart);
    window.addEventListener('mousemove', handleDragMove); // ç”»é¢å¤–ã‚Œã¦ã‚‚è¿½å¾“ã™ã‚‹ã‚ˆã†ã«window
    window.addEventListener('mouseup', handleDragEnd);
    // --- â˜…ä»»æ„ãƒœã‚¿ãƒ³æ©Ÿèƒ½ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼†é•·æŠ¼ã—æ—©é€ã‚Šå¯¾å¿œç‰ˆï¼‰ ---
    
    const DX_CAM_PARTS = ["ã‚±ãƒ¬ãƒ³", "æ´—æµ„", "é¤Šç”Ÿ", "ã‚·ãƒ¼ãƒªãƒ³ã‚°", "è¶³å ´", "ãƒ‘ã‚¿ãƒ¼ãƒ³èª¿æ•´", "ä¸‹åœ°å‡¦ç†", "å¹ä»˜", "é‰„éƒ¨", "æœ¨éƒ¨", "ä»˜å¸¯éƒ¨"];
    const DX_CAM_LOCS  = ["ãƒ™ãƒ©ãƒ³ãƒ€", "å…±ç”¨å»Šä¸‹", "éšæ®µ", "å±‹ä¸Š", "ç„é–¢å»»ã‚Š", "ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹", "å¦»é¢", "è©³ç´°"];
    
    const DIRECTIONS = [
        "åŒ—é¢", "åŒ—åŒ—æ±é¢", "åŒ—æ±é¢", "æ±åŒ—æ±é¢", 
        "æ±é¢", "æ±å—æ±é¢", "å—æ±é¢", "å—å—æ±é¢", 
        "å—é¢", "å—å—è¥¿é¢", "å—è¥¿é¢", "è¥¿å—è¥¿é¢", 
        "è¥¿é¢", "è¥¿åŒ—è¥¿é¢", "åŒ—è¥¿é¢", "åŒ—åŒ—è¥¿é¢"
    ];

    let isCamLocationMode = false; 
    let btnPressTimer = null; // é»’æ¿å…¥åŠ›ãƒœã‚¿ãƒ³ã®é•·æŠ¼ã—ç”¨
    let rapidFireTimer = null; // å·¦å³ãƒœã‚¿ãƒ³ã®é€£æ‰“ç”¨

    let currentFloorLevel = 1; 
    let currentDirIndex = 0; 
    // ...æ—¢å­˜ã®å¤‰æ•°å®šç¾©ã®ä¸‹ã‚ãŸã‚Šã«è¿½åŠ ...
    let editTarget = 'floor'; // æ“ä½œå¯¾è±¡: 'floor' ã¾ãŸã¯ 'dir'

    if(localStorage.getItem('dx_last_floor')) currentFloorLevel = parseInt(localStorage.getItem('dx_last_floor'));
    if(localStorage.getItem('dx_last_dir')) currentDirIndex = parseInt(localStorage.getItem('dx_last_dir'));

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”¨ã®HTMLã‚’JSã§ç”Ÿæˆã—ã¦åŸ‹ã‚è¾¼ã‚€
    document.addEventListener('DOMContentLoaded', () => {
        // ã™ã§ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒã‚ã‚Œã°ä½œã‚‰ãªã„ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        if(document.getElementById('dirSliderOverlay')) return;

        const sliderHTML = `
            <div id="dirSliderOverlay" class="slider-overlay">
                <div class="slider-sub">æŒ‡ã‚’ã‚¹ãƒ©ã‚¤ãƒ‰ã—ã¦æ–¹ä½ã‚’æ±ºå®š</div>
                <div id="dirSliderLabel" class="slider-label">åŒ—</div>
                <input type="range" id="dirRange" min="0" max="15" value="0" step="1">
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', sliderHTML);
        
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆ
        const range = document.getElementById('dirRange');
        range.addEventListener('input', (e) => {
            const idx = parseInt(e.target.value);
            document.getElementById('dirSliderLabel').innerText = DIRECTIONS[idx];
            currentDirIndex = idx;
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒœã‚¿ãƒ³ã®æ–‡å­—ã‚‚æ›´æ–°
            const centerBtn = document.getElementById('dirCenterBtn');
            if(centerBtn) {
                centerBtn.innerText = DIRECTIONS[idx];
                if(DIRECTIONS[idx].length>=3) centerBtn.style.fontSize='0.85rem'; else centerBtn.style.fontSize='';
            }
        });
        range.addEventListener('change', () => {
            // æŒ‡ã‚’é›¢ã—ãŸã‚‰ç¢ºå®šã—ã¦é–‰ã˜ã‚‹
            localStorage.setItem('dx_last_dir', currentDirIndex);
            document.getElementById('dirSliderOverlay').classList.remove('show');
            renderCameraButtons(); // å¿µã®ãŸã‚å†æç”»
        });
    });

    function getCamItems(mode) {
        const key = mode ? 'dx_cam_locs' : 'dx_cam_parts';
        const raw = localStorage.getItem(key);
        if (raw) return JSON.parse(raw);
        return mode ? [...DX_CAM_LOCS] : [...DX_CAM_PARTS];
    }
    
    function saveCamItems(mode, items) {
        const key = mode ? 'dx_cam_locs' : 'dx_cam_parts';
        localStorage.setItem(key, JSON.stringify(items));
    }

    // --- â˜…ä¿®æ­£ç‰ˆï¼šéšæ•°ãƒ»æ–¹ä½ æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ï¼ˆé‡è¤‡é˜²æ­¢ãƒ»é¸æŠæŒ™å‹•å¯¾å¿œï¼‰ ---
    
    function renderCameraButtons() {
        const group = document.getElementById('customBtnGroup');
        if(!group) return;
        group.innerHTML = '';

        // åˆ‡æ›¿ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹ï¼ˆå¾Œã§é…ç½®ï¼‰
        const switchBtn = document.createElement('div');
        switchBtn.className = 'cam-chip btn-switch';
        switchBtn.innerHTML = isCamLocationMode ? 'ğŸ”„ éƒ¨ä½ã¸' : 'ğŸ”„ å ´æ‰€ã¸';
        // é‡è¤‡é˜²æ­¢ã®ãŸã‚ onclick ã®ã¿ã‚’ä½¿ç”¨
        switchBtn.onclick = (e) => {
            e.preventDefault();
            isCamLocationMode = !isCamLocationMode;
            renderCameraButtons();
            if(navigator.vibrate) navigator.vibrate(50);
        };


        if (isCamLocationMode) {
            // --- å ´æ‰€ãƒ¢ãƒ¼ãƒ‰ï¼š1è¡Œç›®ï¼ˆ4ãƒã‚¹ï¼‰ã‚’æ“ä½œç›¤ã«ã™ã‚‹ ---
            
            // 1. [ 1F ] ãƒœã‚¿ãƒ³ï¼ˆéšæ•°ï¼‰
            const floorBtn = document.createElement('div');
            floorBtn.className = `cam-chip target-floor ${editTarget === 'floor' ? 'selected' : ''}`;
            floorBtn.innerText = currentFloorLevel + "F";
            // â˜…ä¿®æ­£ï¼šonclickã®ã¿ã§åˆ¶å¾¡ï¼ˆ1å›ç›®ï¼šé¸æŠã€2å›ç›®ï¼šå…¥åŠ›ï¼‰
            floorBtn.onclick = (e) => handleTargetClick('floor', currentFloorLevel + 'F', e);
            group.appendChild(floorBtn);

            // 2. [ åŒ— ] ãƒœã‚¿ãƒ³ï¼ˆæ–¹ä½ï¼‰
            const dirBtn = document.createElement('div');
            dirBtn.className = `cam-chip target-dir ${editTarget === 'dir' ? 'selected' : ''}`;
            dirBtn.innerText = DIRECTIONS[currentDirIndex];
            if(DIRECTIONS[currentDirIndex].length >= 3) dirBtn.style.fontSize = '0.8rem';
            
            // â˜…ä¿®æ­£ï¼šonclickã¨é•·æŠ¼ã—ã‚’æ˜ç¢ºã«åˆ†é›¢
            // ã‚¿ãƒƒãƒ—ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰æ™‚ã®å‡¦ç†
            dirBtn.onclick = (e) => {
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œå¾Œãªã©ã§ãªã‘ã‚Œã°ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
                if(!isSliderMode) handleTargetClick('dir', DIRECTIONS[currentDirIndex], e);
            };
            // é•·æŠ¼ã—ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼‰ç”¨ãƒªã‚¹ãƒŠãƒ¼
            dirBtn.addEventListener('touchstart', handleDirCenterStart, {passive: false});
            dirBtn.addEventListener('touchend', handleDirCenterEnd);
            dirBtn.addEventListener('mousedown', handleDirCenterStart);
            dirBtn.addEventListener('mouseup', handleDirCenterEnd);
            
            group.appendChild(dirBtn);

            // 3. [ ï¼ ] ãƒœã‚¿ãƒ³
            group.appendChild(createRepeatBtn('ï¼', -1));

            // 4. [ ï¼‹ ] ãƒœã‚¿ãƒ³
            group.appendChild(createRepeatBtn('ï¼‹', 1));

            // --- 2è¡Œç›®ä»¥é™ï¼šåˆ‡æ›¿ãƒœã‚¿ãƒ³ ï¼‹ é€šå¸¸ã‚¢ã‚¤ãƒ†ãƒ  ---
            group.appendChild(switchBtn); // 5å€‹ç›®ï¼ˆ2è¡Œç›®ã®å…ˆé ­ï¼‰ã«åˆ‡æ›¿ãƒœã‚¿ãƒ³

            const currentList = getCamItems(isCamLocationMode);
            // æ—¢ã«5æ ä½¿ã£ãŸã®ã§ã€æ®‹ã‚Šã‚’åŸ‹ã‚ã‚‹ï¼ˆæœ€å¤§11æ ã¾ã§ï¼‰
            const maxCount = 11; 

            for(let i=0; i < maxCount; i++) {
                const text = currentList[i] || 'ï¼ˆç©ºï¼‰';
                const btn = document.createElement('div');
                btn.className = 'cam-chip';
                if(isCamLocationMode) btn.classList.add('mode-loc');
                
                btn.innerHTML = `<span style="pointer-events:none;">${text}</span><div class="chip-bar"></div>`;
                setupCamBtnEvents(btn, i, text);
                group.appendChild(btn);
            }

        } else {
            // --- éƒ¨ä½ãƒ¢ãƒ¼ãƒ‰ï¼ˆé€šå¸¸é€šã‚Šï¼‰ ---
            group.appendChild(switchBtn);
            const currentList = getCamItems(isCamLocationMode);
            for(let i=0; i < 11; i++) {
                const text = currentList[i] || 'ï¼ˆç©ºï¼‰';
                const btn = document.createElement('div');
                btn.className = 'cam-chip';
                if(typeof currentProcess !== 'undefined' && currentProcess === text) btn.classList.add('active');
                
                btn.innerHTML = `<span style="pointer-events:none;">${text}</span><div class="chip-bar"></div>`;
                setupCamBtnEvents(btn, i, text);
                group.appendChild(btn);
            }
        }
    }

    // â˜…è¿½åŠ ï¼šé€£æ‰“ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function createRepeatBtn(label, delta) {
        const btn = document.createElement('div');
        btn.className = 'cam-chip op-btn';
        btn.innerText = label;
        
        // ã‚¹ãƒãƒ›ã§ã®é€£æ‰“ãƒ»PCã§ã®ã‚¯ãƒªãƒƒã‚¯ä¸¡å¯¾å¿œï¼ˆé‡è¤‡ç™ºç«é˜²æ­¢ï¼‰
        const start = (e) => { 
            if(e.cancelable) e.preventDefault(); // ã“ã‚Œã§ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§ãªã©ã‚’é˜²æ­¢
            startRapidOp(delta); 
        };
        const end = (e) => { 
            if(e.cancelable) e.preventDefault(); 
            stopRapid(); 
        };

        btn.addEventListener('touchstart', start, {passive: false});
        btn.addEventListener('touchend', end);
        btn.addEventListener('mousedown', start);
        btn.addEventListener('mouseup', end);
        btn.addEventListener('mouseleave', end);
        
        return btn;
    }

    // â˜…ä¿®æ­£ï¼šã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠæ™‚ã®æŒ™å‹•ï¼ˆ1å›ç›®é¸æŠã€2å›ç›®å…¥åŠ›ï¼‰
    function handleTargetClick(target, text, e) {
        if (editTarget !== target) {
            // é•ã†ã‚‚ã®ã‚’é¸æŠã—ã¦ã„ãŸãªã‚‰ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã ã‘ï¼ˆå…¥åŠ›ã—ãªã„ï¼‰
            editTarget = target;
            renderCameraButtons();
            if(navigator.vibrate) navigator.vibrate(30);
        } else {
            // æ—¢ã«é¸æŠä¸­ãªã‚‰ã€å…¥åŠ›ã™ã‚‹
            inputSpecialText(text, e);
        }
    }

    // æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ï¼ˆï¼‹ï¼ãƒœã‚¿ãƒ³ç”¨ï¼‰
    function operate(delta) {
        if (editTarget === 'floor') {
            changeFloor(delta);
        } else {
            changeDirection(delta);
        }
        renderCameraButtons();
    }

    // é€£æ‰“ç”¨ã‚¿ã‚¤ãƒãƒ¼
    function startRapidOp(delta) {
        operate(delta); // å³åº§ã«1å›å®Ÿè¡Œ
        // 0.4ç§’å¾Œã«é€£æ‰“é–‹å§‹
        rapidFireTimer = setTimeout(() => {
            rapidFireTimer = setInterval(() => operate(delta), 100);
        }, 400);
    }
    
    function stopRapid() {
        if(rapidFireTimer) {
            clearTimeout(rapidFireTimer);
            clearInterval(rapidFireTimer);
            rapidFireTimer = null;
        }
    }

    // éšæ•°å¤‰æ›´
    function changeFloor(delta) {
        currentFloorLevel += delta;
        if(currentFloorLevel < 1) currentFloorLevel = 1;
        localStorage.setItem('dx_last_floor', currentFloorLevel);

    }

    // æ–¹ä½å¤‰æ›´
    function changeDirection(delta) {
        currentDirIndex += delta;
        if (currentDirIndex >= DIRECTIONS.length) currentDirIndex = 0;
        if (currentDirIndex < 0) currentDirIndex = DIRECTIONS.length - 1;
        localStorage.setItem('dx_last_dir', currentDirIndex);

    }


    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”¨ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç«¶åˆé˜²æ­¢ç‰ˆï¼‰
    let dirCenterTimer = null;
    let isSliderMode = false;

    function handleDirCenterStart(e) {
        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¨ã®ç«¶åˆã‚’é˜²ããŸã‚ã“ã“ã§ã¯ preventDefault ã—ãªã„
        // é•·æŠ¼ã—åˆ¤å®šã ã‘è¡Œã†
        isSliderMode = false;
        


        dirCenterTimer = setTimeout(() => {
            isSliderMode = true; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ‰ç™ºå‹•
            if(navigator.vibrate) navigator.vibrate(50);
            

            const overlay = document.getElementById('dirSliderOverlay');
            const range = document.getElementById('dirRange');
            const label = document.getElementById('dirSliderLabel');
            
            range.value = currentDirIndex;
            label.innerText = DIRECTIONS[currentDirIndex];
            overlay.classList.add('show');
        }, 600); // å°‘ã—é•·ã‚ã«è¨­å®šï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
    }

    function handleDirCenterEnd(e) {

        if(dirCenterTimer) clearTimeout(dirCenterTimer);
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã ã£ãŸå ´åˆã€ã“ã“ã§çµ‚äº†å‡¦ç†ãªã©ã¯ä¸è¦ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å´ã®ã‚¤ãƒ™ãƒ³ãƒˆã§å‡¦ç†ï¼‰
        // isSliderModeãƒ•ãƒ©ã‚°ã¯ onclick å´ã§å‚ç…§ã•ã‚Œã‚‹
    }

    function inputSpecialText(text, e) {
        const detailBox = document.getElementById('photoDetail');
        detailBox.value = detailBox.value + (detailBox.value ? ' ' : '') + text;
        drawBoard();
        
        // æŠ¼ã—ãŸæ¼”å‡ºï¼ˆãƒœã‚¿ãƒ³è¦ç´ ã‚’æ¢ã—ã¦è‰²ã‚’å¤‰ãˆã‚‹ï¼‰
        if(e && e.target) {
            // ã‚¯ãƒ©ã‚¹åãŒå«ã¾ã‚Œã‚‹è¦ç´ ã‚’æ¢ã™ï¼ˆspanã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆãªã©ã®å¯¾ç­–ï¼‰
            const target = e.target.classList.contains('cam-chip') ? e.target : e.target.closest('.cam-chip');
            if(target) {
                const originalColor = target.style.backgroundColor;
                target.style.backgroundColor = '#c8e6c9'; // ç·‘ã«å…‰ã‚‹
                setTimeout(() => target.style.backgroundColor = originalColor, 150);
            }
        }
    }
    // 2. æ–½å·¥ç®‡æ‰€ãƒœã‚¿ãƒ³ï¼ˆä»»æ„ï¼‰ã®ã‚¤ãƒ™ãƒ³ãƒˆåˆ¶å¾¡ï¼ˆå·¥ç¨‹ãƒœã‚¿ãƒ³ã¨å®Œå…¨åŒä¸€ãƒ­ã‚¸ãƒƒã‚¯ç‰ˆï¼‰
    function setupCamBtnEvents(btn, index, text) {
        let pressTimer = null;
        let isLongPress = false;
        let startX, startY;
        const bar = btn.querySelector('.chip-bar'); // ã‚²ãƒ¼ã‚¸è¦ç´ ã‚’å–å¾—

        // --- ã‚¿ãƒƒãƒé–‹å§‹ï¼ˆåå¿œã®ãƒ«ãƒ¼ãƒ«ï¼‰ ---
        const handleStart = (e) => {
            if (e.type === 'mousedown' && e.button !== 0) return;
            
            isLongPress = false;
            // ã‚¿ãƒƒãƒä½ç½®ã‚’è¨˜éŒ²ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®šç”¨ï¼‰
            if(e.touches) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            } else {
                startX = e.clientX;
                startY = e.clientY;
            }

            // â˜…ã‚²ãƒ¼ã‚¸ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆå·¥ç¨‹ãƒœã‚¿ãƒ³ã¨åŒã˜å‹•ãï¼‰
            if(bar) {
                bar.style.transition = `width ${LONG_PRESS_MS}ms linear`;
                bar.style.width = '100%';
            }
            btn.classList.add('pressing'); // æŠ¼ã—ãŸè‰²ã«ã™ã‚‹
            
            // é•·æŠ¼ã—ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            pressTimer = setTimeout(() => {
                isLongPress = true;
                btn.classList.remove('pressing');
                
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹ã®ã§ã‚²ãƒ¼ã‚¸ã¯æ¶ˆã™
                if(bar) { bar.style.transition = 'none'; bar.style.width = '0%'; }

                if(navigator.vibrate) navigator.vibrate(100);
                
                // --- åå‰å¤‰æ›´å‡¦ç† ---
                const newName = prompt(`ãƒœã‚¿ãƒ³ã®åç§°ã‚’å¤‰æ›´ã—ã¾ã™\nï¼ˆç¾åœ¨ã®è¨­å®šï¼š${text}ï¼‰`, text);
                if (newName !== null) {
                    const list = getCamItems(isCamLocationMode);
                    list[index] = newName;
                    saveCamItems(isCamLocationMode, list);
                    renderCameraButtons();
                }
            }, LONG_PRESS_MS);
        };

        // --- ã‚¿ãƒƒãƒçµ‚äº†ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ã‚¢ã‚¦ãƒˆã®ãƒ«ãƒ¼ãƒ«ï¼‰ ---
        const handleEnd = (e) => {
            clearTimeout(pressTimer);
            btn.classList.remove('pressing'); // è‰²ã‚’æˆ»ã™
            
            // â˜…æŒ‡ã‚’é›¢ã—ãŸã‚‰ã‚²ãƒ¼ã‚¸ã‚’ã€Œã‚·ãƒ¥ãƒƒã€ã¨æˆ»ã™ï¼ˆå·¥ç¨‹ãƒœã‚¿ãƒ³ã¨åŒã˜æ¼”å‡ºï¼‰
            if(bar) {
                bar.style.transition = 'width 0.1s linear';
                bar.style.width = '0%';
            }

            // é•·æŠ¼ã—æˆç«‹æ¸ˆã¿ãªã‚‰ã€ã‚¿ãƒƒãƒ—å‡¦ç†ã¯ã—ãªã„
            if (isLongPress) return;

            // --- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®šï¼ˆ10pxä»¥ä¸Šã®ç§»å‹•ã¯ç„¡è¦–ï¼‰ ---
            let endX, endY;
            if(e.changedTouches) {
                endX = e.changedTouches[0].clientX;
                endY = e.changedTouches[0].clientY;
            } else {
                endX = e.clientX;
                endY = e.clientY;
            }
            // ã“ã“ãŒã€Œãƒ•ãƒ¬ãƒ¼ãƒ ã‚¢ã‚¦ãƒˆã®ãƒ«ãƒ¼ãƒ«ã€ã§ã™
            if (Math.abs(endX - startX) > 10 || Math.abs(endY - startY) > 10) {
                return; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã¿ãªã—ã¦çµ‚äº†
            }

            // é‡è¤‡é˜²æ­¢ï¼ˆã‚¿ãƒƒãƒã®æ™‚ã¯ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¶ˆã™ï¼‰
            if (e.type === 'touchend' && e.cancelable) e.preventDefault();

            // --- å®Ÿè¡Œå‡¦ç†ï¼ˆçŸ­æŠ¼ã—ï¼‰ ---
            if (text !== 'ï¼ˆç©ºï¼‰') {
                if (isCamLocationMode) {
                    // å ´æ‰€ãƒ¢ãƒ¼ãƒ‰ï¼šæ–‡å­—ã‚’è¿½åŠ 
                    const detailBox = document.getElementById('photoDetail');
                    detailBox.value = detailBox.value + (detailBox.value ? ' ' : '') + text;
                    drawBoard();
                } else {
                    // éƒ¨ä½ãƒ¢ãƒ¼ãƒ‰ï¼šé¸æŠçŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆ
                    if (btn.classList.contains('active')) {
                        btn.classList.remove('active'); 
                        currentProcess = '';
                    } else {
                        document.querySelectorAll('.proc-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.cam-chip').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active'); 
                        currentProcess = text;
                    }
                    drawBoard();
                }
            }
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼ˆå·¥ç¨‹ãƒœã‚¿ãƒ³ã¨å…¨ãåŒã˜æ§‹æˆï¼‰
        btn.addEventListener('touchstart', handleStart, {passive: false});
        btn.addEventListener('touchend', handleEnd, {passive: false});
        btn.addEventListener('mousedown', handleStart);
        btn.addEventListener('mouseup', handleEnd);
        
        // ãƒã‚¦ã‚¹ãŒå¤–ã‚ŒãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        btn.addEventListener('mouseleave', () => { 
            clearTimeout(pressTimer); 
            btn.classList.remove('pressing'); 
            if(bar) { bar.style.transition = 'none'; bar.style.width = '0%'; }
        });
    }

    /* å…±é€šç³»ãƒ»éŸ³å£°å…¥åŠ› */
    function saveEdit() { const name = document.getElementById('siteName').value; const address = document.getElementById('address').value; const status = document.getElementById('status').value; if(!name) return; if (siteId) { const index = sites.findIndex(s => s.id === siteId); if(index !== -1) { sites[index].name = name; sites[index].address = address; sites[index].status = status; sites[index].updatedAt = Date.now(); localStorage.setItem('dx_sites', JSON.stringify(sites)); location.reload(); } } else { alert("ç¾å ´IDãŒã‚ã‚Šã¾ã›ã‚“"); } }
    function deleteSite() { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { const newSites = sites.filter(s => s.id !== siteId); localStorage.setItem('dx_sites', JSON.stringify(newSites)); window.location.href = 'navi.html'; } }
    function searchSupply() { 
        if (navigator.geolocation) { 
            navigator.geolocation.getCurrentPosition(pos => { const url = `https://www.google.com/maps/search/ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼/@${pos.coords.latitude},${pos.coords.longitude},14z`; window.open(url, '_blank'); }, () => { alert("ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“"); }); 
        } else { alert('ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“'); } 
    }
    // --- â˜…ä¿®æ­£ç‰ˆï¼šéŸ³å£°å…¥åŠ›ï¼ˆAndroidé‡è¤‡ãƒã‚°å¯¾ç­–ç‰ˆï¼‰ ---
    let recognition; 
    let isRecognizing = false; 

    if ('webkitSpeechRecognition' in window) { 
        recognition = new webkitSpeechRecognition(); 
        
        // ç¶šã‘ã¦å–‹ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
        recognition.continuous = true; 
        
        // â˜…é‡è¦ä¿®æ­£ï¼šé€”ä¸­çµŒéï¼ˆinterimï¼‰ã‚’ã€Œç„¡è¦–ã€ã™ã‚‹è¨­å®šã«å¤‰æ›´
        // ã“ã‚Œã§ã€Œä½œæ¥­æ™‚é–“... ä½œæ¥­æ™‚é–“1...ã€ã®ã‚ˆã†ãªè¿·ã„è¨€è‘‰ãŒå…¥ã‚‰ãªããªã‚Šã¾ã™
        recognition.interimResults = false; 
        
        recognition.lang = 'ja-JP'; 

        recognition.onresult = function(event) { 
            let finalTranscript = ''; 
            
            // ç¢ºå®šã—ãŸçµæœã ã‘ã‚’æŠ½å‡ºã™ã‚‹ãƒ«ãƒ¼ãƒ—
            for (let i = event.resultIndex; i < event.results.length; ++i) { 
                if (event.results[i].isFinal) { 
                    finalTranscript += event.results[i][0].transcript; 
                } 
            } 

            // ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ 
            if (finalTranscript) { 
                const textBox = document.getElementById('reportText');
                // æ—¢ã«æ–‡å­—ãŒã‚ã‚Œã°æ”¹è¡Œã‚’å…¥ã‚Œã¦è¿½è¨˜ã€ãªã‘ã‚Œã°ãã®ã¾ã¾è¿½è¨˜
                textBox.value += (textBox.value ? '\n' : '') + finalTranscript;
            } 
        }; 

        recognition.onend = function() { 
            // Androidç­‰ã§å‹æ‰‹ã«æ­¢ã¾ã£ãŸå ´åˆã®è¦‹ãŸç›®ãƒªã‚»ãƒƒãƒˆ
            isRecognizing = false; 
            document.getElementById('micBtn').classList.remove('mic-active'); 
        }; 
    }

    function toggleSpeech() { 
        if (!recognition) { 
            alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›éå¯¾å¿œã§ã™ã€‚'); 
            return; 
        } 
        if (isRecognizing) {
            stopSpeech(); 
        } else { 
            recognition.start(); 
            isRecognizing = true; 
            document.getElementById('micBtn').classList.add('mic-active'); 
        } 
    }

    function stopSpeech() { 
        if(recognition) recognition.stop(); 
        isRecognizing = false; 
        document.getElementById('micBtn').classList.remove('mic-active'); 
    }
    function sendReportLine() { const text = document.getElementById('reportText').value; if(!text) return; const lineUrl = `https://line.me/R/msg/text/?ã€æ—¥å ±ï¼š${currentSite ? currentSite.name : 'ç¾å ´'}ã€‘%0A${encodeURIComponent(text)}`; window.open(lineUrl, '_blank'); }
    function sendReportMail() { const text = document.getElementById('reportText').value; if(!text) return; const mailTo = localStorage.getItem('dx_manager_email'); if(!mailTo) { alert("ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘\nãƒŠãƒ“ç”»é¢ã®ã€Œè¨­å®š(âš™ï¸)ã€ã‹ã‚‰ã€ç®¡ç†è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚"); return; } saveReportLocal(); const subject = `ã€æ—¥å ±ã€‘${currentSite ? currentSite.name : 'ç¾å ´'} (${new Date().toLocaleDateString()})`; const body = `${currentSite ? currentSite.name : 'ç¾å ´'}\n\n${text}\n\n--\nSent from è·äººã‚®ã‚¢`; const mailUrl = `mailto:${mailTo}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; window.location.href = mailUrl; }
    function getNextNum(year) {
        let max = 0;
        sites.forEach(s => {
            if (s.id && s.id.startsWith(year + '-')) {
                const parts = s.id.split('-');
                if (parts[1]) {
                    const n = parseInt(parts[1], 10);
                    if (!isNaN(n) && n > max) max = n;
                }
            }
        });
        return (max + 1).toString().padStart(3, '0');
    }
    function copySite() {
        const name = document.getElementById('siteName').value;
        const address = document.getElementById('address').value;
        const parentEl = document.getElementById('parentCaseNo');
        const parentNo = parentEl ? parentEl.value : '';
        if(!name) return;
        if(confirm('ã“ã®ç¾å ´æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€æ–°è¦æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆçŠ¶æ…‹ã¯ã€Œè¦‹ç©ä¸­ã€ã¨ã—ã¦ä½œæˆã•ã‚Œã¾ã™ï¼‰')) {
            const currentYear = new Date().getFullYear().toString();
            const nextNum = getNextNum(currentYear);
            const newId = `${currentYear}-${nextNum}`;
            const newSite = { id: newId, name: name, address: address, status: 'estimate', parentCaseNo: parentNo, start: '', end: '', naviCount: 0, updatedAt: Date.now() };
            sites.unshift(newSite);
            localStorage.setItem('dx_sites', JSON.stringify(sites));
            alert(`ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸã€‚\næ–°æ¡ˆä»¶No: ${newId}`);
            window.location.href = 'navi.html';
        }
    }

    // --- â˜…ã“ã“ã‹ã‚‰è¿½åŠ ï¼šå·¥ç¨‹ãƒœã‚¿ãƒ³ï¼ˆç·¨é›†å¯èƒ½ï¼‰ã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---

    function renderProcessButtons() {
        // HTMLå´ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
        const container = document.querySelector('.process-btns');
        if(!container) return;
        
        // ä¸€æ—¦ç©ºã«ã™ã‚‹ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        container.innerHTML = '';
        
        // ä¿å­˜ã•ã‚ŒãŸãƒªã‚¹ãƒˆãŒã‚ã‚Œã°ãã‚Œã‚’ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ã†
        const list = JSON.parse(localStorage.getItem('dx_process_list')) || DEFAULT_PROCESSES;
        
        list.forEach((text, index) => {
            const btn = document.createElement('button');
            btn.className = 'proc-btn';
            
            // ç¾åœ¨é¸æŠä¸­ãªã‚‰è‰²ã‚’ã¤ã‘ã‚‹
            if (currentProcess === text) btn.classList.add('active');
            
            // ãƒœã‚¿ãƒ³ã®æ–‡å­—
            btn.innerText = text;
            
            // é•·æŠ¼ã—æ¼”å‡ºç”¨ã®ãƒãƒ¼ã‚’è¿½åŠ 
            const bar = document.createElement('div');
            bar.className = 'chip-bar';
            btn.appendChild(bar);

            // é•·æŠ¼ã—ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã‚’è¨­å®š
            setupProcessBtnEvents(btn, index, text);
            
            // ç”»é¢ã«è¿½åŠ 
            container.appendChild(btn);
        });
    }

    // â˜…è¨­å®šï¼šé•·æŠ¼ã—åˆ¤å®šã®æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
    const LONG_PRESS_MS = 1500; // ã“ã“ã‚’å¤‰ãˆã‚‹ã ã‘ã§ã‚²ãƒ¼ã‚¸ã‚‚åˆ¤å®šã‚‚ã™ã¹ã¦å¤‰ã‚ã‚Šã¾ã™

    // 1. å·¥ç¨‹ãƒœã‚¿ãƒ³ï¼ˆå›ºå®šï¼‰ã®ã‚¤ãƒ™ãƒ³ãƒˆåˆ¶å¾¡ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾ç­–ï¼‹ã‚²ãƒ¼ã‚¸åŒæœŸï¼‰
    function setupProcessBtnEvents(btn, index, text) {
        let pressTimer = null;
        let isLongPress = false;
        let startX, startY;
        const bar = btn.querySelector('.chip-bar'); // ã‚²ãƒ¼ã‚¸è¦ç´ ã‚’å–å¾—

        // ã‚¿ãƒƒãƒé–‹å§‹
        const handleStart = (e) => {
            if (e.type === 'mousedown' && e.button !== 0) return;
            
            isLongPress = false;
            // ã‚¿ãƒƒãƒä½ç½®ã‚’è¨˜éŒ²
            if(e.touches) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            } else {
                startX = e.clientX;
                startY = e.clientY;
            }

            // â˜…è¿½åŠ ï¼šã‚²ãƒ¼ã‚¸ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆJSã§æ™‚é–“ã‚’åŒæœŸï¼‰
            if(bar) {
                bar.style.transition = `width ${LONG_PRESS_MS}ms linear`;
                bar.style.width = '100%';
            }
            btn.classList.add('pressing');
            
            // é•·æŠ¼ã—ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            pressTimer = setTimeout(() => {
                isLongPress = true;
                btn.classList.remove('pressing');
                
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹ã®ã§ã‚²ãƒ¼ã‚¸ã¯æˆ»ã™
                if(bar) { bar.style.transition = 'none'; bar.style.width = '0%'; }
                
                if(navigator.vibrate) navigator.vibrate(100);
                
                // åå‰å¤‰æ›´å‡¦ç†
                const newName = prompt(`å·¥ç¨‹åã®å¤‰æ›´\nï¼ˆç¾åœ¨ã®è¨­å®šï¼š${text}ï¼‰`, text);
                if(newName !== null && newName.trim() !== "") {
                    const list = JSON.parse(localStorage.getItem('dx_process_list')) || DEFAULT_PROCESSES;
                    list[index] = newName;
                    localStorage.setItem('dx_process_list', JSON.stringify(list));
                    if(currentProcess === text) currentProcess = newName;
                    renderProcessButtons();
                    drawBoard();
                }
            }, LONG_PRESS_MS); // â˜…å¤‰æ•°ã‚’ä½¿ã†
        };

        // ã‚¿ãƒƒãƒçµ‚äº†
        const handleEnd = (e) => {
            clearTimeout(pressTimer);
            btn.classList.remove('pressing');

            // â˜…æŒ‡ã‚’é›¢ã—ãŸã‚‰ã‚²ãƒ¼ã‚¸ã‚’å³ãƒªã‚»ãƒƒãƒˆ
            if(bar) {
                bar.style.transition = 'width 0.1s linear';
                bar.style.width = '0%';
            }

            if (isLongPress) return;

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®šï¼ˆ10pxä»¥ä¸Šã®ç§»å‹•ã¯ç„¡è¦–ï¼‰
            let endX, endY;
            if(e.changedTouches) {
                endX = e.changedTouches[0].clientX;
                endY = e.changedTouches[0].clientY;
            } else {
                endX = e.clientX;
                endY = e.clientY;
            }

            if (Math.abs(endX - startX) > 10 || Math.abs(endY - startY) > 10) {
                return;
            }

            // é‡è¤‡é˜²æ­¢
            if (e.type === 'touchend' && e.cancelable) e.preventDefault();

            setProcess(btn, text);
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
        btn.addEventListener('touchstart', handleStart, {passive: false});
        btn.addEventListener('touchend', handleEnd, {passive: false});

        btn.addEventListener('mousedown', handleStart);

        btn.addEventListener('mouseup', handleEnd);
        
        // ãƒã‚¦ã‚¹ã‚¢ã‚¦ãƒˆï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«æ‰±ã„ï¼‰
        btn.addEventListener('mouseleave', () => { 
            clearTimeout(pressTimer); 
            btn.classList.remove('pressing'); 
            if(bar) { bar.style.transition = 'none'; bar.style.width = '0%'; }
        });
    }
    // â˜…è¿½åŠ ï¼šæ–½å·¥ç®‡æ‰€ã®ã‚¯ãƒªã‚¢æ©Ÿèƒ½
    function clearLocation() {
        const input = document.getElementById('photoDetail');
        if(input) {
            input.value = ""; // æ–‡å­—ã‚’ç©ºã«ã™ã‚‹
            drawBoard();      // é»’æ¿ã‚’æ›¸ãç›´ã™
        }
    }
</script>
</body>
</html>
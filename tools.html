<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å ´ãƒ„ãƒ¼ãƒ« - è·äººã‚®ã‚¢</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="style.css">
    <style>
        /* (æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
        body { background-color: #f0f2f5; padding-bottom: 80px; scroll-behavior: smooth; }
        .site-header { background: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .site-title { margin: 0; font-size: 1.4rem; font-weight: bold; }
        .site-sub { font-size: 0.9rem; opacity: 0.8; margin-top: 5px; }
        .dashboard-nav { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; padding: 0 15px; position: sticky; top: 100px; z-index: 90; }
        .dash-btn { background: white; color: #555; border: 1px solid #ddd; padding: 10px 20px; border-radius: 30px; font-size: 0.9rem; font-weight: bold; text-decoration: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .dash-btn:active { transform: translateY(2px); box-shadow: none; }
        .dash-btn.rec { border-bottom: 4px solid #27ae60; color: #27ae60; }
        .dash-btn.sup { border-bottom: 4px solid #e67e22; color: #e67e22; }
        .dash-btn.man { border-bottom: 4px solid #2980b9; color: #2980b9; }
        .container { max-width: 600px; margin: 0 auto; padding: 0 20px; }
        .section-header { font-size: 1.2rem; font-weight: bold; margin-top: 40px; margin-bottom: 15px; padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; scroll-margin-top: 140px; }
        .section-record { background-color: #e8f5e9; color: #2e7d32; border-left: 6px solid #2e7d32; }
        .section-support { background-color: #fff3e0; color: #e65100; border-left: 6px solid #e65100; }
        .section-manage { background-color: #e3f2fd; color: #1565c0; border-left: 6px solid #1565c0; }
        .tool-grid { display: grid; gap: 35px; padding-bottom: 20px; }
        .tool-btn { display: flex; align-items: center; justify-content: space-between; background: white; padding: 25px; border-radius: 16px; text-decoration: none; color: #333; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border: 2px solid transparent; transition: transform 0.1s; }
        .tool-grid.rec .tool-btn { border-color: #a5d6a7; }
        .tool-grid.sup .tool-btn { border-color: #ffcc80; }
        .tool-grid.man .tool-btn { border-color: #90caf9; }
        .tool-btn:active { transform: scale(0.98); background: #f9f9f9; }
        .btn-icon { font-size: 2.5rem; margin-right: 20px; width: 50px; text-align: center; }
        .btn-text h3 { margin: 0; font-size: 1.2rem; color: #333; }
        .btn-text p { margin: 5px 0 0; font-size: 0.85rem; color: #777; }
        .back-link-area { margin-top:40px; display:flex; flex-direction:column; gap:10px; }
        .back-link { display: block; text-align: center; color: #888; text-decoration: none; padding: 15px; background: white; border-radius: 8px; border: 1px solid #eee; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; display: none; opacity: 0; }
        .overlay.show { display: block; opacity: 1; }
        .modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; padding: 24px; border-radius: 16px; z-index: 160; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; max-height: 90vh; overflow-y: auto; }
        .modal-box.show { display: block; }
        #cameraModal { padding: 0; background: #000; color: white; overflow: hidden; height: 90vh; flex-direction: column; }
        #cameraModal.show { display: flex; }
        #cameraSetup { padding: 20px; background: #fff; color: #333; height: 100%; display: flex; flex-direction: column; overflow-y: auto; }
        .preview-canvas-wrapper { text-align: center; margin-bottom: 15px; background: #333; padding: 10px; border-radius: 8px; }
        #boardCanvas { max-width: 100%; height: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        #photoPreviewArea { display: none; position: relative; flex: 1; background: #000; overflow: hidden; justify-content: center; align-items: center; }
        #previewImage { max-width: 100%; max-height: 100%; object-fit: contain; }
        #overlayBoard { position: absolute; top: 20px; left: 20px; width: 200px; cursor: grab; z-index: 10; touch-action: none; } 
        .camera-controls-area { padding: 15px; background: #111; display: flex; justify-content: space-between; align-items: center; }
        .btn-cam-action { padding: 10px 20px; border-radius: 30px; font-weight: bold; cursor: pointer; border: none; }
        .btn-retake { background: #e74c3c; color: white; }
        .btn-save-photo { background: #00C853; color: white; font-size: 1.1rem; padding: 12px 30px; }
        .snap-controls { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 20; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 30px; }
        .snap-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5); width: 44px; height: 44px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.1s; }
        .snap-btn:active { background: rgba(255,255,255,0.5); }
        .process-btns { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .proc-btn { flex: 1; min-width: 70px; padding: 12px 5px; font-size: 0.9rem; background: #f0f0f0; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; white-space: nowrap; color: #555; font-weight: bold; transition: all 0.2s; }
        .proc-btn.active { background: #2c3e50; color: white; border-color: #2c3e50; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        .custom-btn-area { border-top: 1px dashed #ddd; padding-top: 15px; margin-top: 10px; }
        .btn-edit-custom { background: #f39c12; color: white; border: none; border-radius: 4px; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; float: right; }
        .rough-paper { background-color: #fff9c4; border: 2px dashed #dcdcdc; border-radius: 8px; padding: 15px; margin-top: 20px; }
        .rough-textarea { width: 100%; height: 150px; background: transparent; border: none; outline: none; font-size: 1.1rem; line-height: 1.6; color: #444; font-family: "Yu Gothic", sans-serif; resize: none; }
        .mic-btn { background: #e74c3c; color: white; width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem; position: absolute; bottom: 20px; right: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .mic-active { animation: pulse 1.5s infinite; background: #c0392b; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 100% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); } }
        .btn-close { background-color: #95a5a6; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top:10px; }
        .save-btn { background-color: #2980b9; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }
        .edit-footer { display: flex; gap: 10px; margin-top: 20px; }
        .btn-del-single { width: 50px; background-color: #fff5f5; border: 1px solid #e74c3c; color: #e74c3c; border-radius: 8px; font-size: 1.2rem; cursor: pointer; }
        label { margin-top: 15px; display: block; font-weight: bold; font-size: 0.95rem; color: #2c3e50; }
        input[type="text"] { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; background: #f9f9f9; }
        .history-list { margin-top: 15px; max-height: 150px; overflow-y: auto; border-top: 1px solid #eee; padding-top: 10px; }
        .history-item { background: #fff; padding: 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.85rem; border: 1px solid #eee; }
        .history-date { font-weight: bold; color: #2980b9; font-size: 0.75rem; }
    </style>
</head>
<body>

<div class="site-header">
    <h2 class="site-title" id="displaySiteName">èª­ã¿è¾¼ã¿ä¸­...</h2>
    <div class="site-sub" id="displaySiteId">---</div>
</div>

<div class="dashboard-nav">
    <a href="#sec-record" class="dash-btn rec">ğŸ“ è¨˜éŒ²</a>
    <a href="#sec-support" class="dash-btn sup">ğŸ§° ã‚µãƒãƒ¼ãƒˆ</a>
    <a href="#sec-manage" class="dash-btn man">âš™ï¸ ç®¡ç†</a>
</div>

<div class="container">
    <div id="sec-record" class="section-header section-record">ğŸ“ è¨˜éŒ²ãƒ»å ±å‘Š</div>
    <div class="tool-grid rec">
        <div class="tool-btn" onclick="openCameraModal()">
            <div class="btn-icon">ğŸ“¸</div>
            <div class="btn-text"><h3>é›»å­é»’æ¿ã‚«ãƒ¡ãƒ©</h3><p>é«˜ç”»è³ªæ’®å½±ï¼†é»’æ¿åˆæˆ</p></div>
            <span style="font-size:1.5rem; color:#a5d6a7;">ï¼</span>
        </div>
        <div class="tool-btn" onclick="openModal('report')">
            <div class="btn-icon">ğŸ™ï¸</div>
            <div class="btn-text"><h3>ã—ã‚ƒã¹ã‚‹æ—¥å ±</h3><p>å£°ã§å…¥åŠ›ã€å±¥æ­´ã‚‚ä¿å­˜</p></div>
            <span style="font-size:1.5rem; color:#a5d6a7;">ï¼</span>
        </div>
    </div>

    <div id="sec-support" class="section-header section-support">ğŸ§° ç¾å ´ã‚µãƒãƒ¼ãƒˆ</div>
    <div class="tool-grid sup">
        <div class="tool-btn" onclick="searchSupply()">
            <div class="btn-icon">ğŸ›’</div>
            <div class="btn-text"><h3>è³‡æSOSãƒãƒƒãƒ—</h3><p>è¿‘ãã®ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼ã‚’æ¤œç´¢</p></div>
            <span style="font-size:1.5rem; color:#ffcc80;">ï¼</span>
        </div>
        <div class="tool-btn" onclick="handleCalendarAction()" style="cursor:pointer;">
            <div class="btn-icon">ğŸ“…</div>
            <div class="btn-text"><h3>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²</h3><p>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ </p></div>
            <span style="font-size:1.5rem; color:#ffcc80;">â†—</span>
        </div>
    </div>

    <div id="sec-manage" class="section-header section-manage">âš™ï¸ æƒ…å ±ç®¡ç†</div>
    <div class="tool-grid man">
        <div class="tool-btn" onclick="openForm()">
            <div class="btn-icon">âœï¸</div>
            <div class="btn-text"><h3>æƒ…å ±ã®ç·¨é›†ãƒ»å‰Šé™¤</h3><p>ç¾å ´åã‚„ä½æ‰€ã®ä¿®æ­£</p></div>
            <span style="font-size:1.5rem; color:#90caf9;">ï¼</span>
        </div>
    </div>

    <div class="back-link-area">
        <a href="navi.html" class="back-link">â†©ï¸ ç¾å ´ä¸€è¦§ã«æˆ»ã‚‹</a>
        <div style="display:flex; gap:10px;">
            <a href="manager.html" class="back-link" style="flex:1; margin-top:0;">ğŸ“Š å¸ä»¤å¡”ã¸</a>
            <a href="index.html" class="back-link" style="flex:1; margin-top:0;">ğŸ” æ¤œç´¢ã¸</a>
        </div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="cameraModal" class="modal-box" style="width:100%; height:100%; max-width:none; border-radius:0; top:0; left:0; transform:none;">
    <div id="cameraSetup">
        <h3 style="text-align:center; margin-top:0;">é»’æ¿ã®æº–å‚™</h3>
        <div class="preview-canvas-wrapper"><canvas id="boardCanvas" width="400" height="300"></canvas></div>
        <label>ä¼šç¤¾å</label>
        <input type="text" id="companyName" value="ãƒšã‚¤ãƒ³ãƒˆãƒã‚¦ã‚¹å±±å²¡" oninput="drawBoard()">
        <label>å·¥ç¨‹</label>
        <div class="process-btns">
            <button class="proc-btn active" onclick="setProcess(this, 'æ–½å·¥å‰')">æ–½å·¥å‰</button>
            <button class="proc-btn" onclick="setProcess(this, 'ä¸‹å¡—ã‚Š')">ä¸‹å¡—ã‚Š</button>
            <button class="proc-btn" onclick="setProcess(this, 'ä¸­å¡—ã‚Š')">ä¸­å¡—ã‚Š</button>
            <button class="proc-btn" onclick="setProcess(this, 'ä¸Šå¡—ã‚Š')">ä¸Šå¡—ã‚Š</button>
            <button class="proc-btn" onclick="setProcess(this, 'å®Œäº†')">å®Œäº†</button>
        </div>
        <div class="custom-btn-area">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <label style="margin:0;">ä»»æ„ãƒœã‚¿ãƒ³</label>
                <button class="btn-edit-custom" onclick="editCustomButtons()">âš™ï¸ åå‰å¤‰æ›´</button>
            </div>
            <div class="process-btns" id="customBtnGroup"></div>
        </div>
        <label>æ–½å·¥ç®‡æ‰€</label>
        <input type="text" id="photoDetail" placeholder="ä¾‹ï¼šåŒ—é¢ã€è»’å¤©ãªã©" oninput="drawBoard()">
        <div style="margin-top:auto; padding-top:20px; display:flex; gap:10px;">
            <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
            <input type="file" id="nativeCameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handlePhotoSelect(this)">
            <button class="save-btn" onclick="document.getElementById('nativeCameraInput').click()" style="background:#00C853; font-size:1.1rem;">ğŸ“¸ æ¨™æº–ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
        </div>
    </div>
    <div id="photoPreviewArea">
        <img id="previewImage" src="" alt="æ’®å½±å†™çœŸ">
        <img id="overlayBoard" src="" alt="é»’æ¿">
        <div class="snap-controls">
            <button class="snap-btn" onclick="snapBoard('tl')">â†–ï¸</button>
            <button class="snap-btn" onclick="snapBoard('tr')">â†—ï¸</button>
            <button class="snap-btn" onclick="snapBoard('bl')">â†™ï¸</button>
            <button class="snap-btn" onclick="snapBoard('br')">â†˜ï¸</button>
        </div>
        <div class="camera-controls-area" style="position:absolute; bottom:0; width:100%;">
            <button class="btn-cam-action btn-retake" onclick="retakePhoto()">ã‚„ã‚Šç›´ã™</button>
            <button class="btn-cam-action btn-save-photo" onclick="saveCompositePhoto()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>
</div>

<div id="reportModal" class="modal-box" style="background:#fffcf0;">
    <h3>ğŸ™ï¸ ã‹ã‚“ãŸã‚“æ—¥å ±</h3>
    <div class="rough-paper" style="position:relative;">
        <textarea id="reportText" class="rough-textarea" placeholder="å†…å®¹ã‚’å…¥åŠ›..."></textarea>
        <button class="mic-btn" id="micBtn" onclick="toggleSpeech()">ğŸ¤</button>
    </div>
    <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
        <button class="save-btn" onclick="saveReportLocal()" style="background:#f39c12; font-size:0.9rem;">ğŸ’¾ ã¾ãšã¯å±¥æ­´ã«æ®‹ã™</button>
        <div style="display:flex; gap:5px;">
            <button class="save-btn" onclick="sendReportCloud()" style="flex:1.5; background:#9b59b6; font-size:0.85rem;">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã¸æå‡º</button>
            <button class="save-btn" onclick="sendReportLine()" style="flex:1; background:#00C300; font-size:0.8rem;">LINE</button>
            <button class="save-btn" onclick="sendReportMail()" style="flex:1; background:#007bff; font-size:0.8rem;">ãƒ¡ãƒ¼ãƒ«</button>
        </div>
    </div>
    <div style="margin-top:15px;">
        <label style="margin:0; font-size:0.85rem;">ğŸ“œ å±¥æ­´ (ã“ã®ç¾å ´ã®ã¿)</label>
        <div id="reportHistoryList" class="history-list"></div>
    </div>
    <div class="settings-footer" style="border-top:none; margin-top:10px;">
        <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="calSelectModal" class="modal-box" style="text-align:center;">
    <h3>ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½</h3>
    <p style="font-size:0.9rem; color:#666;">æ“ä½œã‚’é¸ã‚“ã§ãã ã•ã„</p>
    <div style="display:flex; flex-direction:column; gap:15px; margin-top:20px;">
        <button class="save-btn" onclick="registerSharedCalendar()" style="background:#9b59b6;">ğŸ¢ å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²<br><span style="font-size:0.8rem; opacity:0.9;">(ã“ã®ç¾å ´ã®äºˆå®šã‚’å…±æœ‰)</span></button>
        <button class="save-btn" onclick="openPersonalCalendar()" style="background:#fff; color:#333; border:1px solid #ccc;">ğŸ‘¤ Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‹ã<br><span style="font-size:0.8rem; color:#666;">(å€‹äººã®äºˆå®šãƒ»æ­¯åŒ»è€…ãªã©)</span></button>
    </div>
    <div class="settings-footer" style="border-top:none; margin-top:15px;">
        <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="inputForm" class="modal-box">
    <h3 style="margin-top:0; text-align:center;">æƒ…å ±ã®ç·¨é›†ãƒ»å‰Šé™¤</h3>
    <label>ç¾å ´å</label><input type="text" id="siteName">
    <label>ä½æ‰€</label><input type="text" id="address">
    <label>çŠ¶æ³</label>
    <select id="status">
        <option value="estimate">ğŸ“„ è¦‹ç©ä¸­</option>
        <option value="contract">ğŸ¤ å¥‘ç´„æ¸ˆã¿</option>
        <option value="billing">ğŸ’° è«‹æ±‚</option>
        <option value="complete">âœ… å®Œäº†</option>
        <option value="lost">âŒ å¤±æ³¨</option>
    </select>
    <div class="edit-footer">
        <button class="btn-del-single" onclick="deleteSite()">ğŸ—‘ï¸</button>
        <button class="cancel-btn" onclick="closeAllModals()">ä¸­æ­¢</button>
        <button class="save-btn" onclick="saveEdit()">æ›´æ–°ã™ã‚‹</button>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const siteId = params.get('id');
    let currentSite = null;
    let sites = JSON.parse(localStorage.getItem('dx_sites')) || [];
    let currentProcess = 'æ–½å·¥å‰';
    let customLabels = JSON.parse(localStorage.getItem('dx_custom_btns')) || ["ã‚±ãƒ¬ãƒ³", "æ´—æµ„", "é¤Šç”Ÿ", "ã‚·ãƒ¼ãƒªãƒ³ã‚°", "è¶³å ´"];
    
    let reportHistory;
    try { reportHistory = JSON.parse(localStorage.getItem('dx_reports')); } catch(e) { reportHistory = {}; }
    if (!reportHistory || Array.isArray(reportHistory) || typeof reportHistory !== 'object') { reportHistory = {}; }

    if (siteId) {
        currentSite = sites.find(s => s.id === siteId);
        if (currentSite) {
            document.getElementById('displaySiteName').textContent = currentSite.name;
            document.getElementById('displaySiteId').textContent = `No. ${currentSite.id}`;
        } else { document.getElementById('displaySiteName').textContent = "ç¾å ´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; }
    } else {
        document.getElementById('displaySiteName').textContent = "ç¾å ´æœªé¸æŠ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼)";
        document.getElementById('displaySiteId').textContent = "---";
    }

    window.onload = () => {
        renderCustomButtons();
        if(document.getElementById('boardCanvas')) drawBoard();
        if(siteId) renderReportHistory();
    };

    function handleCalendarAction() {
        const calId = localStorage.getItem('dx_calendar_id');
        if (calId && calId.trim() !== "") openModal('calSelect'); else openPersonalCalendar();
    }
    function openPersonalCalendar() {
        // â˜…ä¿®æ­£ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        let stLabel = 'ç¾èª¿äºˆå®š';
        if(currentSite.status === 'contract' || currentSite.status === 'active') stLabel = 'æ–½å·¥ä¸­';
        
        const text = encodeURIComponent(`ã€${stLabel}ã€‘${currentSite.name}`);
        const location = encodeURIComponent(currentSite.address);
        const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&location=${location}`;
        window.open(url, '_blank');
        closeAllModals();
    }
    function registerSharedCalendar() {
        if(!confirm("å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã€æœ¬æ—¥ã®äºˆå®šã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const calId = localStorage.getItem('dx_calendar_id');
        const gasUrl = localStorage.getItem('dx_gas_url');
        if(!gasUrl) { alert("GAS URLè¨­å®šãŒã‚ã‚Šã¾ã›ã‚“"); return; }

        const data = {
            type: "calendar",
            calendarId: calId,
            id: currentSite.id,
            title: `ã€${(currentSite.status === 'contract' || currentSite.status === 'active') ? 'æ–½å·¥ä¸­' : 'äºˆå®š'}ã€‘${currentSite.name}`,
            address: currentSite.address,
            status: currentSite.status
        };
        
        fetch(gasUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(() => { alert("âœ… å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã—ã¾ã—ãŸï¼"); closeAllModals(); }).catch(err => alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼"));
    }

    const canvas = document.getElementById('boardCanvas'), ctx = canvas ? canvas.getContext('2d') : null;
    function setProcess(btn, text) { if (btn.classList.contains('active')) { btn.classList.remove('active'); currentProcess = ''; } else { document.querySelectorAll('.proc-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentProcess = text; } drawBoard(); }
    function drawBoard() {
        if(!canvas) return;
        const siteName = currentSite ? currentSite.name : "ï¼ˆç¾å ´åæœªå®šï¼‰", company = document.getElementById('companyName').value || "", location = document.getElementById('photoDetail').value || "";
        const d = new Date(), dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
        ctx.fillStyle = '#004d40'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.strokeStyle = 'white'; ctx.lineWidth = 5; ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
        ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(10, 80); ctx.lineTo(390, 80); ctx.moveTo(10, 150); ctx.lineTo(390, 150); ctx.stroke();
        ctx.fillStyle = 'white'; ctx.textAlign = 'left'; ctx.textBaseline = 'middle'; ctx.font = 'bold 20px sans-serif'; ctx.fillText("å·¥äº‹å", 20, 30); ctx.font = 'bold 24px sans-serif'; ctx.fillText(siteName, 20, 55); ctx.font = 'bold 20px sans-serif'; ctx.fillText("å·¥ç¨® / æ–½å·¥å†…å®¹", 20, 100); ctx.font = 'bold 26px sans-serif'; ctx.fillText(currentProcess || "ï¼ˆé¸æŠãªã—ï¼‰", 40, 125); ctx.font = 'bold 20px sans-serif'; ctx.fillText("æ–½å·¥ç®‡æ‰€", 20, 175);
        ctx.font = 'bold 24px sans-serif'; const maxWidth = 340; let line1 = location, line2 = ""; if (ctx.measureText(location).width > maxWidth) { for (let i = 1; i < location.length; i++) { if (ctx.measureText(location.substring(0, i)).width > maxWidth) { line1 = location.substring(0, i-1); line2 = location.substring(i-1); break; } } } if(line2) { ctx.fillText(line1, 40, 200); ctx.fillText(line2, 40, 228); } else { ctx.fillText(line1, 40, 210); }
        ctx.textAlign = 'right'; ctx.font = 'bold 24px sans-serif'; ctx.fillText(dateStr, 380, 270); ctx.textAlign = 'left'; ctx.font = '16px sans-serif'; ctx.fillStyle = '#ccc'; ctx.fillText(company, 20, 270);
    }
    
    let photoFile = null;
    function handlePhotoSelect(input) { if (input.files && input.files[0]) { photoFile = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { document.getElementById('previewImage').src = e.target.result; document.getElementById('overlayBoard').src = canvas.toDataURL('image/png'); document.getElementById('cameraSetup').style.display = 'none'; document.getElementById('photoPreviewArea').style.display = 'flex'; const board = document.getElementById('overlayBoard'); board.style.top = '20px'; board.style.left = '20px'; board.style.bottom = ''; board.style.right = ''; }; reader.readAsDataURL(photoFile); } input.value = ''; }
    function retakePhoto() { document.getElementById('photoPreviewArea').style.display = 'none'; document.getElementById('cameraSetup').style.display = 'flex'; photoFile = null; }
    function saveCompositePhoto() { if(!photoFile) return; const pImg = document.getElementById('previewImage'), bImg = document.getElementById('overlayBoard'), c = document.createElement('canvas'); c.width = pImg.naturalWidth; c.height = pImg.naturalHeight; const cx = c.getContext('2d'); cx.drawImage(pImg, 0, 0); const pRect = pImg.getBoundingClientRect(), bRect = bImg.getBoundingClientRect(), s = pImg.naturalWidth / pRect.width; cx.drawImage(bImg, (bRect.left - pRect.left) * s, (bRect.top - pRect.top) * s, bRect.width * s, bRect.height * s); const link = document.createElement('a'); link.href = c.toDataURL('image/jpeg', 0.9); link.download = `${currentSite?currentSite.name:'ç¾å ´'}_${currentProcess}_${Date.now()}.jpg`; document.body.appendChild(link); link.click(); document.body.removeChild(link); retakePhoto(); closeAllModals(); }
    function snapBoard(pos) { const b = document.getElementById('overlayBoard'); b.style.top = b.style.bottom = b.style.left = b.style.right = 'auto'; if(pos=='tl'){b.style.top='10px';b.style.left='10px';}else if(pos=='tr'){b.style.top='10px';b.style.right='10px';}else if(pos=='bl'){b.style.bottom='10px';b.style.left='10px';}else if(pos=='br'){b.style.bottom='10px';b.style.right='10px';} }
    
    const overlayBoard = document.getElementById('overlayBoard'); let isDragging = false, startX, startY, initialLeft, initialTop;
    overlayBoard.addEventListener('touchstart', (e) => { isDragging = true; const s = window.getComputedStyle(overlayBoard); initialLeft = parseInt(s.left)||0; initialTop = parseInt(s.top)||0; startX = e.touches[0].clientX; startY = e.touches[0].clientY; overlayBoard.style.bottom='auto'; overlayBoard.style.right='auto'; overlayBoard.style.left=initialLeft+'px'; overlayBoard.style.top=initialTop+'px'; e.preventDefault(); });
    overlayBoard.addEventListener('touchmove', (e) => { if (!isDragging) return; overlayBoard.style.left = `${initialLeft + e.touches[0].clientX - startX}px`; overlayBoard.style.top = `${initialTop + e.touches[0].clientY - startY}px`; e.preventDefault(); });
    overlayBoard.addEventListener('touchend', () => isDragging = false);

    function renderCustomButtons() { const group = document.getElementById('customBtnGroup'); group.innerHTML = ''; customLabels.forEach((label, index) => { const btn = document.createElement('button'); btn.className = 'proc-btn'; btn.textContent = label; btn.onclick = function() { setProcess(this, label); }; group.appendChild(btn); }); }
    function editCustomButtons() { for(let i=0; i<5; i++) { const newName = prompt(`ãƒœã‚¿ãƒ³${i+1}ã®åå‰ã‚’å¤‰æ›´:`, customLabels[i]); if(newName) customLabels[i] = newName; } localStorage.setItem('dx_custom_btns', JSON.stringify(customLabels)); renderCustomButtons(); }
    
    function openModal(type) { 
        document.getElementById('overlay').classList.add('show'); 
        if(type === 'camera') openCameraModal(); 
        if(type === 'report') { document.getElementById('reportModal').classList.add('show'); renderReportHistory(); } 
        if(type === 'calSelect') { document.getElementById('calSelectModal').classList.add('show'); }
    }
    function openCameraModal() { document.getElementById('overlay').classList.add('show'); document.getElementById('cameraModal').classList.add('show'); drawBoard(); }
    function openForm() { document.getElementById('overlay').classList.add('show'); document.getElementById('inputForm').classList.add('show'); document.getElementById('siteName').value = currentSite ? currentSite.name : ''; document.getElementById('address').value = currentSite ? currentSite.address : ''; document.getElementById('status').value = currentSite ? currentSite.status : 'estimate'; }
    function closeAllModals() { document.querySelectorAll('.modal-box').forEach(el => el.classList.remove('show')); document.getElementById('overlay').classList.remove('show'); stopSpeech(); if(document.getElementById('photoPreviewArea').style.display==='flex') retakePhoto(); }
    function saveEdit() { const name = document.getElementById('siteName').value; const address = document.getElementById('address').value; const status = document.getElementById('status').value; if(!name) return; if (siteId) { const index = sites.findIndex(s => s.id === siteId); if(index !== -1) { sites[index].name = name; sites[index].address = address; sites[index].status = status; sites[index].updatedAt = Date.now(); localStorage.setItem('dx_sites', JSON.stringify(sites)); location.reload(); } } else { alert("ç¾å ´IDãŒã‚ã‚Šã¾ã›ã‚“"); } }
    function deleteSite() { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { const newSites = sites.filter(s => s.id !== siteId); localStorage.setItem('dx_sites', JSON.stringify(newSites)); window.location.href = 'navi.html'; } }
    function searchSupply() { 
        if (navigator.geolocation) { 
            navigator.geolocation.getCurrentPosition(pos => { 
                const url = `https://www.google.com/maps/search/ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼/@${pos.coords.latitude},${pos.coords.longitude},14z`;
                window.open(url, '_blank'); 
            }, () => { alert("ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“"); }); 
        } else { alert('ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“'); } 
    }
    
    // éŸ³å£°èªè­˜
    let recognition; let isRecognizing = false; 
    if ('webkitSpeechRecognition' in window) { 
        recognition = new webkitSpeechRecognition(); recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'ja-JP'; 
        recognition.onresult = function(event) { let t = ''; for (let i = event.resultIndex; i < event.results.length; ++i) { if (event.results[i].isFinal) t += event.results[i][0].transcript; } if (t) document.getElementById('reportText').value += (document.getElementById('reportText').value ? '\n' : '') + t; }; 
        recognition.onend = function() { isRecognizing = false; document.getElementById('micBtn').classList.remove('mic-active'); }; 
    }
    function toggleSpeech() { if (!recognition) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›éå¯¾å¿œã§ã™ã€‚'); return; } if (isRecognizing) stopSpeech(); else { recognition.start(); isRecognizing = true; document.getElementById('micBtn').classList.add('mic-active'); } }
    function stopSpeech() { if(recognition) recognition.stop(); isRecognizing = false; document.getElementById('micBtn').classList.remove('mic-active'); }

    function sendReport() { const text = document.getElementById('reportText').value; if(!text) return; const lineUrl = `https://line.me/R/msg/text/?ã€æ—¥å ±ï¼š${currentSite ? currentSite.name : 'ç¾å ´'}ã€‘%0A${encodeURIComponent(text)}`; window.open(lineUrl, '_blank'); }
    function sendReportMail() { const text = document.getElementById('reportText').value; if(!text) return; const mailTo = localStorage.getItem('dx_manager_email'); if(!mailTo) { alert("ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘\nãƒŠãƒ“ç”»é¢ã®ã€Œè¨­å®š(âš™ï¸)ã€ã‹ã‚‰ã€ç®¡ç†è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚"); return; } saveReportLocal(); const subject = `ã€æ—¥å ±ã€‘${currentSite ? currentSite.name : 'ç¾å ´'} (${new Date().toLocaleDateString()})`; const body = `${currentSite ? currentSite.name : 'ç¾å ´'}\n\n${text}\n\n--\nSent from è·äººã‚®ã‚¢`; const mailUrl = `mailto:${mailTo}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; window.location.href = mailUrl; }
    
    function saveReportLocal() { 
        const text = document.getElementById('reportText').value; if(!text) { alert('æ—¥å ±ã®å†…å®¹ãŒç©ºã§ã™'); return; }
        const targetId = siteId || 'preview';
        if (!reportHistory[targetId]) { reportHistory[targetId] = []; } 
        reportHistory[targetId].unshift({ date: new Date().toLocaleString(), content: text }); 
        localStorage.setItem('dx_reports', JSON.stringify(reportHistory)); 
        renderReportHistory(); document.getElementById('reportText').value = ''; alert('å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ'); 
    }
    
    function renderReportHistory() { 
        const listEl = document.getElementById('reportHistoryList'); listEl.innerHTML = ''; 
        const targetId = siteId || 'preview';
        if (!reportHistory[targetId] || reportHistory[targetId].length === 0) { listEl.innerHTML = '<div style="color:#777; font-size:0.8rem;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; } 
        reportHistory[targetId].forEach(item => { listEl.insertAdjacentHTML('beforeend', `<div class="history-item"><div class="history-date">${item.date || "æ—¥æ™‚ä¸æ˜"}</div><div>${item.content || item}</div></div>`); }); 
    }

    function sendReportCloud() {
        const text = document.getElementById('reportText').value;
        if(text) { saveReportLocal(); } 
        const gasUrl = localStorage.getItem('dx_gas_url');
        if(!gasUrl) { alert("ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘\nãƒŠãƒ“ç”»é¢ã®è¨­å®šã‹ã‚‰ã€ŒGAS URLã€ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚"); return; }
        const reporterName = localStorage.getItem('dx_reporter_name') || "è·äºº";
        const today = new Date().toLocaleDateString();
        let todayReports = [];
        const targetId = siteId || 'preview';
        if(reportHistory[targetId]) { todayReports = reportHistory[targetId].filter(item => item.date.split(' ')[0] === today); }
        if(todayReports.length === 0) { alert("æœ¬æ—¥ã®æ—¥å ±ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nã¾ãšã¯ã€Œå±¥æ­´ã«æ®‹ã™ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚"); return; }
        todayReports.reverse(); 
        let combinedText = todayReports.map(item => `[${item.date.split(' ')[1]}] ${item.content}`).join('\n');
        const data = { type: "report", siteName: currentSite ? currentSite.name : "æœªå®š", content: combinedText, address: currentSite ? currentSite.address : "", id: currentSite ? currentSite.id : "", reporter: reporterName };
        const btn = event.target; const originalText = btn.innerText; btn.innerText = "é€ä¿¡ä¸­..."; btn.disabled = true;
        fetch(gasUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).then(() => { alert("â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«æ—¥å ±ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼"); btn.innerText = originalText; btn.disabled = false; }).catch(err => { alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼"); console.error(err); btn.innerText = originalText; btn.disabled = false; });
    }
</script>
</body>
</html>
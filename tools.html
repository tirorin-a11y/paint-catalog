<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å ´ãƒ„ãƒ¼ãƒ« - ç¾å ´ã‚«ãƒ¼ãƒŠãƒ“æ‰‹å¸³</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ã“ã®ãƒšãƒ¼ã‚¸å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .site-header { background: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; margin-bottom: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .site-title { margin: 0; font-size: 1.4rem; font-weight: bold; }
        .site-sub { font-size: 0.9rem; opacity: 0.8; margin-top: 5px; }

        .tool-grid { display: grid; gap: 20px; padding: 0 20px; }
        
        .tool-btn { 
            display: flex; align-items: center; justify-content: space-between;
            background: white; padding: 25px; border-radius: 16px; 
            text-decoration: none; color: #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid transparent;
            transition: transform 0.1s;
        }
        .tool-btn:active { transform: scale(0.98); background: #f9f9f9; }
        
        .btn-icon { font-size: 2.5rem; margin-right: 20px; width: 50px; text-align: center; }
        .btn-text h3 { margin: 0; font-size: 1.2rem; color: #2c3e50; }
        .btn-text p { margin: 5px 0 0; font-size: 0.85rem; color: #777; }

        /* æ—¥å ±ç”¨ã®ãƒ©ãƒ•ãªã‚¹ã‚¿ã‚¤ãƒ« */
        .rough-paper {
            background-color: #fff9c4; /* ã‚ã‚‰åŠç´™ã£ã½ã„è‰² */
            border: 2px dashed #dcdcdc; /* ç ´ç·šã§ãƒ©ãƒ•ã•ã‚’æ¼”å‡º */
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.1);
        }
        .rough-textarea {
            width: 100%; height: 150px; 
            background: transparent; border: none; outline: none;
            font-size: 1.1rem; line-height: 1.6; color: #444;
            font-family: "Yu Gothic", sans-serif; /* æ‰‹æ›¸ãé¢¨ãƒ•ã‚©ãƒ³ãƒˆãŒã‚ã‚Œã°ãƒ™ã‚¹ãƒˆ */
            resize: none;
        }
        .rough-textarea::placeholder { color: #aaa; font-style: italic; }
        
        /* ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ */
        .mic-btn {
            background: #e74c3c; color: white; width: 60px; height: 60px;
            border-radius: 50%; border: none; font-size: 1.5rem;
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
            position: absolute; bottom: 20px; right: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .mic-active { animation: pulse 1.5s infinite; background: #c0392b; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }

        /* ã‚«ãƒ¡ãƒ©ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ãƒ¢ãƒƒã‚¯ */
        .camera-preview { width: 100%; height: 200px; background: #333; color: white; display: flex; align-items: center; justify-content: center; border-radius: 8px; margin-bottom: 10px; position: relative; overflow: hidden; }
        .blackboard-overlay {
            position: absolute; bottom: 10px; right: 10px;
            background: url('https://raw.githubusercontent.com/google/material-design-icons/master/png/image/filter_b_and_w/materialicons/24dp/2x/baseline_filter_b_and_w_black_24dp.png'); /* é»’æ¿ç”»åƒã®ä»£ã‚ã‚Šã«é»’èƒŒæ™¯ */
            background: #004d40; border: 2px solid white; color: white;
            padding: 5px 10px; font-family: "HiraMinProN-W3", "YuMincho", serif;
            width: 120px; font-size: 0.7rem; text-align: left;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<div class="site-header">
    <h2 class="site-title" id="displaySiteName">èª­ã¿è¾¼ã¿ä¸­...</h2>
    <div class="site-sub" id="displaySiteId">---</div>
</div>

<div class="container">
    
    <div class="tool-grid">
        <div class="tool-btn" onclick="openModal('camera')">
            <div class="btn-icon">ğŸ“¸</div>
            <div class="btn-text">
                <h3>é›»å­é»’æ¿ã‚«ãƒ¡ãƒ©</h3>
                <p>ç¾å ´åã¨æ—¥ä»˜ã¯è‡ªå‹•å…¥åŠ›ã€‚<br>å·¥ç¨‹ã ã‘é¸ã‚“ã§ãƒ‘ã‚·ãƒ£ãƒªã€‚</p>
            </div>
            <span style="font-size:1.5rem; color:#ccc;">ï¼</span>
        </div>

        <div class="tool-btn" onclick="searchSupply()">
            <div class="btn-icon">ğŸ›’</div>
            <div class="btn-text">
                <h3>è³‡æSOSãƒãƒƒãƒ—</h3>
                <p>è¿‘ãã®ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼ã‚„<br>å»ºæå±‹ã‚’ä¸€ç™ºæ¤œç´¢ã€‚</p>
            </div>
            <span style="font-size:1.5rem; color:#ccc;">ï¼</span>
        </div>

        <div class="tool-btn" onclick="openModal('report')">
            <div class="btn-icon">ğŸ™ï¸</div>
            <div class="btn-text">
                <h3>ã—ã‚ƒã¹ã‚‹æ—¥å ±</h3>
                <p>èª¤å­—è„±å­—OKã€‚<br>å£°ã§ã‚µã‚¯ãƒƒã¨å ±å‘Šä½œæˆã€‚</p>
            </div>
            <span style="font-size:1.5rem; color:#ccc;">ï¼</span>
        </div>
    </div>

    <a href="navi.html" class="back-link" style="display:block; text-align:center; margin-top:40px; color:#888; text-decoration:none;">â†©ï¸ ä¸€è¦§ã«æˆ»ã‚‹</a>

</div>

<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="cameraModal" class="modal-box">
    <h3>ğŸ“¸ é›»å­é»’æ¿æ’®å½±</h3>
    <div class="camera-preview">
        ï¼ˆã“ã“ã«ã‚«ãƒ¡ãƒ©æ˜ åƒï¼‰
        <div class="blackboard-overlay">
            <div id="boardDate">2025/11/24</div>
            <div id="boardName">ç¾å ´å</div>
            <div id="boardProcess" style="color:#ffeb3b;">å·¥ç¨‹ã‚’é¸æŠ</div>
        </div>
    </div>
    <label>å·¥ç¨‹ï¼ˆä½œæ¥­å†…å®¹ï¼‰</label>
    <div style="display:flex; gap:5px; flex-wrap:wrap; margin-top:5px;">
        <button onclick="setProcess('æ–½å·¥å‰')" style="padding:5px 10px;">æ–½å·¥å‰</button>
        <button onclick="setProcess('ä¸‹å¡—ã‚Š')" style="padding:5px 10px;">ä¸‹å¡—ã‚Š</button>
        <button onclick="setProcess('ä¸­å¡—ã‚Š')" style="padding:5px 10px;">ä¸­å¡—ã‚Š</button>
        <button onclick="setProcess('ä¸Šå¡—ã‚Š')" style="padding:5px 10px;">ä¸Šå¡—ã‚Š</button>
        <button onclick="setProcess('å®Œäº†')" style="padding:5px 10px;">å®Œäº†</button>
    </div>
    <p style="font-size:0.8rem; color:#666; margin-top:10px;">â€»å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã“ã“ã§ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã€é»’æ¿ç”»åƒã‚’åˆæˆã—ã¦ä¿å­˜ã—ã¾ã™ã€‚</p>
    <div class="settings-footer">
        <button class="save-btn">ğŸ“· æ’®å½±ã™ã‚‹</button>
        <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="reportModal" class="modal-box" style="background:#fffcf0;">
    <h3>ğŸ™ï¸ ã‹ã‚“ãŸã‚“æ—¥å ±</h3>
    <p style="font-size:0.8rem; color:#666;">
        ãã‚Œã„ã«æ›¸ã‹ãªãã¦OKï¼<br>ã€Œèª°ãŒã€ã€Œã©ã“ã‚’ã€ã€Œã©ã†ã—ãŸã€ãŒä¼ã‚ã‚Œã°100ç‚¹ã§ã™ã€‚
    </p>
    
    <div class="rough-paper" style="position:relative;">
        <textarea id="reportText" class="rough-textarea" placeholder="ï¼ˆä¾‹ï¼‰åŒ—é¢ã®é¤Šç”Ÿçµ‚ã‚ã‚Šã¾ã—ãŸã€‚ã‚ã—ãŸã¯ã‚·ãƒ¼ãƒ©ãƒ¼å¡—ã‚Šã¾ã™ã€‚ææ–™ãŒè¶³ã‚Šãªããªã‚Šãã†ã§ã™..."></textarea>
        <button class="mic-btn" id="micBtn" onclick="toggleSpeech()">ğŸ¤</button>
    </div>

    <div class="settings-footer" style="border-top:none;">
        <button class="save-btn" onclick="sendReport()">LINEã«é€ã‚‹</button>
        <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç¾å ´IDã‚’å–å¾—
    const params = new URLSearchParams(window.location.search);
    const siteId = params.get('id');
    
    let currentSite = null;
    const sites = JSON.parse(localStorage.getItem('dx_sites')) || [];

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    if (siteId) {
        currentSite = sites.find(s => s.id === siteId);
        if (currentSite) {
            document.getElementById('displaySiteName').textContent = currentSite.name;
            document.getElementById('displaySiteId').textContent = `No. ${currentSite.id}`;
            // é»’æ¿ç”¨
            document.getElementById('boardName').textContent = currentSite.name;
            const d = new Date();
            document.getElementById('boardDate').textContent = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
        }
    }

    function openModal(type) {
        document.getElementById('overlay').classList.add('show');
        if(type === 'camera') document.getElementById('cameraModal').classList.add('show');
        if(type === 'report') document.getElementById('reportModal').classList.add('show');
    }
    function closeAllModals() {
        document.querySelectorAll('.modal-box').forEach(el => el.classList.remove('show'));
        document.getElementById('overlay').classList.remove('show');
        stopSpeech(); // éŸ³å£°å…¥åŠ›ã‚‚åœæ­¢
    }

    // --- ğŸ“¸ ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ï¼ˆé»’æ¿æ–‡å­—å¤‰æ›´ï¼‰ ---
    function setProcess(text) {
        document.getElementById('boardProcess').textContent = text;
    }

    // --- ğŸ›’ è³‡æSOS ---
    function searchSupply() {
        // ç¾åœ¨åœ°å‘¨è¾ºã®ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼ã‚’æ¤œç´¢
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                // Google Mapsã§ã€Œè¿‘ãã®ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼ã€ã‚’æ¤œç´¢ã™ã‚‹URL
                const url = `https://www.google.com/maps/search/ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼+å¡—æ–™+å»ºæ/@${lat},${lng},13z`;
                window.open(url, '_blank');
            }, () => {
                // ä½ç½®æƒ…å ±ãŒå–ã‚Œãªã„å ´åˆã¯å˜ãªã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
                window.open('https://www.google.com/maps/search/ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼+å¡—æ–™', '_blank');
            });
        } else {
            alert('ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“');
        }
    }

    // --- ğŸ™ï¸ éŸ³å£°å…¥åŠ›ï¼ˆWeb Speech APIï¼‰ ---
    let recognition;
    let isRecognizing = false;

    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'ja-JP';

        recognition.onresult = function(event) {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                }
            }
            if (finalTranscript) {
                const area = document.getElementById('reportText');
                area.value += (area.value ? '\n' : '') + finalTranscript;
            }
        };
        recognition.onend = function() {
            isRecognizing = false;
            document.getElementById('micBtn').classList.remove('mic-active');
        };
    }

    function toggleSpeech() {
        if (!recognition) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“'); return; }
        if (isRecognizing) {
            stopSpeech();
        } else {
            recognition.start();
            isRecognizing = true;
            document.getElementById('micBtn').classList.add('mic-active');
        }
    }
    function stopSpeech() {
        if(recognition) recognition.stop();
        isRecognizing = false;
        document.getElementById('micBtn').classList.remove('mic-active');
    }

    function sendReport() {
        const text = document.getElementById('reportText').value;
        if(!text) return;
        // LINEå…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆï¼ˆç°¡å˜ãªé€ä¿¡æ–¹æ³•ï¼‰
        const lineUrl = `https://line.me/R/msg/text/?ã€æ—¥å ±ï¼š${currentSite.name}ã€‘%0A${encodeURIComponent(text)}`;
        window.open(lineUrl, '_blank');
    }
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å ´ãƒ„ãƒ¼ãƒ« - è·äººã‚®ã‚¢</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background-color: #f0f2f5; padding-bottom: 80px; scroll-behavior: smooth; }
        
        .site-header { background: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 10; }
        .site-title { margin: 0; font-size: 1.4rem; font-weight: bold; }
        .site-sub { font-size: 0.9rem; opacity: 0.8; margin-top: 5px; }
        
        /* â˜…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼‰ */
        .dashboard-nav { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; padding: 0 15px; }
        .dash-btn { background: #e0e6ed; color: #2c3e50; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; text-decoration: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dash-btn:active { transform: translateY(2px); box-shadow: none; }

        .container { max-width: 600px; margin: 0 auto; padding: 0 20px; }
        
        /* â˜…ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .section-header { font-size: 1.1rem; color: #34495e; font-weight: bold; margin-top: 30px; margin-bottom: 10px; border-left: 5px solid #2980b9; padding-left: 10px; }
        
        /* â˜…ãƒ„ãƒ¼ãƒ«é–“éš”ã‚’åºƒãï¼ˆgap: 35pxï¼‰ */
        .tool-grid { display: grid; gap: 35px; padding-bottom: 20px; }
        
        .tool-btn { display: flex; align-items: center; justify-content: space-between; background: white; padding: 25px; border-radius: 16px; text-decoration: none; color: #333; box-shadow: 0 4px 8px rgba(0,0,0,0.08); border: 2px solid transparent; transition: transform 0.1s; }
        .tool-btn:active { transform: scale(0.98); background: #f9f9f9; }
        
        .btn-icon { font-size: 2.5rem; margin-right: 20px; width: 50px; text-align: center; }
        .btn-text h3 { margin: 0; font-size: 1.2rem; color: #2c3e50; }
        .btn-text p { margin: 5px 0 0; font-size: 0.85rem; color: #777; }

        .back-link { display: block; text-align: center; margin-top: 40px; color: #888; text-decoration: none; padding: 15px; background: white; border-radius: 8px; border: 1px solid #eee; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆçœç•¥ã›ãšè¨˜è¿°ï¼‰ */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; display: none; opacity: 0; }
        .overlay.show { display: block; opacity: 1; }
        .modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; padding: 24px; border-radius: 16px; z-index: 160; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; }
        .modal-box.show { display: block; }

        /* ã‚«ãƒ¡ãƒ© */
        #cameraModal { padding: 0; background: #000; color: white; overflow: hidden; height: 90vh; display: flex; flex-direction: column; }
        #cameraSetup { padding: 20px; background: #fff; color: #333; height: 100%; display: flex; flex-direction: column; overflow-y: auto; }
        .preview-canvas-wrapper { text-align: center; margin-bottom: 15px; background: #333; padding: 10px; border-radius: 8px; }
        #boardCanvas { max-width: 100%; height: auto; }
        #cameraView { display: none; position: relative; flex: 1; background: #000; overflow: hidden; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #overlayBoard { position: absolute; top: 50px; left: 20px; width: 180px; cursor: grab; z-index: 10; }
        .camera-controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-around; align-items: center; z-index: 20; pointer-events: none; }
        .camera-controls button { pointer-events: auto; }
        .shutter-btn { width: 70px; height: 70px; border-radius: 50%; background: white; border: 5px solid #ccc; cursor: pointer; }
        .back-btn-cam { background: rgba(0,0,0,0.5); color: white; border: 1px solid white; padding: 10px 20px; border-radius: 30px; font-weight: bold; cursor: pointer; }
        
        /* â˜…ä¿®æ­£ï¼šå·¥ç¨‹ãƒœã‚¿ãƒ³ */
        .process-btns { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .proc-btn { 
            flex: 1; padding: 10px; font-size: 0.9rem; 
            background: #f0f0f0; /* è–„ã„ã‚°ãƒ¬ãƒ¼ */
            border: 1px solid #ccc; 
            border-radius: 6px; cursor: pointer; white-space: nowrap; 
            color: #555; font-weight: bold;
        }
        .proc-btn.active { background: #2c3e50; color: white; border-color: #2c3e50; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        
        /* æ—¥å ± */
        .rough-paper { background-color: #fff9c4; border: 2px dashed #dcdcdc; border-radius: 8px; padding: 15px; margin-top: 20px; }
        .rough-textarea { width: 100%; height: 150px; background: transparent; border: none; outline: none; font-size: 1.1rem; line-height: 1.6; color: #444; resize: none; }
        .mic-btn { background: #e74c3c; color: white; width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem; position: absolute; bottom: 20px; right: 20px; cursor: pointer; }
        .mic-active { animation: pulse 1.5s infinite; background: #c0392b; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 100% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); } }

        .btn-close { background-color: #95a5a6; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top:10px; }
        .save-btn { background-color: #2980b9; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }
        
        /* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .edit-footer { display: flex; gap: 10px; margin-top: 20px; }
        .btn-del-single { width: 50px; background-color: #fff5f5; border: 1px solid #e74c3c; color: #e74c3c; border-radius: 8px; font-size: 1.2rem; cursor: pointer; }
        label { margin-top: 10px; display: block; font-weight: bold; font-size: 0.9rem; }
        input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
    </style>
</head>
<body>

<div class="site-header">
    <h2 class="site-title" id="displaySiteName">èª­ã¿è¾¼ã¿ä¸­...</h2>
    <div class="site-sub" id="displaySiteId">---</div>
</div>

<div class="dashboard-nav">
    <a href="#sec-record" class="dash-btn">ğŸ“ è¨˜éŒ²</a>
    <a href="#sec-support" class="dash-btn">ğŸ§° ã‚µãƒãƒ¼ãƒˆ</a>
    <a href="#sec-manage" class="dash-btn">âš™ï¸ ç®¡ç†</a>
</div>

<div class="container">

    <div id="sec-record" class="section-header">ğŸ“ è¨˜éŒ²ãƒ»å ±å‘Š</div>
    <div class="tool-grid">
        <div class="tool-btn" onclick="openCameraModal()">
            <div class="btn-icon">ğŸ“¸</div>
            <div class="btn-text"><h3>é›»å­é»’æ¿ã‚«ãƒ¡ãƒ©</h3><p>ç¾å ´åã¨æ—¥ä»˜ã¯è‡ªå‹•å…¥åŠ›ã€‚<br>å·¥ç¨‹ã‚’é¸ã‚“ã§æ’®å½±ã€‚</p></div>
            <span style="font-size:1.5rem; color:#ccc;">ï¼</span>
        </div>
        <div class="tool-btn" onclick="openModal('report')">
            <div class="btn-icon">ğŸ™ï¸</div>
            <div class="btn-text"><h3>ã—ã‚ƒã¹ã‚‹æ—¥å ±</h3><p>èª¤å­—è„±å­—OKã€‚<br>å£°ã§ã‚µã‚¯ãƒƒã¨å ±å‘Šä½œæˆã€‚</p></div>
            <span style="font-size:1.5rem; color:#ccc;">ï¼</span>
        </div>
    </div>

    <div id="sec-support" class="section-header">ğŸ§° ç¾å ´ã‚µãƒãƒ¼ãƒˆ</div>
    <div class="tool-grid">
        <div class="tool-btn" onclick="searchSupply()">
            <div class="btn-icon">ğŸ›’</div>
            <div class="btn-text"><h3>è³‡æSOSãƒãƒƒãƒ—</h3><p>è¿‘ãã®ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼ã‚„<br>å»ºæå±‹ã‚’ä¸€ç™ºæ¤œç´¢ã€‚</p></div>
            <span style="font-size:1.5rem; color:#ccc;">ï¼</span>
        </div>
        <a href="#" id="btnGoogleCal" target="_blank" class="tool-btn">
            <div class="btn-icon">ğŸ“…</div>
            <div class="btn-text"><h3>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²</h3><p>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«äºˆå®šè¿½åŠ </p></div>
            <span style="font-size:1.5rem; color:#ccc;">â†—</span>
        </a>
    </div>

    <div id="sec-manage" class="section-header">âš™ï¸ æƒ…å ±ç®¡ç†</div>
    <div class="tool-grid">
        <div class="tool-btn" onclick="openForm()" style="background: #fff8e1; border-color: #ffecb3;">
            <div class="btn-icon">âœï¸</div>
            <div class="btn-text"><h3>æƒ…å ±ã®ç·¨é›†ãƒ»å‰Šé™¤</h3><p>ç¾å ´åã‚„ä½æ‰€ã®ä¿®æ­£ã¯ã“ã¡ã‚‰</p></div>
            <span style="font-size:1.5rem; color:#ccc;">ï¼</span>
        </div>
    </div>

    <a href="navi.html" class="back-link">â†©ï¸ ä¸€è¦§ã«æˆ»ã‚‹</a>
</div>

<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="cameraModal" class="modal-box" style="width:100%; height:100%; max-width:none; border-radius:0; top:0; left:0; transform:none;">
    <div id="cameraSetup">
        <h3 style="text-align:center; margin-top:0;">é»’æ¿ã®æº–å‚™</h3>
        <div class="preview-canvas-wrapper"><canvas id="boardCanvas" width="400" height="300"></canvas></div>
        
        <label>ä¼šç¤¾åï¼ˆå¤‰æ›´å¯ï¼‰</label>
        <input type="text" id="companyName" value="ãƒšã‚¤ãƒ³ãƒˆãƒã‚¦ã‚¹å±±å²¡" oninput="drawBoard()">

        <label>å·¥ç¨‹ï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠ/è§£é™¤ï¼‰</label>
        <div class="process-btns">
            <button class="proc-btn active" onclick="setProcess(this, 'æ–½å·¥å‰')">æ–½å·¥å‰</button>
            <button class="proc-btn" onclick="setProcess(this, 'ä¸‹å¡—ã‚Š')">ä¸‹å¡—ã‚Š</button>
            <button class="proc-btn" onclick="setProcess(this, 'ä¸­å¡—ã‚Š')">ä¸­å¡—ã‚Š</button>
            <button class="proc-btn" onclick="setProcess(this, 'ä¸Šå¡—ã‚Š')">ä¸Šå¡—ã‚Š</button>
            <button class="proc-btn" onclick="setProcess(this, 'å®Œäº†')">å®Œäº†</button>
        </div>
        
        <label>æ–½å·¥ç®‡æ‰€ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" id="photoDetail" placeholder="ä¾‹ï¼šåŒ—é¢ã€è»’å¤©ãªã©" oninput="drawBoard()">

        <div style="margin-top:auto; padding-top:20px; display:flex; gap:10px;">
            <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
            <button class="save-btn" onclick="startCamera()" style="background:#00C853;">ğŸ“¸ ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
        </div>
    </div>

    <div id="cameraView">
        <video id="video" autoplay playsinline></video>
        <img id="overlayBoard" src="" alt="é»’æ¿">
        <div id="flash"></div>
        <div class="camera-controls">
            <button class="back-btn-cam" onclick="stopCamera()">æˆ»ã‚‹</button>
            <button class="shutter-btn" onclick="takePhoto()"></button>
            <div style="width:60px;"></div>
        </div>
    </div>
</div>

<div id="reportModal" class="modal-box" style="background:#fffcf0;">
    <h3>ğŸ™ï¸ ã‹ã‚“ãŸã‚“æ—¥å ±</h3>
    <div class="rough-paper" style="position:relative;">
        <textarea id="reportText" class="rough-textarea" placeholder="ï¼ˆä¾‹ï¼‰ã‚ãƒ¼ã€ãˆã£ã¨ã€åŒ—é¢ã®é¤Šç”Ÿçµ‚ã‚ã£ã¦..."></textarea>
        <button class="mic-btn" id="micBtn" onclick="toggleSpeech()">ğŸ¤</button>
    </div>
    <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="save-btn" onclick="saveReportLocal()" style="flex:1; background:#f39c12;">ğŸ’¾ å±¥æ­´ã«æ®‹ã™</button>
        <button class="save-btn" onclick="sendReportLine()" style="flex:1; background:#00C300;">LINEé€ã‚‹</button>
    </div>
    <div style="margin-top:10px;"><button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button></div>
</div>

<div id="inputForm" class="modal-box">
    <h3 style="margin-top:0; text-align:center;">æƒ…å ±ã®ç·¨é›†ãƒ»å‰Šé™¤</h3>
    <label>ç¾å ´å</label><input type="text" id="siteName">
    <label>ä½æ‰€</label><input type="text" id="address">
    <label>çŠ¶æ³</label>
    <select id="status">
        <option value="plan">ğŸ“ ç¾èª¿äºˆå®š</option>
        <option value="active">ğŸ—ï¸ æ–½å·¥ä¸­</option>
        <option value="done">âœ… å®Œå·¥</option>
        <option value="handover">ğŸ  å¼•ãæ¸¡ã—</option>
    </select>
    <div class="edit-footer">
        <button class="btn-del-single" onclick="deleteSite()">ğŸ—‘ï¸</button>
        <button class="cancel-btn" onclick="closeAllModals()">ä¸­æ­¢</button>
        <button class="save-btn" onclick="saveEdit()">æ›´æ–°ã™ã‚‹</button>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const siteId = params.get('id');
    let currentSite = null;
    let sites = JSON.parse(localStorage.getItem('dx_sites')) || [];
    let currentProcess = 'æ–½å·¥å‰';

    if (siteId) {
        currentSite = sites.find(s => s.id === siteId);
        if (currentSite) {
            document.getElementById('displaySiteName').textContent = currentSite.name;
            document.getElementById('displaySiteId').textContent = `No. ${currentSite.id}`;
            const d = new Date();
            let stLabel = 'ç¾èª¿äºˆå®š';
            if(currentSite.status === 'active') stLabel = 'æ–½å·¥ä¸­';
            const text = encodeURIComponent(`ã€${stLabel}ã€‘${currentSite.name}`);
            const location = encodeURIComponent(currentSite.address);
            document.getElementById('btnGoogleCal').href = `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&location=${location}`;
        }
    }
    window.onload = () => { if(document.getElementById('boardCanvas')) drawBoard(); };

    // --- â˜…ä¿®æ­£ï¼šé»’æ¿å‡¦ç†ï¼ˆãƒˆã‚°ãƒ«å¯¾å¿œï¼‰ ---
    const canvas = document.getElementById('boardCanvas');
    const ctx = canvas.getContext('2d');
    const video = document.getElementById('video');
    let stream = null;

    function setProcess(btn, text) {
        // ãƒˆã‚°ãƒ«å‡¦ç†
        if (btn.classList.contains('active')) {
            btn.classList.remove('active');
            currentProcess = ''; // è§£é™¤
        } else {
            document.querySelectorAll('.proc-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentProcess = text;
        }
        drawBoard();
    }

    function drawBoard() {
        if(!canvas) return;
        const siteName = currentSite ? currentSite.name : "ç¾å ´å";
        const company = document.getElementById('companyName').value || "";
        const location = document.getElementById('photoDetail').value || "";
        const d = new Date();
        const dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;

        ctx.fillStyle = '#004d40'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = 'white'; ctx.lineWidth = 5; ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
        ctx.lineWidth = 2; ctx.beginPath();
        ctx.moveTo(10, 80); ctx.lineTo(390, 80);
        ctx.moveTo(10, 150); ctx.lineTo(390, 150);
        ctx.stroke();

        ctx.fillStyle = 'white'; ctx.textAlign = 'left'; ctx.textBaseline = 'middle';
        ctx.font = 'bold 20px sans-serif'; ctx.fillText("å·¥äº‹å", 20, 30);
        ctx.font = 'bold 24px sans-serif'; ctx.fillText(siteName, 20, 55);
        ctx.font = 'bold 20px sans-serif'; ctx.fillText("å·¥ç¨® / æ–½å·¥å†…å®¹", 20, 100);
        ctx.font = 'bold 32px sans-serif'; ctx.fillText(currentProcess || "ï¼ˆé¸æŠãªã—ï¼‰", 40, 125); // ç©ºãªã‚‰è¡¨ç¤ºå¤‰ãˆã‚‹
        ctx.font = 'bold 20px sans-serif'; ctx.fillText("æ–½å·¥ç®‡æ‰€", 20, 175);
        ctx.font = 'bold 28px sans-serif'; ctx.fillText(location, 40, 205);
        ctx.textAlign = 'right'; ctx.font = 'bold 24px sans-serif'; ctx.fillText(dateStr, 380, 270);
        ctx.textAlign = 'left'; ctx.font = '16px sans-serif'; ctx.fillStyle = '#ccc'; ctx.fillText(company, 20, 270);
    }

    // (ã‚«ãƒ¡ãƒ©ãƒ»éŸ³å£°ãƒ»ä¿å­˜ç³»ã¯ãã®ã¾ã¾)
    async function startCamera() {
        const dataUrl = canvas.toDataURL('image/png');
        document.getElementById('overlayBoard').src = dataUrl;
        document.getElementById('cameraSetup').style.display = 'none';
        document.getElementById('cameraView').style.display = 'flex';
        try { stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } }, audio: false }); video.srcObject = stream; } catch (err) { alert("ã‚¨ãƒ©ãƒ¼"); stopCamera(); }
    }
    function stopCamera() { if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; } document.getElementById('cameraSetup').style.display = 'flex'; document.getElementById('cameraView').style.display = 'none'; }
    function takePhoto() {
        const flash = document.getElementById('flash'); flash.style.opacity = 1; setTimeout(() => flash.style.opacity = 0, 100);
        const captureCanvas = document.createElement('canvas'); captureCanvas.width = video.videoWidth; captureCanvas.height = video.videoHeight;
        const ctxCap = captureCanvas.getContext('2d'); ctxCap.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
        const rect = video.getBoundingClientRect(); const scaleX = captureCanvas.width / rect.width; const scaleY = captureCanvas.height / rect.height;
        const board = document.getElementById('overlayBoard'); const boardRect = board.getBoundingClientRect();
        ctxCap.drawImage(board, (boardRect.left - rect.left)*scaleX, (boardRect.top - rect.top)*scaleY, boardRect.width*scaleX, boardRect.height*scaleY);
        const link = document.createElement('a'); const timeStr = new Date().toISOString().replace(/[:.]/g, '-');
        link.href = captureCanvas.toDataURL('image/jpeg'); link.download = `${currentSite.name}_${currentProcess}_${timeStr}.jpg`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
    const overlayBoard = document.getElementById('overlayBoard'); let isDragging = false, startX, startY, initialLeft, initialTop;
    overlayBoard.addEventListener('touchstart', (e) => { isDragging = true; startX = e.touches[0].clientX; startY = e.touches[0].clientY; initialLeft = overlayBoard.offsetLeft; initialTop = overlayBoard.offsetTop; e.preventDefault(); });
    overlayBoard.addEventListener('touchmove', (e) => { if (!isDragging) return; const dx = e.touches[0].clientX - startX; const dy = e.touches[0].clientY - startY; overlayBoard.style.left = `${initialLeft + dx}px`; overlayBoard.style.top = `${initialTop + dy}px`; e.preventDefault(); });
    overlayBoard.addEventListener('touchend', () => isDragging = false);

    function openModal(type) { document.getElementById('overlay').classList.add('show'); if(type === 'camera') openCameraModal(); if(type === 'report') document.getElementById('reportModal').classList.add('show'); }
    function openCameraModal() { document.getElementById('overlay').classList.add('show'); document.getElementById('cameraModal').classList.add('show'); drawBoard(); }
    function openForm() { document.getElementById('overlay').classList.add('show'); document.getElementById('inputForm').classList.add('show'); document.getElementById('siteName').value = currentSite.name; document.getElementById('address').value = currentSite.address; document.getElementById('status').value = currentSite.status; }
    function closeAllModals() { document.querySelectorAll('.modal-box').forEach(el => el.classList.remove('show')); document.getElementById('overlay').classList.remove('show'); stopCamera(); stopSpeech(); }
    function saveEdit() {
        const name = document.getElementById('siteName').value; const address = document.getElementById('address').value; const status = document.getElementById('status').value; if(!name) return;
        const index = sites.findIndex(s => s.id === siteId);
        if(index !== -1) { sites[index].name = name; sites[index].address = address; sites[index].status = status; sites[index].updatedAt = Date.now(); localStorage.setItem('dx_sites', JSON.stringify(sites)); location.reload(); }
    }
    function deleteSite() { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { const newSites = sites.filter(s => s.id !== siteId); localStorage.setItem('dx_sites', JSON.stringify(newSites)); window.location.href = 'navi.html'; } }
    function searchSupply() { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { const url = `https://www.google.com/maps/search/ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼+å»ºæ/@${pos.coords.latitude},${pos.coords.longitude},13z`; window.open(url, '_blank'); }, () => { alert("ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“"); }); } else { alert('ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“'); } }
    let recognition; let isRecognizing = false; if ('webkitSpeechRecognition' in window) { recognition = new webkitSpeechRecognition(); recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'ja-JP'; recognition.onresult = function(event) { let finalTranscript = ''; for (let i = event.resultIndex; i < event.results.length; ++i) { if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript; } if (finalTranscript) document.getElementById('reportText').value += (document.getElementById('reportText').value ? '\n' : '') + finalTranscript; }; recognition.onend = function() { isRecognizing = false; document.getElementById('micBtn').classList.remove('mic-active'); }; }
    function toggleSpeech() { if (!recognition) { alert('éå¯¾å¿œã§ã™'); return; } if (isRecognizing) stopSpeech(); else { recognition.start(); isRecognizing = true; document.getElementById('micBtn').classList.add('mic-active'); } }
    function stopSpeech() { if(recognition) recognition.stop(); isRecognizing = false; document.getElementById('micBtn').classList.remove('mic-active'); }
    function sendReport() { const text = document.getElementById('reportText').value; if(!text) return; const lineUrl = `https://line.me/R/msg/text/?ã€æ—¥å ±ï¼š${currentSite.name}ã€‘%0A${encodeURIComponent(text)}`; window.open(lineUrl, '_blank'); }
    function saveReportLocal() { alert('ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ¢ãƒƒã‚¯ï¼‰'); }
    function sendReportLine() { const text = document.getElementById('reportText').value; if(!text) return; const lineUrl = `https://line.me/R/msg/text/?ã€æ—¥å ±ï¼š${currentSite.name}ã€‘%0A${encodeURIComponent(text)}`; window.open(lineUrl, '_blank'); }

</script>
</body>
</html>
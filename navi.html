<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å ´ãƒŠãƒ“ - è·äººã‚®ã‚¢</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³å®šç¾© --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; color: #333; -webkit-font-smoothing: antialiased; }
        
        /* 3è¦ç´ ã‚’ã¾ã¨ã‚ã‚‹å›ºå®šç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
        .fixed-header-group {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: #34495e; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        header { 
            background-color: #2c3e50; 
            color: white; 
            padding: 10px 15px; 
            position: static; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .header-title-area { display: flex; align-items: baseline; gap: 8px; }
        h1 { margin: 0; font-size: 1.1rem; letter-spacing: 0.05em; font-weight: bold; }
        
        /* æœ€åˆã‹ã‚‰ç™½æ–‡å­—ãƒ»ç™½æ ã«ã—ã¦è¦–èªæ€§ã‚’é«˜ã‚ã‚‹ */
        .link-control { font-size: 0.75rem; color: white; text-decoration: none; border: 1px solid white; padding: 2px 6px; border-radius: 4px; transition: 0.2s; }
        .link-control:active { transform: scale(0.95); opacity: 0.8; }

        .header-btn-group { display: flex; align-items: center; gap: 15px; }
        .icon-btn { font-size: 1.4rem; cursor: pointer; text-decoration: none; color: white; display: flex; align-items: center; transition: 0.2s; }
        
        body.sort-mode .icon-btn[onclick="toggleSortMode()"] {
            color: #f39c12;
            text-shadow: 0 0 5px rgba(243, 156, 18, 0.5);
        }

        .search-area { 
            background: #34495e; 
            padding: 10px 15px 0 15px; 
            position: static; 
        }
        .search-input { width: 100%; padding: 10px; border-radius: 6px; border: none; font-size: 1rem; box-sizing: border-box; outline: none; }
        
        .filter-area { 
            background: #34495e; 
            padding: 5px 15px 15px 15px; 
            position: static; 
            display: flex; 
            gap: 8px; 
            overflow-x: auto; 
            white-space: nowrap; 
            -webkit-overflow-scrolling: touch; 
        }
        .filter-area::-webkit-scrollbar { height: 4px; }
        .filter-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.5); border-radius: 4px; }
        .filter-area::-webkit-scrollbar-track { background: transparent; }

        .filter-btn { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: #ccc; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .filter-btn.active { background: white; color: #333; border-color: white; transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .filter-btn[data-st="estimate"].active { color: #e67e22; border-color: #e67e22; }
        .filter-btn[data-st="contract"].active { color: #2980b9; border-color: #2980b9; }
        .filter-btn[data-st="billing"].active { color: #8e44ad; border-color: #8e44ad; }
        .filter-btn[data-st="complete"].active { color: #7f8c8d; border-color: #7f8c8d; }
        .filter-btn[data-st="lost"].active { color: #333; border-color: #333; }

        .container { max-width: 600px; margin: 0 auto; padding: 15px; padding-top: 20px; padding-bottom: 100px; }
        
        .site-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); position: relative; transition: transform 0.2s; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .case-no { font-size: 0.8rem; color: #666; background: #eee; padding: 3px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; }
        
        .status-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; }
        .st-estimate { background-color: #fff3e0; color: #f57c00; border: 1px solid #ffe0b2; }
        .st-contract { background-color: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
        .st-billing { background-color: #f3e5f5; color: #8e24aa; border: 1px solid #e1bee7; }
        .st-complete { background-color: #f5f5f5; color: #757575; border: 1px solid #e0e0e0; }
        .st-lost { background-color: #333; color: #fff; border: 1px solid #000; }

        .site-name { font-size: 1.25rem; font-weight: bold; margin-bottom: 6px; line-height: 1.4; }
        .site-address { font-size: 0.9rem; color: #555; margin-bottom: 16px; display: flex; align-items: center; gap: 4px; }
        
        .card-actions { margin-top: 15px; display: flex; gap: 8px; align-items: flex-end; }
        .action-btn { border-radius: 6px; font-weight: bold; text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: opacity 0.1s; line-height: 1; height: 60px; width: 100%; position: relative; overflow: hidden; user-select: none; }
        .action-btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-navi-side { flex: 1.5; background-color: #00C853; color: white; font-size: 0.9rem; }
        .btn-center { flex: 1; background-color: #fdf2e9; border: 1px solid #f5c6cb; color: #d35400; font-size: 0.8rem; }
        .navi-wrapper { flex: 1.5; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .navi-count-label { font-size: 0.7rem; color: #888; font-family: monospace; font-weight: bold; }
        
        /* å·¦ãƒœã‚¿ãƒ³ç”¨ï¼šæ¸›ã‚‹æ¼”å‡ºï¼ˆèµ¤ï¼‰ - 5ç§’è¨­å®š */
        .hold-bar { position: absolute; top: 0; left: 0; height: 6px; background-color: #e74c3c; opacity: 0.8; width: 100%; transition: width 0s; z-index: 0; }
        .holding .hold-bar { width: 0%; transition: width 5.0s linear; }

        /* å·¦ãƒœã‚¿ãƒ³ç”¨ï¼šå¢—ãˆã‚‹æ¼”å‡ºï¼ˆé’ï¼‰ - 5ç§’è¨­å®š */
        .hold-bar-plus { position: absolute; top: 0; left: 0; height: 100%; background-color: rgba(41, 128, 185, 0.5); width: 0%; transition: width 0s; pointer-events: none; z-index: 0; }
        .holding-plus .hold-bar-plus { width: 100%; transition: width 5.0s linear; }
        
        /* ä¸­èº«ï¼ˆæ–‡å­—ãƒ»çµµæ–‡å­—ï¼‰ã ã‘ã‚’å‰é¢ã«å‡ºã™ãŸã‚ã®ã‚¯ãƒ©ã‚¹ */
        .btn-content { position: relative; z-index: 2; pointer-events: none; text-align: center; }

        .sort-actions { display: none; width: 100%; gap: 8px; height: 60px; }
        body.sort-mode .card-actions { display: none; }
        body.sort-mode .sort-actions { display: flex; }
        .btn-up, .btn-down { flex: 1; background-color: #f39c12; color: white; font-size: 1.5rem; border-radius: 6px; border: none; cursor: pointer; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; display: none; opacity: 0; }
        .overlay.show { display: block; opacity: 1; }
        .modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; padding: 24px; border-radius: 16px; z-index: 160; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; max-height: 90vh; overflow-y: auto; }
        .modal-box.show { display: block; }
        
        label { display: block; margin-top: 12px; font-size: 0.85rem; font-weight: bold; color: #444; }
        input, select { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; appearance: none; }
        .date-group { display: flex; gap: 10px; align-items: center; }
        .date-input { flex: 1; text-align: center; }
        .id-input-group { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .input-year { width: 30%; text-align: center; background: #f0f0f0; color: #555; border: 1px solid #ccc; font-weight: bold; }
        .input-year:not([readonly]) { background: #fff; color: #d35400; border: 2px solid #e67e22; }
        .input-num { width: 60%; text-align: center; font-family: monospace; letter-spacing: 2px; font-weight: bold; transition: 0.3s; }
        .input-num.locked { background: #f9f9f9; color: #999; border: 1px solid #eee; cursor: not-allowed; }
        .input-num.unlocked { background: #fff; color: #d35400; border: 2px solid #e67e22; }

        .edit-footer { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;}
        .btn-del-single { width: 50px; background-color: #fff5f5; border: 1px solid #e74c3c; color: #e74c3c; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-copy { width: 50px; background-color: #e8f6f3; border: 1px solid #1abc9c; color: #16a085; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .save-btn { flex: 2; background-color: #2980b9; color: white; padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .cancel-btn { flex: 1; background-color: #e0e0e0; color: #333; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .settings-item { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #eee; background: #fcfcfc; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px; text-decoration: none; color: #333; box-sizing: border-box; }
        .settings-footer { display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-close { flex: 2; background-color: #95a5a6; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-delete-all { flex: 1; background-color: white; color: #e74c3c; border: 1px solid #e74c3c; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼ˆæŠ˜ã‚ŠãŸãŸã¿è¨­å®šï¼‰ */
        .accordion-box { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: white; overflow: hidden; }
        .accordion-box summary { background: #f1f2f6; padding: 12px 15px; cursor: pointer; font-weight: bold; font-size: 0.9rem; color: #2c3e50; list-style: none; display: flex; align-items: center; justify-content: space-between; user-select: none; }
        .accordion-box summary::-webkit-details-marker { display: none; }
        .accordion-box summary::after { content: 'â–¼'; font-size: 0.8rem; color: #888; transition: 0.2s; }
        .accordion-box[open] summary::after { transform: rotate(180deg); }
        .accordion-content { padding: 15px; border-top: 1px solid #eee; background: #fffcf5; }

        /* --- è¨­å®šç”»é¢ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        .tab-header { display: flex; gap: 5px; margin-bottom: 0; padding-bottom: 0; }
        .tab-btn { 
            flex: 1; padding: 12px; border: none; 
            border-radius: 12px 12px 0 0; cursor: pointer; 
            font-weight: bold; color: #888; background: #eee; 
            transition: 0.2s; border: 1px solid transparent; border-bottom: none;
        }
        
        /* ç¾å ´ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ï¼ˆç·‘ï¼‰ */
        .tab-btn.tab-site.active { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; z-index: 10; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        /* ç®¡ç†è€…ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ï¼ˆé’ï¼‰ */
        .tab-btn.tab-manager.active { background: #fff; color: #1565c0; border-color: #ddd; z-index: 10; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆã‚¿ãƒ–ã®ä¸­èº«ï¼‰ */
        .settings-content { 
            padding: 20px; border-radius: 0 0 12px 12px; 
            border: 1px solid #ddd; border-top: none; 
            min-height: 300px;
        }
        
        /* ç¾å ´ãƒ¢ãƒ¼ãƒ‰ã®èƒŒæ™¯è‰² */
        .mode-site-bg { background-color: #e8f5e9; border-color: #c8e6c9; }
        /* ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã®èƒŒæ™¯è‰² */
        .mode-manager-bg { background-color: #fff; border-color: #ddd; }

        /* ç®¡ç†è€…å°‚ç”¨ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆç¾å ´ã‚¿ãƒ–ã§ã¯æ¶ˆã™ï¼‰ */
        .manager-only { display: block; }
        .hide-in-site { display: none !important; }

        .fab-container { position: fixed; bottom: 24px; right: 20px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 90; }
        .fab-btn { width: 56px; height: 56px; border-radius: 28px; border: none; color: white; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; display: flex; justify-content: center; align-items: center; transition: transform 0.1s; }
        .add-fab { background-color: #2980b9; font-size: 30px; }
        .share-fab { background-color: #f39c12; font-size: 22px; }
        .fab-label { font-size: 10px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; margin-right: 8px; position: absolute; right: 60px; pointer-events: none; white-space: nowrap; }
        
        .notification { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(44, 62, 80, 0.95); color: #fff; padding: 12px 24px; border-radius: 30px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 200; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: max-content; max-width: 80%; text-align: center; }
        .notification.show { opacity: 1; top: 90px; }
        /* --- é€šä¿¡ä¸­ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ --- */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sync-spinner { 
            display: inline-block; 
            margin-left: 8px; 
            font-size: 1rem; 
            animation: spin 1s linear infinite; /* ã‚¯ãƒ«ã‚¯ãƒ«å›ã™ */
            vertical-align: middle;
        }
    </style>
</head>
<body>

<div class="fixed-header-group">

    <header>
        <div class="header-title-area">
            <h1>ğŸš— ç¾å ´ãƒŠãƒ“<span id="syncIndicator" style="display:none;">ğŸ”„</span></h1>
                        <a href="manager.html" class="link-control">ğŸ“Š å·¥ç¨‹ç®¡ç†</a>
        </div>
        <div class="header-btn-group">
            <span class="icon-btn" onclick="toggleSortMode()" title="ä¸¦ã³æ›¿ãˆ">â‡…</span>
            <span class="icon-btn" onclick="openSettings()" title="è¨­å®š">âš™ï¸</span>
        </div>
    </header>

    <div class="search-area">
        <input type="search" id="searchInput" class="search-input" placeholder="ğŸ” ç¾å ´åã‚„ä½æ‰€ã§æ¤œç´¢..." oninput="renderList()">
    </div>

    <div class="filter-area">
        <button class="filter-btn active" onclick="setFilter('all', this)">å…¨ã¦</button>
        <button class="filter-btn" data-st="estimate" onclick="setFilter('estimate', this)">è¦‹ç©ä¸­</button>
        <button class="filter-btn" data-st="contract" onclick="setFilter('contract', this)">å¥‘ç´„æ¸ˆ</button>
        <button class="filter-btn" data-st="billing" onclick="setFilter('billing', this)">è«‹æ±‚</button>
        <button class="filter-btn" data-st="complete" onclick="setFilter('complete', this)">å®Œäº†</button>
        <button class="filter-btn" data-st="lost" onclick="setFilter('lost', this)">å¤±æ³¨</button>
    </div>

</div>

<div class="container" id="siteList"></div>

<input type="file" id="jsonInput" accept=".json" style="display:none" onchange="importJSON(this)">
<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="inputForm" class="modal-box">
    <h3 style="margin-top:0; text-align:center;">ç¾å ´æƒ…å ±ã®ç·¨é›†</h3>
    <label>æ¡ˆä»¶No</label>
    <div class="id-input-group">
        <input type="number" id="inputYear" class="input-year" readonly oninput="checkExistingSite()">
        <span style="color:#888; font-weight:bold;">-</span>
        <input type="number" id="inputNum" class="input-num locked" readonly onclick="unlockCaseNo()" oninput="checkExistingSite()">
    </div>
    <label>è¦ªæ¡ˆä»¶No</label><input type="text" id="parentCaseNo" placeholder="ä¾‹ï¼šK-12345" style="background:#f9f9f9;">
    <label>ç¾å ´å</label><input type="text" id="siteName" placeholder="ä¾‹ï¼šéˆ´æœ¨æ§˜é‚¸">
    <label>ä½æ‰€</label><input type="text" id="address" placeholder="ä¾‹ï¼šæ±äº¬éƒ½åƒä»£ç”°åŒº...">
    <label>å·¥æœŸ</label>
    <div class="date-group">
        <input type="date" id="startDate" class="date-input">
        <span style="color:#888;">ã€œ</span>
        <input type="date" id="endDate" class="date-input">
    </div>
    <label>çŠ¶æ³</label>
    <select id="status">
        <option value="estimate">ğŸ“„ è¦‹ç©ä¸­</option>
        <option value="contract">ğŸ¤ å¥‘ç´„æ¸ˆã¿</option>
        <option value="billing">ğŸ’° è«‹æ±‚</option>
        <option value="complete">âœ… å®Œäº†</option>
        <option value="lost">âŒ å¤±æ³¨</option>
    </select>
    <div id="naviCountArea" style="display:none;"><label>ãƒŠãƒ“å›æ•°</label><input type="number" id="editNaviCount" value="0"></div>
    <div class="edit-footer">
        <button class="btn-del-single" id="btnDeleteSingle" onclick="deleteCurrentSite()">ğŸ—‘ï¸</button>
        <button class="btn-copy" id="btnDuplicate" onclick="duplicateSite()">Â©ï¸</button>
        <button class="cancel-btn" onclick="closeAllModals()">ä¸­æ­¢</button>
        <button class="save-btn" onclick="saveSite()">ä¿ å­˜</button>
    </div>
</div>

<div id="settingsModal" class="modal-box settings-menu" style="padding:0; background:transparent; box-shadow:none; width:95%; max-width:500px;">
    
    <div class="tab-header">
        <button class="tab-btn tab-site active" id="tabSite" onclick="switchSettingsTab('site')">â›‘ï¸ ç¾å ´</button>
        <button class="tab-btn tab-manager" id="tabManager" onclick="switchSettingsTab('manager')">ğŸ‘” ç®¡ç†è€…</button>
    </div>

    <div id="settingsBody" class="settings-content mode-site-bg">
        
        <h3 style="margin-top:0; margin-bottom:20px; text-align:center; opacity:0.7;">
            <span id="tabTitle">ç¾å ´ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
        </h3>

        <div style="margin-bottom:15px;">
            <label>ğŸ‘¤ å ±å‘Šè€…å</label>
            <input type="text" id="reporterName" placeholder="ä¾‹ï¼šå±±å²¡" onchange="saveSettings()" style="background:#fff;">
        </div>
        <div style="margin-bottom:15px;">
            <label>ğŸ“© æ—¥å ±é€ä¿¡å…ˆ</label>
            <input type="email" id="managerEmail" placeholder="example@gmail.com" onchange="saveSettings()" style="background:#fff;">
        </div>

        <div class="manager-only">
            <details class="accordion-box">
                <summary>ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ é€£æºè¨­å®š (GASãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼)</summary>
                <div class="accordion-content">
                    <p style="font-size:0.8rem; color:#e67e22; margin-top:0;">â€»ã“ã“ã‚’å¤‰æ›´ã™ã‚‹ã¨é€£æºãŒå‹•ã‹ãªããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
                    <label>â˜ï¸ GAS URL</label>
                    <input type="text" id="gasUrl" onchange="saveSettings()">
                    <label>ğŸ”‘ åˆè¨€è‘‰ (GASã¨åŒã˜ã«ã™ã‚‹)</label>
                        <input type="text" id="authKey" placeholder="è¨­å®šã—ãŸåˆè¨€è‘‰ã‚’å…¥åŠ›" onchange="saveSettings()">
                        
                    <label>ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID</label>
                    <input type="text" id="calendarId" onchange="saveSettings()">
                </div>
            </details>
        </div>
        
        <a href="index.html" class="settings-item">ğŸ” ã‚«ã‚¿ãƒ­ã‚°æ¤œç´¢ã¸</a>
        
        <div class="manager-only">
            <button class="settings-item" onclick="syncAllDataToCloud()" style="background:#e8f5e9; border-color:#a5d6a7; color:#2e7d32;">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
            <button class="settings-item" onclick="downloadFromCloud()" style="background:#fff3e0; border-color:#ffe0b2; color:#e65100;">ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å¾©å…ƒ (ä¸Šæ›¸ã)</button>
            <button class="settings-item" onclick="copyToClipboard()">ğŸ“‹ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç”¨ã‚³ãƒ”ãƒ¼</button>
            <button class="settings-item" onclick="exportCSV()">ğŸ’¾ CSVå‡ºåŠ›</button>
            <hr style="border:0; border-top:1px solid #eee;">
            <button class="settings-item" onclick="document.getElementById('jsonInput').click()">ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ</button>
        </div>

        <a href="help.html" class="settings-item">ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</a>
        
        <div class="settings-footer">
            <button class="btn-delete-all manager-only" onclick="deleteAllData()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
            <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<div class="fab-container">
    <div style="display:flex; align-items:center;">
        <button class="fab-btn add-fab" onclick="openForm('new')">ï¼‹</button>
    </div>
    
    <div style="display:flex; align-items:center;">
        <span class="fab-label">å…±æœ‰ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</span>
        <button class="fab-btn share-fab" onclick="handleBackupClick()">ğŸ“¤</button>
    </div>
</div>
<div id="notification" class="notification"></div>
<div id="backupModal" class="modal-box" style="text-align:center; max-width:300px;">
    <h3 style="margin-top:0;">ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
    <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">ä¿å­˜å…ˆã‚’é¸ã‚“ã§ãã ã•ã„</p>
    
    <div id="backupModal" class="modal-box" style="text-align:center; max-width:300px;">
    <button onclick="syncAllDataToCloud()" style="width:100%; padding:15px; background:#2980b9; color:white; border:none; border-radius:8px; font-weight:bold; font-size:1rem; margin-bottom:10px; display:flex; align-items:center; justify-content:center; gap:10px;">
        â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜<br><span style="font-size:0.7rem; font-weight:normal;">(ã‚µãƒ¼ãƒãƒ¼ã‚’ä¸Šæ›¸ã)</span>
    </button>
    
    </div>
    
    <button onclick="exportJSON(); closeAllModals();" style="width:100%; padding:15px; background:#f39c12; color:white; border:none; border-radius:8px; font-weight:bold; font-size:1rem; display:flex; align-items:center; justify-content:center; gap:10px;">
        ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜<br><span style="font-size:0.7rem; font-weight:normal;">(ã‚¹ãƒãƒ›å†…ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)</span>
    </button>
    
    <button class="btn-close" onclick="closeAllModals()" style="margin-top:15px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<script>
    let sites = JSON.parse(localStorage.getItem('dx_sites')) || [];
    let isEditing = false, tapCount = 0, editingId = null, isSortMode = false, pressTimer = null; 
    let currentFilter = 'all';
    
    // â˜…è¿½åŠ ï¼šé€£æ‰“é˜²æ­¢ç”¨ã®å¤‰æ•°ï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç”¨ï¼‰
    let lastCheckTime = 0; 

    if (sites.length === 0) {
        sites = [];
    }

    document.addEventListener('DOMContentLoaded', function() {
        renderList();
        if(localStorage.getItem('dx_reporter_name')) document.getElementById('reporterName').value = localStorage.getItem('dx_reporter_name');
        if(localStorage.getItem('dx_manager_email')) document.getElementById('managerEmail').value = localStorage.getItem('dx_manager_email');
        if(localStorage.getItem('dx_gas_url')) document.getElementById('gasUrl').value = localStorage.getItem('dx_gas_url');
        if(localStorage.getItem('dx_calendar_id')) document.getElementById('calendarId').value = localStorage.getItem('dx_calendar_id');
        if(localStorage.getItem('dx_auth_key')) {
    document.getElementById('authKey').value = localStorage.getItem('dx_auth_key');
        }
        checkAutoLost();
        
        // --- â˜…ã“ã“ã‹ã‚‰è‡ªå‹•æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ ---
        // 1. èµ·å‹•æ™‚ã«ã¾ãš1å›ãƒã‚§ãƒƒã‚¯
        checkForCloudUpdates(); 

        // 2. ãã®å¾Œã¯ã€Œ60ç§’ã”ã¨ã€ã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰
        setInterval(checkForCloudUpdates, 60000);

        // 3. ã€Œç”»é¢ãŒè¡¨ç¤ºã•ã‚ŒãŸç¬é–“ï¼ˆãƒã‚±ãƒƒãƒˆã‹ã‚‰å‡ºã—ãŸæ™‚ãªã©ï¼‰ã€ã«æ›´æ–°ãƒã‚§ãƒƒã‚¯
        document.addEventListener("visibilitychange", function() {
            if (document.visibilityState === 'visible') {
                console.log("ç”»é¢ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚Šã¾ã—ãŸã€‚æ›´æ–°ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚");
                checkForCloudUpdates();
            }
        });
    });

    function checkAutoLost() {
        const now = Date.now();
        const oneYearMs = 31536000000; 
        let hasChanged = false; let count = 0;
        sites.forEach(site => {
            if (site.status === 'estimate' && site.updatedAt) {
                if ((now - site.updatedAt) > oneYearMs) {
                    site.status = 'lost'; site.updatedAt = now; hasChanged = true; count++;
                }
            }
        });
        if (hasChanged) {
            localStorage.setItem('dx_sites', JSON.stringify(sites));
            renderList();
            setTimeout(() => showNotification(`ğŸ•’ é•·æœŸæœªæ›´æ–°ã® ${count}ä»¶ã‚’ã€Œå¤±æ³¨ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`), 1000);
        }
    }

    function saveSettings() {
        localStorage.setItem('dx_reporter_name', document.getElementById('reporterName').value);
        localStorage.setItem('dx_manager_email', document.getElementById('managerEmail').value);
        localStorage.setItem('dx_gas_url', document.getElementById('gasUrl').value);
        localStorage.setItem('dx_calendar_id', document.getElementById('calendarId').value);
        // â˜…ã“ã“ã‚’è¿½åŠ ï¼
        localStorage.setItem('dx_auth_key', document.getElementById('authKey').value);
        showNotification('âš™ï¸ è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

    function setFilter(status, btn) {
        currentFilter = status;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderList();
        if (status !== 'all') {
            showNotification(`ğŸ” ã€Œ${btn.innerText}ã€ã§çµã‚Šè¾¼ã¿ (æ¡ˆä»¶Noé †)`);
        } else {
            showNotification('ğŸ“‹ å…¨ã¦è¡¨ç¤º');
        }
    }

    // å·¦ãƒœã‚¿ãƒ³ï¼ˆæ¸›ã‚‹æ¼”å‡ºï¼‰ã®åˆ¶å¾¡
    function handleTouchStart(btn, id, address) {
        if (btn.classList.contains('holding')) return;
        btn.dataset.startTime = Date.now();
        btn.classList.add('holding'); 
        pressTimer = setTimeout(() => {
            if (navigator.vibrate) navigator.vibrate(100); 
            btn.classList.remove('holding'); updateNaviCount(id, -1); 
            showNotification('ä¿®æ­£ã—ã¾ã—ãŸï¼šã‚«ã‚¦ãƒ³ãƒˆ -1'); pressTimer = null; 
            btn.dataset.startTime = 0; 
        }, 5000); 
    }

    function handleTouchEnd(btn, id, address) {
        if (pressTimer) {
            clearTimeout(pressTimer); pressTimer = null; btn.classList.remove('holding');
        }
        const pressTime = Date.now() - (parseInt(btn.dataset.startTime) || 0);
        if (pressTime > 0 && pressTime < 500) {
            updateNaviCount(id, 1);
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`, '_blank');
        }
    }

    // --- å³ãƒœã‚¿ãƒ³åˆ¶å¾¡ ---
    let rightPressTimer = null;
    let isRightLongPress = false;

    function handleRightStart(btn, id) {
        btn.dataset.startTime = Date.now();
        const card = btn.closest('.site-card');
        const leftBtn = card.querySelector('.card-actions > .action-btn:first-child');
        if (!leftBtn || leftBtn.classList.contains('holding-plus')) return;
        isRightLongPress = false;
        leftBtn.classList.add('holding-plus');
        rightPressTimer = setTimeout(() => {
            isRightLongPress = true; 
            if (navigator.vibrate) navigator.vibrate(100);
            leftBtn.classList.remove('holding-plus');
            updateNaviCount(id, 1);
            showNotification('ä¿®æ­£ã—ã¾ã—ãŸï¼šã‚«ã‚¦ãƒ³ãƒˆ +1');
            btn.dataset.startTime = 0;
        }, 5000);
    }

    function handleRightEnd(btn) {
        const card = btn.closest('.site-card');
        const leftBtn = card.querySelector('.card-actions > .action-btn:first-child');
        if (rightPressTimer) { clearTimeout(rightPressTimer); rightPressTimer = null; }
        if(leftBtn) leftBtn.classList.remove('holding-plus'); 
    }

    function handleRightClick(e, id) {
        const btn = e.currentTarget;
        const pressTime = Date.now() - (parseInt(btn.dataset.startTime) || 0);
        if (isRightLongPress || pressTime >= 500 || pressTime <= 0) {
            e.preventDefault(); return false;
        }
        updateNaviCount(id, 1);
        return true;
    }
    // ----------------------------------------

    function updateNaviCount(id, delta) {
        const idx = sites.findIndex(s => s.id === id);
        if (idx !== -1) {
            sites[idx].naviCount = Math.max(0, (sites[idx].naviCount || 0) + delta);
            sites[idx].updatedAt = Date.now();
            localStorage.setItem('dx_sites', JSON.stringify(sites));
            renderList();
        }
    }
    function toggleSortMode() { isSortMode = !isSortMode; document.body.classList.toggle('sort-mode', isSortMode); showNotification(isSortMode ? 'â‡… ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ï¼šON' : 'ä¸¦ã³æ›¿ãˆçµ‚äº†'); renderList(); }

    function getStatusText(status) {
        const map = { 'estimate':'è¦‹ç©ä¸­', 'contract':'å¥‘ç´„æ¸ˆã¿', 'billing':'è«‹æ±‚', 'complete':'å®Œäº†', 'lost':'å¤±æ³¨' };
        return map[status] || 'è¦‹ç©ä¸­';
    }

    function renderList() {
        const listEl = document.getElementById('siteList');
        const kw = document.getElementById('searchInput').value.toLowerCase();
        listEl.innerHTML = '';
        if (sites.length === 0) { listEl.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>å³ä¸‹ã®ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>'; return; }
        let displaySites = [...sites];
        if (currentFilter !== 'all') {
            displaySites = displaySites.filter(s => {
                if (currentFilter === 'contract') return s.status === 'contract' || s.status === 'active';
                if (currentFilter === 'complete') return s.status === 'complete' || s.status === 'done';
                return s.status === currentFilter;
            });
            displaySites.sort((a, b) => { if (a.id < b.id) return 1; if (a.id > b.id) return -1; return 0; });
        }
        displaySites.forEach((site) => {
            const originalIndex = sites.findIndex(s => s.id === site.id);
            if (kw && !site.name.toLowerCase().includes(kw) && !site.address.toLowerCase().includes(kw) && !site.id.includes(kw)) return;
            let stLabel = 'è¦‹ç©ä¸­', stClass = 'st-estimate';
            if(site.status === 'contract' || site.status === 'active') { stLabel = 'å¥‘ç´„æ¸ˆã¿'; stClass = 'st-contract'; }
            if(site.status === 'billing') { stLabel = 'è«‹æ±‚'; stClass = 'st-billing'; }
            if(site.status === 'complete' || site.status === 'done') { stLabel = 'å®Œäº†'; stClass = 'st-complete'; }
            if(site.status === 'lost') { stLabel = 'å¤±æ³¨'; stClass = 'st-lost'; }
            const sortButtons = (currentFilter === 'all') ? `<div class="sort-actions"><button class="btn-up" onclick="moveItem(${originalIndex},-1)">â¬†ï¸</button><button class="btn-down" onclick="moveItem(${originalIndex},1)">â¬‡ï¸</button></div>` : '';
            const html = `
                <div class="site-card">
                    <div class="card-header"><span class="case-no">${site.id}</span><span class="status-badge ${stClass}">${stLabel}</span></div>
                    <div class="site-name">${site.name}</div>
                    <div class="site-address">ğŸ“ ${site.address}</div>
                    <div class="card-actions">
                        <div class="action-btn btn-navi-side" 
                             onmousedown="handleTouchStart(this,'${site.id}','${site.address}')" 
                             onmouseup="handleTouchEnd(this,'${site.id}','${site.address}')" 
                             onmouseleave="handleTouchEnd(this,'${site.id}','${site.address}')" 
                             ontouchstart="handleTouchStart(this,'${site.id}','${site.address}')" 
                             ontouchend="handleTouchEnd(this,'${site.id}','${site.address}')" 
                             ontouchcancel="handleTouchEnd(this,'${site.id}','${site.address}')" 
                             oncontextmenu="return false;">
                            <div class="btn-content">ğŸš€<br><span style="font-size:0.7rem">ãƒŠãƒ“</span></div>
                            <div class="hold-bar"></div><div class="hold-bar-plus"></div>
                        </div>
                        <a href="tools.html?id=${site.id}" class="action-btn btn-center"><div class="btn-content">ğŸ§°<br><span style="font-size:0.7rem">ãƒ„ãƒ¼ãƒ«</span></div></a>
                        <div class="navi-wrapper"><span class="navi-count-label">${site.naviCount||0}å›</span>
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(site.address)}" target="_blank" class="action-btn btn-navi-side" 
                           onclick="return handleRightClick(event, '${site.id}')"
                           onmousedown="handleRightStart(this, '${site.id}')" 
                           onmouseup="handleRightEnd(this)" 
                           onmouseleave="handleRightEnd(this)" 
                           ontouchstart="handleRightStart(this, '${site.id}')" 
                           ontouchend="handleRightEnd(this)" 
                           ontouchcancel="handleRightEnd(this)" 
                           oncontextmenu="return false;">
                           <div class="btn-content">ğŸš€<br><span style="font-size:0.7rem">ãƒŠãƒ“</span></div>
                        </a></div>
                    </div>
                    ${sortButtons}
                </div>`;
            listEl.insertAdjacentHTML('beforeend', html);
        });
    }
    function moveItem(index, direction) {
        if(currentFilter !== 'all') return;
        if ((direction === -1 && index > 0) || (direction === 1 && index < sites.length - 1)) {
            [sites[index], sites[index + direction]] = [sites[index + direction], sites[index]];
            localStorage.setItem('dx_sites', JSON.stringify(sites)); renderList();
        }
    }
    function duplicateSite() {
        const name = document.getElementById('siteName').value;
        if(!name) { showNotification('âš ï¸ ç¾å ´åãŒå¿…è¦ã§ã™'); return; }
        if(!confirm('ã‚³ãƒ”ãƒ¼ã—ã¦æ–°è¦ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;
        const y = new Date().getFullYear(), num = getNextNum(y), id = `${y}-${num}`;
        sites.unshift({ id, name: name+' (ã‚³ãƒ”ãƒ¼)', address: document.getElementById('address').value, status: 'estimate', parentCaseNo: document.getElementById('parentCaseNo').value, updatedAt: Date.now(), naviCount: 0, start:'', end:'' });
        localStorage.setItem('dx_sites', JSON.stringify(sites)); closeAllModals(); renderList(); showNotification('ğŸ‰ è¤‡è£½ã—ã¾ã—ãŸ'); setTimeout(()=>openForm('edit',id),500);
    }
    function saveSite() {
        const id = `${document.getElementById('inputYear').value}-${document.getElementById('inputNum').value}`;
        const name = document.getElementById('siteName').value;
        if(!name) { showNotification('âš ï¸ ç¾å ´åãŒå¿…è¦ã§ã™'); return; }
        const data = {
            id, name, address: document.getElementById('address').value, status: document.getElementById('status').value,
            naviCount: parseInt(document.getElementById('editNaviCount').value)||0,
            parentCaseNo: document.getElementById('parentCaseNo').value,
            start: document.getElementById('startDate').value, end: document.getElementById('endDate').value, updatedAt: Date.now()
        };
        if(isEditing) {
            const idx = sites.findIndex(s => s.id === editingId);
            if(idx !== -1) sites[idx] = data; else sites.unshift(data);
        } else {
            if(sites.some(s=>s.id===id)){ if(!confirm('ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ'))return; const idx=sites.findIndex(s=>s.id===id); sites[idx]=data; }
            else sites.unshift(data);
        }
        localStorage.setItem('dx_sites', JSON.stringify(sites)); closeAllModals(); renderList(); showNotification('ğŸ‰ ä¿å­˜ã—ã¾ã—ãŸ');
    }
    function deleteCurrentSite() { if(editingId && confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { sites = sites.filter(s=>s.id!==editingId); localStorage.setItem('dx_sites', JSON.stringify(sites)); closeAllModals(); renderList(); showNotification('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ'); } }
    function openForm(mode, id=null) {
        document.getElementById('inputForm').classList.add('show'); document.getElementById('overlay').classList.add('show');
        const yearInput = document.getElementById('inputYear'); yearInput.readOnly = false;
        const numInput = document.getElementById('inputNum'); numInput.readOnly = true; numInput.className = 'input-num locked'; tapCount = 0;
        if(mode==='new') {
            isEditing=false; editingId=null;
            document.getElementById('btnDeleteSingle').style.display='none'; document.getElementById('btnDuplicate').style.display='none'; document.getElementById('naviCountArea').style.display='none';
            const y = new Date().getFullYear(); document.getElementById('inputYear').value=y; document.getElementById('inputNum').value=getNextNum(y);
            document.getElementById('siteName').value=''; document.getElementById('address').value=''; document.getElementById('status').value='estimate'; document.getElementById('parentCaseNo').value=''; document.getElementById('startDate').value=''; document.getElementById('endDate').value='';
        } else {
            isEditing=true; editingId=id;
            document.getElementById('btnDeleteSingle').style.display='flex'; document.getElementById('btnDuplicate').style.display='flex'; document.getElementById('naviCountArea').style.display='block';
            const s = sites.find(x=>x.id===id);
            if(s) {
                const p = s.id.split('-'); document.getElementById('inputYear').value=p[0]; document.getElementById('inputNum').value=p[1];
                document.getElementById('siteName').value=s.name; document.getElementById('address').value=s.address; document.getElementById('status').value=s.status; document.getElementById('editNaviCount').value=s.naviCount||0; document.getElementById('parentCaseNo').value=s.parentCaseNo||''; document.getElementById('startDate').value=s.start||''; document.getElementById('endDate').value=s.end||'';
            }
        }
    }
    function checkExistingSite() {
        const id = `${document.getElementById('inputYear').value}-${document.getElementById('inputNum').value}`;
        const s = sites.find(x=>x.id===id);
        if(s) {
            document.getElementById('siteName').value=s.name; document.getElementById('address').value=s.address; document.getElementById('status').value=s.status; document.getElementById('parentCaseNo').value=s.parentCaseNo||''; document.getElementById('editNaviCount').value=s.naviCount||0; document.getElementById('startDate').value=s.start||''; document.getElementById('endDate').value=s.end||'';
            isEditing=true; editingId=id; document.getElementById('btnDeleteSingle').style.display='flex'; document.getElementById('btnDuplicate').style.display='flex'; document.getElementById('naviCountArea').style.display='block';
        } else {
            isEditing=false; editingId=null; document.getElementById('btnDeleteSingle').style.display='none'; document.getElementById('btnDuplicate').style.display='none'; document.getElementById('naviCountArea').style.display='none';
        }
    }
    function getNextNum(y) { let max=0; sites.filter(s=>s.id.startsWith(y)).forEach(s=>{ const n=parseInt(s.id.split('-')[1]); if(n>max)max=n; }); return (max+1).toString().padStart(3,'0'); }
    
    // é–‹ãã¨ãã¯ã€Œç¾å ´ã‚¿ãƒ–ã€ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ã™ã‚‹
    function openSettings() { 
        document.getElementById('overlay').classList.add('show'); 
        document.getElementById('settingsModal').classList.add('show'); 
        switchSettingsTab('site'); 
    }
    
    function closeAllModals() { document.querySelectorAll('.modal-box').forEach(el=>el.classList.remove('show')); document.getElementById('overlay').classList.remove('show'); }
    function unlockCaseNo() { tapCount++; if(tapCount>=5){ const el=document.getElementById('inputNum'); el.readOnly=false; el.className='input-num unlocked'; showNotification('ğŸ”“ ãƒ­ãƒƒã‚¯è§£é™¤'); tapCount=0; } }
    function getNowStr() { const d=new Date(); return `${d.getFullYear()}${('0'+(d.getMonth()+1)).slice(-2)}${('0'+d.getDate()).slice(-2)}`; }
    
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
    function switchSettingsTab(mode) {
        const body = document.getElementById('settingsBody');
        const tabSite = document.getElementById('tabSite');
        const tabManager = document.getElementById('tabManager');
        const title = document.getElementById('tabTitle');
        const managerItems = document.querySelectorAll('.manager-only');

        if (mode === 'site') {
            tabSite.classList.add('active'); tabManager.classList.remove('active');
            body.className = 'settings-content mode-site-bg'; title.innerText = 'â›‘ï¸ ç¾å ´ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (å®‰å…¨ãƒ¢ãƒ¼ãƒ‰)';
            managerItems.forEach(el => el.classList.add('hide-in-site'));
        } else {
            tabManager.classList.add('active'); tabSite.classList.remove('active');
            body.className = 'settings-content mode-manager-bg'; title.innerText = 'ğŸ‘” ç®¡ç†è€…è¨­å®š (ãƒ•ãƒ«æ©Ÿèƒ½)';
            managerItems.forEach(el => el.classList.remove('hide-in-site'));
            if(navigator.vibrate) navigator.vibrate(50);
        }
    }

    // ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ï¼ˆåŒæœŸãƒã‚°ä¿®æ­£ç‰ˆï¼‰
    async function syncAllDataToCloud() {
        if(!confirm("ç¾åœ¨ã‚¹ãƒãƒ›ã«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã§ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ä¸Šæ›¸ãä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;
        
        const targetUrl = localStorage.getItem('dx_gas_url');
        if(!targetUrl || targetUrl.includes("script.google.com") === false) { 
            alert("GAS URLã‚’è¨­å®šã—ã¦ãã ã•ã„"); return false; 
        }
        
        const authKey = localStorage.getItem('dx_auth_key') || "";

        // -----------------------------------------------------------
        // ğŸ•µï¸â€â™‚ï¸ ã‚¹ãƒ†ãƒƒãƒ—1ï¼šä¿å­˜ã™ã‚‹å‰ã«ã€å¿µã®ãŸã‚ã‚¯ãƒ©ã‚¦ãƒ‰ã®çŠ¶æ³ã‚’ãƒãƒ©è¦‹ã™ã‚‹
        // -----------------------------------------------------------
        showNotification("â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ç¢ºèªä¸­...");
        try {
            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ã‚’å–å¾—
            const checkRes = await fetch(targetUrl + "?type=getAll&authKey=" + authKey);
            const text = await checkRes.text(); 
            const cloudData = JSON.parse(text);      
            
            // ã‚¹ãƒãƒ›ã¨ã‚¯ãƒ©ã‚¦ãƒ‰ã€ã©ã£ã¡ãŒæ–°ã—ã„ã‹æ¯”è¼ƒ
            const localMax = sites.length > 0 ? Math.max(...sites.map(s => s.updatedAt || 0)) : 0;
            const cloudMax = Array.isArray(cloudData) && cloudData.length > 0 ? Math.max(...cloudData.map(s => s.updatedAt || 0)) : 0;
            
            // â˜…ã‚‚ã—ã‚¯ãƒ©ã‚¦ãƒ‰ã®æ–¹ãŒæ–°ã—ã‹ã£ãŸã‚‰...ã€Œå¾©å…ƒã€ã‚’ææ¡ˆã™ã‚‹ï¼
            if (cloudMax > localMax) {
                const cloudDate = new Date(cloudMax).toLocaleString();
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸æŠã—ã¦ã‚‚ã‚‰ã†
                if (confirm(`âš ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰å´ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ï¼ˆ${cloudDate}ï¼‰ã€‚\n\nä¿å­˜ã‚’ä¸­æ­¢ã—ã¦ã€æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nï¼ˆ[OK]ã‚’æŠ¼ã™ã¨å¾©å…ƒã‚’é–‹å§‹ã—ã¾ã™ï¼‰`)) {
                    // OKãªã‚‰ã€ä¿å­˜ã¯ã‚„ã‚ã¦å¾©å…ƒã¸ã‚¸ãƒ£ãƒ³ãƒ—
                    loadFromCloud(); 
                    return false; 
                } else {
                    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã‚‰ã€ã€Œå¼·å¼•ã«ä¸Šæ›¸ãã€ã—ã‚ˆã†ã¨ã™ã‚‹ï¼ˆã‘ã©ã€æ¬¡ã®GASãƒã‚§ãƒƒã‚¯ã§æ­¢ã¾ã‚‹ã‹ã‚‚ï¼‰
                    if(!confirm("âš ï¸ æœ¬å½“ã«ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\nã‚¯ãƒ©ã‚¦ãƒ‰ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã™ã€‚")) {
                        showNotification("ä¸­æ–­ã—ã¾ã—ãŸ");
                        return false;
                    }
                }
            }
        } catch(e) { 
            console.warn("äº‹å‰ãƒã‚§ãƒƒã‚¯å¤±æ•—:", e); 
            // ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚ã€ã¨ã‚Šã‚ãˆãšä¿å­˜ã«ã¯é€²ã‚“ã§ã¿ã‚‹
        }
        
        // -----------------------------------------------------------
        // ğŸš€ ã‚¹ãƒ†ãƒƒãƒ—2ï¼šã„ã–ã€é€ä¿¡ï¼ï¼ˆGASå´ã®é–€ç•ªãƒã‚§ãƒƒã‚¯å«ã‚€ï¼‰
        // -----------------------------------------------------------
        try {
            showNotification("â˜ï¸ é€ä¿¡ä¸­...");
            
            const response = await fetch(targetUrl, { 
                method: 'POST', 
                headers: { 'Content-Type': 'text/plain' }, 
                body: JSON.stringify({ 
                    type: "sync", 
                    data: sites, 
                    reporter: localStorage.getItem('dx_reporter_name') || "è·äºº",
                    
                    // â˜…æ­£ç›´ãªã€ŒåŒæœŸæ™‚é–“ã€ã‚’ç”³å‘Šï¼ˆå˜˜ã‚’ã¤ã‹ãªã„ï¼‰
                    clientTime: Number(localStorage.getItem('dx_sync_time') || 0),
                    
                    authKey: authKey
                })
            });

            const resText = await response.text(); 
            const resJson = JSON.parse(resText);   
            
            // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
            if (resJson.result === "success") { 
                // âœ… æˆåŠŸï¼
                localStorage.setItem('dx_sync_time', Date.now()); // è‡ªåˆ†ã®æ™‚é–“ã‚‚æ›´æ–°
                showNotification("âœ… é€ä¿¡å®Œäº†"); 
                alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸï¼"); 
                // â˜…è¿½åŠ ï¼šæˆåŠŸã—ãŸã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeAllModals();
                return true; 
            
            } else { 
                // â›” ã‚¨ãƒ©ãƒ¼ï¼ˆã§ã‚‚ä¸­èº«ã‚’è¦‹ã‚‹ï¼‰
                
                // ã‚‚ã—ã€Œã‚µãƒ¼ãƒãƒ¼ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã€ã¨ã„ã†ç†ç”±ãªã‚‰...
                if (resJson.error && resJson.error.includes("ã‚µãƒ¼ãƒãƒ¼ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿")) {
                    if (confirm("âš ï¸ ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nã‚µãƒ¼ãƒãƒ¼ã«èª°ã‹ãŒä¿å­˜ã—ãŸæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚\n\næœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ï¼ˆå¾©å…ƒï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) {
                        loadFromCloud(); // å¾©å…ƒã¸èª˜å°
                    }
                } else {
                    // ãã‚Œä»¥å¤–ã®æœ¬ç‰©ã®ã‚¨ãƒ©ãƒ¼
                    throw new Error(resJson.error || "GASã‚¨ãƒ©ãƒ¼");
                }
            }

        } catch(e) { 
            alert("é€ä¿¡å¤±æ•—: " + e); 
            return false; 
        }
    }

    async function downloadFromCloud() {
        const gasUrl = localStorage.getItem('dx_gas_url');
        if(!gasUrl) { alert("GAS URLè¨­å®šãªã—"); return; }
        if(!confirm("ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãå¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;
        showNotification('ğŸ“¥ å–å¾—ä¸­...');
        try {
            const res = await fetch(gasUrl + "?type=getAll");
            const text = await res.text(); const data = JSON.parse(text);       
            if(Array.isArray(data)) {
                sites = data; sites.sort((a, b) => (a.id > b.id ? -1 : 1));
                localStorage.setItem('dx_sites', JSON.stringify(sites));
                // â˜…ã“ã“ã«è¿½åŠ ã—ã¦ãã ã•ã„ï¼
                localStorage.setItem('dx_sync_time', Date.now());
                renderList(); closeAllModals(); showNotification(`âœ… å¾©å…ƒå®Œäº† (${sites.length}ä»¶)`);
            } else { alert("ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼"); }
        } catch(e) { alert("å–å¾—ã‚¨ãƒ©ãƒ¼: " + e); }
    }

    // â˜…ä¿®æ­£ç‰ˆï¼šè‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯ï¼ˆè¦–è¦šåŠ¹æœä»˜ãï¼‰
    async function checkForCloudUpdates() {
        const targetUrl = localStorage.getItem('dx_gas_url');
        if(!targetUrl) return;

        // é€£æ‰“ã‚¬ãƒ¼ãƒ‰ï¼ˆ10ç§’ï¼‰
        const now = Date.now();
        // lastCheckTime ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼é˜²æ­¢
        if (typeof lastCheckTime !== 'undefined' && now - lastCheckTime < 10000) {
            console.log("çŸ­æ™‚é–“ã®é€£æ‰“ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ");
            return;
        }
        lastCheckTime = now;

        // â˜…è¦–è¦šåŠ¹æœï¼šã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºã—ã¦å›ã™
        const indicator = document.getElementById('syncIndicator');
        if(indicator) {
            indicator.style.display = 'inline-block'; // è¡¨ç¤º
            indicator.classList.add('sync-spinner');  // å›ã™
        }

        // â˜…è¿½åŠ 1ï¼šåˆè¨€è‘‰ã‚’å–å¾—
        const authKey = localStorage.getItem('dx_auth_key') || "";

        try {
            // â˜…è¿½åŠ 2ï¼šURLã®å¾Œã‚ã«åˆè¨€è‘‰ã‚’ãã£ã¤ã‘ã‚‹ (&authKey=...)
            const res = await fetch(targetUrl + "?type=getAll&authKey=" + authKey);
            
            const text = await res.text(); 
            const cloudData = JSON.parse(text);
            
            if (Array.isArray(cloudData)) {
                // é…åˆ—ãŒç©ºã®å ´åˆã®ã‚¨ãƒ©ãƒ¼é˜²æ­¢ç­–ã¨ã—ã¦ || 0 ã‚’è¿½åŠ 
                const localMax = sites.length > 0 ? Math.max(...sites.map(s => s.updatedAt || 0)) : 0;
                const cloudMax = cloudData.length > 0 ? Math.max(...cloudData.map(s => s.updatedAt || 0)) : 0;
                
                if (cloudMax > localMax) {
                    // æ›´æ–°ãŒã‚ã£ãŸå ´åˆ
                    if (confirm(`ğŸ”„ ã‚¯ãƒ©ã‚¦ãƒ‰ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ï¼\nå–ã‚Šè¾¼ã¿ã¾ã™ã‹ï¼Ÿ`)) {
                        cloudData.sort((a, b) => (a.id > b.id ? -1 : 1));
                        sites = cloudData; 
                        localStorage.setItem('dx_sites', JSON.stringify(sites));
                        
                        // â˜…ã“ã“ã€ãƒãƒƒãƒãƒªåˆã£ã¦ã¾ã™ï¼
                        localStorage.setItem('dx_sync_time', Date.now());

                        alert("âœ… æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã—ã¾ã—ãŸï¼"); 
                        location.reload();
                    }
                }
            }
        } catch (e) { 
            console.log("æ›´æ–°ãƒã‚§ãƒƒã‚¯å¤±æ•—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®å¯èƒ½æ€§ï¼‰:", e); 
        } finally {
            // â˜…é‡è¦ï¼šæˆåŠŸã—ã¦ã‚‚å¤±æ•—ã—ã¦ã‚‚ã€æœ€å¾Œã«å¿…ãšã‚¢ã‚¤ã‚³ãƒ³ã‚’æ¶ˆã™
            if(indicator) {
                // ä¸€ç¬ã§æ¶ˆãˆã‚‹ã¨è¦‹é€ƒã™ã®ã§ã€0.5ç§’ã ã‘ä½™éŸ»ã‚’æ®‹ã—ã¦æ¶ˆã™
                setTimeout(() => {
                    indicator.classList.remove('sync-spinner'); // æ­¢ã‚ã‚‹
                    indicator.style.display = 'none';           // éš ã™
                }, 500);
            }
        }
    }

    async function exportCSV() { showNotification('ğŸ“¤ æº–å‚™ä¸­...'); let c = "\uFEFFæ¡ˆä»¶No,è¦ªæ¡ˆä»¶No,ç¾å ´å,ä½æ‰€,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,é–‹å§‹,çµ‚äº†\n"; sites.forEach(s => { c += `"${s.id}","${s.parentCaseNo||''}","${s.name}","${s.address}","${getStatusText(s.status)}","${s.start||''}","${s.end||''}"\n`; }); const f = new File([c], `ç¾å ´ãƒªã‚¹ãƒˆ_${getNowStr()}.csv`, { type: "text/csv" }); if (navigator.share && navigator.canShare({ files: [f] })) { try { await navigator.share({ files: [f] }); } catch (e) { forceDL(f); } } else { forceDL(f); } }
    function forceDL(f) { const u = URL.createObjectURL(f); const a = document.createElement("a"); a.href=u; a.download=f.name; document.body.appendChild(a); a.click(); document.body.removeChild(a); showNotification('ğŸ“¥ ä¿å­˜ã—ã¾ã—ãŸ'); }
    function copyToClipboard() { let t = ""; sites.forEach(s => { t += `${s.id}\t${s.parentCaseNo||''}\t${s.name}\t${s.address}\t${getStatusText(s.status)}\t${s.start||''}\t${s.end||''}\n`; }); navigator.clipboard.writeText(t).then(()=>showNotification('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')); }
    async function exportJSON() { const f = new File([JSON.stringify(sites,null,2)], `backup_${getNowStr()}.json`, {type:"application/json"}); if(navigator.share&&navigator.canShare({files:[f]})) { try{await navigator.share({files:[f]});}catch(e){forceDL(f);} } else { forceDL(f); } }
    function importJSON(input) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(e){ try{ const d=JSON.parse(e.target.result); if(!Array.isArray(d)){alert('ã‚¨ãƒ©ãƒ¼');return;} let add=0,upd=0; d.forEach(n=>{ const i=sites.findIndex(s=>s.id===n.id); if(i!==-1){ if((n.updatedAt||0)>(sites[i].updatedAt||0)){sites[i]=n;upd++;} }else{sites.push(n);add++;} }); sites.sort((a,b)=>(a.id>b.id?-1:1)); localStorage.setItem('dx_sites',JSON.stringify(sites)); renderList(); closeAllModals(); showNotification(`å¾©å…ƒ: ${upd}ä»¶æ›´æ–°, ${add}ä»¶è¿½åŠ `); }catch(e){alert('èª­è¾¼å¤±æ•—');} input.value=''; }; r.readAsText(f); }
    function deleteAllData() { if(confirm('æœ¬å½“ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { sites=[]; localStorage.setItem('dx_sites',JSON.stringify(sites)); renderList(); closeAllModals(); showNotification('ğŸ—‘ï¸ å…¨å‰Šé™¤å®Œäº†'); } }
    function showNotification(msg) { const el = document.getElementById('notification'); el.textContent = msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 2000); }
    // â˜…è¿½åŠ ï¼šãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã®æŒ™å‹•åˆ¶å¾¡
    function handleBackupClick() {
        const gasUrl = localStorage.getItem('dx_gas_url');
        
        // ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šãŒã‚ã‚‹å ´åˆ â†’ é¸æŠç”»é¢ã‚’å‡ºã™
        if (gasUrl && gasUrl.trim() !== "") {
            document.getElementById('overlay').classList.add('show');
            document.getElementById('backupModal').classList.add('show');
        } 
        // ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šãŒãªã„å ´åˆ â†’ ã„ããªã‚ŠJSONä¿å­˜ï¼ˆä»Šã¾ã§é€šã‚Šï¼‰
        else {
            exportJSON();
        }
    }
    function togglePasswordVisibility() {
    const input = document.getElementById("authKey");
    if (input.type === "password") {
        input.type = "text"; // è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
    } else {
        input.type = "password"; // éš ã™
    }
    }
</script>
</body>
</html>
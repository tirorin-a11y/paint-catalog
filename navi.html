<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å ´ãƒŠãƒ“ - è·äººã‚®ã‚¢</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³å®šç¾© --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; color: #333; -webkit-font-smoothing: antialiased; }
        header { background-color: #2c3e50; color: white; padding: 10px 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .header-title-area { display: flex; align-items: baseline; gap: 8px; }
        h1 { margin: 0; font-size: 1.1rem; letter-spacing: 0.05em; font-weight: bold; }
        .link-control { font-size: 0.75rem; color: #95a5a6; text-decoration: none; border: 1px solid #555; padding: 2px 6px; border-radius: 4px; transition: 0.2s; }
        .link-control:hover { color: white; border-color: white; }
        .header-btn-group { display: flex; align-items: center; gap: 15px; }
        .icon-btn { font-size: 1.4rem; cursor: pointer; text-decoration: none; color: white; display: flex; align-items: center; }
        /* ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ä¸­ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’é»„è‰²ã«ã™ã‚‹ */
        body.sort-mode .icon-btn[onclick="toggleSortMode()"] {
        color: #f39c12;
        text-shadow: 0 0 5px rgba(243, 156, 18, 0.5);
        }

        .search-area { background: #34495e; padding: 10px 15px 5px 15px; position: sticky; top: 50px; z-index: 99; }
        .search-input { width: 100%; padding: 10px; border-radius: 6px; border: none; font-size: 1rem; box-sizing: border-box; outline: none; }
        
        /* â˜… ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œï¼‰ */
        .filter-area { background: #34495e; padding: 5px 15px 15px 15px; position: sticky; top: 96px; z-index: 99; display: flex; gap: 8px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; box-shadow: 0 4px 5px rgba(0,0,0,0.1); }
        .filter-area::-webkit-scrollbar { display: none; } /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼æ¶ˆã™ */
        .filter-btn { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: #ccc; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .filter-btn.active { background: white; color: #333; border-color: white; transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        /* å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è‰²ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ï¼‰ */
        .filter-btn[data-st="estimate"].active { color: #e67e22; border-color: #e67e22; }
        .filter-btn[data-st="contract"].active { color: #2980b9; border-color: #2980b9; }
        .filter-btn[data-st="billing"].active { color: #8e44ad; border-color: #8e44ad; }
        .filter-btn[data-st="complete"].active { color: #7f8c8d; border-color: #7f8c8d; }
        .filter-btn[data-st="lost"].active { color: #333; border-color: #333; }

        .container { max-width: 600px; margin: 0 auto; padding: 15px; padding-top: 20px; padding-bottom: 100px; }
        
        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .site-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); position: relative; transition: transform 0.2s; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .case-no { font-size: 0.8rem; color: #666; background: #eee; padding: 3px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; }
        
        .status-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; }
        .st-estimate { background-color: #fff3e0; color: #f57c00; border: 1px solid #ffe0b2; }
        .st-contract { background-color: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
        .st-billing { background-color: #f3e5f5; color: #8e24aa; border: 1px solid #e1bee7; }
        .st-complete { background-color: #f5f5f5; color: #757575; border: 1px solid #e0e0e0; }
        .st-lost { background-color: #333; color: #fff; border: 1px solid #000; }

        .site-name { font-size: 1.25rem; font-weight: bold; margin-bottom: 6px; line-height: 1.4; }
        .site-address { font-size: 0.9rem; color: #555; margin-bottom: 16px; display: flex; align-items: center; gap: 4px; }
        
        .card-actions { margin-top: 15px; display: flex; gap: 8px; align-items: flex-end; }
        .action-btn { border-radius: 6px; font-weight: bold; text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: opacity 0.1s; line-height: 1; height: 60px; width: 100%; position: relative; overflow: hidden; user-select: none; }
        .action-btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-navi-side { flex: 1.5; background-color: #00C853; color: white; font-size: 0.9rem; }
        .btn-center { flex: 1; background-color: #fdf2e9; border: 1px solid #f5c6cb; color: #d35400; font-size: 0.8rem; }
        .navi-wrapper { flex: 1.5; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .navi-count-label { font-size: 0.7rem; color: #888; font-family: monospace; font-weight: bold; }
        .hold-bar { position: absolute; top: 0; left: 0; height: 6px; background-color: #e74c3c; opacity: 0.8; width: 100%; transition: width 0s; }
        .holding .hold-bar { width: 0%; transition: width 2.0s linear; }

        .sort-actions { display: none; width: 100%; gap: 8px; height: 60px; }
        body.sort-mode .card-actions { display: none; }
        body.sort-mode .sort-actions { display: flex; }
        .btn-up, .btn-down { flex: 1; background-color: #f39c12; color: white; font-size: 1.5rem; border-radius: 6px; border: none; cursor: pointer; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; display: none; opacity: 0; }
        .overlay.show { display: block; opacity: 1; }
        .modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; padding: 24px; border-radius: 16px; z-index: 160; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; max-height: 90vh; overflow-y: auto; }
        .modal-box.show { display: block; }
        
        label { display: block; margin-top: 12px; font-size: 0.85rem; font-weight: bold; color: #444; }
        input, select { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; appearance: none; }
        .date-group { display: flex; gap: 10px; align-items: center; }
        .date-input { flex: 1; text-align: center; }
        .id-input-group { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .input-year { width: 30%; text-align: center; background: #f0f0f0; color: #555; border: 1px solid #ccc; font-weight: bold; }
        .input-year:not([readonly]) { background: #fff; color: #d35400; border: 2px solid #e67e22; }
        .input-num { width: 60%; text-align: center; font-family: monospace; letter-spacing: 2px; font-weight: bold; transition: 0.3s; }
        .input-num.locked { background: #f9f9f9; color: #999; border: 1px solid #eee; cursor: not-allowed; }
        .input-num.unlocked { background: #fff; color: #d35400; border: 2px solid #e67e22; }

        .edit-footer { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;}
        .btn-del-single { width: 50px; background-color: #fff5f5; border: 1px solid #e74c3c; color: #e74c3c; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-copy { width: 50px; background-color: #e8f6f3; border: 1px solid #1abc9c; color: #16a085; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .save-btn { flex: 2; background-color: #2980b9; color: white; padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .cancel-btn { flex: 1; background-color: #e0e0e0; color: #333; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .settings-item { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #eee; background: #fcfcfc; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px; text-decoration: none; color: #333; box-sizing: border-box; }
        .settings-footer { display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-close { flex: 2; background-color: #95a5a6; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-delete-all { flex: 1; background-color: white; color: #e74c3c; border: 1px solid #e74c3c; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }

        .fab-container { position: fixed; bottom: 24px; right: 20px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 90; }
        .fab-btn { width: 56px; height: 56px; border-radius: 28px; border: none; color: white; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; display: flex; justify-content: center; align-items: center; transition: transform 0.1s; }
        .add-fab { background-color: #2980b9; font-size: 30px; }
        .share-fab { background-color: #f39c12; font-size: 22px; }
        .fab-label { font-size: 10px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; margin-right: 8px; position: absolute; right: 60px; pointer-events: none; white-space: nowrap; }
        
        .notification { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(44, 62, 80, 0.95); color: #fff; padding: 12px 24px; border-radius: 30px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 200; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: max-content; max-width: 80%; text-align: center; }
        .notification.show { opacity: 1; top: 90px; }
    </style>
</head>
<body>

<header>
    <div class="header-title-area">
        <h1>ğŸš— ç¾å ´ãƒŠãƒ“</h1>
        <a href="manager.html" class="link-control">ğŸ“Š å·¥ç¨‹ç®¡ç†</a>
    </div>
    <div class="header-btn-group">
        <span class="icon-btn" onclick="toggleSortMode()" title="ä¸¦ã³æ›¿ãˆ">â‡…</span>
        <span class="icon-btn" onclick="openSettings()" title="è¨­å®š">âš™ï¸</span>
    </div>
</header>

<div class="search-area">
    <input type="search" id="searchInput" class="search-input" placeholder="ğŸ” ç¾å ´åã‚„ä½æ‰€ã§æ¤œç´¢..." oninput="renderList()">
</div>

<div class="filter-area">
    <button class="filter-btn active" onclick="setFilter('all', this)">å…¨ã¦</button>
    <button class="filter-btn" data-st="estimate" onclick="setFilter('estimate', this)">è¦‹ç©ä¸­</button>
    <button class="filter-btn" data-st="contract" onclick="setFilter('contract', this)">å¥‘ç´„æ¸ˆ</button>
    <button class="filter-btn" data-st="billing" onclick="setFilter('billing', this)">è«‹æ±‚</button>
    <button class="filter-btn" data-st="complete" onclick="setFilter('complete', this)">å®Œäº†</button>
    <button class="filter-btn" data-st="lost" onclick="setFilter('lost', this)">å¤±æ³¨</button>
</div>

<div class="container" id="siteList"></div>

<input type="file" id="jsonInput" accept=".json" style="display:none" onchange="importJSON(this)">
<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="inputForm" class="modal-box">
    <h3 style="margin-top:0; text-align:center;">ç¾å ´æƒ…å ±ã®ç·¨é›†</h3>
    <label>æ¡ˆä»¶No</label>
    <div class="id-input-group">
        <input type="number" id="inputYear" class="input-year" readonly oninput="checkExistingSite()">
        <span style="color:#888; font-weight:bold;">-</span>
        <input type="number" id="inputNum" class="input-num locked" readonly onclick="unlockCaseNo()" oninput="checkExistingSite()">
    </div>
    <label>è¦ªæ¡ˆä»¶No</label><input type="text" id="parentCaseNo" placeholder="ä¾‹ï¼šK-12345" style="background:#f9f9f9;">
    <label>ç¾å ´å</label><input type="text" id="siteName" placeholder="ä¾‹ï¼šéˆ´æœ¨æ§˜é‚¸">
    <label>ä½æ‰€</label><input type="text" id="address" placeholder="ä¾‹ï¼šæ±äº¬éƒ½åƒä»£ç”°åŒº...">
    <label>å·¥æœŸ</label>
    <div class="date-group">
        <input type="date" id="startDate" class="date-input">
        <span style="color:#888;">ã€œ</span>
        <input type="date" id="endDate" class="date-input">
    </div>
    <label>çŠ¶æ³</label>
    <select id="status">
        <option value="estimate">ğŸ“„ è¦‹ç©ä¸­</option>
        <option value="contract">ğŸ¤ å¥‘ç´„æ¸ˆã¿</option>
        <option value="billing">ğŸ’° è«‹æ±‚</option>
        <option value="complete">âœ… å®Œäº†</option>
        <option value="lost">âŒ å¤±æ³¨</option>
    </select>
    <div id="naviCountArea" style="display:none;"><label>ãƒŠãƒ“å›æ•°</label><input type="number" id="editNaviCount" value="0"></div>
    <div class="edit-footer">
        <button class="btn-del-single" id="btnDeleteSingle" onclick="deleteCurrentSite()">ğŸ—‘ï¸</button>
        <button class="btn-copy" id="btnDuplicate" onclick="duplicateSite()">Â©ï¸</button>
        <button class="cancel-btn" onclick="closeAllModals()">ä¸­æ­¢</button>
        <button class="save-btn" onclick="saveSite()">ä¿ å­˜</button>
    </div>
</div>

<div id="settingsModal" class="modal-box settings-menu">
    <h3>âš™ï¸ è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
    <div style="margin-bottom:15px;"><label>ğŸ‘¤ å ±å‘Šè€…å</label><input type="text" id="reporterName" placeholder="ä¾‹ï¼šå±±å²¡" onchange="saveSettings()" style="background:#f9f9f9;"></div>
    <div style="margin-bottom:15px;"><label>ğŸ“© æ—¥å ±é€ä¿¡å…ˆ</label><input type="email" id="managerEmail" placeholder="example@gmail.com" onchange="saveSettings()" style="background:#f9f9f9;"></div>
    <div style="margin-bottom:15px;"><label>â˜ï¸ GAS URL</label><input type="text" id="gasUrl" placeholder="https://script.google.com/..." onchange="saveSettings()" style="background:#f9f9f9;"></div>
    <div style="margin-bottom:15px;"><label>ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID</label><input type="text" id="calendarId" onchange="saveSettings()" style="background:#f9f9f9;"></div>
    
    <a href="index.html" class="settings-item">ğŸ” ã‚«ã‚¿ãƒ­ã‚°æ¤œç´¢ã¸</a>
    
    <button class="settings-item" onclick="syncAllDataToCloud()" style="background:#e8f5e9; border-color:#a5d6a7; color:#2e7d32;">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
    <button class="settings-item" onclick="downloadFromCloud()" style="background:#fff3e0; border-color:#ffe0b2; color:#e65100;">ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å¾©å…ƒ (ä¸Šæ›¸ã)</button>

    <button class="settings-item" onclick="copyToClipboard()">ğŸ“‹ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç”¨ã‚³ãƒ”ãƒ¼</button>
    <button class="settings-item" onclick="exportCSV()">ğŸ’¾ CSVå‡ºåŠ›</button>
    <hr style="border:0; border-top:1px solid #eee;">
    <button class="settings-item" onclick="document.getElementById('jsonInput').click()">ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ</button>
    <a href="help.html" class="settings-item">ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</a>
    <div class="settings-footer">
        <button class="btn-delete-all" onclick="deleteAllData()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
        <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div class="fab-container">
    <div style="display:flex; align-items:center;"><span class="fab-label">å…±æœ‰ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</span><button class="fab-btn share-fab" onclick="exportJSON()">ğŸ“¤</button></div>
    <div style="display:flex; align-items:center;"><button class="fab-btn add-fab" onclick="openForm('new')">ï¼‹</button></div>
</div>
<div id="notification" class="notification"></div>

<script>
    let sites = JSON.parse(localStorage.getItem('dx_sites')) || [];
    let isEditing = false, tapCount = 0, editingId = null, isSortMode = false, pressTimer = null; 
    
    // â˜…è¿½åŠ ï¼šç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹
    let currentFilter = 'all';

    if (sites.length === 0) {
        sites = [];
    }

    document.addEventListener('DOMContentLoaded', function() {
        renderList();
        if(localStorage.getItem('dx_reporter_name')) document.getElementById('reporterName').value = localStorage.getItem('dx_reporter_name');
        if(localStorage.getItem('dx_manager_email')) document.getElementById('managerEmail').value = localStorage.getItem('dx_manager_email');
        if(localStorage.getItem('dx_gas_url')) document.getElementById('gasUrl').value = localStorage.getItem('dx_gas_url');
        if(localStorage.getItem('dx_calendar_id')) document.getElementById('calendarId').value = localStorage.getItem('dx_calendar_id');
        checkAutoLost();
        checkForCloudUpdates(); // èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯
    });

    function checkAutoLost() {
        const now = Date.now();
        const oneYearMs = 31536000000; 
        let hasChanged = false; let count = 0;
        sites.forEach(site => {
            if (site.status === 'estimate' && site.updatedAt) {
                if ((now - site.updatedAt) > oneYearMs) {
                    site.status = 'lost'; site.updatedAt = now; hasChanged = true; count++;
                }
            }
        });
        if (hasChanged) {
            localStorage.setItem('dx_sites', JSON.stringify(sites));
            renderList();
            setTimeout(() => showNotification(`ğŸ•’ é•·æœŸæœªæ›´æ–°ã® ${count}ä»¶ã‚’ã€Œå¤±æ³¨ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`), 1000);
        }
    }

    function saveSettings() {
        localStorage.setItem('dx_reporter_name', document.getElementById('reporterName').value);
        localStorage.setItem('dx_manager_email', document.getElementById('managerEmail').value);
        localStorage.setItem('dx_gas_url', document.getElementById('gasUrl').value);
        localStorage.setItem('dx_calendar_id', document.getElementById('calendarId').value);
        showNotification('âš™ï¸ è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }

    // â˜…è¿½åŠ ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
    function setFilter(status, btn) {
        currentFilter = status;
        
        // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®æ›´æ–°
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // ãƒªã‚¹ãƒˆå†æç”»
        renderList();
        
        if (status !== 'all') {
            showNotification(`ğŸ” ã€Œ${btn.innerText}ã€ã§çµã‚Šè¾¼ã¿ (æ¡ˆä»¶Noé †)`);
        } else {
            showNotification('ğŸ“‹ å…¨ã¦è¡¨ç¤º');
        }
    }

    function handleTouchStart(btn, id, address) {
        if (btn.classList.contains('holding')) return;
        btn.classList.add('holding'); 
        pressTimer = setTimeout(() => {
            if (navigator.vibrate) navigator.vibrate(100); 
            btn.classList.remove('holding'); updateNaviCount(id, -1); 
            showNotification('ä¿®æ­£ã—ã¾ã—ãŸï¼šã‚«ã‚¦ãƒ³ãƒˆ -1'); pressTimer = null; 
        }, 2000);
    }
    function handleTouchEnd(btn, id, address) {
        if (pressTimer) {
            clearTimeout(pressTimer); pressTimer = null; btn.classList.remove('holding');
            updateNaviCount(id, 1);
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`, '_blank');
        }
    }
    function updateNaviCount(id, delta) {
        const idx = sites.findIndex(s => s.id === id);
        if (idx !== -1) {
            sites[idx].naviCount = Math.max(0, (sites[idx].naviCount || 0) + delta);
            sites[idx].updatedAt = Date.now();
            localStorage.setItem('dx_sites', JSON.stringify(sites));
            renderList();
        }
    }
    function toggleSortMode() { isSortMode = !isSortMode; document.body.classList.toggle('sort-mode', isSortMode); showNotification(isSortMode ? 'â‡… ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ï¼šON' : 'ä¸¦ã³æ›¿ãˆçµ‚äº†'); renderList(); }

    function getStatusText(status) {
        const map = { 'estimate':'è¦‹ç©ä¸­', 'contract':'å¥‘ç´„æ¸ˆã¿', 'billing':'è«‹æ±‚', 'complete':'å®Œäº†', 'lost':'å¤±æ³¨' };
        return map[status] || 'è¦‹ç©ä¸­';
    }

    function renderList() {
        const listEl = document.getElementById('siteList');
        const kw = document.getElementById('searchInput').value.toLowerCase();
        listEl.innerHTML = '';
        
        if (sites.length === 0) {
            listEl.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>å³ä¸‹ã®ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
            return;
        }
        
        // â˜…ä¿®æ­£ï¼šè¡¨ç¤ºç”¨ã®ä¸€æ™‚ãƒªã‚¹ãƒˆã‚’ä½œã‚‹
        let displaySites = [...sites];

        // 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        if (currentFilter !== 'all') {
            displaySites = displaySites.filter(s => {
                // "contract"ãƒœã‚¿ãƒ³ãªã‚‰ "contract" ã¨ "active" ä¸¡æ–¹å‡ºã™ç­‰ã®èª¿æ•´ã‚‚å¯ã€‚
                // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ä¸€è‡´åˆ¤å®šï¼ˆãŸã ã—activeã¯contractæ‰±ã„ã«ã™ã‚‹ï¼‰
                if (currentFilter === 'contract') return s.status === 'contract' || s.status === 'active';
                if (currentFilter === 'complete') return s.status === 'complete' || s.status === 'done';
                return s.status === currentFilter;
            });
            
            // â˜…é‡è¦ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä¸­ã¯ã€Œæ¡ˆä»¶Noã®æ–°ã—ã„é †ï¼ˆé™é †ï¼‰ã€ã«å¼·åˆ¶ã‚½ãƒ¼ãƒˆï¼
            displaySites.sort((a, b) => {
                if (a.id < b.id) return 1;
                if (a.id > b.id) return -1;
                return 0;
            });
        }

        displaySites.forEach((site) => {
            // å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆä¸¦ã³æ›¿ãˆç”¨ï¼‰ã‚’æ¢ã™
            const originalIndex = sites.findIndex(s => s.id === site.id);

            if (kw && !site.name.toLowerCase().includes(kw) && !site.address.toLowerCase().includes(kw) && !site.id.includes(kw)) return;
            
            let stLabel = 'è¦‹ç©ä¸­', stClass = 'st-estimate';
            if(site.status === 'contract' || site.status === 'active') { stLabel = 'å¥‘ç´„æ¸ˆã¿'; stClass = 'st-contract'; }
            if(site.status === 'billing') { stLabel = 'è«‹æ±‚'; stClass = 'st-billing'; }
            if(site.status === 'complete' || site.status === 'done') { stLabel = 'å®Œäº†'; stClass = 'st-complete'; }
            if(site.status === 'lost') { stLabel = 'å¤±æ³¨'; stClass = 'st-lost'; }
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä¸­ã¯ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’éš ã™ï¼ˆä¸¦ã³é †ãŒå›ºå®šã•ã‚Œã‚‹ãŸã‚ï¼‰
            const sortButtons = (currentFilter === 'all') ? 
                `<div class="sort-actions"><button class="btn-up" onclick="moveItem(${originalIndex},-1)">â¬†ï¸</button><button class="btn-down" onclick="moveItem(${originalIndex},1)">â¬‡ï¸</button></div>` 
                : '';

            const html = `
                <div class="site-card">
                    <div class="card-header"><span class="case-no">${site.id}</span><span class="status-badge ${stClass}">${stLabel}</span></div>
                    <div class="site-name">${site.name}</div>
                    <div class="site-address">ğŸ“ ${site.address}</div>
                    <div class="card-actions">
                        <div class="action-btn btn-navi-side" onmousedown="handleTouchStart(this,'${site.id}','${site.address}')" onmouseup="handleTouchEnd(this,'${site.id}','${site.address}')" ontouchstart="handleTouchStart(this,'${site.id}','${site.address}')" ontouchend="handleTouchEnd(this,'${site.id}','${site.address}')" oncontextmenu="return false;">ğŸš€<br><span style="font-size:0.7rem">ãƒŠãƒ“</span><div class="hold-bar"></div></div>
                        <a href="tools.html?id=${site.id}" class="action-btn btn-center">ğŸ§°<br><span style="font-size:0.7rem">ãƒ„ãƒ¼ãƒ«</span></a>
                        <div class="navi-wrapper"><span class="navi-count-label">${site.naviCount||0}å›</span><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(site.address)}" target="_blank" class="action-btn btn-navi-side" onclick="updateNaviCount('${site.id}',1)">ğŸš€<br><span style="font-size:0.7rem">ãƒŠãƒ“</span></a></div>
                    </div>
                    ${sortButtons}
                </div>`;
            listEl.insertAdjacentHTML('beforeend', html);
        });
    }
    function moveItem(index, direction) {
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä¸­ã¯ä¸¦ã³æ›¿ãˆç„¡åŠ¹
        if(currentFilter !== 'all') return;

        if ((direction === -1 && index > 0) || (direction === 1 && index < sites.length - 1)) {
            [sites[index], sites[index + direction]] = [sites[index + direction], sites[index]];
            localStorage.setItem('dx_sites', JSON.stringify(sites)); renderList();
        }
    }
    function duplicateSite() {
        const name = document.getElementById('siteName').value;
        if(!name) { showNotification('âš ï¸ ç¾å ´åãŒå¿…è¦ã§ã™'); return; }
        if(!confirm('ã‚³ãƒ”ãƒ¼ã—ã¦æ–°è¦ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;
        const y = new Date().getFullYear(), num = getNextNum(y), id = `${y}-${num}`;
        sites.unshift({ id, name: name+' (ã‚³ãƒ”ãƒ¼)', address: document.getElementById('address').value, status: 'estimate', parentCaseNo: document.getElementById('parentCaseNo').value, updatedAt: Date.now(), naviCount: 0, start:'', end:'' });
        localStorage.setItem('dx_sites', JSON.stringify(sites)); closeAllModals(); renderList(); showNotification('ğŸ‰ è¤‡è£½ã—ã¾ã—ãŸ'); setTimeout(()=>openForm('edit',id),500);
    }
    function saveSite() {
        const id = `${document.getElementById('inputYear').value}-${document.getElementById('inputNum').value}`;
        const name = document.getElementById('siteName').value;
        if(!name) { showNotification('âš ï¸ ç¾å ´åãŒå¿…è¦ã§ã™'); return; }
        const data = {
            id, name, address: document.getElementById('address').value, status: document.getElementById('status').value,
            naviCount: parseInt(document.getElementById('editNaviCount').value)||0,
            parentCaseNo: document.getElementById('parentCaseNo').value,
            start: document.getElementById('startDate').value, end: document.getElementById('endDate').value, updatedAt: Date.now()
        };
        if(isEditing) {
            const idx = sites.findIndex(s => s.id === editingId);
            if(idx !== -1) sites[idx] = data; else sites.unshift(data);
        } else {
            if(sites.some(s=>s.id===id)){ if(!confirm('ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ'))return; const idx=sites.findIndex(s=>s.id===id); sites[idx]=data; }
            else sites.unshift(data);
        }
        localStorage.setItem('dx_sites', JSON.stringify(sites)); closeAllModals(); renderList(); showNotification('ğŸ‰ ä¿å­˜ã—ã¾ã—ãŸ');
    }
    function deleteCurrentSite() { if(editingId && confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { sites = sites.filter(s=>s.id!==editingId); localStorage.setItem('dx_sites', JSON.stringify(sites)); closeAllModals(); renderList(); showNotification('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ'); } }
    function openForm(mode, id=null) {
        document.getElementById('inputForm').classList.add('show'); document.getElementById('overlay').classList.add('show');
        const yearInput = document.getElementById('inputYear'); yearInput.readOnly = false;
        const numInput = document.getElementById('inputNum'); numInput.readOnly = true; numInput.className = 'input-num locked'; tapCount = 0;
        if(mode==='new') {
            isEditing=false; editingId=null;
            document.getElementById('btnDeleteSingle').style.display='none'; document.getElementById('btnDuplicate').style.display='none'; document.getElementById('naviCountArea').style.display='none';
            const y = new Date().getFullYear(); document.getElementById('inputYear').value=y; document.getElementById('inputNum').value=getNextNum(y);
            document.getElementById('siteName').value=''; document.getElementById('address').value=''; document.getElementById('status').value='estimate'; document.getElementById('parentCaseNo').value=''; document.getElementById('startDate').value=''; document.getElementById('endDate').value='';
        } else {
            isEditing=true; editingId=id;
            document.getElementById('btnDeleteSingle').style.display='flex'; document.getElementById('btnDuplicate').style.display='flex'; document.getElementById('naviCountArea').style.display='block';
            const s = sites.find(x=>x.id===id);
            if(s) {
                const p = s.id.split('-'); document.getElementById('inputYear').value=p[0]; document.getElementById('inputNum').value=p[1];
                document.getElementById('siteName').value=s.name; document.getElementById('address').value=s.address; document.getElementById('status').value=s.status; document.getElementById('editNaviCount').value=s.naviCount||0; document.getElementById('parentCaseNo').value=s.parentCaseNo||''; document.getElementById('startDate').value=s.start||''; document.getElementById('endDate').value=s.end||'';
            }
        }
    }
    function checkExistingSite() {
        const id = `${document.getElementById('inputYear').value}-${document.getElementById('inputNum').value}`;
        const s = sites.find(x=>x.id===id);
        if(s) {
            document.getElementById('siteName').value=s.name; document.getElementById('address').value=s.address; document.getElementById('status').value=s.status; document.getElementById('parentCaseNo').value=s.parentCaseNo||''; document.getElementById('editNaviCount').value=s.naviCount||0; document.getElementById('startDate').value=s.start||''; document.getElementById('endDate').value=s.end||'';
            isEditing=true; editingId=id; document.getElementById('btnDeleteSingle').style.display='flex'; document.getElementById('btnDuplicate').style.display='flex'; document.getElementById('naviCountArea').style.display='block';
        } else {
            isEditing=false; editingId=null; document.getElementById('btnDeleteSingle').style.display='none'; document.getElementById('btnDuplicate').style.display='none'; document.getElementById('naviCountArea').style.display='none';
        }
    }
    function getNextNum(y) { let max=0; sites.filter(s=>s.id.startsWith(y)).forEach(s=>{ const n=parseInt(s.id.split('-')[1]); if(n>max)max=n; }); return (max+1).toString().padStart(3,'0'); }
    function openSettings() { document.getElementById('overlay').classList.add('show'); document.getElementById('settingsModal').classList.add('show'); }
    function closeAllModals() { document.querySelectorAll('.modal-box').forEach(el=>el.classList.remove('show')); document.getElementById('overlay').classList.remove('show'); }
    function unlockCaseNo() { tapCount++; if(tapCount>=5){ const el=document.getElementById('inputNum'); el.readOnly=false; el.className='input-num unlocked'; showNotification('ğŸ”“ ãƒ­ãƒƒã‚¯è§£é™¤'); tapCount=0; } }
    function getNowStr() { const d=new Date(); return `${d.getFullYear()}${('0'+(d.getMonth()+1)).slice(-2)}${('0'+d.getDate()).slice(-2)}`; }
    
    // --- ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸæ©Ÿèƒ½ (å®‰å…¨ãƒ»ä¿®æ­£ç‰ˆ) ---

    // 1. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã§å‘¼ã°ã‚Œã‚‹
    function syncAllDataToCloud() {
        if(!confirm("ç¾åœ¨ã‚¹ãƒãƒ›ã«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã§ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ä¸Šæ›¸ãæ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ")) return;
        uploadDataToCloud(sites, "sync");
    }

    // --- é€šä¿¡é–¢é€£ (ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å¯¾å¿œç‰ˆ) ---

    // 1. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»åŒæœŸ
    async function uploadDataToCloud(data, type = "sync") {
        const targetUrl = localStorage.getItem('dx_gas_url');
        if(!targetUrl || targetUrl.includes("script.google.com") === false) {
            alert("GAS URLã‚’è¨­å®šã—ã¦ãã ã•ã„"); return false;
        }
        
        // ç«¶åˆãƒã‚§ãƒƒã‚¯
        if (type === "sync") {
            showNotification("â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ç¢ºèªä¸­...");
            try {
                const checkRes = await fetch(targetUrl + "?type=getAll");
                const text = await checkRes.text();      // â˜…ãƒ†ã‚­ã‚¹ãƒˆã§å—ã‘ã‚‹
                const cloudData = JSON.parse(text);      // â˜…è‡ªåˆ†ã§ãƒ‘ãƒ¼ã‚¹
                
                const localMax = data.length > 0 ? Math.max(...data.map(s => s.updatedAt || 0)) : 0;
                const cloudMax = Array.isArray(cloudData) && cloudData.length > 0 ? Math.max(...cloudData.map(s => s.updatedAt || 0)) : 0;
                
                if (cloudMax > localMax) {
                    const cloudDate = new Date(cloudMax).toLocaleString();
                    if (!confirm(`âš ï¸ ä¸Šæ›¸ãæ³¨æ„ï¼\nã‚¯ãƒ©ã‚¦ãƒ‰ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ï¼ˆ${cloudDate}ï¼‰ã€‚\nå¼·åˆ¶ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
                        showNotification("ä¸­æ–­ã—ã¾ã—ãŸ"); return false;
                    }
                }
            } catch(e) { console.warn("ãƒã‚§ãƒƒã‚¯å¤±æ•—:", e); }
        }
        
        // é€ä¿¡å‡¦ç†
        try {
            showNotification("â˜ï¸ é€ä¿¡ä¸­...");
            const exportData = data;

            const response = await fetch(targetUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' }, // â˜…text/plainå¿…é ˆ
                body: JSON.stringify({ type: type, data: exportData, reporter: localStorage.getItem('dx_reporter_name') || "è·äºº" })
            });

            const resText = await response.text(); // â˜…ãƒ†ã‚­ã‚¹ãƒˆã§å—ã‘ã‚‹
            const resJson = JSON.parse(resText);   // â˜…è‡ªåˆ†ã§ãƒ‘ãƒ¼ã‚¹

            if (resJson.result === "success") {
                showNotification("âœ… é€ä¿¡å®Œäº†");
                if(type==="sync") alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸï¼");
                return true;
            } else { throw new Error("GASã‚¨ãƒ©ãƒ¼"); }
        } catch(e) {
            alert("é€ä¿¡å¤±æ•—: " + e); return false;
        }
    }

    // 2. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå¾©å…ƒï¼‰
    async function downloadFromCloud() {
        const gasUrl = localStorage.getItem('dx_gas_url');
        if(!gasUrl) { alert("GAS URLè¨­å®šãªã—"); return; }
        if(!confirm("ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãå¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;

        showNotification('ğŸ“¥ å–å¾—ä¸­...');
        try {
            const res = await fetch(gasUrl + "?type=getAll");
            const text = await res.text();       // â˜…ãƒ†ã‚­ã‚¹ãƒˆã§å—ã‘ã‚‹
            const data = JSON.parse(text);       // â˜…è‡ªåˆ†ã§ãƒ‘ãƒ¼ã‚¹
            
            if(Array.isArray(data)) {
                sites = data;
                sites.sort((a, b) => (a.id > b.id ? -1 : 1));
                localStorage.setItem('dx_sites', JSON.stringify(sites));
                renderList(); closeAllModals();
                showNotification(`âœ… å¾©å…ƒå®Œäº† (${sites.length}ä»¶)`);
            } else { alert("ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼"); }
        } catch(e) { alert("å–å¾—ã‚¨ãƒ©ãƒ¼: " + e); }
    }

    // 3. èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯
    // èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯ï¼ˆå‰Šé™¤å¯¾å¿œç‰ˆï¼‰
    async function checkForCloudUpdates() {
        const targetUrl = localStorage.getItem('dx_gas_url');
        if(!targetUrl) return;

        try {
            const res = await fetch(targetUrl + "?type=getAll");
            const text = await res.text();
            const cloudData = JSON.parse(text);
            
            if (Array.isArray(cloudData)) {
                // 1. æ—¥æ™‚ã®ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜ï¼‰
                const localMax = sites.length > 0 ? Math.max(...sites.map(s => s.updatedAt || 0)) : 0;
                const cloudMax = cloudData.length > 0 ? Math.max(...cloudData.map(s => s.updatedAt || 0)) : 0;
                
                // 2. ä»¶æ•°ã®ãƒã‚§ãƒƒã‚¯ï¼ˆâ˜…æ–°è¦è¿½åŠ ï¼‰
                // ã€Œä»¶æ•°ãŒé•ã†ã€ï¼ã€Œèª°ã‹ãŒè¿½åŠ ã‹å‰Šé™¤ã‚’ã—ãŸã€ã¨ã„ã†ã“ã¨
                const isCountMismatch = sites.length !== cloudData.length;

                // æ—¥æ™‚ãŒæ–°ã—ã„ã‹ã€ã¾ãŸã¯ä»¶æ•°ãŒã‚ºãƒ¬ã¦ã„ãŸã‚‰ã€Œæ›´æ–°ã‚ã‚Šã€ã¨ã¿ãªã™
                if (cloudMax > localMax || isCountMismatch) {
                    
                    // èª¤æ“ä½œé˜²æ­¢ï¼šè‡ªåˆ†ã®æœªé€ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆãªã„ã‚ˆã†ã«ã€è‡ªåˆ†ã®æ›´æ–°æ—¥æ™‚ãŒå¤ããªã„ã‹ç¢ºèª
                    if(localMax > cloudMax && isCountMismatch) {
                         // è‡ªåˆ†ã®ã»ã†ãŒæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ã„ã‚‹ã®ã«ä»¶æ•°ãŒé•ã†å ´åˆã¯ã€
                         // è‡ªåˆ†ãŒã¾ã é€ä¿¡ã—ã¦ã„ãªã„ã ã‘ã®å¯èƒ½æ€§ãŒé«˜ã„ã®ã§ã€å‹æ‰‹ã«åŒæœŸã•ã›ãªã„ï¼ˆé€šçŸ¥ã ã‘å‡ºã™ãªã©ï¼‰
                         // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œã‚¯ãƒ©ã‚¦ãƒ‰å„ªå…ˆã€ã§æ¡ˆå†…ã—ã¾ã™
                    }

                    if (confirm(`ğŸ”„ ã‚¯ãƒ©ã‚¦ãƒ‰ã¨ãƒ‡ãƒ¼ã‚¿ãŒç•°ãªã‚Šã¾ã™ï¼\nï¼ˆå‰Šé™¤ã‚„æ›´æ–°ãŒã‚ã£ãŸã‚ˆã†ã§ã™ï¼‰\n\nåŒæœŸã—ã¦æœ€æ–°ã«ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        cloudData.sort((a, b) => (a.id > b.id ? -1 : 1));
                        localStorage.setItem('dx_sites', JSON.stringify(cloudData));
                        alert("âœ… æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã—ã¾ã—ãŸï¼");
                        location.reload();
                    }
                }
            }
        } catch (e) {
            console.log("æ›´æ–°ãƒã‚§ãƒƒã‚¯å¤±æ•—:", e);
        }
    }

    async function exportCSV() { showNotification('ğŸ“¤ æº–å‚™ä¸­...'); let c = "\uFEFFæ¡ˆä»¶No,è¦ªæ¡ˆä»¶No,ç¾å ´å,ä½æ‰€,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,é–‹å§‹,çµ‚äº†\n"; sites.forEach(s => { c += `"${s.id}","${s.parentCaseNo||''}","${s.name}","${s.address}","${getStatusText(s.status)}","${s.start||''}","${s.end||''}"\n`; }); const f = new File([c], `ç¾å ´ãƒªã‚¹ãƒˆ_${getNowStr()}.csv`, { type: "text/csv" }); if (navigator.share && navigator.canShare({ files: [f] })) { try { await navigator.share({ files: [f] }); } catch (e) { forceDL(f); } } else { forceDL(f); } }
    function forceDL(f) { const u = URL.createObjectURL(f); const a = document.createElement("a"); a.href=u; a.download=f.name; document.body.appendChild(a); a.click(); document.body.removeChild(a); showNotification('ğŸ“¥ ä¿å­˜ã—ã¾ã—ãŸ'); }
    function copyToClipboard() { let t = ""; sites.forEach(s => { t += `${s.id}\t${s.parentCaseNo||''}\t${s.name}\t${s.address}\t${getStatusText(s.status)}\t${s.start||''}\t${s.end||''}\n`; }); navigator.clipboard.writeText(t).then(()=>showNotification('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')); }
    async function exportJSON() { const f = new File([JSON.stringify(sites,null,2)], `backup_${getNowStr()}.json`, {type:"application/json"}); if(navigator.share&&navigator.canShare({files:[f]})) { try{await navigator.share({files:[f]});}catch(e){forceDL(f);} } else { forceDL(f); } }
    function importJSON(input) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(e){ try{ const d=JSON.parse(e.target.result); if(!Array.isArray(d)){alert('ã‚¨ãƒ©ãƒ¼');return;} let add=0,upd=0; d.forEach(n=>{ const i=sites.findIndex(s=>s.id===n.id); if(i!==-1){ if((n.updatedAt||0)>(sites[i].updatedAt||0)){sites[i]=n;upd++;} }else{sites.push(n);add++;} }); sites.sort((a,b)=>(a.id>b.id?-1:1)); localStorage.setItem('dx_sites',JSON.stringify(sites)); renderList(); closeAllModals(); showNotification(`å¾©å…ƒ: ${upd}ä»¶æ›´æ–°, ${add}ä»¶è¿½åŠ `); }catch(e){alert('èª­è¾¼å¤±æ•—');} input.value=''; }; r.readAsText(f); }
    function deleteAllData() { if(confirm('æœ¬å½“ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { sites=[]; localStorage.setItem('dx_sites',JSON.stringify(sites)); renderList(); closeAllModals(); showNotification('ğŸ—‘ï¸ å…¨å‰Šé™¤å®Œäº†'); } }
    function showNotification(msg) { const el = document.getElementById('notification'); el.textContent = msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 2000); }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å ´ãƒŠãƒ“ - è·äººã‚®ã‚¢</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="style.css">
    <style>
        /* ã“ã®ãƒšãƒ¼ã‚¸ç‰¹æœ‰ã®CSSã ã‘æ®‹ã™ */
        .site-name { font-size: 1.25rem; font-weight: bold; margin-bottom: 6px; }
        .site-address { font-size: 0.9rem; color: #555; margin-bottom: 15px; }
        .card-actions { display: flex; gap: 8px; align-items: flex-end; }
        .action-btn { flex: 1; height: 50px; border-radius: 8px; border: 1px solid #ddd; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.75rem; color: #555; text-decoration: none; }
        .btn-navi-main { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; flex: 1.5; font-weight: bold; }
        .date-group { display: flex; gap: 10px; align-items: center; }
        .input-year { width: 30%; text-align: center; background: #f0f0f0; }
        .input-num { width: 60%; text-align: center; font-family: monospace; letter-spacing: 2px; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <div class="header-title-area">
        <h1>ğŸš— ç¾å ´ãƒŠãƒ“</h1>
        <a href="manager.html" class="link-control">ğŸ“Š å·¥ç¨‹ç®¡ç†</a>
    </div>
    <div class="header-btn-group">
        <span class="icon-btn" onclick="toggleSortMode()">â‡…</span>
        <span class="icon-btn" onclick="openSettings()">âš™ï¸</span>
    </div>
</header>

<div class="search-area">
    <input type="search" id="searchInput" class="search-input" placeholder="ğŸ” ç¾å ´åã‚„ä½æ‰€ã§æ¤œç´¢..." oninput="renderList()">
</div>

<div class="container" id="siteList"></div>

<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="inputForm" class="modal-box">
    <h3 style="margin-top:0; text-align:center;">ç¾å ´æƒ…å ±ã®ç·¨é›†</h3>
    <label>æ¡ˆä»¶No</label>
    <div style="display:flex; gap:10px;">
        <input type="number" id="inputYear" class="input-year" readonly>
        <input type="number" id="inputNum" class="input-num" readonly ondblclick="this.readOnly=false">
    </div>
    <label>ç¾å ´å</label><input type="text" id="siteName">
    <label>ä½æ‰€</label><input type="text" id="address">
    <label>å·¥æœŸ</label>
    <div class="date-group">
        <input type="date" id="startDate"><span style="color:#888;">ã€œ</span><input type="date" id="endDate">
    </div>
    <label>çŠ¶æ³</label>
    <select id="status">
        <option value="estimate">ğŸ“„ è¦‹ç©ä¸­</option>
        <option value="contract">ğŸ¤ å¥‘ç´„æ¸ˆã¿</option>
        <option value="billing">ğŸ’° è«‹æ±‚</option>
        <option value="complete">âœ… å®Œäº†</option>
        <option value="lost">âŒ å¤±æ³¨</option>
    </select>
    <button class="save-btn" onclick="saveSite()">ä¿ å­˜</button>
    <button class="btn-close" onclick="closeAllModals()" style="background:#eee; color:#333;">é–‰ã˜ã‚‹</button>
    <button onclick="deleteCurrentSite()" style="width:100%; margin-top:10px; color:#e74c3c; border:none; background:none;">ã“ã®ç¾å ´ã‚’å‰Šé™¤</button>
</div>

<div id="settingsModal" class="modal-box">
    <h3>âš™ï¸ è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿</h3>
    <label>å ±å‘Šè€…å</label><input type="text" id="reporterName" onchange="saveConfig()">
    <label>GAS URL</label><input type="text" id="gasUrl" onchange="saveConfig()">
    <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
    <button class="save-btn" onclick="syncData()" style="background:#27ae60;">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
    <button class="save-btn" onclick="downloadFromCloud()" style="background:#e67e22; margin-top:10px;">ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å¾©å…ƒ(ä¸Šæ›¸ã)</button>
    <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
</div>

<div class="fab-container">
    <button class="fab-btn add-fab" onclick="openForm('new')">ï¼‹</button>
</div>

<script src="common.js"></script>
<script>
    let sites = JSON.parse(localStorage.getItem('dx_sites')) || [];
    let isEditing = false, editingId = null, isSortMode = false;

    document.addEventListener('DOMContentLoaded', () => {
        renderList();
        loadConfig();
        checkBackupStatus(); // common.jsã®é–¢æ•°
        checkAutoLost();     // è‡ªå‹•å¤±æ³¨ãƒã‚§ãƒƒã‚¯
    });

    function loadConfig() {
        if(localStorage.getItem('dx_reporter_name')) document.getElementById('reporterName').value = localStorage.getItem('dx_reporter_name');
        if(localStorage.getItem('dx_gas_url')) document.getElementById('gasUrl').value = localStorage.getItem('dx_gas_url');
    }
    function saveConfig() {
        localStorage.setItem('dx_reporter_name', document.getElementById('reporterName').value);
        localStorage.setItem('dx_gas_url', document.getElementById('gasUrl').value);
        // common.jsã®CONFIGã‚‚æ›´æ–°ã—ã¦ãŠãï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ãªã—ã§åæ˜ ã™ã‚‹ãŸã‚ï¼‰
        CONFIG.GAS_API_URL = document.getElementById('gasUrl').value;
    }

    function checkAutoLost() {
        const now = Date.now();
        let changed = false;
        sites.forEach(s => {
            if(s.status === 'estimate' && s.updatedAt && (now - s.updatedAt > 31536000000)) { // 1å¹´
                s.status = 'lost'; s.updatedAt = now; changed = true;
            }
        });
        if(changed) { localStorage.setItem('dx_sites', JSON.stringify(sites)); renderList(); showNotification("é•·æœŸæœªæ›´æ–°ã®æ¡ˆä»¶ã‚’å¤±æ³¨ã«ã—ã¾ã—ãŸ"); }
    }

    function renderList() {
        const listEl = document.getElementById('siteList');
        const kw = document.getElementById('searchInput').value.toLowerCase();
        listEl.innerHTML = '';
        
        // ã‚½ãƒ¼ãƒˆï¼šæ–°ã—ã„é †
        sites.sort((a,b) => (a.id < b.id ? 1 : -1));

        sites.forEach(site => {
            if(kw && !site.name.includes(kw) && !site.address.includes(kw)) return;
            
            let stLabel = 'è¦‹ç©ä¸­', stClass = 'st-estimate';
            if(site.status==='contract'||site.status==='active') { stLabel='å¥‘ç´„æ¸ˆ'; stClass='st-contract'; }
            if(site.status==='billing') { stLabel='è«‹æ±‚'; stClass='st-billing'; }
            if(site.status==='complete'||site.status==='done') { stLabel='å®Œäº†'; stClass='st-complete'; }
            if(site.status==='lost') { stLabel='å¤±æ³¨'; stClass='st-lost'; }

            const html = `
                <div class="site-card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:0.8rem;">${site.id}</span>
                        <span class="status-badge ${stClass}">${stLabel}</span>
                    </div>
                    <div class="site-name">${site.name}</div>
                    <div class="site-address">ğŸ“ ${site.address}</div>
                    <div class="card-actions">
                        <a href="tools.html?id=${site.id}" class="action-btn">ğŸ§° ãƒ„ãƒ¼ãƒ«</a>
                        <div class="action-btn" onclick="openForm('edit', '${site.id}')">âœï¸ ç·¨é›†</div>
                        <a href="https://maps.google.com/?q=${encodeURIComponent(site.address)}" target="_blank" class="action-btn btn-navi-main">ğŸš€ ãƒŠãƒ“</a>
                    </div>
                </div>`;
            listEl.insertAdjacentHTML('beforeend', html);
        });
    }

    function openForm(mode, id) {
        toggleModal('inputForm', true); // common.jsã®é–¢æ•°ï¼ˆæˆ»ã‚‹ãƒœã‚¿ãƒ³å¯¾å¿œï¼‰
        const y = new Date().getFullYear();
        if(mode==='new'){
            isEditing=false; editingId=null;
            document.getElementById('inputYear').value=y;
            document.getElementById('inputNum').value="001"; // ç°¡æ˜“
            document.getElementById('siteName').value="";
            document.getElementById('address').value="";
        } else {
            isEditing=true; editingId=id;
            const s = sites.find(x=>x.id===id);
            if(s) {
                const parts = s.id.split('-');
                document.getElementById('inputYear').value=parts[0];
                document.getElementById('inputNum').value=parts[1];
                document.getElementById('siteName').value=s.name;
                document.getElementById('address').value=s.address;
                document.getElementById('status').value=s.status;
                document.getElementById('startDate').value=s.start||"";
                document.getElementById('endDate').value=s.end||"";
            }
        }
    }
    
    function closeAllModals() { toggleModal('inputForm', false); toggleModal('settingsModal', false); }
    function openSettings() { toggleModal('settingsModal', true); }

    function saveSite() {
        const id = `${document.getElementById('inputYear').value}-${document.getElementById('inputNum').value}`;
        const name = document.getElementById('siteName').value;
        if(!name) return alert("ç¾å ´åã¯å¿…é ˆã§ã™");
        
        const newData = {
            id, name, 
            address: document.getElementById('address').value,
            status: document.getElementById('status').value,
            start: document.getElementById('startDate').value,
            end: document.getElementById('endDate').value,
            updatedAt: Date.now()
        };

        if(isEditing && editingId) {
            const idx = sites.findIndex(s=>s.id===editingId);
            if(idx!==-1) sites[idx] = newData;
        } else {
            sites.push(newData);
        }
        localStorage.setItem('dx_sites', JSON.stringify(sites));
        closeAllModals();
        renderList();
        showNotification("ä¿å­˜ã—ã¾ã—ãŸ");
    }

    function deleteCurrentSite() {
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            sites = sites.filter(s=>s.id!==editingId);
            localStorage.setItem('dx_sites', JSON.stringify(sites));
            closeAllModals();
            renderList();
        }
    }

    // â˜…é‡è¦ï¼šã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆé€ä¿¡ï¼‰
    function syncData() {
        if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«é€ä¿¡ï¼ˆä¸Šæ›¸ãï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) {
            uploadDataToCloud(sites, "sync");
        }
    }

    // â˜…è¿½åŠ ï¼šã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå—ä¿¡ï¼‰
    async function downloadFromCloud() {
        if(!CONFIG.GAS_API_URL) return alert("URLæœªè¨­å®š");
        if(!confirm("ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã§ã‚¹ãƒãƒ›ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨ã®ã‚¹ãƒãƒ›ã®ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã™ï¼‰")) return;
        
        showNotification("ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...");
        try {
            // doGetã‚’å©ã
            const res = await fetch(CONFIG.GAS_API_URL + "?type=getAll");
            const data = await res.json();
            if(Array.isArray(data) && data.length > 0) {
                sites = data;
                localStorage.setItem('dx_sites', JSON.stringify(sites));
                renderList();
                showNotification("âœ… å¾©å…ƒå®Œäº†");
                closeAllModals();
            } else {
                alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
            }
        } catch(e) {
            alert("å—ä¿¡ã‚¨ãƒ©ãƒ¼: " + e);
        }
    }
</script>
</body>
</html>
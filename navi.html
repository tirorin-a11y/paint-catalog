<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚®ã‚¢ - è·äººã‚®ã‚¢</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; color: #333; -webkit-font-smoothing: antialiased; }
        header { background-color: #2c3e50; color: white; padding: 10px 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        
        .header-title-area { display: flex; align-items: baseline; gap: 8px; }
        h1 { margin: 0; font-size: 1.1rem; letter-spacing: 0.05em; font-weight: bold; }
        .link-control { font-size: 0.75rem; color: #95a5a6; text-decoration: none; border: 1px solid #555; padding: 2px 6px; border-radius: 4px; transition: 0.2s; }
        .link-control:hover { color: white; border-color: white; }

        .header-btn-group { display: flex; align-items: center; gap: 15px; }
        .icon-btn { font-size: 1.4rem; cursor: pointer; text-decoration: none; color: white; display: flex; align-items: center; }
        body.sort-mode header { background-color: #e67e22; }
        .search-area { background: #34495e; padding: 10px 15px; position: sticky; top: 50px; z-index: 99; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-input { width: 100%; padding: 10px; border-radius: 6px; border: none; font-size: 1rem; box-sizing: border-box; outline: none; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; padding-top: 320px; padding-bottom: 100px; }
        .site-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); position: relative; transition: transform 0.2s; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .case-no { font-size: 0.8rem; color: #666; background: #eee; padding: 3px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; }
        .status-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; }
        .st-plan { background-color: #fff3e0; color: #f57c00; border: 1px solid #ffe0b2; }
        .st-active { background-color: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
        .st-done { background-color: #f5f5f5; color: #757575; border: 1px solid #e0e0e0; }
        .st-handover { background-color: #34495e; color: #fff; border: 1px solid #2c3e50; }
        .site-name { font-size: 1.25rem; font-weight: bold; margin-bottom: 6px; line-height: 1.4; }
        .site-address { font-size: 0.9rem; color: #555; margin-bottom: 16px; display: flex; align-items: center; gap: 4px; }
        .card-actions { margin-top: 15px; display: flex; gap: 8px; align-items: flex-end; }
        .action-btn { border-radius: 6px; font-weight: bold; text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: opacity 0.1s; line-height: 1; height: 60px; width: 100%; position: relative; overflow: hidden; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
        .action-btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-navi-side { flex: 1.5; background-color: #00C853; color: white; font-size: 0.9rem; }
        .btn-center { flex: 1; background-color: #fdf2e9; border: 1px solid #f5c6cb; color: #d35400; font-size: 0.8rem; }
        .navi-wrapper { flex: 1.5; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .navi-count-label { font-size: 0.7rem; color: #888; font-family: monospace; font-weight: bold; }
        .hold-bar { position: absolute; top: 0; left: 0; height: 6px; background-color: #e74c3c; opacity: 0.8; width: 100%; transition: width 0s; }
        .holding .hold-bar { width: 0%; transition: width 2.0s linear; }
        .sort-actions { display: none; width: 100%; gap: 8px; height: 60px; }
        body.sort-mode .card-actions { display: none; }
        body.sort-mode .sort-actions { display: flex; }
        .btn-up, .btn-down { flex: 1; background-color: #f39c12; color: white; font-size: 1.5rem; border-radius: 6px; border: none; cursor: pointer; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; display: none; opacity: 0; }
        .overlay.show { display: block; opacity: 1; }
        .modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; padding: 24px; border-radius: 16px; z-index: 160; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; max-height: 90vh; overflow-y: auto; }
        .modal-box.show { display: block; }
        label { display: block; margin-top: 12px; font-size: 0.85rem; font-weight: bold; color: #444; }
        input, select { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; appearance: none; }
        .id-input-group { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .input-year { width: 30%; text-align: center; background: #f0f0f0; color: #555; border: 1px solid #ccc; }
        .input-num { width: 60%; text-align: center; font-family: monospace; letter-spacing: 2px; font-weight: bold; transition: 0.3s; }
        .input-num.locked { background: #f9f9f9; color: #999; border: 1px solid #eee; cursor: not-allowed; }
        .input-num.unlocked { background: #fff; color: #d35400; border: 2px solid #e67e22; }
        .edit-footer { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;}
        .btn-del-single { width: 50px; background-color: #fff5f5; border: 1px solid #e74c3c; color: #e74c3c; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-copy { width: 50px; background-color: #e8f6f3; border: 1px solid #1abc9c; color: #16a085; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .save-btn { flex: 2; background-color: #2980b9; color: white; padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .cancel-btn { flex: 1; background-color: #e0e0e0; color: #333; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .settings-menu h3 { margin-top: 0; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .settings-item { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #eee; background: #fcfcfc; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px; text-decoration: none; color: #333; box-sizing: border-box; }
        .settings-footer { display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-close { flex: 2; background-color: #95a5a6; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-delete-all { flex: 1; background-color: white; color: #e74c3c; border: 1px solid #e74c3c; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .fab-container { position: fixed; bottom: 24px; right: 20px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 90; }
        .fab-btn { width: 56px; height: 56px; border-radius: 28px; border: none; color: white; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; display: flex; justify-content: center; align-items: center; transition: transform 0.1s; }
        .add-fab { background-color: #2980b9; font-size: 30px; }
        .share-fab { background-color: #f39c12; font-size: 22px; }
        .fab-label { font-size: 10px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; margin-right: 8px; position: absolute; right: 60px; pointer-events: none; white-space: nowrap; }
        .notification { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(44, 62, 80, 0.9); color: #fff; padding: 12px 24px; border-radius: 30px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 200; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: max-content; max-width: 80%; text-align: center; }
        .notification.show { opacity: 1; top: 90px; }
    </style>
</head>
<body>

<header>
    <div class="header-title-area">
        <h1>ğŸš— ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚®ã‚¢</h1>
        <a href="manager.html" class="link-control">ğŸ“Š ç®¡ç†ã¸</a>
    </div>
    <div class="header-btn-group">
        <span class="icon-btn" onclick="toggleSortMode()" title="ä¸¦ã³æ›¿ãˆ">â‡…</span>
        <span class="icon-btn" onclick="openSettings()" title="è¨­å®š">âš™ï¸</span>
    </div>
</header>

<div class="search-area">
    <input type="search" id="searchInput" class="search-input" placeholder="ğŸ” ç¾å ´åã‚„ä½æ‰€ã§æ¤œç´¢..." oninput="renderList()">
</div>

<div class="container" id="siteList"></div>

<input type="file" id="jsonInput" accept=".json" style="display:none" onchange="importJSON(this)">
<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="inputForm" class="modal-box">
    <h3 style="margin-top:0; text-align:center;">ç¾å ´æƒ…å ±ã®ç·¨é›†</h3>
    <label>æ¡ˆä»¶No (5å›ã‚¿ãƒƒãƒ—ã§ç·¨é›†è§£é™¤)</label>
    <div class="id-input-group">
        <input type="number" id="inputYear" class="input-year" readonly oninput="checkExistingSite()">
        <span style="color:#888; font-weight:bold;">-</span>
        <input type="number" id="inputNum" class="input-num locked" readonly onclick="unlockCaseNo()" oninput="checkExistingSite()">
    </div>
    
    <label>è¦ªæ¡ˆä»¶Noï¼ˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ é€£æºç”¨ï¼‰</label>
    <input type="text" id="parentCaseNo" placeholder="ä¾‹ï¼šK-12345" style="background:#f9f9f9;">

    <label>ç¾å ´å</label>
    <input type="text" id="siteName" placeholder="ä¾‹ï¼šéˆ´æœ¨æ§˜é‚¸">
    
    <label>ä½æ‰€ï¼ˆãƒŠãƒ“ç”¨ï¼‰</label>
    <input type="text" id="address" placeholder="ä¾‹ï¼šæ±äº¬éƒ½åƒä»£ç”°åŒº...">
    
    <label>ç¾åœ¨ã®çŠ¶æ³</label>
    <select id="status">
        <option value="plan">ğŸ“ ç¾èª¿äºˆå®š</option>
        <option value="active">ğŸ—ï¸ æ–½å·¥ä¸­</option>
        <option value="done">âœ… å®Œå·¥</option>
        <option value="handover">ğŸ  å¼•ãæ¸¡ã—</option>
    </select>

    <div id="naviCountArea" style="display:none;">
        <label>ãƒŠãƒ“å›æ•°ï¼ˆèª¤ã‚¿ãƒƒãƒ—ä¿®æ­£ç”¨ï¼‰</label>
        <input type="number" id="editNaviCount" value="0">
    </div>

    <div class="edit-footer">
        <button class="btn-del-single" id="btnDeleteSingle" onclick="deleteCurrentSite()" title="å‰Šé™¤">ğŸ—‘ï¸</button>
        <button class="btn-copy" id="btnDuplicate" onclick="duplicateSite()" title="è¤‡è£½ã—ã¦æ–°è¦ä½œæˆ">Â©ï¸</button>
        <button class="cancel-btn" onclick="closeAllModals()">ä¸­æ­¢</button>
        <button class="save-btn" onclick="saveSite()">ä¿ å­˜</button>
    </div>
</div>

<div id="settingsModal" class="modal-box settings-menu">
    <h3>âš™ï¸ è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
    
    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
        <label style="margin-top:0;">ğŸ“© æ—¥å ±ã®é€ä¿¡å…ˆï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰</label>
        <input type="email" id="managerEmail" placeholder="example@gmail.com" onchange="saveSettings()" style="background:#f9f9f9;">
    </div>

    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
        <label style="margin-top:0;">â˜ï¸ æ—¥å ±ãƒ»ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡å…ˆï¼ˆGAS URLï¼‰</label>
        <input type="text" id="gasUrl" placeholder="https://script.google.com/..." onchange="saveSettings()" style="background:#f9f9f9; font-size:0.8rem;">
        <p style="font-size:0.7rem; color:#888; margin:5px 0 0;">â€»ç®¡ç†è€…ãŒç™ºè¡Œã—ãŸURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</p>
    </div>

    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
        <label style="margin-top:0;">ğŸ“… å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID (ä»»æ„)</label>
        <input type="text" id="calendarId" placeholder="example@group.calendar.google.com" onchange="saveSettings()" style="background:#f9f9f9; font-size:0.8rem;">
        <p style="font-size:0.7rem; color:#888; margin:5px 0 0;">â€»å…¥åŠ›ã™ã‚‹ã¨ã€ãƒ„ãƒ¼ãƒ«ç”»é¢ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ãŒã“ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã®è‡ªå‹•ç™»éŒ²ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</p>
    </div>

    <a href="index.html" class="settings-item">ğŸ” <strong>ã‚«ã‚¿ãƒ­ã‚°æ¤œç´¢ã¸</strong></a>

    <button class="settings-item" onclick="syncAllDataToCloud()" style="background:#e8f5e9; border-color:#a5d6a7; color:#2e7d32;">
        â˜ï¸ <strong>å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã¨åŒæœŸ</strong>
    </button>

    <button class="settings-item" onclick="copyToClipboard()">ğŸ“‹ <strong>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç”¨ã‚³ãƒ”ãƒ¼</strong></button>
    <button class="settings-item" onclick="exportCSV()">ğŸ’¾ <strong>CSVå‡ºåŠ›</strong></button>
    <hr style="border:0; border-top:1px solid #eee;">
    <button class="settings-item" onclick="document.getElementById('jsonInput').click()">ğŸ“¥ <strong>ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒï¼ˆå–è¾¼ï¼‰</strong></button>
    <a href="help.html" class="settings-item">ğŸ“– <strong>ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã‚’è¦‹ã‚‹</strong></a>
    <div class="settings-footer">
        <button class="btn-delete-all" onclick="deleteAllData()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
        <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div class="fab-container">
    <div style="display:flex; align-items:center;">
        <span class="fab-label">å…±æœ‰ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</span>
        <button class="fab-btn share-fab" onclick="exportJSON()">ğŸ“¤</button>
    </div>
    <div style="display:flex; align-items:center;">
        <button class="fab-btn add-fab" onclick="openForm('new')">ï¼‹</button>
    </div>
</div>
<div id="notification" class="notification"></div>

<script>
    let sites = JSON.parse(localStorage.getItem('dx_sites')) || [];
    let isEditing = false;
    let tapCount = 0;
    let editingId = null;
    let isSortMode = false;
    let pressTimer = null; 

    // åˆæœŸãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
    if (sites.length === 0) {
        sites = [
            { id: '2025-001', name: 'ã€ã‚µãƒ³ãƒ—ãƒ«ã€‘éˆ´æœ¨æ§˜é‚¸', address: 'æ±äº¬éƒ½å¢¨ç”°åŒºæŠ¼ä¸Š1-1-2', status: 'active', updatedAt: Date.now(), naviCount: 0 }
        ];
        localStorage.setItem('dx_sites', JSON.stringify(sites));
    }

    function saveSettings() {
        const email = document.getElementById('managerEmail').value;
        const gas = document.getElementById('gasUrl').value;
        const calId = document.getElementById('calendarId').value;
        localStorage.setItem('dx_manager_email', email);
        localStorage.setItem('dx_gas_url', gas);
        localStorage.setItem('dx_calendar_id', calId);
        showNotification('âš™ï¸ è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        renderList();
        const savedEmail = localStorage.getItem('dx_manager_email');
        if(savedEmail) document.getElementById('managerEmail').value = savedEmail;
        const savedGas = localStorage.getItem('dx_gas_url');
        if(savedGas) document.getElementById('gasUrl').value = savedGas;
        const savedCal = localStorage.getItem('dx_calendar_id');
        if(savedCal) document.getElementById('calendarId').value = savedCal;
    });

    function handleTouchStart(btn, id, address) {
        if (btn.classList.contains('holding')) return;
        btn.classList.add('holding'); 
        pressTimer = setTimeout(() => {
            if (navigator.vibrate) navigator.vibrate(100); 
            btn.classList.remove('holding');
            updateNaviCount(id, -1); 
            showNotification('ä¿®æ­£ã—ã¾ã—ãŸï¼šã‚«ã‚¦ãƒ³ãƒˆ -1');
            pressTimer = null; 
        }, 2000);
    }

    function handleTouchEnd(btn, id, address) {
        if (pressTimer) {
            clearTimeout(pressTimer);
            pressTimer = null;
            btn.classList.remove('holding');
            updateNaviCount(id, 1);
            // â˜…ä¿®æ­£ï¼šhttpsåŒ–
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
            window.open(mapUrl, '_blank');
        }
    }

    function updateNaviCount(id, delta) {
        const index = sites.findIndex(s => s.id === id);
        if (index !== -1) {
            let newCount = (sites[index].naviCount || 0) + delta;
            if(newCount < 0) newCount = 0;
            sites[index].naviCount = newCount;
            sites[index].updatedAt = Date.now();
            localStorage.setItem('dx_sites', JSON.stringify(sites));
            renderList();
        }
    }

    function toggleSortMode() {
        isSortMode = !isSortMode;
        if(isSortMode) { 
            document.body.classList.add('sort-mode'); 
            showNotification('â‡… ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ï¼šON'); 
        } else { 
            document.body.classList.remove('sort-mode'); 
            showNotification('ä¸¦ã³æ›¿ãˆã‚’çµ‚äº†ã—ã¾ã—ãŸ'); 
        }
        renderList();
    }

    function renderList() {
        const listEl = document.getElementById('siteList');
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        listEl.innerHTML = '';

        sites.forEach((site, index) => {
            if (keyword && !site.name.toLowerCase().includes(keyword) && !site.address.toLowerCase().includes(keyword) && !site.id.includes(keyword)) { return; }

            let stLabel = 'ç¾èª¿äºˆå®š', stClass = 'st-plan';
            if(site.status === 'active') { stLabel = 'æ–½å·¥ä¸­'; stClass = 'st-active'; }
            if(site.status === 'done') { stLabel = 'å®Œå·¥'; stClass = 'st-done'; }
            if(site.status === 'handover') { stLabel = 'å¼•ãæ¸¡ã—'; stClass = 'st-handover'; }
            
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(site.address)}`;
            const naviCount = site.naviCount || 0;

            const html = `
                <div class="site-card">
                    <div class="card-header">
                        <span class="case-no">${site.id}</span>
                        <span class="status-badge ${stClass}">${stLabel}</span>
                    </div>
                    <div class="site-name">${site.name}</div>
                    <div class="site-address">ğŸ“ ${site.address}</div>
                    
                    <div class="card-actions">
                        <div class="action-btn btn-navi-side" 
                             onmousedown="handleTouchStart(this, '${site.id}', '${site.address}')" 
                             onmouseup="handleTouchEnd(this, '${site.id}', '${site.address}')"
                             ontouchstart="handleTouchStart(this, '${site.id}', '${site.address}')" 
                             ontouchend="handleTouchEnd(this, '${site.id}', '${site.address}')"
                             oncontextmenu="return false;"> 
                            ğŸš€<br><span style="font-size:0.7rem">ãƒŠãƒ“</span>
                            <div class="hold-bar"></div>
                        </div>
                        
                        <a href="tools.html?id=${site.id}" class="action-btn btn-center">
                            ğŸ§°<br><span style="font-size:0.7rem">ãƒ„ãƒ¼ãƒ«</span>
                        </a>
                        
                        <div class="navi-wrapper">
                            <span class="navi-count-label">${naviCount}å›</span>
                            <a href="${mapUrl}" target="_blank" class="action-btn btn-navi-side" onclick="updateNaviCount('${site.id}', 1)">
                                ğŸš€<br><span style="font-size:0.7rem">ãƒŠãƒ“</span>
                            </a>
                        </div>
                    </div>

                    <div class="sort-actions">
                        <button class="btn-up" onclick="moveItem(${index}, -1)" ${index === 0 ? 'disabled style="opacity:0.3"' : ''}>â¬†ï¸</button>
                        <button class="btn-down" onclick="moveItem(${index}, 1)" ${index === sites.length - 1 ? 'disabled style="opacity:0.3"' : ''}>â¬‡ï¸</button>
                    </div>
                </div>
            `;
            listEl.insertAdjacentHTML('beforeend', html);
        });
    }

    function moveItem(index, direction) {
        if (direction === -1 && index > 0) { [sites[index], sites[index - 1]] = [sites[index - 1], sites[index]]; } 
        else if (direction === 1 && index < sites.length - 1) { [sites[index], sites[index + 1]] = [sites[index + 1], sites[index]]; }
        localStorage.setItem('dx_sites', JSON.stringify(sites));
        renderList();
    }

    function duplicateSite() {
        const name = document.getElementById('siteName').value;
        const address = document.getElementById('address').value;
        const parentNo = document.getElementById('parentCaseNo').value;
        
        if(!name || !address) { showNotification('âš ï¸ ç¾å ´åã¨ä½æ‰€ãŒå¿…è¦ã§ã™'); return; }
        if(!confirm('ã“ã®ç¾å ´æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€æ–°è¦æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;

        const todayYear = new Date().getFullYear();
        const newIdNum = getNextNum(todayYear);
        const newId = `${todayYear}-${newIdNum}`;
        const now = Date.now();
        
        sites.unshift({
            id: newId, name: name + ' (ã‚³ãƒ”ãƒ¼)', address: address, status: 'plan', 
            parentCaseNo: parentNo, updatedAt: now, naviCount: 0 
        });
        localStorage.setItem('dx_sites', JSON.stringify(sites));
        closeAllModals(); renderList(); showNotification('ğŸ‰ è¤‡è£½ã—ã¾ã—ãŸ');
        setTimeout(() => openForm('edit', newId), 500);
    }

    function saveSite() {
        const y = document.getElementById('inputYear').value;
        const n = document.getElementById('inputNum').value.toString().padStart(3, '0');
        const id = `${y}-${n}`;
        const name = document.getElementById('siteName').value;
        const address = document.getElementById('address').value;
        const status = document.getElementById('status').value;
        const naviCountVal = parseInt(document.getElementById('editNaviCount').value) || 0;
        const parentNo = document.getElementById('parentCaseNo').value;

        if(!name || !address) { showNotification('âš ï¸ ç¾å ´åã¨ä½æ‰€ã¯å¿…é ˆã§ã™'); return; }
        
        if (isEditing) {
            if (id !== editingId) { sites = sites.filter(s => s.id !== editingId); }
            const index = sites.findIndex(s => s.id === id);
            if(index !== -1) { sites[index] = { ...sites[index], name, address, status, naviCount: naviCountVal, parentCaseNo: parentNo, updatedAt: Date.now() }; } 
            else { sites.unshift({ id, name, address, status, naviCount: naviCountVal, parentCaseNo: parentNo, updatedAt: Date.now() }); }
        } else {
            if(sites.some(s => s.id === id)){ 
                if(!confirm('âš ï¸ æ—¢å­˜ã®ç¾å ´ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãæ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) return; 
                const idx = sites.findIndex(s => s.id === id); 
                sites[idx] = { ...sites[idx], name, address, status, naviCount: naviCountVal, parentCaseNo: parentNo, updatedAt: Date.now() }; 
            } else { 
                sites.unshift({ id, name, address, status, naviCount: naviCountVal, parentCaseNo: parentNo, updatedAt: Date.now() }); 
            }
        }
        localStorage.setItem('dx_sites', JSON.stringify(sites));
        closeAllModals(); renderList(); showNotification('ğŸ‰ ä¿å­˜ã—ã¾ã—ãŸ');
    }

    function deleteCurrentSite() {
        if(!editingId) return;
        if(confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå¾©å…ƒã§ãã¾ã›ã‚“ï¼‰')) {
            sites = sites.filter(s => s.id !== editingId);
            localStorage.setItem('dx_sites', JSON.stringify(sites));
            closeAllModals(); renderList(); showNotification('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ');
        }
    }

    function openForm(mode, id = null) {
        document.getElementById('inputForm').classList.add('show'); 
        document.getElementById('overlay').classList.add('show');
        const numInput = document.getElementById('inputNum');
        numInput.readOnly = true; numInput.classList.remove('unlocked'); numInput.classList.remove('locked'); numInput.classList.add('locked'); tapCount = 0;
        const todayYear = new Date().getFullYear();

        if (mode === 'new') {
            isEditing = false; editingId = null;
            document.getElementById('btnDeleteSingle').style.display = 'none';
            document.getElementById('btnDuplicate').style.display = 'none';
            document.getElementById('naviCountArea').style.display = 'none'; 
            
            document.getElementById('inputYear').value = todayYear;
            document.getElementById('inputNum').value = getNextNum(todayYear);
            document.getElementById('siteName').value = '';
            document.getElementById('address').value = '';
            document.getElementById('status').value = 'plan';
            document.getElementById('editNaviCount').value = 0;
            document.getElementById('parentCaseNo').value = '';
        } else {
            isEditing = true; editingId = id;
            document.getElementById('btnDeleteSingle').style.display = 'flex';
            document.getElementById('btnDuplicate').style.display = 'flex';
            document.getElementById('naviCountArea').style.display = 'block'; 
            
            const targetSite = sites.find(s => s.id === id);
            if(targetSite) {
                const parts = targetSite.id.split('-');
                document.getElementById('inputYear').value = parts[0];
                document.getElementById('inputNum').value = parts[1];
                document.getElementById('siteName').value = targetSite.name;
                document.getElementById('address').value = targetSite.address;
                document.getElementById('status').value = targetSite.status;
                document.getElementById('editNaviCount').value = targetSite.naviCount || 0;
                document.getElementById('parentCaseNo').value = targetSite.parentCaseNo || '';
            }
        }
    }

    function checkExistingSite() {
        const y = document.getElementById('inputYear').value;
        const n = document.getElementById('inputNum').value;
        if(!y || !n) return;
        
        const checkId = `${y}-${n.toString().padStart(3, '0')}`;
        const found = sites.find(s => s.id === checkId);
        
        if (found) {
            document.getElementById('siteName').value = found.name;
            document.getElementById('address').value = found.address;
            document.getElementById('status').value = found.status;
            document.getElementById('parentCaseNo').value = found.parentCaseNo || '';
            document.getElementById('editNaviCount').value = found.naviCount || 0;
            isEditing = true;
            editingId = checkId;
            document.getElementById('btnDeleteSingle').style.display = 'flex';
            document.getElementById('btnDuplicate').style.display = 'flex';
            document.getElementById('naviCountArea').style.display = 'block';
        } else {
            isEditing = false;
            editingId = null;
            document.getElementById('btnDeleteSingle').style.display = 'none';
            document.getElementById('btnDuplicate').style.display = 'none';
            document.getElementById('naviCountArea').style.display = 'none';
        }
    }

    function getNextNum(year) {
        const thisYearSites = sites.filter(s => s.id.startsWith(year.toString()));
        let maxNum = 0;
        thisYearSites.forEach(s => { const numPart = parseInt(s.id.split('-')[1]); if(numPart > maxNum) maxNum = numPart; });
        return (maxNum + 1).toString().padStart(3, '0');
    }
    
    function openSettings() { 
        document.getElementById('overlay').classList.add('show'); 
        document.getElementById('settingsModal').classList.add('show'); 
    }
    function closeAllModals() { 
        document.querySelectorAll('.modal-box').forEach(el => el.classList.remove('show')); 
        document.getElementById('overlay').classList.remove('show'); 
    }
    
    function unlockCaseNo() { 
        const el = document.getElementById('inputNum'); 
        if(!el.readOnly) return; 
        tapCount++; 
        if(tapCount >= 5) { 
            el.readOnly = false; 
            el.classList.remove('locked'); 
            el.classList.add('unlocked'); 
            showNotification('ğŸ”“ ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¾ã—ãŸ'); 
            tapCount = 0; 
        } 
    }
    
    function getNowStr() { 
        const d = new Date(); 
        return `${d.getFullYear()}${('0'+(d.getMonth()+1)).slice(-2)}${('0'+d.getDate()).slice(-2)}_${('0'+d.getHours()).slice(-2)}${('0'+d.getMinutes()).slice(-2)}`; 
    }
    
    async function exportJSON() { 
        showNotification('ğŸ“¤ æº–å‚™ä¸­...'); 
        const jsonContent = JSON.stringify(sites, null, 2); 
        
        // ã‚¹ãƒãƒ›ã‹PCã‹ã®åˆ¤å®šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åç”¨ï¼‰
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const deviceLabel = isMobile ? 'ã‚¹ãƒãƒ›' : 'PC';
        
        const fileName = `ã€è·äººã‚®ã‚¢ã€‘backup_${deviceLabel}_${getNowStr()}.json`; 
        const file = new File([jsonContent], fileName, { type: "application/json" }); 
        
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) { 
            try { await navigator.share({ files: [file] }); } catch (e) { forceDL(file); } 
        } else { 
            forceDL(file); 
        } 
    }
    
    function forceDL(file) { 
        const url = URL.createObjectURL(file); 
        const link = document.createElement("a"); 
        link.setAttribute("href", url); 
        link.setAttribute("download", file.name); 
        document.body.appendChild(link); 
        link.click(); 
        document.body.removeChild(link); 
        showNotification('ğŸ“¥ ä¿å­˜ã—ã¾ã—ãŸ'); 
    }
    
    function importJSON(input) { 
        const file = input.files[0]; 
        if (!file) return; 
        const reader = new FileReader(); 
        reader.onload = function(e) { 
            try { 
                const importedSites = JSON.parse(e.target.result); 
                if (!Array.isArray(importedSites)) { alert('ã‚¨ãƒ©ãƒ¼'); return; } 
                let countAdded = 0; 
                let countUpdated = 0; 
                importedSites.forEach(newSite => { 
                    const index = sites.findIndex(s => s.id === newSite.id); 
                    if (index !== -1) { 
                        if ((newSite.updatedAt || 0) > (sites[index].updatedAt || 0)) { 
                            sites[index] = newSite; 
                            countUpdated++; 
                        } 
                    } else { 
                        sites.push(newSite); 
                        countAdded++; 
                    } 
                }); 
                localStorage.setItem('dx_sites', JSON.stringify(sites)); 
                renderList(); 
                closeAllModals(); 
                showNotification(`å¾©å…ƒ: ${countUpdated}ä»¶æ›´æ–°, ${countAdded}ä»¶è¿½åŠ `); 
            } catch (err) { alert('èª­ã¿è¾¼ã¿å¤±æ•—'); } 
            input.value = ''; 
        }; 
        reader.readAsText(file); 
    }
    
    function deleteAllData() { 
        if(confirm('ã€è­¦å‘Šã€‘\næœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { 
            sites = []; 
            localStorage.setItem('dx_sites', JSON.stringify(sites)); 
            renderList(); 
            closeAllModals(); 
            showNotification('ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); 
        } 
    }
    
    function getStatusText(status) { 
        switch (status) { 
            case 'active': return 'æ–½å·¥ä¸­'; 
            case 'done': return 'å®Œå·¥'; 
            case 'handover': return 'å¼•ãæ¸¡ã—'; 
            case 'plan': return 'ç¾èª¿äºˆå®š'; 
            default: return 'ç¾èª¿äºˆå®š'; 
        } 
    }
    
    // â˜…ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸå‡¦ç†
    function syncAllDataToCloud() {
        const gasUrl = localStorage.getItem('dx_gas_url');
        if(!gasUrl) { alert("è¨­å®šã‹ã‚‰ã€ŒGAS URLã€ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„"); return; }
        if(!confirm("å…¨ç¾å ´ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ\nâ€»å‘ã“ã†ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™")) return;

        showNotification('â˜ï¸ åŒæœŸä¸­...');
        const data = { type: "sync", data: sites };

        fetch(gasUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(() => {
            showNotification('âœ… ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸå®Œäº†');
            alert("åŒæœŸã—ã¾ã—ãŸï¼ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œæ¡ˆä»¶ä¸€è¦§ã€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }).catch(err => {
            alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼"); console.error(err);
        });
    }

    async function exportCSV() { 
        showNotification('ğŸ“¤ æº–å‚™ä¸­...'); 
        let csvContent = "\uFEFFæ¡ˆä»¶No,è¦ªæ¡ˆä»¶No,ç¾å ´å,ä½æ‰€,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,é–‹å§‹,çµ‚äº†\n"; 
        sites.forEach(s => { 
            csvContent += `"${s.id}","${s.parentCaseNo||''}","${s.name}","${s.address}","${getStatusText(s.status)}","${s.start||''}","${s.end||''}"\n`; 
        }); 
        const fileName = `ç¾å ´ãƒªã‚¹ãƒˆ_${getNowStr()}.csv`; 
        const file = new File([csvContent], fileName, { type: "text/csv" }); 
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) { 
            try { await navigator.share({ files: [file] }); } catch (e) { forceDL(file); } 
        } else { 
            forceDL(file); 
        } 
    }
    
    function copyToClipboard() { 
        let tsvContent = ""; 
        sites.forEach(s => { 
            tsvContent += `${s.id}\t${s.parentCaseNo||''}\t${s.name}\t${s.address}\t${getStatusText(s.status)}\t${s.start||''}\t${s.end||''}\n`; 
        }); 
        navigator.clipboard.writeText(tsvContent)
            .then(() => { showNotification('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); })
            .catch(err => { showNotification('âš ï¸ å¤±æ•—ã—ã¾ã—ãŸ'); }); 
    }
    
    function showNotification(msg) { 
        const el = document.getElementById('notification'); 
        el.textContent = msg; 
        el.classList.add('show'); 
        setTimeout(() => el.classList.remove('show'), 2000); 
    }
    
    document.addEventListener('DOMContentLoaded', renderList);
</script>
</body>
</html>
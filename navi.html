<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å ´ã‚«ãƒ¼ãƒŠãƒ“æ‰‹å¸³ DX</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; color: #333; -webkit-font-smoothing: antialiased; }
        header { background-color: #2c3e50; color: white; padding: 10px 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.1rem; letter-spacing: 0.05em; }
        .header-btn-group { display: flex; align-items: center; gap: 15px; }
        .icon-btn { font-size: 1.4rem; cursor: pointer; text-decoration: none; color: white; display: flex; align-items: center; }
        body.sort-mode header { background-color: #e67e22; }
        .search-area { background: #34495e; padding: 10px 15px; position: sticky; top: 50px; z-index: 99; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-input { width: 100%; padding: 10px; border-radius: 6px; border: none; font-size: 1rem; box-sizing: border-box; outline: none; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; padding-bottom: 100px; }
        .site-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); position: relative; transition: transform 0.2s; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .case-no { font-size: 0.8rem; color: #666; background: #eee; padding: 3px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; }
        .status-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; }
        .st-plan { background-color: #fff3e0; color: #f57c00; border: 1px solid #ffe0b2; }
        .st-active { background-color: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
        .st-done { background-color: #f5f5f5; color: #757575; border: 1px solid #e0e0e0; }
        .st-handover { background-color: #34495e; color: #fff; border: 1px solid #2c3e50; }
        .site-name { font-size: 1.25rem; font-weight: bold; margin-bottom: 6px; line-height: 1.4; }
        .site-address { font-size: 0.9rem; color: #555; margin-bottom: 16px; display: flex; align-items: center; gap: 4px; }
        /* â˜…ä¿®æ­£ï¼šãƒœã‚¿ãƒ³ã®é«˜ã•ã‚’çµ±ä¸€ */
        .card-actions { margin-top: 15px; display: flex; gap: 8px; height: 60px; }
        .action-btn { border-radius: 6px; font-weight: bold; text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: opacity 0.1s; line-height: 1; }
        .action-btn:active { transform: translateY(2px); box-shadow: none; }
        /* â˜…ãƒŠãƒ“ãƒœã‚¿ãƒ³ï¼ˆä¸¡ã‚µã‚¤ãƒ‰ï¼‰ */
        .btn-navi-side { flex: 1.5; background-color: #00C853; color: white; font-size: 0.9rem; }
        /* â˜…ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆä¸­å¤®ï¼‰ */
        .btn-center { flex: 1; background-color: #fdf2e9; border: 1px solid #f5c6cb; color: #d35400; font-size: 0.8rem; }
        
        .sort-actions { display: none; width: 100%; gap: 8px; height: 60px; }
        body.sort-mode .card-actions { display: none; }
        body.sort-mode .sort-actions { display: flex; }
        .btn-up, .btn-down { flex: 1; background-color: #f39c12; color: white; font-size: 1.5rem; border-radius: 6px; border: none; cursor: pointer; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; display: none; opacity: 0; }
        .overlay.show { display: block; opacity: 1; }
        .modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; padding: 24px; border-radius: 16px; z-index: 160; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; }
        .modal-box.show { display: block; }
        label { display: block; margin-top: 12px; font-size: 0.85rem; font-weight: bold; color: #444; }
        input, select { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; appearance: none; }
        .id-input-group { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .input-year { width: 30%; text-align: center; background: #f0f0f0; color: #555; border: 1px solid #ccc; }
        .input-num { width: 60%; text-align: center; font-family: monospace; letter-spacing: 2px; font-weight: bold; transition: 0.3s; }
        .input-num.locked { background: #f9f9f9; color: #999; border: 1px solid #eee; cursor: not-allowed; }
        .input-num.unlocked { background: #fff; color: #d35400; border: 2px solid #e67e22; }
        .edit-footer { display: flex; gap: 10px; margin-top: 20px; }
        .btn-del-single { width: 50px; background-color: #fff5f5; border: 1px solid #e74c3c; color: #e74c3c; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .save-btn { flex: 2; background-color: #2980b9; color: white; padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .cancel-btn { flex: 1; background-color: #e0e0e0; color: #333; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .settings-menu h3 { margin-top: 0; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .settings-item { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #eee; background: #fcfcfc; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px; text-decoration: none; color: #333; box-sizing: border-box; }
        .settings-footer { display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-close { flex: 2; background-color: #95a5a6; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-delete-all { flex: 1; background-color: white; color: #e74c3c; border: 1px solid #e74c3c; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .fab-container { position: fixed; bottom: 24px; right: 20px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 90; }
        .fab-btn { width: 56px; height: 56px; border-radius: 28px; border: none; color: white; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; display: flex; justify-content: center; align-items: center; transition: transform 0.1s; }
        .add-fab { background-color: #2980b9; font-size: 30px; }
        .mini-fab { width: 44px; height: 44px; font-size: 14px; border-radius: 22px; font-weight: bold; }
        .csv-fab { background-color: #27ae60; }
        .copy-fab { background-color: #f39c12; }
        .fab-label { font-size: 10px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; margin-right: 8px; position: absolute; right: 60px; pointer-events: none; white-space: nowrap; }
        .notification { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(44, 62, 80, 0.9); color: #fff; padding: 12px 24px; border-radius: 30px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 200; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: max-content; max-width: 80%; text-align: center; }
        .notification.show { opacity: 1; top: 90px; }
    </style>
</head>
<body>

<header>
    <h1>ğŸš— ç¾å ´ã‚«ãƒ¼ãƒŠãƒ“æ‰‹å¸³</h1>
    <div class="header-btn-group">
        <span class="icon-btn" onclick="toggleSortMode()" title="ä¸¦ã³æ›¿ãˆ">â‡…</span>
        <span class="icon-btn" onclick="openSettings()" title="è¨­å®š">âš™ï¸</span>
    </div>
</header>

<div class="search-area">
    <input type="search" id="searchInput" class="search-input" placeholder="ğŸ” ç¾å ´åã‚„ä½æ‰€ã§æ¤œç´¢..." oninput="renderList()">
</div>

<div class="container" id="siteList"></div>

<input type="file" id="jsonInput" accept=".json" style="display:none" onchange="importJSON(this)">
<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="inputForm" class="modal-box">
    <h3 style="margin-top:0; text-align:center;">ç¾å ´æƒ…å ±ã®ç·¨é›†</h3>
    <label>æ¡ˆä»¶No (5å›ã‚¿ãƒƒãƒ—ã§ç·¨é›†è§£é™¤)</label>
    <div class="id-input-group">
        <input type="number" id="inputYear" class="input-year" readonly>
        <span style="color:#888; font-weight:bold;">-</span>
        <input type="number" id="inputNum" class="input-num locked" readonly onclick="unlockCaseNo()">
    </div>
    <label>ç¾å ´å</label>
    <input type="text" id="siteName" placeholder="ä¾‹ï¼šéˆ´æœ¨æ§˜é‚¸">
    <label>ä½æ‰€ï¼ˆãƒŠãƒ“ç”¨ï¼‰</label>
    <input type="text" id="address" placeholder="ä¾‹ï¼šæ±äº¬éƒ½åƒä»£ç”°åŒº...">
    <label>ç¾åœ¨ã®çŠ¶æ³</label>
    <select id="status">
        <option value="plan">ğŸ“ ç¾èª¿äºˆå®š</option>
        <option value="active">ğŸ—ï¸ æ–½å·¥ä¸­</option>
        <option value="done">âœ… å®Œå·¥</option>
        <option value="handover">ğŸ  å¼•ãæ¸¡ã—</option>
    </select>
    <div class="edit-footer">
        <button class="btn-del-single" id="btnDeleteSingle" onclick="deleteCurrentSite()">ğŸ—‘ï¸</button>
        <button class="cancel-btn" onclick="closeAllModals()">ä¸­æ­¢</button>
        <button class="save-btn" onclick="saveSite()">ä¿ å­˜</button>
    </div>
</div>

<div id="settingsModal" class="modal-box settings-menu">
    <h3>âš™ï¸ è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
    <button class="settings-item" onclick="exportJSON()">ğŸ“¤ <strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ</strong></button>
    <button class="settings-item" onclick="document.getElementById('jsonInput').click()">ğŸ“¥ <strong>ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒï¼ˆå–è¾¼ï¼‰</strong></button>
    <a href="help.html" class="settings-item">ğŸ“– <strong>ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã‚’è¦‹ã‚‹</strong></a>
    <div class="settings-footer">
        <button class="btn-delete-all" onclick="deleteAllData()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
        <button class="btn-close" onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div class="fab-container">
    <div style="display:flex; align-items:center;"><span class="fab-label">ã‚¹ãƒ—ã‚·ç”¨ã‚³ãƒ”ãƒ¼</span><button class="fab-btn mini-fab copy-fab" onclick="copyToClipboard()">ğŸ“‹</button></div>
    <div style="display:flex; align-items:center;"><span class="fab-label">CSVå‡ºåŠ›</span><button class="fab-btn mini-fab csv-fab" onclick="exportCSV()">ğŸ’¾</button></div>
    <div style="display:flex; align-items:center;"><button class="fab-btn add-fab" onclick="openForm('new')">ï¼‹</button></div>
</div>
<div id="notification" class="notification"></div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    let sites = JSON.parse(localStorage.getItem('dx_sites')) || [];
    let isEditing = false;
    let tapCount = 0;
    let editingId = null;
    let isSortMode = false;

    // åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆåˆå›ã®ã¿ï¼‰
    if (sites.length === 0) {
        sites = [
            { id: '2025-001', name: 'ã€ã‚µãƒ³ãƒ—ãƒ«ã€‘éˆ´æœ¨æ§˜é‚¸', address: 'æ±äº¬éƒ½å¢¨ç”°åŒºæŠ¼ä¸Š1-1-2', status: 'active', updatedAt: Date.now(), naviCount: 0 }
        ];
        localStorage.setItem('dx_sites', JSON.stringify(sites));
    }

    // --- â˜…ãƒŠãƒ“å›æ•°ã‚«ã‚¦ãƒ³ãƒˆæ©Ÿèƒ½ ---
    function countNavi(id) {
        const index = sites.findIndex(s => s.id === id);
        if (index !== -1) {
            sites[index].naviCount = (sites[index].naviCount || 0) + 1;
            sites[index].updatedAt = Date.now();
            localStorage.setItem('dx_sites', JSON.stringify(sites));
        }
    }

    // --- ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ ---
    function toggleSortMode() {
        isSortMode = !isSortMode;
        if(isSortMode) { 
            document.body.classList.add('sort-mode'); 
            showNotification('â‡… ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ï¼šON'); 
        } else { 
            document.body.classList.remove('sort-mode'); 
            showNotification('ä¸¦ã³æ›¿ãˆã‚’çµ‚äº†ã—ã¾ã—ãŸ'); 
        }
        renderList();
    }

    // --- ãƒªã‚¹ãƒˆæç”» ---
    function renderList() {
        const listEl = document.getElementById('siteList');
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        listEl.innerHTML = '';

        sites.forEach((site, index) => {
            if (keyword && !site.name.toLowerCase().includes(keyword) && !site.address.toLowerCase().includes(keyword) && !site.id.includes(keyword)) {
                return; 
            }

            let stLabel = 'ç¾èª¿äºˆå®š', stClass = 'st-plan';
            if(site.status === 'active') { stLabel = 'æ–½å·¥ä¸­'; stClass = 'st-active'; }
            if(site.status === 'done') { stLabel = 'å®Œå·¥'; stClass = 'st-done'; }
            if(site.status === 'handover') { stLabel = 'å¼•ãæ¸¡ã—'; stClass = 'st-handover'; }
            
            // â˜…ä¿®æ­£ï¼šURLã®è¨˜è¿°ãƒŸã‚¹ã‚’ä¿®æ­£
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(site.address)}`;
            
            const html = `
                <div class="site-card">
                    <div class="card-header">
                        <span class="case-no">${site.id}</span>
                        <span class="status-badge ${stClass}">${stLabel}</span>
                    </div>
                    <div class="site-name">${site.name}</div>
                    <div class="site-address">ğŸ“ ${site.address}</div>
                    
                    <div class="card-actions">
                        <a href="${mapUrl}" target="_blank" class="action-btn btn-navi-side" onclick="countNavi('${site.id}')">
                            ğŸš€<br><span style="font-size:0.7rem">ãƒŠãƒ“</span>
                        </a>
                        
                        <a href="tools.html?id=${site.id}" class="action-btn btn-center">
                            ğŸ§°<br><span style="font-size:0.7rem">ãƒ„ãƒ¼ãƒ«</span>
                        </a>
                        
                        <a href="${mapUrl}" target="_blank" class="action-btn btn-navi-side" onclick="countNavi('${site.id}')">
                            ğŸš€<br><span style="font-size:0.7rem">ãƒŠãƒ“</span>
                        </a>
                    </div>

                    <div class="sort-actions">
                        <button class="btn-up" onclick="moveItem(${index}, -1)" ${index === 0 ? 'disabled style="opacity:0.3"' : ''}>â¬†ï¸</button>
                        <button class="btn-down" onclick="moveItem(${index}, 1)" ${index === sites.length - 1 ? 'disabled style="opacity:0.3"' : ''}>â¬‡ï¸</button>
                    </div>
                </div>
            `;
            listEl.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- ä¸¦ã³æ›¿ãˆå®Ÿè¡Œ ---
    function moveItem(index, direction) {
        if (direction === -1 && index > 0) { 
            [sites[index], sites[index - 1]] = [sites[index - 1], sites[index]]; 
        } else if (direction === 1 && index < sites.length - 1) { 
            [sites[index], sites[index + 1]] = [sites[index + 1], sites[index]]; 
        }
        localStorage.setItem('dx_sites', JSON.stringify(sites));
        renderList();
    }

    // --- ä¿å­˜å‡¦ç† ---
    function saveSite() {
        const y = document.getElementById('inputYear').value;
        const n = document.getElementById('inputNum').value.toString().padStart(3, '0');
        const id = `${y}-${n}`;
        const name = document.getElementById('siteName').value;
        const address = document.getElementById('address').value;
        const status = document.getElementById('status').value;

        if(!name || !address) { 
            showNotification('âš ï¸ ç¾å ´åã¨ä½æ‰€ã¯å¿…é ˆã§ã™'); 
            return; 
        }

        const now = Date.now();

        if (isEditing) {
            if (id !== editingId) { 
                sites = sites.filter(s => s.id !== editingId); 
            }
            const index = sites.findIndex(s => s.id === id);
            
            if(index !== -1) { 
                sites[index] = { ...sites[index], name, address, status, updatedAt: now }; 
            } else { 
                sites.unshift({ id, name, address, status, updatedAt: now, naviCount: 0 }); 
            }
        } else {
            if(sites.some(s => s.id === id)){ 
                if(!confirm('âš ï¸ é‡è¤‡ã—ã¦ã„ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) return; 
                const idx = sites.findIndex(s => s.id === id); 
                sites[idx] = { ...sites[idx], name, address, status, updatedAt: now }; 
            } else { 
                sites.unshift({ id, name, address, status, updatedAt: now, naviCount: 0 }); 
            }
        }
        
        localStorage.setItem('dx_sites', JSON.stringify(sites));
        closeAllModals(); 
        renderList(); 
        showNotification('ğŸ‰ ä¿å­˜ã—ã¾ã—ãŸ');
    }

    // --- å‰Šé™¤å‡¦ç† ---
    function deleteCurrentSite() {
        if(!editingId) return;
        if(confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå¾©å…ƒã§ãã¾ã›ã‚“ï¼‰')) {
            sites = sites.filter(s => s.id !== editingId);
            localStorage.setItem('dx_sites', JSON.stringify(sites));
            closeAllModals();
            renderList();
            showNotification('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ');
        }
    }

    // --- ãƒ•ã‚©ãƒ¼ãƒ é–‹é–‰ ---
    function openForm(mode, id = null) {
        document.getElementById('inputForm').classList.add('show'); 
        document.getElementById('overlay').classList.add('show');
        
        const numInput = document.getElementById('inputNum');
        numInput.readOnly = true; 
        numInput.classList.remove('unlocked'); 
        numInput.classList.add('locked'); 
        tapCount = 0;

        const todayYear = new Date().getFullYear();

        if (mode === 'new') {
            isEditing = false;
            editingId = null;
            document.getElementById('btnDeleteSingle').style.display = 'none';
            document.getElementById('inputYear').value = todayYear;
            document.getElementById('inputNum').value = getNextNum(todayYear);
            document.getElementById('siteName').value = '';
            document.getElementById('address').value = '';
            document.getElementById('status').value = 'plan';
        } else {
            isEditing = true;
            editingId = id;
            document.getElementById('btnDeleteSingle').style.display = 'flex';
            const targetSite = sites.find(s => s.id === id);
            if(targetSite) {
                const parts = targetSite.id.split('-');
                document.getElementById('inputYear').value = parts[0];
                document.getElementById('inputNum').value = parts[1];
                document.getElementById('siteName').value = targetSite.name;
                document.getElementById('address').value = targetSite.address;
                document.getElementById('status').value = targetSite.status;
            }
        }
    }

    function getNextNum(year) {
        const thisYearSites = sites.filter(s => s.id.startsWith(year.toString()));
        let maxNum = 0;
        thisYearSites.forEach(s => {
            const numPart = parseInt(s.id.split('-')[1]);
            if(numPart > maxNum) maxNum = numPart;
        });
        return (maxNum + 1).toString().padStart(3, '0');
    }

    function openSettings() { 
        document.getElementById('overlay').classList.add('show'); 
        document.getElementById('settingsModal').classList.add('show'); 
    }

    function closeAllModals() { 
        document.querySelectorAll('.modal-box').forEach(el => el.classList.remove('show')); 
        document.getElementById('overlay').classList.remove('show'); 
    }

    function unlockCaseNo() {
        const el = document.getElementById('inputNum');
        if(!el.readOnly) return;
        tapCount++;
        if(tapCount >= 5) {
            el.readOnly = false;
            el.classList.remove('locked');
            el.classList.add('unlocked');
            showNotification('ğŸ”“ ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¾ã—ãŸ');
            tapCount = 0;
        }
    }

    function getNowStr() {
        const d = new Date();
        return `${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}_${d.getHours().toString().padStart(2,'0')}${d.getMinutes().toString().padStart(2,'0')}`;
    }

    async function exportJSON() {
        showNotification('ğŸ“¤ æº–å‚™ä¸­...');
        const jsonContent = JSON.stringify(sites, null, 2);
        const fileName = `ã€ã‚«ãƒ¼ãƒŠãƒ“æ‰‹å¸³ã€‘backup_${getNowStr()}.json`;
        const file = new File([jsonContent], fileName, { type: "application/json" });
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            try { await navigator.share({ files: [file] }); } catch (e) { forceDL(file); }
        } else {
            forceDL(file);
        }
    }

    function forceDL(file) {
        const url = URL.createObjectURL(file);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", file.name);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification('ğŸ“¥ ä¿å­˜ã—ã¾ã—ãŸ');
    }

    function importJSON(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedSites = JSON.parse(e.target.result);
                if (!Array.isArray(importedSites)) { alert('ã‚¨ãƒ©ãƒ¼ï¼šæ­£ã—ã„å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }
                let countAdded = 0;
                let countUpdated = 0;
                importedSites.forEach(newSite => {
                    const index = sites.findIndex(s => s.id === newSite.id);
                    if (index !== -1) {
                        const existingTime = sites[index].updatedAt || 0;
                        const newTime = newSite.updatedAt || 0;
                        if (newTime > existingTime) { sites[index] = newSite; countUpdated++; }
                    } else { sites.push(newSite); countAdded++; }
                });
                localStorage.setItem('dx_sites', JSON.stringify(sites));
                renderList();
                closeAllModals();
                showNotification(`å¾©å…ƒ: ${countUpdated}ä»¶æ›´æ–°, ${countAdded}ä»¶è¿½åŠ `);
            } catch (err) { alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
            input.value = '';
        };
        reader.readAsText(file);
    }

    function deleteAllData() {
        if(confirm('ã€è­¦å‘Šã€‘\næœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            if(confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                sites = [];
                localStorage.setItem('dx_sites', JSON.stringify(sites));
                renderList();
                closeAllModals();
                showNotification('ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'active': return 'æ–½å·¥ä¸­'; case 'done': return 'å®Œå·¥'; case 'handover': return 'å¼•ãæ¸¡ã—'; case 'plan': return 'ç¾èª¿äºˆå®š'; default: return 'ç¾èª¿äºˆå®š';
        }
    }

    async function exportCSV() {
        showNotification('ğŸ“¤ æº–å‚™ä¸­...');
        let csvContent = "\uFEFFæ¡ˆä»¶No,ç¾å ´å,ä½æ‰€,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,é–‹å§‹,çµ‚äº†\n"; 
        sites.forEach(s => {
            csvContent += `"${s.id}","${s.name}","${s.address}","${getStatusText(s.status)}","${s.start||''}","${s.end||''}"\n`;
        });
        const fileName = `ç¾å ´ãƒªã‚¹ãƒˆ_${getNowStr()}.csv`;
        const file = new File([csvContent], fileName, { type: "text/csv" });
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            try { await navigator.share({ files: [file] }); } catch (e) { forceDL(file); }
        } else { forceDL(file); }
    }

    function copyToClipboard() {
        let tsvContent = "";
        sites.forEach(s => {
            tsvContent += `${s.id}\t${s.name}\t${s.address}\t${getStatusText(s.status)}\t${s.start||''}\t${s.end||''}\n`;
        });
        navigator.clipboard.writeText(tsvContent).then(() => { showNotification('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }).catch(err => { showNotification('âš ï¸ å¤±æ•—ã—ã¾ã—ãŸ'); });
    }

    function showNotification(msg) {
        const el = document.getElementById('notification');
        el.textContent = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 2000);
    }

    // â˜…ç¢ºå®Ÿã«åˆæœŸè¡¨ç¤ºã‚’è¡Œã†
    document.addEventListener('DOMContentLoaded', renderList);
</script>
</body>
</html>
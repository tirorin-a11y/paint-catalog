<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»å­é»’æ¿ã‚«ãƒ¡ãƒ© - è·äººã‚®ã‚¢</title>
    <style>
        /* åŸºæœ¬è¨­å®š */
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif; background-color: #000; margin: 0; padding: 0; color: #333; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .site-header { background: #2c3e50; color: white; padding: 12px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; }
        .site-title { margin: 0; font-size: 1.1rem; font-weight: bold; }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        #cameraContainer { flex: 1; display: flex; flex-direction: column; background: #fff; overflow: hidden; position: relative; }
        
        /* å›ºå®šã‚¨ãƒªã‚¢ï¼ˆä¸Šéƒ¨ï¼‰ */
        #fixedTopArea {
            background: #222; 
            padding: 10px;
            flex-shrink: 0;
            border-bottom: 1px solid #444;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ï¼ˆä¸‹éƒ¨ï¼‰ */
        #scrollableInputArea {
            flex: 1;
            overflow-y: auto;
            background: #fff;
            padding: 15px;
            padding-bottom: 80px; /* ä¸‹ã«ä½™ç™½ */
            -webkit-overflow-scrolling: touch;
        }

        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ */
        .mode-switch-container { display: flex; width: 100%; max-width: 400px; background: rgba(255,255,255,0.1); border-radius: 8px; padding: 4px; margin-bottom: 8px; }
        .mode-btn { flex: 1; border: none; background: transparent; padding: 6px; font-weight: bold; color: #aaa; cursor: pointer; border-radius: 6px; transition: 0.2s; font-size: 0.85rem; }
        .mode-btn.active { background: #fff; color: #2c3e50; }
        .mode-btn.active-date { color: #e67e22; }

        .preview-canvas-wrapper { display: flex; justify-content: center; align-items: center; width: 100%; max-width: 320px; }
        #boardCanvas { width: 100%; height: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.5); background: transparent; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        #boardInputGroup { display: block; transition: opacity 0.3s; margin-bottom: 20px; }
        #boardInputGroup.hidden { display: none; }

        label { margin-top: 15px; display: block; font-weight: bold; font-size: 0.9rem; color: #2c3e50; }
        label:first-child { margin-top: 0; }
        input[type="text"] { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; background: #f9f9f9; }
        
        .process-btns { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; margin-top: 5px; }
        .proc-btn { flex: 1; min-width: 70px; padding: 5px; font-size: 0.9rem; line-height: 1.2; background: #f0f0f0; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; color: #555; font-weight: bold; display: flex; align-items: center; justify-content: center; text-align: center; height: 45px; position: relative; overflow: hidden; }
        .proc-btn.active { background: #2c3e50; color: white; border-color: #2c3e50; }
        
        .custom-btn-area { border-top: 1px dashed #ddd; padding-top: 15px; margin-top: 15px; }
        .input-grid-cam { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 5px; }
        .cam-chip { background: #f0f0f0; border: 1px solid #ccc; border-radius: 6px; font-size: 0.8rem; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; font-weight: bold; color: #555; user-select: none; padding: 0 2px; text-align: center; }
        .cam-chip.active { background: #2c3e50; color: white; border-color: #2c3e50; }
        .cam-chip.mode-loc { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
        .cam-chip.btn-switch { background: #34495e; color: white; border: none; font-size: 0.75rem; }
        
        .chip-bar { position: absolute; bottom: 0; left: 0; height: 4px; background: #f39c12; width: 0%; pointer-events: none; }
        .pressing .chip-bar { width: 100%; transition: width 0.8s linear; }
        
        .input-wrapper { display: flex; align-items: center; margin-top: 5px; gap: 5px; }
        .btn-clear-left { width: 44px; height: 44px; border-radius: 6px; border: 1px solid #ccc; background: #ffebee; color: #c62828; font-weight: bold; font-size: 1.2rem; cursor: pointer; flex-shrink: 0; }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®æœ€å¾Œã«é…ç½®ï¼‰ */
        .footer-actions { 
            padding-top: 20px; 
            border-top: 1px solid #eee; 
            display: flex; 
            gap: 10px; 
        }
        .btn-close { background-color: #95a5a6; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; flex: 1; }
        .save-btn { background-color: #00C853; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; flex: 2; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(0,200,83,0.2); }


        /* æ’®å½±å¾Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ */
        #photoPreviewArea { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; flex-direction: column; justify-content: center; align-items: center; }
        #previewImage { max-width: 100%; max-height: 100%; object-fit: contain; flex: 1; }
        #overlayBoard { position: absolute; top: 20px; left: 20px; width: 200px; cursor: grab; z-index: 210; touch-action: none; }
        
        /* çŸ¢å°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼ˆå››è§’ã„2x2é…ç½® & é«˜é€éï¼‰ */
        .snap-controls { 
            position: absolute; 
            top: 40%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            
            /* â–¼â–¼â–¼ å››è§’ã„ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¤‰æ›´ â–¼â–¼â–¼ */
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2åˆ— */
            gap: 15px; /* ãƒœã‚¿ãƒ³åŒå£«ã®é–“éš” */
            /* â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² */

            z-index: 230; 
            
            /* â–¼â–¼â–¼ é€æ˜åº¦ã‚’ä¸Šã’ã¾ã—ãŸï¼ˆ0.6 â†’ 0.2ï¼‰ â–¼â–¼â–¼ */
            background: rgba(0, 0, 0, 0.2); 
            /* â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² */
            
            padding: 20px; 
            border-radius: 25px; /* è§’ä¸¸ã®å››è§’ */
            backdrop-filter: blur(2px); /* ã™ã‚Šã‚¬ãƒ©ã‚¹åŠ¹æœã§è¦–èªæ€§ç¢ºä¿ */
        }

        .snap-btn { 
            background: rgba(255,255,255,0.15); /* ãƒœã‚¿ãƒ³è‡ªä½“ã‚‚è–„ã */
            color: white; 
            border: 1px solid rgba(255,255,255,0.4); 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            font-size: 1.5rem; 
            cursor: pointer; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: 0.2s;
        }
        
        .snap-btn:active {
            background: rgba(255,255,255,0.5); /* æŠ¼ã—ãŸæ™‚ã ã‘æ˜ã‚‹ã */
            transform: scale(0.95);
        }
        .camera-controls-area { 
            position: absolute; bottom: 0; width: 100%; padding: 30px 20px; 
            background: #000000;  /* å®Œå…¨ãªé»’ */
            display: flex; justify-content: center; 
            gap: 30px; 
            align-items: center; box-sizing: border-box; z-index: 220; 
        }
        .btn-cam-action { padding: 12px 30px; border-radius: 30px; font-weight: bold; cursor: pointer; border: none; font-size: 1rem; min-width: 120px; }
        .btn-retake { background: #e74c3c; color: white; }
        .btn-save-photo { background: #00C853; color: white; box-shadow: 0 0 15px rgba(0,200,83,0.4); }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãã®ä»–ã‚¹ã‚¿ã‚¤ãƒ« */
        .slider-overlay { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); width: 85%; max-width: 400px; background: rgba(44, 62, 80, 0.95); padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 300; display: none; text-align: center; color: white; backdrop-filter: blur(5px); }
        .slider-overlay.show { display: block; animation: popUp 0.2s ease-out; }
        @keyframes popUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .slider-label { font-size: 2.5rem; font-weight: bold; margin-bottom: 10px; color: #f39c12; }
        .slider-sub { font-size: 0.9rem; color: #bdc3c7; margin-bottom: 15px; }
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; height: 10px; border-radius: 5px; background: #555; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 30px; height: 30px; border-radius: 50%; background: #f39c12; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .cam-chip.target-floor.selected { background-color: #2196F3; color: white; border-color: #1976D2; }
        .cam-chip.target-dir.selected { background-color: #FFEB3B; color: #333; border-color: #FBC02D; }
        .cam-chip.op-btn { background-color: #eceff1; color: #333; font-size: 1.4rem; font-weight: 900; }
        .cam-chip.op-btn:active { background-color: #cfd8dc; }
    </style>
</head>
<body>

<div class="site-header">
    <h2 class="site-title">ğŸ“¸ é›»å­é»’æ¿ã‚«ãƒ¡ãƒ©</h2>
</div>

<div id="cameraContainer">
    
    <div id="fixedTopArea">
        <div class="mode-switch-container">
            <button class="mode-btn active" onclick="switchMode('board')" id="btn-mode-board">ğŸ“‹ é»’æ¿</button>
            <button class="mode-btn" onclick="switchMode('date')" id="btn-mode-date">ğŸ“… æ—¥ä»˜</button>
            <button class="mode-btn" onclick="switchMode('datetime')" id="btn-mode-datetime">ğŸ•’ æ—¥æ™‚</button>
        </div>

        <div class="preview-canvas-wrapper">
            <canvas id="boardCanvas" width="400" height="300"></canvas>
        </div>
    </div>

    <div id="scrollableInputArea">
        <div id="boardInputGroup">
            <label>ä¼šç¤¾å</label>
            <input type="text" id="companyName" placeholder="ä¼šç¤¾åã‚’å…¥åŠ›" oninput="drawBoard(); saveCameraSettings()">

            <label>å·¥ç¨‹ <span style="font-size:0.8rem; font-weight:normal; color:#888;">(é•·æŠ¼ã—ã§ç·¨é›†)</span></label>
            <div class="process-btns"></div>
            
            <div class="custom-btn-area">
                <label style="margin-bottom:5px; display:block;">ä»»æ„ãƒœã‚¿ãƒ³ <span style="font-size:0.8rem; font-weight:normal; color:#888;">(é•·æŠ¼ã—ã§ç·¨é›†)</span></label>
                <div id="customBtnGroup" class="input-grid-cam"></div>
            </div>
            
            <label>æ–½å·¥ç®‡æ‰€</label>
            <div class="input-wrapper">
                <button class="btn-clear-left" onclick="clearLocation()">Ã—</button>
                <input type="text" id="photoDetail" placeholder="ä¾‹ï¼šåŒ—é¢ã€è»’å¤©ãªã©" oninput="drawBoard()">
            </div>
        </div>

        <div class="footer-actions">
            <button class="btn-close" onclick="location.href='tools.html'">é–‰ã˜ã‚‹</button>
            <input type="file" id="nativeCameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handlePhotoSelect(this)">
            <button class="save-btn" onclick="document.getElementById('nativeCameraInput').click()">ğŸ“¸ ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
        </div>
    </div>
</div>

<div id="photoPreviewArea">
    <img id="previewImage" src="" alt="æ’®å½±å†™çœŸ">
    <img id="overlayBoard" src="" alt="é»’æ¿">
    
    <div class="snap-controls">
        <button class="snap-btn" onclick="snapBoard('tl')">â†–ï¸</button>
        <button class="snap-btn" onclick="snapBoard('tr')">â†—ï¸</button>
        <button class="snap-btn" onclick="snapBoard('bl')">â†™ï¸</button>
        <button class="snap-btn" onclick="snapBoard('br')">â†˜ï¸</button>
    </div>
    
    <div class="camera-controls-area">
        <button class="btn-cam-action btn-retake" onclick="retakePhoto()">ã‚„ã‚Šç›´ã™</button>
        <button class="btn-cam-action btn-save-photo" onclick="saveCompositePhoto()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
    </div>
</div>

<script>
    // --- JSãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä¿®æ­£ç‰ˆï¼šIDæŒ‡å®šã®ã¿ï¼‰ ---
    let currentSite = null;
    let currentMode = 'board';

    try {
        // 1. URLã‹ã‚‰IDã‚’å–å¾—
        const params = new URLSearchParams(window.location.search);
        const siteId = params.get('id');
        
        // 2. ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒªã‚¹ãƒˆã‹ã‚‰ã€ãã®IDã®ç¾å ´ã‚’æ¢ã™
        const sites = JSON.parse(localStorage.getItem('dx_sites')) || [];
        
        if (siteId) {
            currentSite = sites.find(s => s.id === siteId);
        }
        
        // â€»ã‚‚ã—IDãŒãªã„ã€ã¾ãŸã¯è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ nullï¼ˆç¾å ´åæœªå®šï¼‰ã®ã¾ã¾ã«ã™ã‚‹
        // ï¼ˆä½™è¨ˆãªè‡ªå‹•æ¤œç´¢ã¯ã—ãªã„ï¼‰

    } catch(e) { console.error(e); }

    let currentProcess = 'æ–½å·¥å‰';
    const DEFAULT_PROCESSES = ["æ–½å·¥å‰", "ä¸‹å¡—ã‚Š", "ä¸­å¡—ã‚Š", "ä¸Šå¡—ã‚Š", "å®Œäº†"];
    const LONG_PRESS_MS = 1500;

    window.onload = () => {
        const savedComp = localStorage.getItem('dx_company_name');
        document.getElementById('companyName').value = savedComp ? savedComp : "ãƒšã‚¤ãƒ³ãƒˆãƒã‚¦ã‚¹";
        renderProcessButtons();
        renderCameraButtons();
        drawBoard();
    };

    function saveCameraSettings() {
        const val = document.getElementById('companyName').value;
        localStorage.setItem('dx_company_name', val);
    }

    function switchMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => {
            b.classList.remove('active', 'active-date');
        });
        const activeBtn = document.getElementById(`btn-mode-${mode}`);
        activeBtn.classList.add('active');
        if(mode !== 'board') activeBtn.classList.add('active-date');

        const inputGroup = document.getElementById('boardInputGroup');
        if (mode === 'board') {
            inputGroup.classList.remove('hidden');
        } else {
            inputGroup.classList.add('hidden');
        }
        drawBoard();
    }

    const canvas = document.getElementById('boardCanvas');
    const ctx = canvas.getContext('2d');

    function drawBoard() {
        if(!canvas) return;
        const d = new Date();
        const dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
        const timeStr = `${('0'+d.getHours()).slice(-2)}:${('0'+d.getMinutes()).slice(-2)}`;
        const fullDateTime = `${dateStr} ${timeStr}`;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (currentMode === 'board') {
            const siteName = currentSite ? currentSite.name : "ï¼ˆç¾å ´åæœªå®šï¼‰";
            const company = document.getElementById('companyName').value || "";
            const location = document.getElementById('photoDetail').value || "";
            const process = currentProcess || "ï¼ˆé¸æŠãªã—ï¼‰";
            const fontFamily = '"Yu Gothic","Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif';

            ctx.fillStyle = '#004d40'; ctx.fillRect(0, 0, canvas.width, canvas.height); 
            ctx.strokeStyle = 'white'; ctx.lineWidth = 5; ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
            
            ctx.lineWidth = 2; ctx.beginPath(); 
            ctx.moveTo(10, 80); ctx.lineTo(390, 80); 
            ctx.moveTo(10, 150); ctx.lineTo(390, 150); 
            ctx.stroke();

            ctx.fillStyle = 'white'; ctx.textAlign = 'left'; ctx.textBaseline = 'middle'; 
            const maxWidth = 340; 
            const getLines = (ctx, text, max) => {
                let words = text.split(''); let lines = []; let currentLine = words[0] || "";
                for (let i = 1; i < words.length; i++) {
                    if (ctx.measureText(currentLine + words[i]).width < max) { currentLine += words[i]; } 
                    else { lines.push(currentLine); currentLine = words[i]; }
                }
                lines.push(currentLine); return lines;
            };

            ctx.font = `bold 20px ${fontFamily}`; ctx.fillText("å·¥äº‹å", 20, 23);
            let siteFontSize = 24; ctx.font = `bold ${siteFontSize}px ${fontFamily}`;
            let siteLines = getLines(ctx, siteName, maxWidth);
            if (siteLines.length > 1) { siteFontSize = 16; ctx.font = `bold ${siteFontSize}px ${fontFamily}`; siteLines = getLines(ctx, siteName, maxWidth); if(siteLines.length > 2) { siteLines = siteLines.slice(0, 2); siteLines[1] = siteLines[1].slice(0, -1) + "â€¦"; } }
            if (siteLines.length === 1) ctx.fillText(siteLines[0], 20, 55); else { ctx.fillText(siteLines[0], 20, 48); ctx.fillText(siteLines[1], 20, 68); }

            ctx.font = `bold 20px ${fontFamily}`; ctx.fillText("å·¥ç¨® / æ–½å·¥å†…å®¹", 20, 95);
            let procFontSize = 26; ctx.font = `bold ${procFontSize}px ${fontFamily}`;
            let procLines = getLines(ctx, process, maxWidth);
            if (procLines.length > 1) { procFontSize = 18; ctx.font = `bold ${procFontSize}px ${fontFamily}`; procLines = getLines(ctx, process, maxWidth); if(procLines.length > 2) { procLines = procLines.slice(0, 2); procLines[1] = procLines[1].slice(0, -1) + "â€¦"; } }
            if (procLines.length === 1) ctx.fillText(procLines[0], 40, 125); else { ctx.fillText(procLines[0], 40, 118); ctx.fillText(procLines[1], 40, 138); }

            ctx.font = `bold 20px ${fontFamily}`; ctx.fillText("æ–½å·¥ç®‡æ‰€", 20, 168);
            let locFontSize = 24; ctx.font = `bold ${locFontSize}px ${fontFamily}`;
            let locLines = getLines(ctx, location, maxWidth);
            if (locLines.length > 2) { locFontSize = 20; ctx.font = `bold ${locFontSize}px ${fontFamily}`; locLines = getLines(ctx, location, maxWidth); }
            if (locLines.length > 3) { locFontSize = 17; ctx.font = `bold ${locFontSize}px ${fontFamily}`; locLines = getLines(ctx, location, maxWidth); if(locLines.length > 3) { locLines = locLines.slice(0, 3); locLines[2] = locLines[2].slice(0, -1) + "â€¦"; } }
            const locX = 40;
            if (locLines.length === 1) ctx.fillText(locLines[0], locX, 210);
            else if (locLines.length === 2) { ctx.fillText(locLines[0], locX, 200); ctx.fillText(locLines[1], locX, 228); }
            else { ctx.fillText(locLines[0], locX, 195); ctx.fillText(locLines[1], locX, 215); ctx.fillText(locLines[2], locX, 235); }

            ctx.textAlign = 'right'; ctx.font = `bold 24px ${fontFamily}`; ctx.fillText(dateStr, 380, 270); 
            ctx.textAlign = 'left'; ctx.font = `16px ${fontFamily}`; ctx.fillStyle = '#ccc'; ctx.fillText(company, 20, 270);

        } else {
            const displayText = (currentMode === 'datetime') ? fullDateTime : dateStr;
            const fontSize = 50; 
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = 'right';
            ctx.textBaseline = 'bottom';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 6;
            ctx.lineJoin = 'round';
            ctx.strokeText(displayText, canvas.width - 10, canvas.height - 10);
            ctx.fillStyle = '#ff9f43';
            ctx.fillText(displayText, canvas.width - 10, canvas.height - 10);
        }
    }

    let photoFile = null;
    function handlePhotoSelect(input) {
        if (input.files && input.files[0]) {
            photoFile = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const previewImg = document.getElementById('previewImage');
                
                // â˜…ä¿®æ­£1ï¼šç”»åƒãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰å‡¦ç†ã‚’é–‹å§‹ã™ã‚‹
                previewImg.onload = function() {
                    // 1. é»’æ¿ã‚’æç”»ã—ã¦ç”»åƒåŒ–
                    drawBoard(); 
                    const boardImg = document.getElementById('overlayBoard');
                    boardImg.src = canvas.toDataURL('image/png');
                    
                    // 2. ç”»é¢ã‚’è¡¨ç¤ºï¼ˆè¡¨ç¤ºã—ãªã„ã¨ã‚µã‚¤ã‚ºè¨ˆç®—ã§ããªã„ãŸã‚ï¼‰
                    document.getElementById('photoPreviewArea').style.display = 'flex';
                    
                    // 3. æœ€å¾Œã«ä½ç½®ã‚’å³ä¸‹ã«åˆã‚ã›ã‚‹
                    // ï¼ˆé»’æ¿ç”»åƒã®èª­ã¿è¾¼ã¿ãƒ©ã‚°å¯¾ç­–ã¨ã—ã¦å°‘ã—ã ã‘å¾…ã¤ã®ãŒãƒ™ã‚¹ãƒˆã§ã™ãŒã€é€šå¸¸ã¯ã“ã‚Œã§ã‚‚å‹•ãã¾ã™ï¼‰
                    setTimeout(() => {
                        snapBoard('br');
                    }, 50);
                };

                // ç”»åƒã‚½ãƒ¼ã‚¹ã‚’ã‚»ãƒƒãƒˆï¼ˆã“ã‚Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ä¸Šã®onloadãŒå‹•ãï¼‰
                previewImg.src = e.target.result;
            };
            reader.readAsDataURL(photoFile);
        }
        input.value = '';
    }
    
    function retakePhoto() {
        document.getElementById('photoPreviewArea').style.display = 'none';
        photoFile = null;
    }

    function saveCompositePhoto() {
        if(!photoFile) return;
        const pImg = document.getElementById('previewImage');
        const bImg = document.getElementById('overlayBoard');
        const c = document.createElement('canvas');
        c.width = pImg.naturalWidth; c.height = pImg.naturalHeight;
        const cx = c.getContext('2d');
        
        cx.drawImage(pImg, 0, 0);
        const pRect = pImg.getBoundingClientRect();
        const bRect = bImg.getBoundingClientRect();
        const s = pImg.naturalWidth / pRect.width;
        
        cx.drawImage(bImg, (bRect.left - pRect.left) * s, (bRect.top - pRect.top) * s, bRect.width * s, bRect.height * s);
        
        const link = document.createElement('a');
        link.href = c.toDataURL('image/jpeg', 0.9);
        const suffix = (currentMode === 'board') ? currentProcess : 'æ—¥ä»˜';
        link.download = `${currentSite?currentSite.name:'ç¾å ´'}_${suffix}_${Date.now()}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        retakePhoto();
    }

    // --- â˜…å¤‰æ›´ç®‡æ‰€ï¼šé»’æ¿ç§»å‹•ãƒ»ã‚¹ãƒŠãƒƒãƒ—è¨­å®šï¼ˆæ•°å€¤ã§å¾®èª¿æ•´å¯èƒ½ï¼‰ ---
    
    // ã“ã“ã§å››éš…ã‹ã‚‰ã®è·é›¢ã‚’pxå˜ä½ã§æŒ‡å®šã—ã¾ã™
    const SNAP_MARGIN_TOP    = 50;  // ä¸Šã‹ã‚‰ã®éš™é–“
    const SNAP_MARGIN_BOTTOM = 110;  // ä¸‹ã‹ã‚‰ã®éš™é–“
    const SNAP_MARGIN_LEFT   = 10;  // å·¦ã‹ã‚‰ã®éš™é–“
    const SNAP_MARGIN_RIGHT  = 10;  // å³ã‹ã‚‰ã®éš™é–“

    function snapBoard(pos) {
        const board = document.getElementById('overlayBoard');
        const pImg = document.getElementById('previewImage');
        const container = document.getElementById('photoPreviewArea');
        const pRect = pImg.getBoundingClientRect();
        const cRect = container.getBoundingClientRect();
        
        // å†™çœŸã®è¡¨ç¤ºä½ç½®ï¼ˆä½™ç™½ã‚’è€ƒæ…®ï¼‰
        const offsetTop = pRect.top - cRect.top;
        const offsetLeft = pRect.left - cRect.left;
        const pWidth = pRect.width;
        const pHeight = pRect.height;
        
        const bWidth = board.offsetWidth;
        const bHeight = board.offsetHeight;

        board.style.top = ''; board.style.bottom = ''; board.style.left = ''; board.style.right = '';

        // ä½ç½®è¨ˆç®—
        if (pos === 'tl') { // å·¦ä¸Š
            board.style.top  = (offsetTop + SNAP_MARGIN_TOP) + 'px';
            board.style.left = (offsetLeft + SNAP_MARGIN_LEFT) + 'px';
        } 
        else if (pos === 'tr') { // å³ä¸Š
            board.style.top  = (offsetTop + SNAP_MARGIN_TOP) + 'px';
            board.style.left = (offsetLeft + pWidth - bWidth - SNAP_MARGIN_RIGHT) + 'px';
        } 
        else if (pos === 'bl') { // å·¦ä¸‹
            board.style.top  = (offsetTop + pHeight - bHeight - SNAP_MARGIN_BOTTOM) + 'px';
            board.style.left = (offsetLeft + SNAP_MARGIN_LEFT) + 'px';
        } 
        else if (pos === 'br') { // å³ä¸‹
            board.style.top  = (offsetTop + pHeight - bHeight - SNAP_MARGIN_BOTTOM) + 'px';
            board.style.left = (offsetLeft + pWidth - bWidth - SNAP_MARGIN_RIGHT) + 'px';
        }
    }

    // ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†
    const overlayBoard = document.getElementById('overlayBoard'); 
    let isDragging = false, dragStartX, dragStartY, initialLeft, initialTop;
    const SNAP_SIZE = 10;
    
    const handleDragStart = (e) => {
        isDragging = true;
        const s = window.getComputedStyle(overlayBoard);
        initialLeft = parseInt(s.left) || 0; initialTop = parseInt(s.top) || 0;
        if(e.touches) { dragStartX = e.touches[0].clientX; dragStartY = e.touches[0].clientY; } 
        else { dragStartX = e.clientX; dragStartY = e.clientY; }
        overlayBoard.style.bottom = ''; overlayBoard.style.right = ''; overlayBoard.style.left = initialLeft + 'px'; overlayBoard.style.top = initialTop + 'px';
        overlayBoard.style.transition = 'none';
        if(e.cancelable && e.type === 'touchstart') e.preventDefault();
    };
    const handleDragMove = (e) => {
        if (!isDragging) return;
        let clientX, clientY;
        if(e.touches) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } 
        else { clientX = e.clientX; clientY = e.clientY; }
        const snappedDx = Math.round((clientX - dragStartX) / SNAP_SIZE) * SNAP_SIZE;
        const snappedDy = Math.round((clientY - dragStartY) / SNAP_SIZE) * SNAP_SIZE;
        overlayBoard.style.left = `${initialLeft + snappedDx}px`;
        overlayBoard.style.top = `${initialTop + snappedDy}px`;
        if(e.cancelable) e.preventDefault();
    };
    const handleDragEnd = () => { isDragging = false; };
    overlayBoard.addEventListener('touchstart', handleDragStart, {passive: false});
    overlayBoard.addEventListener('touchmove', handleDragMove, {passive: false});
    overlayBoard.addEventListener('touchend', handleDragEnd);
    overlayBoard.addEventListener('mousedown', handleDragStart);
    window.addEventListener('mousemove', handleDragMove);
    window.addEventListener('mouseup', handleDragEnd);

    const DX_CAM_PARTS = ["ã‚±ãƒ¬ãƒ³", "æ´—æµ„", "é¤Šç”Ÿ", "ã‚·ãƒ¼ãƒªãƒ³ã‚°", "è¶³å ´", "ãƒ‘ã‚¿ãƒ¼ãƒ³èª¿æ•´", "ä¸‹åœ°å‡¦ç†", "å¹ä»˜", "é‰„éƒ¨", "æœ¨éƒ¨", "ä»˜å¸¯éƒ¨"];
    const DX_CAM_LOCS  = ["ãƒ™ãƒ©ãƒ³ãƒ€", "å…±ç”¨å»Šä¸‹", "éšæ®µ", "å±‹ä¸Š", "ç„é–¢å»»ã‚Š", "ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹", "å¦»é¢", "è©³ç´°"];
    const DIRECTIONS = ["åŒ—é¢", "åŒ—åŒ—æ±é¢", "åŒ—æ±é¢", "æ±åŒ—æ±é¢", "æ±é¢", "æ±å—æ±é¢", "å—æ±é¢", "å—å—æ±é¢", "å—é¢", "å—å—è¥¿é¢", "å—è¥¿é¢", "è¥¿å—è¥¿é¢", "è¥¿é¢", "è¥¿åŒ—è¥¿é¢", "åŒ—è¥¿é¢", "åŒ—åŒ—è¥¿é¢"];

    let isCamLocationMode = false;
    let currentFloorLevel = parseInt(localStorage.getItem('dx_last_floor')) || 1; 
    let currentDirIndex = parseInt(localStorage.getItem('dx_last_dir')) || 0;
    let editTarget = 'floor';

    document.addEventListener('DOMContentLoaded', () => {
        if(document.getElementById('dirSliderOverlay')) return;
        const sliderHTML = `<div id="dirSliderOverlay" class="slider-overlay"><div class="slider-sub">æŒ‡ã‚’ã‚¹ãƒ©ã‚¤ãƒ‰ã—ã¦æ–¹ä½ã‚’æ±ºå®š</div><div id="dirSliderLabel" class="slider-label">åŒ—</div><input type="range" id="dirRange" min="0" max="15" value="0" step="1"></div>`;
        document.body.insertAdjacentHTML('beforeend', sliderHTML);
        const range = document.getElementById('dirRange');
        range.addEventListener('input', (e) => { const idx = parseInt(e.target.value); document.getElementById('dirSliderLabel').innerText = DIRECTIONS[idx]; currentDirIndex = idx; });
        range.addEventListener('change', () => { localStorage.setItem('dx_last_dir', currentDirIndex); document.getElementById('dirSliderOverlay').classList.remove('show'); renderCameraButtons(); });
    });

    function getCamItems(mode) { const key = mode ? 'dx_cam_locs' : 'dx_cam_parts'; const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : (mode ? [...DX_CAM_LOCS] : [...DX_CAM_PARTS]); }
    function saveCamItems(mode, items) { const key = mode ? 'dx_cam_locs' : 'dx_cam_parts'; localStorage.setItem(key, JSON.stringify(items)); }

    function renderCameraButtons() {
        const group = document.getElementById('customBtnGroup'); if(!group) return; group.innerHTML = '';
        const switchBtn = document.createElement('div'); switchBtn.className = 'cam-chip btn-switch'; switchBtn.innerHTML = isCamLocationMode ? 'ğŸ”„ éƒ¨ä½ã¸' : 'ğŸ”„ å ´æ‰€ã¸';
        switchBtn.onclick = (e) => { e.preventDefault(); isCamLocationMode = !isCamLocationMode; renderCameraButtons(); if(navigator.vibrate) navigator.vibrate(50); };

        if (isCamLocationMode) {
            const floorBtn = document.createElement('div'); floorBtn.className = `cam-chip target-floor ${editTarget === 'floor' ? 'selected' : ''}`; floorBtn.innerText = currentFloorLevel + "F";
            floorBtn.onclick = (e) => handleTargetClick('floor', currentFloorLevel + 'F', e);
            group.appendChild(floorBtn);
            
            const dirBtn = document.createElement('div'); dirBtn.className = `cam-chip target-dir ${editTarget === 'dir' ? 'selected' : ''}`; dirBtn.innerText = DIRECTIONS[currentDirIndex]; if(DIRECTIONS[currentDirIndex].length >= 3) dirBtn.style.fontSize = '0.8rem';
            dirBtn.onclick = (e) => { if(!isSliderMode) handleTargetClick('dir', DIRECTIONS[currentDirIndex], e); };
            dirBtn.addEventListener('touchstart', handleDirCenterStart, {passive: false});
            dirBtn.addEventListener('touchend', handleDirCenterEnd);
            dirBtn.addEventListener('mousedown', handleDirCenterStart);
            dirBtn.addEventListener('mouseup', handleDirCenterEnd);
            group.appendChild(dirBtn);

            group.appendChild(createRepeatBtn('ï¼', -1));
            group.appendChild(createRepeatBtn('ï¼‹', 1));
            group.appendChild(switchBtn);
            
            const currentList = getCamItems(isCamLocationMode);
            for(let i=0; i < 11; i++) {
                const text = currentList[i] || 'ï¼ˆç©ºï¼‰';
                const btn = document.createElement('div'); btn.className = 'cam-chip mode-loc';
                btn.innerHTML = `<span style="pointer-events:none;">${text}</span><div class="chip-bar"></div>`;
                setupCamBtnEvents(btn, i, text); group.appendChild(btn);
            }
        } else {
            group.appendChild(switchBtn);
            const currentList = getCamItems(isCamLocationMode);
            for(let i=0; i < 11; i++) {
                const text = currentList[i] || 'ï¼ˆç©ºï¼‰';
                const btn = document.createElement('div'); btn.className = 'cam-chip';
                if(currentProcess === text) btn.classList.add('active');
                btn.innerHTML = `<span style="pointer-events:none;">${text}</span><div class="chip-bar"></div>`;
                setupCamBtnEvents(btn, i, text); group.appendChild(btn);
            }
        }
    }

    function createRepeatBtn(label, delta) {
        const btn = document.createElement('div'); btn.className = 'cam-chip op-btn'; btn.innerText = label;
        const start = (e) => { if(e.cancelable) e.preventDefault(); startRapidOp(delta); };
        const end = (e) => { if(e.cancelable) e.preventDefault(); stopRapid(); };
        btn.addEventListener('touchstart', start, {passive: false}); btn.addEventListener('touchend', end);
        btn.addEventListener('mousedown', start); btn.addEventListener('mouseup', end); btn.addEventListener('mouseleave', end);
        return btn;
    }

    function handleTargetClick(target, text, e) {
        if (editTarget !== target) { editTarget = target; renderCameraButtons(); if(navigator.vibrate) navigator.vibrate(30); }
        else { inputSpecialText(text, e); }
    }

    let rapidFireTimer = null;
    function startRapidOp(delta) { operate(delta); rapidFireTimer = setTimeout(() => { rapidFireTimer = setInterval(() => operate(delta), 100); }, 400); }
    function stopRapid() { if(rapidFireTimer) { clearTimeout(rapidFireTimer); clearInterval(rapidFireTimer); rapidFireTimer = null; } }
    function operate(delta) { if (editTarget === 'floor') changeFloor(delta); else changeDirection(delta); renderCameraButtons(); }
    function changeFloor(delta) { currentFloorLevel += delta; if(currentFloorLevel < 1) currentFloorLevel = 1; localStorage.setItem('dx_last_floor', currentFloorLevel); }
    function changeDirection(delta) { currentDirIndex += delta; if (currentDirIndex >= DIRECTIONS.length) currentDirIndex = 0; if (currentDirIndex < 0) currentDirIndex = DIRECTIONS.length - 1; localStorage.setItem('dx_last_dir', currentDirIndex); }

    let dirCenterTimer = null, isSliderMode = false;
    function handleDirCenterStart(e) { isSliderMode = false; dirCenterTimer = setTimeout(() => { isSliderMode = true; if(navigator.vibrate) navigator.vibrate(50); const overlay = document.getElementById('dirSliderOverlay'), range = document.getElementById('dirRange'), label = document.getElementById('dirSliderLabel'); range.value = currentDirIndex; label.innerText = DIRECTIONS[currentDirIndex]; overlay.classList.add('show'); }, 600); }
    function handleDirCenterEnd(e) { if(dirCenterTimer) clearTimeout(dirCenterTimer); }

    function inputSpecialText(text, e) {
        const detailBox = document.getElementById('photoDetail');
        detailBox.value = detailBox.value + (detailBox.value ? ' ' : '') + text;
        drawBoard();
        if(e && e.target) { const target = e.target.classList.contains('cam-chip') ? e.target : e.target.closest('.cam-chip'); if(target) { const org = target.style.backgroundColor; target.style.backgroundColor = '#c8e6c9'; setTimeout(() => target.style.backgroundColor = org, 150); } }
    }

    function setupCamBtnEvents(btn, index, text) {
        let pressTimer = null, isLongPress = false, startX, startY; const bar = btn.querySelector('.chip-bar');
        const handleStart = (e) => {
            if (e.type === 'mousedown' && e.button !== 0) return;
            isLongPress = false; if(e.touches) { startX = e.touches[0].clientX; startY = e.touches[0].clientY; } else { startX = e.clientX; startY = e.clientY; }
            if(bar) { bar.style.transition = `width ${LONG_PRESS_MS}ms linear`; bar.style.width = '100%'; } btn.classList.add('pressing');
            pressTimer = setTimeout(() => {
                isLongPress = true; btn.classList.remove('pressing'); if(bar) { bar.style.transition = 'none'; bar.style.width = '0%'; }
                if(navigator.vibrate) navigator.vibrate(100);
                const newName = prompt(`ãƒœã‚¿ãƒ³ã®åç§°ã‚’å¤‰æ›´ã—ã¾ã™\nï¼ˆç¾åœ¨ã®è¨­å®šï¼š${text}ï¼‰`, text);
                if (newName !== null) { const list = getCamItems(isCamLocationMode); list[index] = newName; saveCamItems(isCamLocationMode, list); renderCameraButtons(); }
            }, LONG_PRESS_MS);
        };
        const handleEnd = (e) => {
            clearTimeout(pressTimer); btn.classList.remove('pressing'); if(bar) { bar.style.transition = 'width 0.1s linear'; bar.style.width = '0%'; }
            if (isLongPress) return;
            let endX, endY; if(e.changedTouches) { endX = e.changedTouches[0].clientX; endY = e.changedTouches[0].clientY; } else { endX = e.clientX; endY = e.clientY; }
            if (Math.abs(endX - startX) > 10 || Math.abs(endY - startY) > 10) return;
            if (e.type === 'touchend' && e.cancelable) e.preventDefault();
            if (text !== 'ï¼ˆç©ºï¼‰') { if (isCamLocationMode) { const detailBox = document.getElementById('photoDetail'); detailBox.value = detailBox.value + (detailBox.value ? ' ' : '') + text; drawBoard(); } else { if (btn.classList.contains('active')) { btn.classList.remove('active'); currentProcess = ''; } else { document.querySelectorAll('.proc-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.cam-chip').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentProcess = text; } drawBoard(); } }
        };
        btn.addEventListener('touchstart', handleStart, {passive: false}); btn.addEventListener('touchend', handleEnd, {passive: false});
        btn.addEventListener('mousedown', handleStart); btn.addEventListener('mouseup', handleEnd); btn.addEventListener('mouseleave', () => { clearTimeout(pressTimer); btn.classList.remove('pressing'); if(bar) { bar.style.transition = 'none'; bar.style.width = '0%'; } });
    }

    function renderProcessButtons() {
        const container = document.querySelector('.process-btns'); if(!container) return; container.innerHTML = '';
        const list = JSON.parse(localStorage.getItem('dx_process_list')) || DEFAULT_PROCESSES;
        list.forEach((text, index) => {
            const btn = document.createElement('button'); btn.className = 'proc-btn';
            if (currentProcess === text) btn.classList.add('active');
            btn.innerText = text;
            const bar = document.createElement('div'); bar.className = 'chip-bar'; btn.appendChild(bar);
            setupProcessBtnEvents(btn, index, text);
            container.appendChild(btn);
        });
    }

    function setupProcessBtnEvents(btn, index, text) {
        let pressTimer = null, isLongPress = false, startX, startY; const bar = btn.querySelector('.chip-bar');
        const handleStart = (e) => {
            if (e.type === 'mousedown' && e.button !== 0) return;
            isLongPress = false; if(e.touches) { startX = e.touches[0].clientX; startY = e.touches[0].clientY; } else { startX = e.clientX; startY = e.clientY; }
            if(bar) { bar.style.transition = `width ${LONG_PRESS_MS}ms linear`; bar.style.width = '100%'; } btn.classList.add('pressing');
            pressTimer = setTimeout(() => {
                isLongPress = true; btn.classList.remove('pressing'); if(bar) { bar.style.transition = 'none'; bar.style.width = '0%'; }
                if(navigator.vibrate) navigator.vibrate(100);
                const newName = prompt(`å·¥ç¨‹åã®å¤‰æ›´\nï¼ˆç¾åœ¨ã®è¨­å®šï¼š${text}ï¼‰`, text);
                if(newName !== null && newName.trim() !== "") { const list = JSON.parse(localStorage.getItem('dx_process_list')) || DEFAULT_PROCESSES; list[index] = newName; localStorage.setItem('dx_process_list', JSON.stringify(list)); if(currentProcess === text) currentProcess = newName; renderProcessButtons(); drawBoard(); }
            }, LONG_PRESS_MS);
        };
        const handleEnd = (e) => {
            clearTimeout(pressTimer); btn.classList.remove('pressing'); if(bar) { bar.style.transition = 'width 0.1s linear'; bar.style.width = '0%'; }
            if (isLongPress) return;
            let endX, endY; if(e.changedTouches) { endX = e.changedTouches[0].clientX; endY = e.changedTouches[0].clientY; } else { endX = e.clientX; endY = e.clientY; }
            if (Math.abs(endX - startX) > 10 || Math.abs(endY - startY) > 10) return;
            if (e.type === 'touchend' && e.cancelable) e.preventDefault();
            if (btn.classList.contains('active')) { btn.classList.remove('active'); currentProcess = ''; } 
            else { document.querySelectorAll('.proc-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentProcess = text; } 
            drawBoard();
        };
        btn.addEventListener('touchstart', handleStart, {passive: false}); btn.addEventListener('touchend', handleEnd, {passive: false});
        btn.addEventListener('mousedown', handleStart); btn.addEventListener('mouseup', handleEnd); btn.addEventListener('mouseleave', () => { clearTimeout(pressTimer); btn.classList.remove('pressing'); if(bar) { bar.style.transition = 'none'; bar.style.width = '0%'; } });
    }

    function clearLocation() {
        const input = document.getElementById('photoDetail');
        if(input) { input.value = ""; drawBoard(); }
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å ´é›»å­å°é»’æ¿ã‚«ãƒ¡ãƒ©</title>
    <style>
        /* --- å…¨ä½“è¨­å®š --- */
        body { margin: 0; padding: 0; background: #222; color: white; font-family: sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* --- 1. æº–å‚™ç”»é¢ï¼ˆå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼‰ --- */
        #setupScreen { flex: 1; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; background: #f0f2f5; color: #333; }
        
        /* ä¸ŠåŠåˆ†ï¼šé»’æ¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
        .preview-area { flex: 1; display: flex; justify-content: center; align-items: center; background: #ccc; border-radius: 8px; margin-bottom: 10px; overflow: hidden; position: relative; }
        
        /* é»’æ¿ï¼ˆCanvasï¼‰ */
        #boardCanvas { box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 90%; max-height: 90%; }

        /* ä¸‹åŠåˆ†ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        .input-area { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; color: #555; }
        select, input { width: 100%; padding: 10px; font-size: 1rem; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        .start-btn { width: 100%; padding: 15px; background: #00C853; color: white; font-weight: bold; font-size: 1.2rem; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* --- 2. æ’®å½±ç”»é¢ï¼ˆã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰ï¼‰ --- */
        #cameraScreen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 100; }
        
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* æµ®ã„ã¦ã‚‹é»’æ¿ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ç”¨ï¼‰ */
        #overlayBoard { position: absolute; top: 50px; left: 20px; width: 200px; cursor: grab; z-index: 110; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); touch-action: none; }
        
        /* æ’®å½±UI */
        .camera-controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 30px; z-index: 120; }
        
        .shutter-btn { width: 70px; height: 70px; border-radius: 50%; background: white; border: 5px solid #ccc; cursor: pointer; }
        .shutter-btn:active { background: #ddd; transform: scale(0.95); }
        
        .back-btn { background: rgba(0,0,0,0.5); color: white; border: 1px solid white; padding: 10px 20px; border-radius: 30px; font-weight: bold; cursor: pointer; }

        /* ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡º */
        #flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 200; transition: opacity 0.1s; }
        
        /* DXæ‰‹å¸³ã¸ã®ãƒªãƒ³ã‚¯ */
        .navi-link { text-align: center; margin-bottom: 15px; }
        .navi-link a { color: #007bff; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="setupScreen">
        <div class="navi-link"><a href="navi.html">â†©ï¸ DXæ‰‹å¸³ã«æˆ»ã‚‹</a></div>
        
        <div class="preview-area">
            <canvas id="boardCanvas" width="400" height="300"></canvas>
        </div>

        <div class="input-area">
            <div class="input-group">
                <label>ç¾å ´å (DXæ‰‹å¸³ã‹ã‚‰é¸æŠ)</label>
                <select id="siteSelect" onchange="updateBoard()">
                    <option value="">(é¸æŠã—ã¦ãã ã•ã„)</option>
                </select>
            </div>
            <div class="input-group">
                <label>æ–½å·¥å†…å®¹ / å·¥ç¨®</label>
                <select id="processSelect" onchange="updateBoard()">
                    <option value="æ–½å·¥å‰">æ–½å·¥å‰</option>
                    <option value="ã‚±ãƒ¬ãƒ³ãƒ»æ¸…æƒ">ã‚±ãƒ¬ãƒ³ãƒ»æ¸…æƒ</option>
                    <option value="é«˜åœ§æ´—æµ„">é«˜åœ§æ´—æµ„</option>
                    <option value="é¤Šç”Ÿ">é¤Šç”Ÿ</option>
                    <option value="ä¸‹å¡—ã‚Š">ä¸‹å¡—ã‚Š</option>
                    <option value="ä¸­å¡—ã‚Š">ä¸­å¡—ã‚Š</option>
                    <option value="ä¸Šå¡—ã‚Š">ä¸Šå¡—ã‚Š</option>
                    <option value="å®Œäº†">å®Œäº†</option>
                </select>
            </div>
            <div class="input-group">
                <label>æ–½å·¥ç®‡æ‰€ (ä»»æ„)</label>
                <input type="text" id="locationInput" placeholder="ä¾‹ï¼šå¤–å£ æ±é¢" oninput="updateBoard()">
            </div>
            
            <button class="start-btn" onclick="startCamera()">ğŸ“¸ ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
        </div>
    </div>

    <div id="cameraScreen">
        <video id="video" autoplay playsinline></video>
        
        <img id="overlayBoard" src="" alt="é»’æ¿">

        <div class="camera-controls">
            <button class="back-btn" onclick="stopCamera()">æˆ»ã‚‹</button>
            <button class="shutter-btn" onclick="takePhoto()"></button>
            <div style="width: 60px;"></div> </div>
        
        <div id="flash"></div>
    </div>

    <script>
        // --- è¨­å®š ---
        const canvas = document.getElementById('boardCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('video');
        let stream = null;

        // DXæ‰‹å¸³ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        const sites = JSON.parse(localStorage.getItem('dx_sites')) || [];

        // åˆæœŸåŒ–
        window.onload = () => {
            loadSites();
            drawBoard(); // åˆæœŸã®ç©ºé»’æ¿ã‚’æç”»
        };

        // --- 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ & é»’æ¿æç”» ---
        function loadSites() {
            const select = document.getElementById('siteSelect');
            // æ–½å·¥ä¸­ã®ã‚‚ã®ã‚’å„ªå…ˆã—ã¦è¡¨ç¤º
            const activeSites = sites.filter(s => s.status === 'active');
            const otherSites = sites.filter(s => s.status !== 'active');
            
            [...activeSites, ...otherSites].forEach(site => {
                const opt = document.createElement('option');
                opt.value = site.name;
                opt.textContent = site.status === 'active' ? `ã€æ–½å·¥ä¸­ã€‘${site.name}` : site.name;
                select.appendChild(opt);
            });
        }

        function updateBoard() {
            drawBoard();
        }

        function drawBoard() {
            const siteName = document.getElementById('siteSelect').value || "ã€€";
            const process = document.getElementById('processSelect').value;
            const location = document.getElementById('locationInput').value || "";
            
            // æ—¥ä»˜å–å¾—
            const d = new Date();
            const dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;

            // --- é»’æ¿ã®ãƒ‡ã‚¶ã‚¤ãƒ³ ---
            // èƒŒæ™¯ï¼ˆæ·±ç·‘ï¼‰
            ctx.fillStyle = '#004d40';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ ç·šï¼ˆç™½ï¼‰
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 5;
            ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);

            // ç½«ç·š
            ctx.lineWidth = 2;
            ctx.beginPath();
            // æ¨ªç·š1 (å·¥äº‹åã®ä¸‹)
            ctx.moveTo(10, 80); ctx.lineTo(390, 80);
            // æ¨ªç·š2 (å·¥ç¨®ã®ä¸‹)
            ctx.moveTo(10, 150); ctx.lineTo(390, 150);
            // ç¸¦ç·š (æ—¥ä»˜ã®å·¦)
            ctx.moveTo(280, 230); ctx.lineTo(280, 290); // æ—¥ä»˜æ ã‚’ä½œã‚‹å ´åˆãªã©
            ctx.stroke();

            // æ–‡å­—è¨­å®š
            ctx.fillStyle = 'white';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';

            // å·¥äº‹å
            ctx.font = 'bold 20px sans-serif';
            ctx.fillText("å·¥äº‹å", 20, 30);
            ctx.font = 'bold 28px sans-serif';
            ctx.fillText(siteName, 20, 55);

            // å·¥ç¨®ãƒ»æ–½å·¥å†…å®¹
            ctx.font = 'bold 20px sans-serif';
            ctx.fillText("å·¥ç¨® / æ–½å·¥å†…å®¹", 20, 100);
            ctx.font = 'bold 32px sans-serif';
            ctx.fillText(process, 40, 128);

            // æ–½å·¥ç®‡æ‰€ï¼ˆç©ºãªã‚‰è©°ã‚ãªã„ï¼‰
            ctx.font = 'bold 20px sans-serif';
            ctx.fillText("æ–½å·¥ç®‡æ‰€", 20, 175);
            ctx.font = 'bold 28px sans-serif';
            ctx.fillText(location, 40, 205);

            // æ—¥ä»˜ï¼ˆå³ä¸‹ï¼‰
            ctx.textAlign = 'right';
            ctx.font = 'bold 24px sans-serif';
            ctx.fillText(dateStr, 380, 270);
            
            // ç¤¾åãƒ­ã‚´çš„ãªã‚‚ã®ï¼ˆå·¦ä¸‹ï¼‰
            ctx.textAlign = 'left';
            ctx.font = '16px sans-serif';
            ctx.fillStyle = '#ccc';
            ctx.fillText("ãƒšã‚¤ãƒ³ãƒˆãƒã‚¦ã‚¹å±±å²¡", 20, 270);
        }

        // --- 2. ã‚«ãƒ¡ãƒ©èµ·å‹• & é»’æ¿è»¢é€ ---
        async function startCamera() {
            // é»’æ¿ç”»åƒã‚’ç”Ÿæˆã—ã¦æ’®å½±ç”»é¢ã®imgã‚¿ã‚°ã«ã‚»ãƒƒãƒˆ
            const dataUrl = canvas.toDataURL('image/png');
            const overlay = document.getElementById('overlayBoard');
            overlay.src = dataUrl;
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('cameraScreen').style.display = 'block';

            // ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆèƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆï¼‰
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: { ideal: "environment" } }, 
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\næ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
                stopCamera();
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('setupScreen').style.display = 'flex';
            document.getElementById('cameraScreen').style.display = 'none';
        }

        // --- 3. ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰ ---
        const overlay = document.getElementById('overlayBoard');
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;

        // ã‚¿ãƒƒãƒé–‹å§‹
        overlay.addEventListener('touchstart', (e) => {
            isDragging = true;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            initialLeft = overlay.offsetLeft;
            initialTop = overlay.offsetTop;
            e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
        });

        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­
        overlay.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const dx = e.touches[0].clientX - startX;
            const dy = e.touches[0].clientY - startY;
            overlay.style.left = `${initialLeft + dx}px`;
            overlay.style.top = `${initialTop + dy}px`;
            e.preventDefault();
        });

        // çµ‚äº†
        overlay.addEventListener('touchend', () => { isDragging = false; });

        // PCï¼ˆãƒã‚¦ã‚¹ï¼‰ç”¨ã‚‚ä¸€å¿œ
        overlay.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            initialLeft = overlay.offsetLeft;
            initialTop = overlay.offsetTop;
        });
        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            overlay.style.left = `${initialLeft + dx}px`;
            overlay.style.top = `${initialTop + dy}px`;
        });
        window.addEventListener('mouseup', () => { isDragging = false; });


        // --- 4. æ’®å½±ï¼†åˆæˆä¿å­˜ ---
        function takePhoto() {
            // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡º
            const flash = document.getElementById('flash');
            flash.style.opacity = 1;
            setTimeout(() => flash.style.opacity = 0, 100);

            // åˆæˆç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ä½œæˆï¼ˆå‹•ç”»ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹ï¼‰
            const captureCanvas = document.createElement('canvas');
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            const ctxCap = captureCanvas.getContext('2d');

            // 1. ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’æç”»
            ctxCap.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);

            // 2. é»’æ¿ã‚’åˆæˆ
            // ç”»é¢ä¸Šã®ä½ç½®ã¨æ¯”ç‡ã‚’è¨ˆç®—ã—ã¦ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®åº§æ¨™ã«å¤‰æ›ã™ã‚‹
            const rect = video.getBoundingClientRect(); // ç”»é¢ä¸Šã®å‹•ç”»ã‚µã‚¤ã‚º
            const scaleX = captureCanvas.width / rect.width; // å®Ÿéš›ã®è§£åƒåº¦ã¨ã®æ¯”ç‡
            const scaleY = captureCanvas.height / rect.height;

            const board = document.getElementById('overlayBoard');
            const boardRect = board.getBoundingClientRect();

            // é»’æ¿ã®ä½ç½®ï¼ˆç”»é¢ä¸Šï¼‰ã‹ã‚‰å‹•ç”»å†…ã®åº§æ¨™ã¸å¤‰æ›
            const boardX = (boardRect.left - rect.left) * scaleX;
            const boardY = (boardRect.top - rect.top) * scaleY;
            const boardW = boardRect.width * scaleX;
            const boardH = boardRect.height * scaleY;

            // é»’æ¿ç”»åƒã‚’æç”»
            ctxCap.drawImage(board, boardX, boardY, boardW, boardH);

            // 3. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const dataUrl = captureCanvas.toDataURL('image/jpeg');
            const link = document.createElement('a');
            const timeStr = new Date().toISOString().replace(/[:.]/g, '-');
            link.href = dataUrl;
            link.download = `ç¾å ´å†™çœŸ_${timeStr}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
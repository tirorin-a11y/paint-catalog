<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ヘルプ＆設定 - 職人ギア</title>
    <link rel="icon" href="icon-192x192.png">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif; background: #f0f2f5; padding: 20px; color: #333; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 50px; }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 1.5rem; }
        .back-link { display: block; margin-bottom: 20px; color: #2980b9; text-decoration: none; font-weight: bold; }

        details { background: white; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; }
        summary { padding: 15px 20px; font-weight: bold; cursor: pointer; background: #fff; list-style: none; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; color: #2c3e50; }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: '+'; font-size: 1.5rem; color: #aaa; }
        details[open] summary { border-bottom: 1px solid #eee; background: #f9f9f9; }
        details[open] summary::after { content: '-'; }
        
        .content { padding: 20px; }
        
        .code-area { width: 100%; height: 200px; font-family: monospace; font-size: 13px; background: #282c34; color: #abb2bf; padding: 15px; border-radius: 6px; border: 1px solid #ccc; white-space: pre; overflow: auto; margin-bottom: 10px; box-sizing: border-box; }

        .btn-copy { background-color: #2980b9; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; width: 100%; justify-content: center; }
        .btn-copy:active { transform: translateY(2px); }
        
        h3 { border-left: 4px solid #3498db; padding-left: 10px; margin-top: 25px; color: #34495e; }
        h3:first-of-type { margin-top: 0; }
        ul, ol { padding-left: 20px; }
        li { margin-bottom: 8px; }
        
        .alert-box { background: #fff3e0; border: 1px solid #ffe0b2; padding: 15px; border-radius: 6px; color: #e65100; font-size: 0.95rem; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <a href="navi.html" class="back-link">← アプリに戻る</a>
    <h1>📖 ヘルプ＆設定ガイド</h1>

    <details open>
        <summary>📱 アプリの使い方・データ保存</summary>
        <div class="content">
            <h3>基本操作</h3>
            <ul>
                <li><strong>現場の登録:</strong> 右下の「＋」ボタンから新規登録できます。</li>
                <li><strong>ナビ起動:</strong> リストの「🚀」ボタンを押すとGoogleマップが起動し、同時にナビ回数がカウントされます。</li>
                <li><strong>ステータス変更:</strong> リスト左上のバッジ（見積中など）を見ることで状況を一目で確認できます。</li>
            </ul>

            <h3>☁️ クラウド同期（推奨）</h3>
            <p>スプレッドシートを使って、PCや他のスマホとデータを自動同期します。</p>
            <ul>
                <li><strong>バックアップ:</strong> 設定画面の「☁️ クラウドへバックアップ」で保存します。</li>
                <li><strong>復元:</strong> 「📥 クラウドから復元」で最新データを取り込みます。</li>
                <li>※PCで編集した内容も「復元」ボタンで反映されます。</li>
            </ul>

            <h3>📂 ファイルでの保存・復元（メールなど）</h3>
            <p>クラウド設定がなくても、ファイルを使ってデータのバックアップや共有ができます。</p>
            <ul>
                <li><strong>書き出し:</strong> 右下の「共有ボタン（オレンジ色）」を押し、「共有」を選ぶと、メールやLINEでデータファイル（.json）を送信・保存できます。</li>
                <li><strong>取り込み:</strong> 設定画面（⚙️）の「📥 ファイルから復元」を押し、メール等で受け取ったファイルを選択すると復元されます。</li>
            </ul>
        </div>
    </details>

    <details>
        <summary>📝 日報・ツール機能</summary>
        <div class="content">
            <h3>日報の送信</h3>
            <p>現場リストの「🧰 ツール」ボタンから日報画面へ移動できます。</p>
            <ul>
                <li><strong>日報作成:</strong> その日の作業内容を入力して保存します。履歴として端末に残ります。</li>
                <li><strong>クラウド提出:</strong> 「📤 クラウドへ提出」ボタンを押すと、スプレッドシートの「日報」シートに送信されます。</li>
                <li>※一度提出した日報も、履歴から再送可能です。</li>
            </ul>
        </div>
    </details>

    <details>
        <summary>🛠️ 【初期設定】クラウド環境の構築</summary>
        <div class="content">
            <p>このアプリのデータを保存・共有するための「スプレッドシート」を作成する手順です。<br>
            <strong>初めて使う方</strong>や、<strong>管理者の方</strong>のみ行ってください。</p>

            <h3>STEP 1. スプレッドシート準備</h3>
            <ol>
                <li><a href="https://sheets.new" target="_blank">Googleスプレッドシート</a> を新規作成します。</li>
                <li>ファイル名を「職人ギア_データ」等に変更します。</li>
                <li>「拡張機能」→「Apps Script」を開きます。</li>
            </ol>

            <h3>STEP 2. スクリプト登録</h3>
            <p>エディタの文字を全て消し、以下のコードを貼り付けてください。</p>
            
            <textarea id="gasCode" class="code-area" readonly>
// --- メイン処理 (スマホからの通信受付) ---
function doPost(e) {
  var json = {};
  try {
    json = JSON.parse(e.postData.contents);
  } catch (err) {
    return createResponse({ result: "error", error: "JSON parse error" });
  }

  var type = json.type;
  var ss = SpreadsheetApp.getActiveSpreadsheet();

  // --- A: 日報送信 ---
  if (type === "report") {
    var sheet = ss.getSheetByName("日報");
    if (!sheet) { 
      sheet = ss.insertSheet("日報"); 
      sheet.appendRow(["日時", "案件No", "現場名", "住所", "報告者", "内容"]); 
      sheet.setFrozenRows(1); 
    }
    var reporter = json.reporter || "職人";
    var reportDate = json.timestamp ? new Date(json.timestamp) : new Date();
    sheet.appendRow([reportDate, json.id, json.siteName, json.address, reporter, json.content]);
    
    return createResponse({ result: "success" });
  }

  // --- B: 全データ同期 (スマホ→シートへ保存) ---
  else if (type === "sync") {
    var sheet = ss.getSheetByName("案件一覧");
    if (!sheet) { sheet = ss.insertSheet("案件一覧"); }
    
    // シートを一度クリアしてヘッダーを作り直す
    sheet.clear();
    var header = ["案件No", "親案件No", "現場名", "住所", "ステータス", "ナビ回数", "工期開始", "工期終了", "最終更新日時", "JSONデータ"];
    sheet.appendRow(header);
    
    var sites = json.data;
    var rows = [];
    
    // 日本語変換マップ（スマホ英語 -> シート日本語）
    var stMap = { 'estimate':'見積中', 'contract':'契約済み', 'billing':'請求', 'complete':'完了', 'lost':'失注' };

    for (var i = 0; i < sites.length; i++) {
      var s = sites[i];
      // 日本語に変換して保存
      var stLabel = stMap[s.status] || s.status;
      
      rows.push([
        s.id, 
        s.parentCaseNo||"", 
        s.name, 
        s.address, 
        stLabel, // E列: 日本語
        s.naviCount||0, 
        s.start||"", 
        s.end||"", 
        s.updatedAt ? new Date(s.updatedAt).toLocaleString() : "",
        JSON.stringify(s) // J列: バックアップ用JSON
      ]);
    }
    
    if (rows.length > 0) { sheet.getRange(2, 1, rows.length, rows[0].length).setValues(rows); }
    return createResponse({ result: "success", msg: "保存完了" });
  }

  // --- C: カレンダー機能（期間対応版） ---
  else if (type === "calendar") {
    try {
      var calId = json.calendarId;
      var cal = CalendarApp.getCalendarById(calId);
      
      if (!cal) throw new Error("カレンダーIDが見つかりません: " + calId);

      // 開始日の取得
      var startStr = json.start || json.startDate || json.date;
      if (!startStr) throw new Error("開始日がありません");
      var startDate = new Date(startStr);

      // 終了日の取得（あれば）
      var endStr = json.end || json.endDate;
      
      var title = json.title || "現場予定";
      var options = {
        description: json.description || "登録: 職人ギア",
        location: json.address || ""
      };

      // ★ここが進化ポイント：期間判定
      if (endStr && endStr !== startStr) {
        // 終了日がある場合
        var endDate = new Date(endStr);
        // Googleカレンダーの仕様上、終了日は「その日を含まない」ので、+1日してあげる必要がある
        endDate.setDate(endDate.getDate() + 1);
        
        // 期間イベントとして作成
        cal.createAllDayEvent(title, startDate, endDate, options);
      } else {
        // 1日だけのイベントとして作成
        cal.createAllDayEvent(title, startDate, options);
      }
      
      return createResponse({ result: "success", message: "登録完了" });
      
    } catch (error) {
      return createResponse({ result: "error", error: error.toString() });
    }
  }

  return createResponse({ result: "error", error: "不明なリクエストタイプ: " + type });
}

// レスポンス作成用ヘルパー関数
function createResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

// --- シートのセルを読んでスマホに返す (変更なし) ---
function doGet(e) {
  var type = e.parameter.type;
  var ss = SpreadsheetApp.getActiveSpreadsheet();

  // データ取得
  if (type === "getAll") {
    var sheet = ss.getSheetByName("案件一覧");
    // シートがなければ空配列を返す
    if (!sheet) return createResponse([]);
    
    var rows = sheet.getDataRange().getValues();
    var data = [];

    // 逆変換マップ（シート日本語 -> スマホ英語）
    var reverseStMap = { '見積中':'estimate', '契約済み':'contract', '請求':'billing', '完了':'complete', '失注':'lost' };

    // 1行目(ヘッダー)は飛ばして、2行目から読む
    for (var i = 1; i < rows.length; i++) {
      var row = rows[i];
      
      // JSON列(J列)は無視して、セルから直接データを作る！
      var siteData = {
        id: String(row[0]),          // A列: 案件No
        parentCaseNo: String(row[1]),// B列: 親案件No
        name: String(row[2]),        // C列: 現場名
        address: String(row[3]),     // D列: 住所
        status: reverseStMap[row[4]] || 'estimate', // E列: ステータス(日本語を英語に戻す)
        naviCount: Number(row[5]),   // F列
        start: row[6] ? formatYMD(row[6]) : "", // G列: 日付変換
        end: row[7] ? formatYMD(row[7]) : "",   // H列
        updatedAt: row[8] ? new Date(row[8]).getTime() : 0 // I列: 更新日時
      };
      
      // もしIDが空ならスキップ
      if(siteData.id) {
        data.push(siteData);
      }
    }
    
    return createResponse(data);
  }
  
  return createResponse({msg:"ready"});
}

// 日付型を "YYYY-MM-DD" 文字列になおす補助関数
function formatYMD(val) {
  if (!val) return "";
  var d = new Date(val);
  if (isNaN(d.getTime())) return "";
  var y = d.getFullYear();
  var m = ("0" + (d.getMonth() + 1)).slice(-2);
  var da = ("0" + d.getDate()).slice(-2);
  return y + "-" + m + "-" + da;
}

// --- スプレッドシート編集検知 (変更なし) ---
function onEdit(e) {
  var sheet = e.source.getActiveSheet();
  if (sheet.getName() !== "案件一覧") return;
  var row = e.range.getRow();
  var col = e.range.getColumn();
  if (row < 2 || col === 9) return;
  sheet.getRange(row, 9).setValue(new Date());
}

            </textarea>
            <button class="btn-copy" onclick="copyCode()">📋 コードをコピー</button>

            <h3>STEP 3. デプロイ設定（重要）</h3>
            <ul>
                <li>右上の「デプロイ」→「新しいデプロイ」</li>
                <li>種類：「ウェブアプリ」</li>
                <li>アクセスできるユーザー：<span style="color:red; font-weight:bold;">全員 (Anyone)</span></li>
            </ul>
            
            <div class="alert-box">
                <strong>⚠️ 重要：警告画面が出た場合</strong><br>
                初回は「このアプリはGoogleによって確認されていません」という警告が出ます。<br>
                これは自作アプリでは必ず出るものです。ウイルスではありません。<br>
                <br>
                1. 左下の <strong>「詳細 (Advanced)」</strong> をクリック<br>
                2. 一番下の <strong>「...（安全ではないページ）に移動」</strong> をクリック<br>
                3. <strong>「許可 (Allow)」</strong> を押して完了させてください。
            </div>

            <p>最後に発行されたURLをコピーし、アプリの「設定」→「GAS URL」に登録してください。</p>
        </div>
    </details>

    <br>
    <a href="navi.html" class="back-link" style="text-align:center;">アプリに戻る</a>
</div>

<script>
    function copyCode() {
        var copyText = document.getElementById("gasCode");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value).then(function() {
            alert("✅ コピーしました！");
        }, function() {
            alert("コピーできませんでした。手動でコピーしてください。");
        });
    }
</script>

</body>
</html>
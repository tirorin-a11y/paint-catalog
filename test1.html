<!DOCTYPE html>
<html>
<head>
<style>
  /* ãƒ†ã‚¹ãƒˆç”¨ã®ç°¡æ˜“ã‚¹ã‚¿ã‚¤ãƒ« */
  #previewImg { max-width: 100%; height: auto; margin-top: 10px; border: 1px solid #ccc; display: none;}
  #loading { display: none; color: blue; font-weight: bold;}
  #resultArea { margin-top: 20px; padding: 10px; border: 2px solid #333; background: #f9f9f9; display: none;}
  .btn-camera { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px;}
</style>
</head>
<body>

  <h2>AIãƒ¬ã‚·ãƒ¼ãƒˆèª­å–ãƒ†ã‚¹ãƒˆ</h2>

  <input type="file" accept="image/*" capture="environment" id="fileInput" style="display: none;">
  <button class="btn-camera" onclick="document.getElementById('fileInput').click();">ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±</button>

  <img id="previewImg" src="">
  
  <p id="loading">ğŸ¤– AIãŒè§£æä¸­...ï¼ˆæ•°ç§’ãŠå¾…ã¡ãã ã•ã„ï¼‰</p>

  <div id="resultArea">
    <p>æ—¥ä»˜: <span id="resDate"></span></p>
    <p>é‡‘é¡: <span id="resAmount"></span> å††</p>
    <p>åº—å: <span id="resShop"></span></p>
    <p style="font-size:12px; color:#666;">â€»ã“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚«ãƒ¼ãƒ‰ã«ãªã£ã¦ã‚¹ãƒ¯ã‚¤ãƒ—ç”»é¢ã«é£›ã³ã¾ã™</p>
  </div>


<script>
  // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠï¼ˆæ’®å½±ï¼‰ã•ã‚ŒãŸã‚‰å‹•ãå‡¦ç†
  document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    // 1. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    const preview = document.getElementById('previewImg');
    const loading = document.getElementById('loading');
    const resultArea = document.getElementById('resultArea');
    
    preview.style.display = 'block';
    preview.src = URL.createObjectURL(file);
    loading.style.display = 'block';
    resultArea.style.display = 'none';

    // 2. ç”»åƒã‚’Base64å½¢å¼ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼‰ã«å¤‰æ›
    const reader = new FileReader();
    reader.onloadend = function() {
      const base64Data = reader.result;

      // 3. GASå´ã®é–¢æ•°(analyzeReceiptImage)ã‚’å‘¼ã³å‡ºã™
      google.script.run
        .withSuccessHandler(onSuccess) // æˆåŠŸã—ãŸã‚‰ onSuccess ã‚’å®Ÿè¡Œ
        .withFailureHandler(onFailure) // å¤±æ•—ã—ãŸã‚‰ onFailure ã‚’å®Ÿè¡Œ
        .analyzeReceiptImage(base64Data);
    }
    reader.readAsDataURL(file);
  });

  // æˆåŠŸã—ãŸæ™‚ã®å‡¦ç†ï¼ˆGASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã£ã¦ããŸã‚‰ï¼‰
  function onSuccess(data) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('resultArea').style.display = 'block';

    if (data.error) {
      alert("ã‚¨ãƒ©ãƒ¼: " + data.error);
    } else {
      // è¿”ã£ã¦ããŸãƒ‡ãƒ¼ã‚¿ã‚’ç”»é¢ã«è¡¨ç¤º
      document.getElementById('resDate').textContent = data.date || "ä¸æ˜";
      document.getElementById('resAmount').textContent = data.amount || "0";
      document.getElementById('resShop').textContent = data.shop || "ä¸æ˜";
      
      console.log("AIè§£æçµæœ:", data); // é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚‚ç¢ºèªã§ãã¾ã™
    }
  }

  // å¤±æ•—ã—ãŸæ™‚ã®å‡¦ç†
  function onFailure(error) {
     document.getElementById('loading').style.display = 'none';
     alert("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
  }
</script>

</body>
</html>
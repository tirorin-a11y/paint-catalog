<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹ç®¡ç† - è·äººã‚®ã‚¢</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="style.css">
    <style>
        body { 
            font-family: sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            padding-bottom: 50px; 
            overflow: hidden; /* å…¨ä½“ã®ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢ */
        }
        header { 
            background: #2c3e50; 
            color: white; 
            padding: 10px 15px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .nav-links { 
            display: flex; 
            gap: 10px; 
            padding: 10px; 
            justify-content: center; 
            background: #fff; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: sticky; 
            top: 50px; 
            z-index: 90;
        }
        .nav-btn { text-decoration: none; font-size: 0.85rem; padding: 8px 20px; border-radius: 20px; background: #f8f9fa; color: #555; border: 1px solid #ddd; font-weight: bold; }

        .toggle-area { 
            padding: 10px 15px; 
            background: #fff; 
            border-bottom: 1px solid #eee; 
            border-top: 1px solid #eee;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            position: sticky; 
            top: 98px; 
            z-index: 90;
        }
        
        .current-month {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-toggle { background: #fff; border: 1px solid #2980b9; color: #2980b9; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .btn-toggle.active { background: #2980b9; color: white; }
        
        /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
        .gantt-container { 
            overflow-x: auto; 
            background: white; 
            position: relative; 
            height: calc(100vh - 150px); 
            cursor: grab; /* ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã€Œæ´ã‚€æ‰‹ã€ã« */
        }
        .gantt-container:active {
            cursor: grabbing; /* æ´ã‚“ã§ã„ã‚‹æ™‚ã¯ã€Œæ¡ã‚‹æ‰‹ã€ã« */
        }

        /* â˜…è¿½åŠ ï¼šPCç”¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .gantt-container::-webkit-scrollbar {
            height: 12px; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å°‘ã—å¤ªã */
        }
        .gantt-container::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .gantt-container::-webkit-scrollbar-thumb {
            background: #bbb; /* ã¤ã¾ã¿éƒ¨åˆ†ã®è‰² */
            border-radius: 6px;
        }
        .gantt-container::-webkit-scrollbar-thumb:hover {
            background: #999; /* ãƒ›ãƒãƒ¼æ™‚ã«æ¿ƒã */
        }
        
        .gantt-header { 
            display: flex; 
            position: sticky; 
            top: 0; 
            background: #ecf0f1; 
            z-index: 10; 
            border-bottom: 1px solid #ddd; 
        }
        
        .gantt-cell { 
            min-width: 40px; 
            height: 40px; 
            border-right: 1px solid #eee; 
            border-bottom: 1px solid #eee; 
            text-align: center; 
            line-height: 40px; 
            font-size: 0.8rem; 
            box-sizing: border-box; 
            flex-shrink: 0;
            user-select: none; /* æ–‡å­—é¸æŠé˜²æ­¢ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ã®ãŸã‚ï¼‰ */
        }
        
        .day-header { font-weight: bold; font-size: 0.7rem; color: #555; }
        .is-sunday { background-color: #ffcdd2; color: #c62828; }
        .is-today { background-color: #fff9c4; border-bottom: 3px solid #fbc02d; }
        
        .site-row { 
            display: flex; 
            position: relative; 
            height: 50px; 
            align-items: center; 
            border-bottom: 1px solid #eee; 
        }
        
        .site-name-col { 
            position: sticky; 
            left: 0; 
            width: 120px; 
            background: white; 
            z-index: 5; 
            font-size: 0.8rem; 
            padding: 0 5px; 
            border-right: 2px solid #ddd; 
            display: flex; 
            align-items: center; 
            height: 100%; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); 
            flex-shrink: 0;
            cursor: pointer;
            color: #2980b9;
            font-weight: bold;
            transition: background 0.2s;
            user-select: none;
        }
        .site-name-col:active { background-color: #e3f2fd; }
        
        .bar { 
            position: absolute; 
            height: 24px; 
            top: 13px; 
            border-radius: 12px; 
            font-size: 0.7rem; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            white-space: nowrap; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            opacity: 0.9; 
            cursor: pointer; 
        }
        .bar-plan { background: #f39c12; }
        .bar-active { background: #2980b9; }
        .bar-done { background: #7f8c8d; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; display: none; }
        .overlay.show { display: block; }
        .modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; background: white; padding: 20px; border-radius: 12px; z-index: 160; box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: none; }
        .modal-box.show { display: block; }
        .modal-btn-area { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-save { background: #2980b9; color: white; }
        .btn-cancel { background: #eee; color: #333; }
        input[type="date"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-top: 5px; font-size: 1rem; }
        label { display: block; margin-top: 15px; font-size: 0.9rem; font-weight: bold; color: #555; }
    </style>
</head>
<body>

<header>
    <div style="font-weight:bold; font-size:1.1rem;">ğŸ“Š å·¥ç¨‹ç®¡ç†</div>
    <a href="navi.html" style="color:white; text-decoration:none; font-size:1.2rem;">âœ•</a>
</header>

<div class="nav-links">
    <a href="navi.html" class="nav-btn">ğŸ  ç¾å ´ãƒŠãƒ“</a>
    <a href="index.html" class="nav-btn">ğŸ” æ¤œç´¢</a>
</div>

<div class="toggle-area">
    <div class="current-month">
        <span style="font-size:1.5rem;">ğŸ“…</span> <span id="monthDisplay">--å¹´ --æœˆ</span>
    </div>
    <button class="btn-toggle" id="btnShowAll" onclick="toggleShowAll()">å…¨ã¦ã®ç¾å ´ã‚’è¡¨ç¤º</button>
</div>

<div id="ganttArea" class="gantt-container"></div>

<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div id="dateModal" class="modal-box">
    <h3 style="margin-top:0; color:#2c3e50;">ğŸ“… æ—¥ç¨‹ã®èª¿æ•´</h3>
    <p id="editSiteName" style="font-weight:bold; color:#2980b9; border-bottom:1px solid #eee; padding-bottom:10px;"></p>
    <label>é–‹å§‹æ—¥</label><input type="date" id="editStart">
    <label>çµ‚äº†æ—¥</label><input type="date" id="editEnd">
    <div class="modal-btn-area">
        <button class="modal-btn btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn btn-save" onclick="saveSchedule()">ä¿ å­˜</button>
    </div>
</div>

<script>
    let sites = JSON.parse(localStorage.getItem('dx_sites')) || [];
    let isShowAll = false;
    let editingId = null;
    let gStartDate = null; 

    function toggleShowAll() {
        isShowAll = !isShowAll;
        const btn = document.getElementById('btnShowAll');
        if(isShowAll) {
            btn.classList.add('active');
            btn.textContent = "å®Œäº†ç¾å ´ã‚’éš ã™";
        } else {
            btn.classList.remove('active');
            btn.textContent = "å…¨ã¦ã®ç¾å ´ã‚’è¡¨ç¤º";
        }
        renderGantt();
    }

    function parseDate(str) {
        if(!str) return null;
        return new Date(str.replace(/-/g, '/'));
    }

    function getDiffDays(date1, date2) {
        const dt1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
        const dt2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
        return Math.floor((dt2 - dt1) / (1000 * 60 * 60 * 24));
    }

    function openEditModal(id) {
        const site = sites.find(s => s.id === id);
        if(!site) return;
        editingId = id;
        document.getElementById('editSiteName').textContent = site.name;
        document.getElementById('editStart').value = site.start || '';
        document.getElementById('editEnd').value = site.end || '';
        document.getElementById('overlay').classList.add('show');
        document.getElementById('dateModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('overlay').classList.remove('show');
        document.getElementById('dateModal').classList.remove('show');
        editingId = null;
    }

    function saveSchedule() {
        if(!editingId) return;
        const index = sites.findIndex(s => s.id === editingId);
        if(index !== -1) {
            const newStart = document.getElementById('editStart').value;
            const newEnd = document.getElementById('editEnd').value;
            if(newStart && newEnd && newStart > newEnd) { alert("é–‹å§‹æ—¥ãŒçµ‚äº†æ—¥ã‚ˆã‚Šå¾Œã«ãªã£ã¦ã„ã¾ã™"); return; }
            sites[index].start = newStart;
            sites[index].end = newEnd;
            sites[index].updatedAt = Date.now();
            localStorage.setItem('dx_sites', JSON.stringify(sites));
            renderGantt();
            closeModal();
        }
    }

    function updateMonthDisplay() {
        const container = document.getElementById('ganttArea');
        if(!gStartDate) return;
        const scrollLeft = container.scrollLeft;
        const daysToAdd = Math.floor((scrollLeft + 20) / 40);
        const currentDate = new Date(gStartDate);
        currentDate.setDate(gStartDate.getDate() + daysToAdd);
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        document.getElementById('monthDisplay').textContent = `${year}å¹´ ${month}æœˆ`;
    }

    function renderGantt() {
        const container = document.getElementById('ganttArea');
        container.innerHTML = '';

        const today = new Date();
        const startDate = new Date(today.getFullYear(), today.getMonth(), 1); 
        gStartDate = startDate; 
        const endDate = new Date(today.getFullYear(), today.getMonth() + 3, 0);
        const totalDays = getDiffDays(startDate, endDate) + 1;

        let headerHTML = '<div class="gantt-header"><div class="gantt-cell" style="min-width:120px; position:sticky; left:0; z-index:20; background:#ecf0f1; border-right:2px solid #ddd;">ç¾å ´å</div>';
        let todayLeftPos = 0;

        for (let i = 0; i < totalDays; i++) {
            const d = new Date(startDate);
            d.setDate(startDate.getDate() + i);
            const isSun = d.getDay() === 0;
            const isToday = d.toDateString() === today.toDateString();
            if (isToday) todayLeftPos = i * 40;
            headerHTML += `<div class="gantt-cell day-header ${isSun?'is-sunday':''} ${isToday?'is-today':''}">${d.getDate()}</div>`;
        }
        headerHTML += '</div>';
        container.insertAdjacentHTML('beforeend', headerHTML);

        const targetSites = isShowAll ? sites : sites.filter(s => s.status !== 'complete' && s.status !== 'lost' && s.status !== 'done' && s.status !== 'handover');

        targetSites.forEach(site => {
            if (!site.start || !site.end) return;
            const sDate = parseDate(site.start);
            const eDate = parseDate(site.end);
            if (eDate < startDate || sDate > endDate) return;
            const offsetDays = getDiffDays(startDate, sDate);
            const durationDays = getDiffDays(sDate, eDate) + 1;
            let left = offsetDays * 40;
            let width = durationDays * 40;
            if (left < 0) { width += left; left = 0; } 

            let barClass = 'bar-plan';
            if (site.status === 'contract' || site.status === 'active' || site.status === 'billing') { barClass = 'bar-active'; }
            if (site.status === 'complete' || site.status === 'lost' || site.status === 'done') { barClass = 'bar-done'; }

            const rowHTML = `
                <div class="site-row" style="width:${120 + (totalDays * 40)}px">
                    <div class="site-name-col" onclick="openEditModal('${site.id}')" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ—¥ç¨‹å¤‰æ›´">
                        ${site.name} <span style="font-size:0.6rem; color:#888; margin-left:2px;">âœ</span>
                    </div>
                    <div class="bar ${barClass}" style="left:${120 + left}px; width:${width}px;">${durationDays}æ—¥</div>
                    ${Array.from({length: totalDays}).map((_, idx) => {
                        const d = new Date(startDate); d.setDate(startDate.getDate() + idx);
                        const isSun = d.getDay() === 0;
                        const isToday = d.toDateString() === today.toDateString();
                        let bg = isToday ? '#fff9c4' : (isSun ? '#fff0f0' : 'transparent');
                        return `<div style="position:absolute; left:${120 + idx * 40}px; top:0; width:40px; height:100%; border-right:1px solid #eee; background:${bg}; z-index:-1;"></div>`
                    }).join('')}
                </div>
            `;
            container.insertAdjacentHTML('beforeend', rowHTML);
        });

        container.onscroll = updateMonthDisplay;
        updateMonthDisplay();
        if(todayLeftPos > 0) { setTimeout(() => { container.scrollTo({ left: todayLeftPos - 100, behavior: 'smooth' }); }, 100); }
        
        setupPCScroll(container); // PCç”¨æ“ä½œã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    }

    // â˜…è¿½åŠ ï¼šPCæ“ä½œç”¨ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ï¼‰
    function setupPCScroll(container) {
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ (â†/â†’)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') {
                container.scrollBy({ left: 100, behavior: 'smooth' });
            } else if (e.key === 'ArrowLeft') {
                container.scrollBy({ left: -100, behavior: 'smooth' });
            }
        });

        // ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œ (Grab & Drag)
        let isDown = false;
        let startX;
        let scrollLeft;

        container.addEventListener('mousedown', (e) => {
            isDown = true;
            container.classList.add('active');
            startX = e.pageX - container.offsetLeft;
            scrollLeft = container.scrollLeft;
        });
        container.addEventListener('mouseleave', () => { isDown = false; });
        container.addEventListener('mouseup', () => { isDown = false; });
        container.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - container.offsetLeft;
            const walk = (x - startX) * 2; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦
            container.scrollLeft = scrollLeft - walk;
        });
    }

    document.addEventListener('DOMContentLoaded', renderGantt);
</script>
</body>
</html>
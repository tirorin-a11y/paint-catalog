<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹ç®¡ç† - è·äººã‚®ã‚¢</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="style.css">
    <style>
        body { 
            font-family: sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            padding-bottom: 50px; 
        }
        header { 
            background: #2c3e50; 
            color: white; 
            padding: 10px 15px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .nav-links { 
            display: flex; 
            gap: 10px; 
            padding: 10px; 
            justify-content: center; 
            background: #fff; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: sticky; /* ãƒŠãƒ“ã‚‚è¿½å¾“ã•ã›ã‚‹ */
            top: 50px; /* headerã®é«˜ã•åˆ†ãšã‚‰ã™ */
            z-index: 90;
        }
        .nav-btn { text-decoration: none; font-size: 0.85rem; padding: 8px 20px; border-radius: 20px; background: #f8f9fa; color: #555; border: 1px solid #ddd; font-weight: bold; }

        /* â˜…ä¿®æ­£ï¼šæœˆè¡¨ç¤ºã¨ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ã‚¨ãƒªã‚¢ */
        .toggle-area { 
            padding: 10px 15px; 
            background: #fff; 
            border-bottom: 1px solid #eee; 
            border-top: 1px solid #eee;
            display: flex; 
            justify-content: space-between; /* å·¦å³ã«é…ç½® */
            align-items: center;
            position: sticky; /* ã“ã“ã‚‚è¿½å¾“ã•ã›ã‚‹ */
            top: 98px; /* header + nav-links ã®é«˜ã•æ¦‚ç®— */
            z-index: 90;
        }
        
        /* â˜…è¿½åŠ ï¼šæœˆè¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .current-month {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-toggle { background: #fff; border: 1px solid #2980b9; color: #2980b9; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .btn-toggle.active { background: #2980b9; color: white; }
        
        /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ */
        .gantt-container { 
            overflow-x: auto; 
            background: white; 
            /* margin-top: 10px; å‰Šé™¤ï¼ˆstickyã¨ã®å…¼ã­åˆã„ï¼‰ */
            position: relative; 
            scrollbar-width: thin; 
            height: calc(100vh - 150px); /* ç”»é¢ä¸‹ã¾ã§åºƒã’ã‚‹ */
        }
        
        .gantt-header { 
            display: flex; 
            position: sticky; 
            top: 0; 
            background: #ecf0f1; 
            z-index: 10; 
            border-bottom: 1px solid #ddd; 
        }
        
        .gantt-cell { 
            min-width: 40px; 
            height: 40px; 
            border-right: 1px solid #eee; 
            border-bottom: 1px solid #eee; 
            text-align: center; 
            line-height: 40px; 
            font-size: 0.8rem; 
            box-sizing: border-box; 
            flex-shrink: 0;
        }
        
        .day-header { font-weight: bold; font-size: 0.7rem; color: #555; }
        .is-sunday { background-color: #ffcdd2; color: #c62828; }
        .is-today { background-color: #fff9c4; border-bottom: 3px solid #fbc02d; }
        
        .site-row { 
            display: flex; 
            position: relative; 
            height: 50px; 
            align-items: center; 
            border-bottom: 1px solid #eee; 
        }
        
        .site-name-col { 
            position: sticky; 
            left: 0; 
            width: 120px; 
            background: white; 
            z-index: 5; 
            font-size: 0.8rem; 
            padding: 0 5px; 
            border-right: 2px solid #ddd; 
            display: flex; 
            align-items: center; 
            height: 100%; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); 
            flex-shrink: 0;
            cursor: pointer;
            color: #2980b9;
            font-weight: bold;
            transition: background 0.2s;
        }
        .site-name-col:active { background-color: #e3f2fd; }
        
        .bar { 
            position: absolute; 
            height: 24px; 
            top: 13px; 
            border-radius: 12px; 
            font-size: 0.7rem; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            white-space: nowrap; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            opacity: 0.9; 
            cursor: pointer; 
        }
        .bar-plan { background: #f39c12; }
        .bar-active { background: #2980b9; }
        .bar-done { background: #7f8c8d; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; display: none; }
        .overlay.show { display: block; }
        .modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; background: white; padding: 20px; border-radius: 12px; z-index: 160; box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: none; }
        .modal-box.show { display: block; }
        .modal-btn-area { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-save { background: #2980b9; color: white; }
        .btn-cancel { background: #eee; color: #333; }
        input[type="date"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-top: 5px; font-size: 1rem; }
        label { display: block; margin-top: 15px; font-size: 0.9rem; font-weight: bold; color: #555; }
    </style>
</head>
<body>

<header>
    <div style="font-weight:bold; font-size:1.1rem;">ğŸ“Š å·¥ç¨‹ç®¡ç†</div>
    <a href="navi.html" style="color:white; text-decoration:none; font-size:1.2rem;">âœ•</a>
</header>

<div class="nav-links">
    <a href="navi.html" class="nav-btn">ğŸ  ç¾å ´ãƒŠãƒ“</a>
    <a href="index.html" class="nav-btn">ğŸ” æ¤œç´¢</a>
</div>

<div class="toggle-area">
    <div class="current-month">
        <span style="font-size:1.5rem;">ğŸ“…</span> <span id="monthDisplay">--å¹´ --æœˆ</span>
    </div>
    <button class="btn-toggle" id="btnShowAll" onclick="toggleShowAll()">å…¨ã¦ã®ç¾å ´ã‚’è¡¨ç¤º</button>
</div>

<div id="ganttArea" class="gantt-container"></div>

<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div id="dateModal" class="modal-box">
    <h3 style="margin-top:0; color:#2c3e50;">ğŸ“… æ—¥ç¨‹ã®èª¿æ•´</h3>
    <p id="editSiteName" style="font-weight:bold; color:#2980b9; border-bottom:1px solid #eee; padding-bottom:10px;"></p>
    
    <label>é–‹å§‹æ—¥</label>
    <input type="date" id="editStart">
    
    <label>çµ‚äº†æ—¥</label>
    <input type="date" id="editEnd">
    
    <div class="modal-btn-area">
        <button class="modal-btn btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn btn-save" onclick="saveSchedule()">ä¿ å­˜</button>
    </div>
</div>

<script>
    let sites = JSON.parse(localStorage.getItem('dx_sites')) || [];
    let isShowAll = false;
    let editingId = null;
    let gStartDate = null; // â˜…è¿½åŠ ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨ˆç®—ç”¨ã«é–‹å§‹æ—¥ã‚’ä¿æŒ

    function toggleShowAll() {
        isShowAll = !isShowAll;
        const btn = document.getElementById('btnShowAll');
        if(isShowAll) {
            btn.classList.add('active');
            btn.textContent = "å®Œäº†ç¾å ´ã‚’éš ã™";
        } else {
            btn.classList.remove('active');
            btn.textContent = "å…¨ã¦ã®ç¾å ´ã‚’è¡¨ç¤º";
        }
        renderGantt();
    }

    function parseDate(str) {
        if(!str) return null;
        return new Date(str.replace(/-/g, '/'));
    }

    function getDiffDays(date1, date2) {
        const dt1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
        const dt2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
        return Math.floor((dt2 - dt1) / (1000 * 60 * 60 * 24));
    }

    function openEditModal(id) {
        const site = sites.find(s => s.id === id);
        if(!site) return;
        editingId = id;
        document.getElementById('editSiteName').textContent = site.name;
        document.getElementById('editStart').value = site.start || '';
        document.getElementById('editEnd').value = site.end || '';
        document.getElementById('overlay').classList.add('show');
        document.getElementById('dateModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('overlay').classList.remove('show');
        document.getElementById('dateModal').classList.remove('show');
        editingId = null;
    }

    function saveSchedule() {
        if(!editingId) return;
        const index = sites.findIndex(s => s.id === editingId);
        if(index !== -1) {
            const newStart = document.getElementById('editStart').value;
            const newEnd = document.getElementById('editEnd').value;
            if(newStart && newEnd && newStart > newEnd) { alert("é–‹å§‹æ—¥ãŒçµ‚äº†æ—¥ã‚ˆã‚Šå¾Œã«ãªã£ã¦ã„ã¾ã™"); return; }
            sites[index].start = newStart;
            sites[index].end = newEnd;
            sites[index].updatedAt = Date.now();
            localStorage.setItem('dx_sites', JSON.stringify(sites));
            renderGantt();
            closeModal();
        }
    }

    // â˜…è¿½åŠ ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã®æœˆè¡¨ç¤ºæ›´æ–°
    function updateMonthDisplay() {
        const container = document.getElementById('ganttArea');
        if(!gStartDate) return;
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‹ã‚‰ã€Œç¾åœ¨ã®æ—¥ä»˜ã€ã‚’è¨ˆç®—ï¼ˆ1æ—¥=40pxï¼‰
        // å·¦ç«¯ã‹ã‚‰å°‘ã—å³ï¼ˆ+20pxï¼‰ã®æ—¥ä»˜ã‚’è¡¨ç¤ºåŸºæº–ã«ã™ã‚‹
        const scrollLeft = container.scrollLeft;
        const daysToAdd = Math.floor((scrollLeft + 20) / 40);
        
        const currentDate = new Date(gStartDate);
        currentDate.setDate(gStartDate.getDate() + daysToAdd);
        
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        
        document.getElementById('monthDisplay').textContent = `${year}å¹´ ${month}æœˆ`;
    }

    function renderGantt() {
        const container = document.getElementById('ganttArea');
        container.innerHTML = '';

        // æ—¥ä»˜ç¯„å›²ï¼šä»Šæœˆ1æ—¥ ã€œ 3ãƒ¶æœˆå¾Œ
        const today = new Date();
        const startDate = new Date(today.getFullYear(), today.getMonth(), 1); 
        gStartDate = startDate; // â˜…ä¿æŒ
        
        const endDate = new Date(today.getFullYear(), today.getMonth() + 3, 0);
        const totalDays = getDiffDays(startDate, endDate) + 1;

        let headerHTML = '<div class="gantt-header"><div class="gantt-cell" style="min-width:120px; position:sticky; left:0; z-index:20; background:#ecf0f1; border-right:2px solid #ddd;">ç¾å ´å</div>';
        let todayLeftPos = 0;

        for (let i = 0; i < totalDays; i++) {
            const d = new Date(startDate);
            d.setDate(startDate.getDate() + i);
            const isSun = d.getDay() === 0;
            const isToday = d.toDateString() === today.toDateString();
            if (isToday) todayLeftPos = i * 40;
            headerHTML += `<div class="gantt-cell day-header ${isSun?'is-sunday':''} ${isToday?'is-today':''}">${d.getDate()}</div>`;
        }
        headerHTML += '</div>';
        container.insertAdjacentHTML('beforeend', headerHTML);

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const targetSites = isShowAll ? sites : sites.filter(s => s.status !== 'complete' && s.status !== 'lost' && s.status !== 'done' && s.status !== 'handover');

        targetSites.forEach(site => {
            if (!site.start || !site.end) return;

            const sDate = parseDate(site.start);
            const eDate = parseDate(site.end);
            if (eDate < startDate || sDate > endDate) return;

            const offsetDays = getDiffDays(startDate, sDate);
            const durationDays = getDiffDays(sDate, eDate) + 1;

            let left = offsetDays * 40;
            let width = durationDays * 40;
            if (left < 0) { width += left; left = 0; } 

            let barClass = 'bar-plan';
            if (site.status === 'contract' || site.status === 'active' || site.status === 'billing') {
                barClass = 'bar-active';
            }
            if (site.status === 'complete' || site.status === 'lost' || site.status === 'done') {
                barClass = 'bar-done';
            }

            const rowHTML = `
                <div class="site-row" style="width:${120 + (totalDays * 40)}px">
                    <div class="site-name-col" onclick="openEditModal('${site.id}')" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ—¥ç¨‹å¤‰æ›´">
                        ${site.name} <span style="font-size:0.6rem; color:#888; margin-left:2px;">âœ</span>
                    </div>
                    <div class="bar ${barClass}" style="left:${120 + left}px; width:${width}px;">
                        ${durationDays}æ—¥
                    </div>
                    ${Array.from({length: totalDays}).map((_, idx) => {
                        const d = new Date(startDate); d.setDate(startDate.getDate() + idx);
                        const isSun = d.getDay() === 0;
                        const isToday = d.toDateString() === today.toDateString();
                        let bg = isToday ? '#fff9c4' : (isSun ? '#fff0f0' : 'transparent');
                        return `<div style="position:absolute; left:${120 + idx * 40}px; top:0; width:40px; height:100%; border-right:1px solid #eee; background:${bg}; z-index:-1;"></div>`
                    }).join('')}
                </div>
            `;
            container.insertAdjacentHTML('beforeend', rowHTML);
        });

        // â˜…è¿½åŠ ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
        container.onscroll = updateMonthDisplay;
        
        // åˆå›æœˆè¡¨ç¤ºæ›´æ–°
        updateMonthDisplay();

        // ä»Šæ—¥ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        if(todayLeftPos > 0) {
            setTimeout(() => {
                container.scrollTo({ left: todayLeftPos - 100, behavior: 'smooth' });
            }, 100);
        }
    }

    document.addEventListener('DOMContentLoaded', renderGantt);
</script>
</body>
</html>
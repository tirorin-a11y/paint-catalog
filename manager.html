<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹ç®¡ç† - è·äººã‚®ã‚¢</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="style.css">
    <style>
        body { 
            font-family: sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            padding-bottom: 50px; 
        }
        header { 
            background: #2c3e50; 
            color: white; 
            padding: 10px 15px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .gantt-container { 
            overflow-x: auto; 
            background: white; 
            margin-top: 10px; 
            position: relative; 
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’è¦‹ã‚„ã™ã */
            scrollbar-width: thin; 
        }
        
        .gantt-header { 
            display: flex; 
            position: sticky; 
            top: 0; 
            background: #ecf0f1; 
            z-index: 10; 
            border-bottom: 1px solid #ddd; 
        }
        
        .gantt-cell { 
            min-width: 40px; 
            height: 40px; 
            border-right: 1px solid #eee; 
            border-bottom: 1px solid #eee; 
            text-align: center; 
            line-height: 40px; 
            font-size: 0.8rem; 
            box-sizing: border-box; 
            flex-shrink: 0;
        }
        
        .day-header { 
            font-weight: bold; 
            font-size: 0.7rem; 
            color: #555; 
        }
        
        .is-sunday { background-color: #ffcdd2; color: #c62828; }
        .is-today { background-color: #fff9c4; border-bottom: 3px solid #fbc02d; }
        
        .site-row { 
            display: flex; 
            position: relative; 
            height: 50px; 
            align-items: center; 
            border-bottom: 1px solid #eee; 
        }
        
        .site-name-col { 
            position: sticky; 
            left: 0; 
            width: 120px; 
            background: white; 
            z-index: 5; 
            font-size: 0.8rem; 
            padding: 0 5px; 
            border-right: 2px solid #ddd; 
            display: flex; 
            align-items: center; 
            height: 100%; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); 
            flex-shrink: 0;
        }
        
        .bar { 
            position: absolute; 
            height: 24px; 
            top: 13px; 
            border-radius: 12px; 
            font-size: 0.7rem; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            white-space: nowrap; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            opacity: 0.9; 
            cursor: pointer; 
        }
        .bar-plan { background: #f39c12; }
        .bar-active { background: #2980b9; }
        .bar-done { background: #7f8c8d; }
        
        /* è¡¨ç¤ºåˆ‡æ›¿ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
        .toggle-area { 
            padding: 10px; 
            text-align: right; 
            background: #fff; 
            border-bottom: 1px solid #eee; 
        }
        .btn-toggle { 
            background: #fff; 
            border: 1px solid #2980b9; 
            color: #2980b9; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            cursor: pointer; 
            transition: 0.2s;
        }
        .btn-toggle.active { 
            background: #2980b9; 
            color: white; 
        }
        
        /* ä¸Šéƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav-links { 
            display: flex; 
            gap: 10px; 
            padding: 10px; 
            justify-content: center; 
            background: #fff; 
            margin-bottom: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .nav-btn { 
            text-decoration: none; 
            font-size: 0.85rem; 
            padding: 8px 20px; 
            border-radius: 20px; 
            background: #f8f9fa; 
            color: #555; 
            border: 1px solid #ddd; 
            font-weight: bold;
        }
    </style>
</head>
<body>

<header>
    <div style="font-weight:bold; font-size:1.1rem;">ğŸ“Š å·¥ç¨‹ç®¡ç†</div>
    <a href="navi.html" style="color:white; text-decoration:none; font-size:1.2rem;">âœ•</a>
</header>

<div class="nav-links">
    <a href="navi.html" class="nav-btn">ğŸ  ç¾å ´ãƒŠãƒ“</a>
    <a href="index.html" class="nav-btn">ğŸ” æ¤œç´¢</a>
</div>

<div class="toggle-area">
    <button class="btn-toggle" id="btnShowAll" onclick="toggleShowAll()">å…¨ã¦ã®ç¾å ´ã‚’è¡¨ç¤º</button>
</div>

<div id="ganttArea" class="gantt-container">
    </div>

<script>
    let sites = JSON.parse(localStorage.getItem('dx_sites')) || [];
    let isShowAll = false; // åˆæœŸçŠ¶æ…‹ï¼šå®Œäº†ç¾å ´ã¯éš ã™

    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    function toggleShowAll() {
        isShowAll = !isShowAll;
        const btn = document.getElementById('btnShowAll');
        if(isShowAll) {
            btn.classList.add('active');
            btn.textContent = "å®Œäº†ç¾å ´ã‚’éš ã™";
        } else {
            btn.classList.remove('active');
            btn.textContent = "å…¨ã¦ã®ç¾å ´ã‚’è¡¨ç¤º";
        }
        renderGantt();
    }

    // â˜…é‡è¦ï¼šæ—¥ä»˜æ–‡å­—åˆ—ã‚’Dateå‹ã«å¤‰æ›ï¼ˆ/åŒºåˆ‡ã‚Šã«ç½®æ›ã—ã¦ã‚ºãƒ¬é˜²æ­¢ï¼‰
    function parseDate(str) {
        if(!str) return null;
        return new Date(str.replace(/-/g, '/'));
    }

    // æ—¥ä»˜ã®å·®åˆ†ï¼ˆæ—¥æ•°ï¼‰ã‚’è¨ˆç®—
    function getDiffDays(date1, date2) {
        const dt1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
        const dt2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
        return Math.floor((dt2 - dt1) / (1000 * 60 * 60 * 24));
    }

    function renderGantt() {
        const container = document.getElementById('ganttArea');
        container.innerHTML = '';

        // 1. è¡¨ç¤ºç¯„å›²ã®æ±ºå®šï¼ˆä»Šæœˆ1æ—¥ ã€œ 3ãƒ¶æœˆå¾Œæœ«æ—¥ï¼‰
        const today = new Date();
        const startDate = new Date(today.getFullYear(), today.getMonth(), 1); 
        const endDate = new Date(today.getFullYear(), today.getMonth() + 3, 0);
        const totalDays = getDiffDays(startDate, endDate) + 1;

        // 2. ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ç”Ÿæˆ
        let headerHTML = '<div class="gantt-header"><div class="gantt-cell" style="min-width:120px; position:sticky; left:0; z-index:20; background:#ecf0f1; border-right:2px solid #ddd;">ç¾å ´å</div>';
        
        let todayLeftPos = 0; // ä»Šæ—¥ã®ä½ç½®ã‚’è¨˜éŒ²

        for (let i = 0; i < totalDays; i++) {
            const d = new Date(startDate);
            d.setDate(startDate.getDate() + i);
            
            const isSun = d.getDay() === 0;
            const isToday = d.toDateString() === today.toDateString();
            
            if (isToday) todayLeftPos = i * 40;

            let classNames = 'gantt-cell day-header';
            if (isSun) classNames += ' is-sunday';
            if (isToday) classNames += ' is-today';

            headerHTML += `<div class="${classNames}">${d.getDate()}</div>`;
        }
        headerHTML += '</div>';
        container.insertAdjacentHTML('beforeend', headerHTML);

        // 3. ç¾å ´ãƒ‡ãƒ¼ã‚¿ã®æç”»
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆisShowAllãŒfalseãªã‚‰å®Œäº†ã‚’é™¤å¤–ï¼‰
        const targetSites = isShowAll ? sites : sites.filter(s => s.status !== 'handover');

        targetSites.forEach(site => {
            if (!site.start || !site.end) return; // æ—¥ç¨‹æœªå®šã¯ã‚¹ã‚­ãƒƒãƒ—

            const sDate = parseDate(site.start);
            const eDate = parseDate(site.end);
            
            // ç¯„å›²å¤–ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
            if (eDate < startDate || sDate > endDate) return;

            // ãƒãƒ¼ã®ä½ç½®è¨ˆç®—
            const offsetDays = getDiffDays(startDate, sDate);
            const durationDays = getDiffDays(sDate, eDate) + 1;

            let left = offsetDays * 40;
            let width = durationDays * 40;

            // å·¦ç«¯è£œæ­£ï¼ˆè¡¨ç¤ºæœŸé–“ã‚ˆã‚Šå‰ã‹ã‚‰å§‹ã¾ã£ã¦ã„ã‚‹å ´åˆï¼‰
            if (left < 0) { 
                width += left; 
                left = 0; 
            } 

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®è‰²åˆ†ã‘
            let barClass = 'bar-plan';
            if (site.status === 'active') barClass = 'bar-active';
            if (site.status === 'done' || site.status === 'handover') barClass = 'bar-done';

            const rowHTML = `
                <div class="site-row" style="width:${120 + (totalDays * 40)}px">
                    <div class="site-name-col">${site.name}</div>
                    <div class="bar ${barClass}" style="left:${120 + left}px; width:${width}px;">
                        ${durationDays}æ—¥
                    </div>
                    ${Array.from({length: totalDays}).map((_, idx) => {
                        const d = new Date(startDate); d.setDate(startDate.getDate() + idx);
                        const isSun = d.getDay() === 0;
                        const isToday = d.toDateString() === today.toDateString();
                        let bg = isToday ? '#fff9c4' : (isSun ? '#fff0f0' : 'transparent');
                        return `<div style="position:absolute; left:${120 + idx * 40}px; top:0; width:40px; height:100%; border-right:1px solid #eee; background:${bg}; z-index:-1;"></div>`
                    }).join('')}
                </div>
            `;
            container.insertAdjacentHTML('beforeend', rowHTML);
        });

        // â˜…ä»Šæ—¥ã¸è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« (å°‘ã—å·¦ã«ä½™è£•ã‚’æŒãŸã›ã‚‹ -100px)
        if(todayLeftPos > 0) {
            setTimeout(() => {
                container.scrollTo({ left: todayLeftPos - 100, behavior: 'smooth' });
            }, 100);
        }
    }

    document.addEventListener('DOMContentLoaded', renderGantt);
</script>
</body>
</html>